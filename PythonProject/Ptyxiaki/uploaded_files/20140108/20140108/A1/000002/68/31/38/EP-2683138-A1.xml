<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2683138-A1" country="EP" doc-number="2683138" kind="A1" date="20140108" family-id="46816624" file-reference-id="252638" date-produced="20180824" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="146585111" ucid="EP-2683138-A1"><document-id><country>EP</country><doc-number>2683138</doc-number><kind>A1</kind><date>20140108</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-12823122-A" is-representative="YES"><document-id mxw-id="PAPP154847303" load-source="docdb" format="epo"><country>EP</country><doc-number>12823122</doc-number><kind>A</kind><date>20121019</date><lang>ZH</lang></document-id><document-id mxw-id="PAPP220439886" load-source="docdb" format="original"><country>EP</country><doc-number>12823122.2</doc-number><date>20121019</date></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC140548379" ucid="CN-2012083177-W" linkage-type="W" load-source="docdb"><document-id format="epo"><country>CN</country><doc-number>2012083177</doc-number><kind>W</kind><date>20121019</date></document-id></priority-claim><priority-claim mxw-id="PPC140556174" ucid="CN-201210174333-A" load-source="docdb"><document-id format="epo"><country>CN</country><doc-number>201210174333</doc-number><kind>A</kind><date>20120530</date></document-id></priority-claim></priority-claims><dates-of-public-availability><search-report-dispatch-date><date>20131001</date></search-report-dispatch-date></dates-of-public-availability><technical-data><classifications-ipcr><classification-ipcr mxw-id="PCL1989317733" load-source="docdb">H04L  29/12        20060101AFI20130925BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-2094105741" load-source="docdb" scheme="CPC">H04L  61/2557      20130101 LI20150203BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2094109824" load-source="docdb" scheme="CPC">H04L  61/2517      20130101 FI20130923BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2094110138" load-source="docdb" scheme="CPC">H04L  61/2514      20130101 LA20150203BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT132359966" lang="DE" load-source="patent-office">VERFAHREN UND VORRICHTUNG ZUR ZUWEISUNG ÖFFENTLICHER NETZWERKADRESSEN</invention-title><invention-title mxw-id="PT132359967" lang="EN" load-source="patent-office">PUBLIC NETWORK ADDRESS ALLOCATION METHOD AND DEVICE</invention-title><invention-title mxw-id="PT132359968" lang="FR" load-source="patent-office">PROCÉDÉ ET DISPOSITIF D'AFFECTATION D'ADRESSE DE RÉSEAU PUBLIC</invention-title></technical-data><parties><applicants><applicant mxw-id="PPAR919520866" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>HUAWEI TECH CO LTD</last-name><address><country>CN</country></address></addressbook></applicant><applicant mxw-id="PPAR919535950" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>HUAWEI TECHNOLOGIES CO., LTD.</last-name></addressbook></applicant><applicant mxw-id="PPAR919017820" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Huawei Technologies Co., Ltd.</last-name><iid>101371896</iid><address><street>Huawei Administration Building Bantian, Longgang</street><city>Shenzhen, Guangdong 518129</city><country>CN</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR919535340" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>GUO YINGHUI</last-name><address><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR919535663" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>GUO, YINGHUI</last-name></addressbook></inventor><inventor mxw-id="PPAR919014595" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>GUO, YINGHUI</last-name><address><street>Huawei Administration Building, Bantian, Longgang</street><city>Shenzhen, Guangdong 518129</city><country>CN</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR919006068" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Maiwald Patentanwalts GmbH</last-name><iid>101330423</iid><address><street>Engineering Elisenhof Elisenstrasse 3</street><city>80335 München</city><country>DE</country></address></addressbook></agent></agents></parties><international-convention-data><pct-or-regional-filing-data ucid="CN-2012083177-W"><document-id><country>CN</country><doc-number>2012083177</doc-number><kind>W</kind><date>20121019</date><lang>ZH</lang></document-id></pct-or-regional-filing-data><pct-or-regional-publishing-data ucid="WO-2013177891-A1"><document-id><country>WO</country><doc-number>2013177891</doc-number><kind>A1</kind><date>20131205</date><lang>ZH</lang></document-id></pct-or-regional-publishing-data><designated-states><ep-contracting-states><country mxw-id="DS549744541" load-source="docdb">AL</country><country mxw-id="DS549816621" load-source="docdb">AT</country><country mxw-id="DS549744542" load-source="docdb">BE</country><country mxw-id="DS549742588" load-source="docdb">BG</country><country mxw-id="DS549744884" load-source="docdb">CH</country><country mxw-id="DS549818647" load-source="docdb">CY</country><country mxw-id="DS549818648" load-source="docdb">CZ</country><country mxw-id="DS549908543" load-source="docdb">DE</country><country mxw-id="DS549744543" load-source="docdb">DK</country><country mxw-id="DS549744544" load-source="docdb">EE</country><country mxw-id="DS549814758" load-source="docdb">ES</country><country mxw-id="DS549742601" load-source="docdb">FI</country><country mxw-id="DS549742602" load-source="docdb">FR</country><country mxw-id="DS549908544" load-source="docdb">GB</country><country mxw-id="DS549744557" load-source="docdb">GR</country><country mxw-id="DS549908545" load-source="docdb">HR</country><country mxw-id="DS549818649" load-source="docdb">HU</country><country mxw-id="DS549744893" load-source="docdb">IE</country><country mxw-id="DS549744558" load-source="docdb">IS</country><country mxw-id="DS549742603" load-source="docdb">IT</country><country mxw-id="DS549744559" load-source="docdb">LI</country><country mxw-id="DS549908546" load-source="docdb">LT</country><country mxw-id="DS549816626" load-source="docdb">LU</country><country mxw-id="DS549742604" load-source="docdb">LV</country><country mxw-id="DS549908547" load-source="docdb">MC</country><country mxw-id="DS549816627" load-source="docdb">MK</country><country mxw-id="DS549816628" load-source="docdb">MT</country><country mxw-id="DS549814759" load-source="docdb">NL</country><country mxw-id="DS549815808" load-source="docdb">NO</country><country mxw-id="DS549814760" load-source="docdb">PL</country><country mxw-id="DS549742605" load-source="docdb">PT</country><country mxw-id="DS549818662" load-source="docdb">RO</country><country mxw-id="DS549742606" load-source="docdb">RS</country><country mxw-id="DS549814761" load-source="docdb">SE</country><country mxw-id="DS549744894" load-source="docdb">SI</country><country mxw-id="DS549815809" load-source="docdb">SK</country><country mxw-id="DS549815814" load-source="docdb">SM</country><country mxw-id="DS549816629" load-source="docdb">TR</country></ep-contracting-states></designated-states></international-convention-data></bibliographic-data><abstract mxw-id="PA128673283" lang="EN" load-source="patent-office"><p id="pa01" num="0001">An embodiment of the present invention provides a method for assigning a public network address. The method includes: receiving a first request packet sent by a private network user equipment; assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assigning a first idle port set to the private network user equipment from an idle port in a first port set that is corresponding to the first public network IP address; and when it is determined that all ports in the first idle port set are occupied, assigning a second idle port set to the private network user equipment from an idle port in a second port set that is corresponding to the first public network IP address. An embodiment of the present invention further provides an apparatus for assigning a public network address. With the technical solutions provided in the embodiments of the present invention, a probability that the private network user fails to be assigned a public network port when adding a new connection to a public network equipment is lowered.<img id="iaf01" file="imgaf001.tif" wi="123" he="85" img-content="drawing" img-format="tif"/></p></abstract><abstract mxw-id="PA128737434" lang="EN" source="EPO" load-source="docdb"><p>An embodiment of the present invention provides a method for assigning a public network address. The method includes: receiving a first request packet sent by a private network user equipment; assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assigning a first idle port set to the private network user equipment from an idle port in a first port set that is corresponding to the first public network IP address; and when it is determined that all ports in the first idle port set are occupied, assigning a second idle port set to the private network user equipment from an idle port in a second port set that is corresponding to the first public network IP address. An embodiment of the present invention further provides an apparatus for assigning a public network address. With the technical solutions provided in the embodiments of the present invention, a probability that the private network user fails to be assigned a public network port when adding a new connection to a public network equipment is lowered.</p></abstract><description mxw-id="PDES63959271" lang="EN" load-source="patent-office"><!-- EPO <DP n="1"> --><heading id="h0001"><b>FIELD OF THE INVENTION</b></heading><p id="p0001" num="0001">The present invention relates to the field of communications, and in particular to a method and an apparatus for assigning a public network address.</p><heading id="h0002"><b>BACKGROUND OF THE INVENTION</b></heading><p id="p0002" num="0002">With the development of the Internet, Internet protocol (its full name is Internet Protocol in English, and its abbreviation is IP in English) address shortage has become an increasingly severe problem. At present, there are mainly two solutions: introduction of the Internet protocol version 6 (its full name is Internet Protocol Version 6 in English, and its abbreviation is IPv6 in English) technology and network address translation (its full name is Network Address Translation in English, and its abbreviation is NAT in English). Though the introduction of IPv6 can thoroughly solve an address exhaustion problem, currently, most content and applications are still based on the Internet protocol version 4 (its full name is Internet Protocol Version 4 in English, and its abbreviation is IPv4 in English) and if they are forcibly and completely switched to the IPv6, a risk that cannot be borne by an existing service may be encountered. During a relatively long term evolution process from the IPv4 to the IPv6, a NAT technology is a main solution selected to solve the IP address shortage problem in consideration of user experience, technology maturity, deployment difficulty, and the like.</p><p id="p0003" num="0003">In the NAT technology, a most typical address translation method is a network address and port translation (its full name is Network Address and Port Translation in English, and its abbreviation is NAPT in English) method. Specifically, the method is as follows: On a local area network, each private network user equipment occupies one internal address and one internal port number, where the internal address is a private network address and the internal port number is a private network port number; and when a private network user equipment needs to communicate with an external network, a NAT equipment translates the private network address and the private network port number to an idle external address and an external port number, where the idle external address is a public network address and the<!-- EPO <DP n="2"> --> external port number is a public network port number, thereby implementing normal communication between the private network user equipment on the local area network and the external network. Therefore, by using the NAT technology, multiple equipments may be enabled to share one public network address, thereby solving a public IP address shortage problem in a better way. However, by using this method, each time when a connection is established between a private network user equipment and an external network equipment, a NAT equipment applies for a new public network port for the private network user equipment, thereby resulting in a low connection rate. Furthermore, the NAT equipment needs to record usage of each port, which is assigned to the private network user equipment, in a log, thereby resulting in complicated management. The established connection between the private network user equipment and the external network equipment may be established by using a transmission control protocol (its full name is Transmission Control Protocol in English, and its abbreviation is TCP in English), may also be established by using a secure sockets layer (its full name is Secure Sockets Layer in English, and its abbreviation is SSL in English) protocol, may also be established by using a transport layer security (its full name is Transport Layer Security in English, and its abbreviation is TLS in English) protocol, and may also be established by using a user datagram protocol (its full name is User Datagram Protocol in English, and its abbreviation is UDP in English).</p><p id="p0004" num="0004">To solve the foregoing problems, the prior art further provides a method for assigning an address according to a port range (Port-range). Specifically, when a private network user equipment communicates with an external network by establishing a connection, a NAT equipment selects an idle public network address and a public network port block, and assigns them to the private network user equipment, where the public network port block is formed by consecutive idle ports among public network ports that are corresponding to the public network address. During communication, if the private network user equipment occupies all ports in the public network port block that is assigned to the private network user equipment and still requires a public network port, applies for a public network port block again. However, because the same private network user equipment must use the same public network address, when no idle port is available for assignment among public network ports that are corresponding to the public network address, that is, all public network ports that are corresponding to the public network address have been assigned, the private network user equipment fails to apply for a public network port. As a result, the private network user equipment cannot establish a new connection to an external network equipment.<!-- EPO <DP n="3"> --></p><heading id="h0003"><b>SUMMARY OF THE INVENTION</b></heading><p id="p0005" num="0005">Embodiments of the present invention provide a method and an apparatus for assigning a public network address, so as to decrease a probability that a private network user equipment fails to be assigned a public network port when establishing a newly added connection to a public network equipment after a public network IP address is assigned to the private network user equipment.</p><p id="p0006" num="0006">According to one aspect of the embodiments of the present invention, a method for assigning a public network address includes:
<ul><li>receiving a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</li><li>assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment, where ports that are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set includes at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assigning a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and</li><li>when it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assigning a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, where the second idle port set includes at least one port.</li></ul></p><p id="p0007" num="0007">According to another aspect of the embodiments of the present invention, a method for assigning a public network address includes:
<ul><li>receiving a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</li><li>assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assigning a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and saving the port in the first<!-- EPO <DP n="4"> --> idle port set to a first port set that is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value; and</li><li>assigning a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set to the first port set are occupied and an idle port exists among ports that are corresponding to the first public network IP address, where the second idle port set includes at least one port; and saving the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value, and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</li></ul></p><p id="p0008" num="0008">According to another aspect of the embodiments of the present invention, an apparatus for assigning a public network address includes:
<ul><li>a first receiving unit, configured to receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</li><li>a first assigning unit, configured to assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment, where ports that are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set includes at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assign a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and</li><li>a second assigning unit, configured to, when it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assign a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, where the second idle port set includes at least one port.</li></ul></p><p id="p0009" num="0009">According to another aspect of the embodiments of the present invention, an apparatus for assigning a public network address includes:
<ul><li>a third receiving unit, configured to receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection<!-- EPO <DP n="5"> --> between the private network user equipment and a network equipment that is on a public network;</li><li>a fourth assigning unit, configured to assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assign a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and save the port in the first idle port set to a first port set that is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value; and</li><li>a fifth assigning unit, configured to assign a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set to the first port set are occupied and an idle port exists among ports that is corresponding to the first public network IP address, where the second idle port set includes at least one port; and save the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value, and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</li></ul></p><p id="p0010" num="0010">According to a method and an apparatus for assigning a public network address provided in one aspect of the embodiments of the present invention, ports that are corresponding to a public network IP address are classified into a first port set and a second port set. After a public network IP address is assigned to a private network equipment that applies for a public network IP address for the first time, a port is assigned to the private network equipment from a first port set of the assigned public network IP address. When a newly added connection is established between the private network equipment and a public network equipment, a port from a second port set of the assigned public network IP address is assigned to the private network equipment. In this way, the second port set of the assigned public network IP address is reserved and is used for port assignment that is performed when a new connection is added between the private network equipment and the public network equipment, so that a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><p id="p0011" num="0011">According to a method and an apparatus for assigning a public network address provided in another aspect of the embodiments of the present invention, the number of ports, which are<!-- EPO <DP n="6"> --> among ports of a public network IP address and assigned to a private network equipment that applies for a public network IP address for the first time, is limited within a first threshold value. Furthermore, ports whose number is equivalent to a second threshold value are reserved among the ports of the public network IP address and are used for port assignment that is performed when a new connection is added between the private network equipment and a public network equipment, so that when a newly added connection is established between the private network equipment and the public network equipment, a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><heading id="h0004"><b>BRIEF DESCRIPTION OF THE DRAWINGS</b></heading><p id="p0012" num="0012">To describe the technical solutions in the embodiment of the present invention or in the prior art more clearly, the accompanying drawings required for describing the embodiment or the prior art are briefly introduced in the following. Apparently, the accompanying drawings in the following description show merely some embodiment of the present invention, and persons of ordinary skill in the art may still derive other drawings from these accompanying drawings without creative efforts.
<ul><li><figref idrefs="f0001">FIG. 1</figref> is a first schematic flowchart of a method for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0001">FIG. 2</figref> is a schematic structural diagram of a public network IP address and its corresponding port according to an embodiment of the present invention;</li><li><figref idrefs="f0002">FIG. 3</figref> is a second schematic flowchart of a method for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0003">FIG. 4</figref> is a third schematic flowchart of a method for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0004">FIG. 5</figref> is a fourth schematic flowchart of a method for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0005">FIG. 6</figref> is a fifth schematic flowchart of a method for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0006">FIG. 7</figref> is a first schematic structural diagram of an apparatus for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0006">FIG. 8</figref> is a second schematic structural diagram of an apparatus for assigning a public network address according to an embodiment of the present invention;</li><li><figref idrefs="f0007">FIG. 9</figref> is a third schematic structural diagram of an apparatus for assigning a public<!-- EPO <DP n="7"> --> network address according to an embodiment of the present invention; and</li><li><figref idrefs="f0007">FIG. 10</figref> is a fourth schematic structural diagram of an apparatus for assigning a public network address according to an embodiment of the present invention.</li></ul></p><heading id="h0005"><b>DETAILED DESCRIPTION OF THE EMBODIMENTS</b></heading><p id="p0013" num="0013">The technical solutions in the embodiments of the present invention are clearly and completely described in the following with reference to the accompanying drawings in the embodiments of the present invention. Apparently, the embodiment to be described is merely a part rather than all of the embodiments of the present invention. All other embodiments obtained by persons of ordinary skill in the art based on the embodiments of the present invention without creative efforts shall fall within the protection scope of the present invention.</p><p id="p0014" num="0014">As shown in <figref idrefs="f0001">FIG. 1</figref>, an embodiment of the present invention provides a method for assigning a public network address, where the method includes the following content.</p><p id="p0015" num="0015">101. Receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network.</p><p id="p0016" num="0016">The connection may be a TCP connection, a UDP connection, an SSL connection, or a TSL connection. Correspondingly, the first request packet may be a TCP connection establishment request packet, a UDP connection establishment request packet, an SSL connection establishment request packet, or a TSL connection establishment request packet, which is not specifically limited in this embodiment of the present invention.</p><p id="p0017" num="0017">102. Assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment, where ports that are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set includes at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assign a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, where the first idle port set includes at least one port.</p><p id="p0018" num="0018">The first port set that is corresponding to the first public network IP address is a port set used to assign a port to a private network user equipment that has not been assigned any public network IP address. The second port set that is corresponding to the first public network IP address is a port set used to reassign a port to a private network user equipment<!-- EPO <DP n="8"> --> that has been assigned a public network IP address. A structural diagram of ports that are corresponding to the first public network IP address is shown in <figref idrefs="f0001">FIG. 2</figref>.</p><p id="p0019" num="0019">Exemplarily, 10.0.0.1:4567 is used as a private network IP address and a private network port number and 128.0.0.1 is used as a first public network IP address in this embodiment of the present invention to clearly describe the method for assigning a public network address provided in this embodiment of the present invention. For example, ports that are ranging from 0 to 65535 and are corresponding to the first public network IP address 128.0.0.1 are classified into a first port set and a second port set, where ports in the first port set that is corresponding to the IP address 128.0.0.1 range from 0 to 50000 and ports in the second port set that is corresponding to the IP address 128.0.0.1 range from 50001 to 65535. When a first request packet sent by a private network user equipment is received, the first request packet carries a private network IP address 10.0.0.1, and it is determined, according to the private network IP address 10.0.0.1, that no public network IP address is assigned to the private network user equipment, the first public network IP address 128.0.0.1 is assigned to the private network user equipment from a public network address pool, and a first idle port set is assigned to the private network user equipment from an idle port in the first port set that is corresponding to the first public network IP address 128.0.0.1, where the first idle port set includes at least one port, for example, ports in the first idle port set range from 3812 to 4812.</p><p id="p0020" num="0020">Specifically, a method for determining that no public network IP address is assigned to the private network user equipment may be: searching a database that stores a private network user list, where an IP address and a public network port of a private network user that has been assigned a public network IP address are stored in information of the private network user list, and when a private network user list that stores a private network IP address of the private network user equipment is not found by searching the database, determining that no public network IP address is assigned to the private network user equipment.</p><p id="p0021" num="0021">103. When it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assign a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, where the second idle port set includes at least one port.</p><p id="p0022" num="0022">Each time when the private network user equipment connects to the network equipment on the public network for one service, that is, each time when a connection to the network equipment on the public network is established, a port in the first idle port set is used. All ports in the first idle port set are occupied, which indicates that all ports in the first idle port<!-- EPO <DP n="9"> --> set are used by the private network user equipment.</p><p id="p0023" num="0023">Exemplarily, when it is determined that all ports ranging from 3812 to 4812 in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address 128.0.0.1, a second idle port set, such as one with ports ranging from 50678 to 60678, is assigned to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address 128.0.0.1.</p><p id="p0024" num="0024">Optionally, before it is determined that all ports in the first idle port set are occupied, the method further includes: receiving a second request packet sent by the private network user equipment, and triggering detection on occupancy conditions of all ports in the first idle port set, where the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or starting a detection timer, and when the detection timer expires, triggering detection on occupancy conditions of all ports in the first idle port set.</p><p id="p0025" num="0025">Further, as shown in <figref idrefs="f0002">FIG. 3</figref>, the method further includes:
<ul><li>104. Assign a third public network IP address to the private network user equipment when it is determined that no public network IP address is assigned to the private network user equipment, and a second public network IP address does not exist in the public network address pool, ports that are corresponding to the second public network IP address are classified into a first port set and a second port set, and an idle port exists in the first port set of the second public network IP address, where ports that are corresponding to the third public network IP address are classified into a first port set and a second port set, and an idle port exists in the second port set that is corresponding to the third public network IP address; and assign a third idle port set to the private network user equipment from a idle port in the second port set that is corresponding to the third public network IP address, where the third idle port set includes at least one port.</li></ul></p><p id="p0026" num="0026">When an idle port exists in the second port set that is corresponding to the first public network IP address, the third public network IP address may also be the first public network IP address. When an idle port exists in the second port set that is corresponding to the second public network IP address, the third public network IP address may also be the second public network IP address.</p><p id="p0027" num="0027">Benefits of such implementation are as follows: When another private network user equipment needs to apply for a public network IP address and at this time, if no idle port exists in first port sets that are corresponding to all public network IP addresses in the public<!-- EPO <DP n="10"> --> network address pool, one public network IP address is assigned to the another private network user equipment, where an idle port exists in a second port set of the assigned public network IP address; furthermore, a public network port is assigned to the another private network user equipment from the second port set of the assigned public network IP address, and in this way, it can be ensured that a private network user equipment is assigned a public network IP address and a port in time and that communication is established in time between the private network user equipment and a network equipment that is on a public network.</p><p id="p0028" num="0028">Optionally, as shown in <figref idrefs="f0003">FIG. 4</figref>, the method further includes:
<ul><li>105. Receive an offline notification message sent by the private network user equipment and reclaim the first idle port set and the second idle port set.</li></ul></p><p id="p0029" num="0029">Specifically, when the private network user equipment does not need public network address and public network port resources any more, the private network user equipment sends an offline notification message that carries a private network IP address. After the offline notification is received, a public network IP address and a public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0030" num="0030">Optionally, as shown in <figref idrefs="f0003">FIG. 4</figref>, the method further includes:
<ul><li>106. Reclaim the first idle port set and the second idle port set if no packet sent by the private network user equipment is received within a preset time threshold.</li></ul></p><p id="p0031" num="0031">Exemplarily, if no packet that carries the private network IP address 10.0.0.1 is received within a preset time threshold, the public network IP address and the public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0032" num="0032">Optionally, as shown in <figref idrefs="f0003">FIG. 4</figref>, the method further includes:<!-- EPO <DP n="11"> -->
<ul><li>107. Reclaim the first idle port set and the second idle port set if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold.</li></ul></p><p id="p0033" num="0033">Exemplarily, if no packet sent to the private network IP address 10.0.0.1 is received within a preset time threshold, the public network IP address and the public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0034" num="0034">Optionally, as shown in <figref idrefs="f0003">FIG. 4</figref>, the method further includes:
<ul><li>108. Reclaim the second idle port set when no port in the second idle port set is occupied.</li></ul></p><p id="p0035" num="0035">The reclaiming of a port in the second idle port set may be performed without waiting for an offline notification sent by the private network user. The port in the second idle port set can be reclaimed as long as it is determined that no port in the second idle port set is occupied. In this way, the reclaiming of an idle port in the second idle port set can be accelerated, thereby further improving a utilization ratio of a port in the second port set that is corresponding to the first public network IP address, and increasing a probability that the private network user equipment applies for a port from the second port set that is corresponding to the first public network IP address, when a new connection is added between the private network user equipment and the network equipment that is on the public network.</p><p id="p0036" num="0036">It can be seen that, with the method for assigning a public network address provided in this embodiment of the present invention, ports that are corresponding to a public network IP address are classified into a first port set and a second port set. After a public network IP address is assigned to a private network equipment that applies for a public network IP address for the first time, a port is assigned to the private network equipment from a first port set of the assigned public network IP address. When a newly added connection is established between the private network equipment and a public network equipment, a port from a second port set of the assigned public network IP address is assigned to the private network equipment. In this way, the second port set of the assigned public network IP address is reserved and is used for port assignment that is performed when a new connection is added<!-- EPO <DP n="12"> --> between the private network equipment and the public network equipment, so that a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><p id="p0037" num="0037">As shown in <figref idrefs="f0004">FIG. 5</figref>, an embodiment of the present invention provides another method for assigning a public network address, where the method includes the following content.</p><p id="p0038" num="0038">501. Receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network.</p><p id="p0039" num="0039">The connection may be a TCP connection, a UDP connection, an SSL connection, or a TSL connection. Correspondingly, the first request packet may be a TCP connection establishment request packet, a UDP connection establishment request packet, an SSL connection establishment request packet, or a TSL connection establishment request packet, which is not specifically limited in this embodiment of the present invention.</p><p id="p0040" num="0040">502. Assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assign a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and save all ports in the first idle port set to a first port set, where the first port set is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value.</p><p id="p0041" num="0041">Exemplarily, 10.0.0.1:4567 is used as a private network IP address and a private network port number and 128.0.0.1 is used as a first public network IP address in this embodiment of the present invention to clearly describe the method for assigning a public network address provided in this embodiment of the present invention. Exemplarily, after it is determined, according to the private network IP address 10.0.0.1, that no public network IP address is assigned to the private network user equipment, a first public network IP address 128.0.0.1 is assigned to the private network user equipment from a public network address pool, and a first idle port set is assigned to the private network user equipment from an idle port that is corresponding to the first public network IP address 128.0.0.1. For example, a port in the first idle port set ranges from 3812 to 4812. The port in the first idle port set is saved to a first port set, where the number of ports in the first port set is not greater than a first threshold value. That is, if a public network IP address needs to be assigned to the private network IP address 10.0.0.1, before a public network IP address is assigned to the private network user equipment,<!-- EPO <DP n="13"> --> it needs to be determined that the number of ports in the first port set that is corresponding to the public network IP address is not greater than the first threshold value, where a port saved in the first port set is a port that is assigned to the private network user equipment that has not been assigned any public network IP address.</p><p id="p0042" num="0042">Specifically, a method for determining that no public network IP address is assigned to the private network user equipment may be: searching a database that stores a private network user list, where an IP address and a public network port of a private network user that has been assigned a public network IP address are stored in information of the private network user list, and when a private network user list that stores a private network IP address of the private network user equipment is not found by searching the database, determining that no public network IP address is assigned to the private network user equipment.</p><p id="p0043" num="0043">503. Assign a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set to the first port set are occupied and an idle port exists among all ports that are corresponding to the first public network IP address, where the second idle port set includes at least one port; and save the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value, and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</p><p id="p0044" num="0044">The first threshold value is used to limit the maximum number of ports in the first port set that is corresponding to the first public network IP address and the second threshold value is used to limit the maximum number of ports in the second port set that is corresponding to the first public network IP address. Exemplarily, when it is determined that all ports that are ranging from 3812 to 4812 in the first idle port set and are saved to the first port set are occupied and an idle port exists among ports that are corresponding to the first public network IP address, a second idle port set, such as one with ports ranging from 50678 to 60678, is assigned to the private network user equipment, where the second idle port set includes at least one port. The port in the second idle port set is saved to the second port set that is corresponding to the first public network IP address and the number of ports in the second port set is not greater than the second threshold value. That is, if a port that is corresponding to the first network IP address needs to be reassigned to the private network user equipment, it needs to be determined that the number of ports in the second port set that is corresponding to the first public network IP address is not greater than the second threshold value, and then the second idle port is assigned to the private network user equipment from an idle port that is<!-- EPO <DP n="14"> --> corresponding to the first public network IP address, where the sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</p><p id="p0045" num="0045">Optionally, before it is determined that all ports in the first idle port set are occupied, the method further includes: receiving a second request packet sent by the private network user equipment, triggering detection on occupancy conditions of all ports in the first idle port set, where the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or starting a detection timer, and when the detection timer expires, triggering detection on occupancy conditions of all ports in the first idle port set.</p><p id="p0046" num="0046">Further, as shown in <figref idrefs="f0004">FIG. 5</figref>, the method further includes:
<ul><li>504. Assign a third public network IP address to the private network user equipment when it is determined that no public network IP address is assigned to the private network user equipment, a second public network IP address does not exist in the public network address pool, and the number of ports in a first port set that is corresponding to the second public network IP address is smaller than a third threshold value; assign a third idle port set to the private network user equipment from an idle port that is corresponding to the third public network IP address, where the third idle port set includes at least one port; and save the port in the third idle port set to a second port set, where the second port set that is corresponding to the third public network IP address and the number of ports in the second port set is not greater than a fourth threshold value.</li></ul></p><p id="p0047" num="0047">The third threshold value is used to limit the maximum number of ports in the first port set that is corresponding to the second public network IP address and the fourth threshold value is used to limit the maximum number of ports in the second port set that is corresponding to the third public network IP address.</p><p id="p0048" num="0048">Benefits of such implementation are as follows: When another private network user equipment needs to apply for a public network IP address and at this time, if the number of ports in a first port set that is corresponding to each public network IP address in the public network address pool reaches a threshold value, one public network IP address is assigned to the another private network user equipment, where an idle port of the assigned public network IP address exists and the number of ports in a second port set of the assigned public network IP address does not reach the threshold value; furthermore, a public network port is assigned to the another private network user equipment from the idle port of the assigned public network IP address, and in this way, it can be ensured that a private network user equipment is<!-- EPO <DP n="15"> --> assigned a public network IP address and a port in time and that communication is established in time between the private network user equipment and a network equipment that is on a public network.</p><p id="p0049" num="0049">Optionally, as shown in <figref idrefs="f0005">FIG. 6</figref>, the method further includes:
<ul><li>505. Receive an offline notification message sent by the private network user equipment and reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0050" num="0050">Specifically, when the private network user equipment does not need public network address and public network port resources any more, the private network user equipment sends an offline notification message that carries a private network IP address. After the offline notification is received, a public network IP address and a public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved.</p><p id="p0051" num="0051">Optionally, as shown in <figref idrefs="f0005">FIG. 6</figref>, the method further includes:
<ul><li>506. If no packet sent by the private network user equipment is received within a preset time threshold, reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0052" num="0052">Exemplarily, if no packet that carries the private network IP address 10.0.0.1 is received within a preset time threshold, the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address are reclaimed. When the third idle port set is assigned to the private network user equipment, a port saved from the third idle port set to the second port set that is corresponding to the third public network IP address further needs to be reclaimed. In this way, a public network IP address and a port that is corresponding to the public network IP address are fully used, and a resource utilization ratio is improved.</p><p id="p0053" num="0053">Optionally, as shown in <figref idrefs="f0005">FIG. 6</figref>, the method further includes:
<ul><li>507. If no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold, reclaim the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim the port saved from the second idle port set to the second port set that is<!-- EPO <DP n="16"> --> corresponding to the first public network IP address.</li></ul></p><p id="p0054" num="0054">Exemplarily, if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold, that is, no packet that carries the private network address 10.0.0.1 is sent, the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address are reclaimed. When the third idle port set is assigned to the private network user equipment, the port saved from the third idle port set to the second port set that is corresponding to the third public network IP address further needs to be reclaimed. In this way, a public network IP address and a port that is corresponding to the public network IP address are fully used, and a resource utilization ratio is improved.</p><p id="p0055" num="0055">Optionally, as shown in <figref idrefs="f0005">FIG. 6</figref>, the method further includes:
<ul><li>508. When the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied, reclaim the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0056" num="0056">The reclaiming of the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address may be performed without waiting for an offline notification sent by the private network user. The port saved from the second idle port set to the second port set that is corresponding to the first public network IP address can be reclaimed as long as it is determined that the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied. In this way, the reclaiming of the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address can be accelerated, thereby further improving a utilization ratio of a port of the first public network IP address, and increasing a probability that when a new connection is added between the private network user equipment and the network equipment that is on the public network, the private network user equipment applies for a port from a port set that is corresponding to the first public network IP address.</p><p id="p0057" num="0057">It can be seen that, with the method for assigning a public network address provided in this embodiment of the present invention, the number of ports, which are among ports of a public network IP address and assigned to a private network equipment that applies for a public network IP address for the first time, is limited within a first threshold value. Furthermore, ports whose number is equivalent to a second threshold value are reserved among the ports of the public network IP address and are used for port assignment that is<!-- EPO <DP n="17"> --> performed when a new connection is added between the private network equipment and a public network equipment, so that when a newly added connection is established between the private network equipment and the public network equipment, a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><p id="p0058" num="0058">As shown in <figref idrefs="f0006">FIG. 7</figref>, an embodiment of the present invention provides an apparatus 70 for assigning a public network address. The apparatus 70 includes:
<ul><li>a first receiving unit 701, configured to receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</li><li>a first assigning unit 702, configured to assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment, where ports that are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set includes at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assign a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and</li><li>a second assigning unit 703, configured to, when it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assign a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, where the second idle port set includes at least one port.</li></ul></p><p id="p0059" num="0059">The connection may be a TCP connection, a UDP connection, an SSL connection, or a TSL connection. Correspondingly, the first request packet may be a TCP connection establishment request packet, a UDP connection establishment request packet, an SSL connection establishment request packet, or a TSL connection establishment request packet, which is not specifically limited in this embodiment of the present invention.</p><p id="p0060" num="0060">The first port set that is corresponding to the first public network IP address is a port set used to assign a port to a private network user equipment that has not been assigned any public network IP address. The second port set that is corresponding to the first public network IP address is a port set used to reassign a port to a private network user equipment<!-- EPO <DP n="18"> --> that has been assigned a public network IP address. A structural diagram of ports that are corresponding to the first public network IP address is shown in <figref idrefs="f0001">FIG. 2</figref>. Exemplarily, 10.0.0.1:4567 is used as a private network IP address and a private network port number and 128.0.0.1 is used as a first public network IP address in this embodiment of the present invention to clearly describe the apparatus for assigning a public network address provided in this embodiment of the present invention. For example, ports that are ranging from 0 to 65535 and are corresponding to the first public network IP address 128.0.0.1 are classified into a first port set and a second port set, where ports in the first port set that is corresponding to the IP address 128.0.0.1 range from 0 to 50000 and ports in the second port set that is corresponding to the IP address 128.0.0.1 range from 50001 to 65535. When the first receiving unit 701 receives a first request packet sent by a private network user equipment, the first request packet carries a private network IP address 10.0.0.1, and the first assigning unit 702 determines, according to the private network IP address 10.0.0.1, that no public network IP address is assigned to the private network user equipment, the first public network IP address 128.0.0.1 is assigned to the private network user equipment from a public network address pool, and a first idle port set is assigned to the private network user equipment from an idle port in the first port set that is corresponding to the first public network IP address 128.0.0.1, where the first idle port set includes at least one port, for example, ports in the first idle port set range from 3812 to 4812.</p><p id="p0061" num="0061">Specifically, a method for determining that no public network IP address is assigned to the private network user equipment may be: searching a database that stores a private network user list, where an IP address and a public network port of a private network user that has been assigned a public network IP address are stored in information of the private network user list, and when a private network user list that stores a private network IP address of the private network user equipment is not found by searching the database, determining that no public network IP address is assigned to the private network user equipment.</p><p id="p0062" num="0062">Each time when the private network user equipment connects to the network equipment on the public network for one service, that is, each time when a connection to the network equipment on the public network is established, a port in the first idle port set is used. All ports in the first idle port set are occupied, which indicates that all ports in the first idle port set are used by the private network user equipment.</p><p id="p0063" num="0063">Exemplarily, when the second assigning unit 703 determines that all ports ranging from 3812 to 4812 in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address 128.0.0.1, a second idle port set,<!-- EPO <DP n="19"> --> such as one with ports ranging from 50678 to 60678, is assigned to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address 128.0.0.1.</p><p id="p0064" num="0064">Further, to determine whether all ports in the first idle port set are occupied, as shown in <figref idrefs="f0006">FIG. 7</figref>, the apparatus 70 further includes:
<ul><li>a second receiving unit 704, configured to receive a second request packet sent by the private network user equipment and trigger detection on occupancy conditions of all ports in the first idle port set, where the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network.</li></ul></p><p id="p0065" num="0065">Alternatively, as shown in <figref idrefs="f0006">FIG. 7</figref>, the apparatus further includes:
<ul><li>a first starting and triggering unit 705, configured to start a detection timer, and when the detection timer expires, trigger detection on occupancy conditions of all ports in the first idle port set.</li></ul></p><p id="p0066" num="0066">Further, as shown in <figref idrefs="f0006">FIG. 8</figref>, the apparatus 70 further includes:
<ul><li>a third assigning unit 706, configured to assign a third public network IP address to the private network user equipment when it is determined that no public network IP address is assigned to the private network user equipment, a second public network IP address does not exist in the public network address pool, ports that are corresponding to the second public network IP address are classified into a first port set and a second port set, and an idle port exists in the first port set that is corresponding to the second public network IP address, where ports that are corresponding to the third public network IP address are classified into a first port set and a second port set, and an idle port exists in the second port set that is corresponding to the third public network IP address; and assign a third idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the third public network IP address, where the third idle port set includes at least one port.</li></ul></p><p id="p0067" num="0067">When an idle port exists in the second port set that is corresponding to the first public network IP address, the third public network IP address may also be the first public network IP address. When an idle port exists in the second port set that is corresponding to the second public network IP address, the third public network IP address may also be the second public network IP address.</p><p id="p0068" num="0068">Benefits of such implementation are as follows: When another private network user equipment needs to apply for a public network IP address and at this time, if no idle port exists in first port sets that are corresponding to all public network IP addresses in the public<!-- EPO <DP n="20"> --> network address pool, the third assigning unit 706 assigns one public network IP address to the another private network user equipment, where an idle port exists in a second port set of the assigned public network IP address; and assigns a public network port to the another private network user equipment from the second port set of the assigned public network IP address, and in this way, it can be ensured that a private network user equipment is assigned a public network IP address and a port and that communication is established in time between the private network user equipment and a network equipment that is on a public network.</p><p id="p0069" num="0069">Optionally, as shown in <figref idrefs="f0006">FIG. 7</figref>, the apparatus 70 further includes:
<ul><li>a first reclaiming unit 707, configured to receive an offline notification message sent by the private network user equipment and reclaim the first idle port set and the second idle port set.</li></ul></p><p id="p0070" num="0070">Specifically, when the private network user equipment does not need public network address and public network port resources any more, the private network user equipment sends an offline notification message that carries a private network IP address. After the first reclaiming unit 707 receives the offline notification, a public network IP address and a public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0071" num="0071">Optionally, the apparatus 70 further includes:
<ul><li>a second reclaiming unit 708, configured to reclaim the first idle port set and the second idle port set if no packet sent by the private network user equipment is received within a preset time threshold.</li></ul></p><p id="p0072" num="0072">Exemplarily, if the second reclaiming unit 708 does not receive, within a preset time threshold, a packet that carries the private network IP address 10.0.0.1, the public network IP address and the public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle<!-- EPO <DP n="21"> --> port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0073" num="0073">Optionally, the apparatus 70 further includes:
<ul><li>a third reclaiming unit 709, configured to reclaim the first idle port set and the second idle port set if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold.</li></ul></p><p id="p0074" num="0074">Exemplarily, if the third reclaiming unit 709 does not receive, within a preset time threshold, a packet sent to the private network IP address 10.0.0.1, the public network IP address and the public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved. The reclaiming of the first idle port set and the second idle port set indicates that an occupancy flag of a port in the first idle port set and that in the second idle port set are cleared, so that the ports can be reassigned to another private network user equipment. When the third idle port set is assigned to the private network user equipment, the third idle port set further needs to be reclaimed.</p><p id="p0075" num="0075">Optionally, the apparatus 70 further includes:
<ul><li>a fourth reclaiming unit 710, configured to reclaim the second idle port set when no port in the second idle port set is occupied.</li></ul></p><p id="p0076" num="0076">The reclaiming of a port in the second idle port set may be performed without waiting for an offline notification sent by the private network user. The fourth reclaiming unit 710 can reclaim the port in the second idle port set as long as it is determined that no port in the second idle port set is occupied. In this way, the reclaiming of an idle port in the second idle port set can be accelerated, thereby further improving a utilization ratio of a port in the second port set that is corresponding to the first public network IP address, and increasing a probability that when a new connection is added between the private network user equipment and the network equipment that is on the public network, the private network user equipment applies for a port from the second port set that is corresponding to the first public network IP address.</p><p id="p0077" num="0077">Optionally, the foregoing units provided in this embodiment of the present invention may be integrated into one or multiple units. During implementation, the first receiving unit 701 and the second receiving unit 704 may be implemented by one or multiple physical interfaces, the first assigning unit 702, the second assigning unit 703, and the third assigning<!-- EPO <DP n="22"> --> unit 706 may be a processor, the first starting and triggering unit 705 may be a timer, and the first reclaiming unit 707, the second reclaiming unit 708, the third reclaiming unit 709, and the fourth reclaiming unit 710 may also be a processor. The one or multiple physical interfaces and processors enable the apparatus to implement operations executed in this embodiment.</p><p id="p0078" num="0078">It can be seen that, with the apparatus for assigning a public network address provided in this embodiment of the present invention, ports that are corresponding to a public network IP address are classified into a first port set and a second port set. After a public network IP address is assigned to a private network equipment that applies for a public network IP address for the first time, a port is assigned to the private network equipment from a first port set of the assigned public network IP address. When a newly added connection is established between the private network equipment and a public network equipment, a port from a second port set of the assigned public network IP address is assigned to the private network equipment. In this way, the second port set of the assigned public network IP address is reserved and is used for port assignment that is performed when a new connection is added between the private network equipment and the public network equipment, so that a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><p id="p0079" num="0079">An embodiment of the present invention provides an apparatus 90 for assigning a public network address, and as shown in <figref idrefs="f0007">FIG. 9</figref>, the apparatus includes:
<ul><li>a third receiving unit 901, configured to receive a first request packet sent by a private network user equipment, where the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</li><li>a fourth assigning unit 902, configured to assign a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment; assign a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, where the first idle port set includes at least one port; and save the port in the first idle port set to a first port set that is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value; and</li><li>a fifth assigning unit 903, configured to assign a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set<!-- EPO <DP n="23"> --> to the first port set are occupied and an idle port exists among all ports that are corresponding to the first public network IP address, where the second idle port set includes at least one port; and save the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value, and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</li></ul></p><p id="p0080" num="0080">Exemplarily, 10.0.0.1:4567 is used as a private network IP address and a private network port number and 128.0.0.1 is used as a first public network IP address in this embodiment of the present invention to clearly describe the method for assigning a public network address provided in this embodiment of the present invention. Exemplarily, when the fourth assigning unit 902 determines, according to the private network IP address 10.0.0.1, that no public network IP address is assigned to the private network user equipment, a first public network IP address 128.0.0.1 is assigned to the private network user equipment from a public network address pool, and a first idle port set is assigned to the private network user equipment from an idle port that is corresponding to the first public network IP address 128.0.0.1. For example, a port in the first idle port set ranges from 3812 to 4812. The port in the first idle port set is saved to a first port set, where the number of ports in the first port set is not greater than a first threshold value. That is, if a public network IP address needs to be assigned to the private network IP address 10.0.0.1, before a public network IP address is assigned to the private network user equipment, it needs to be determined that the number of ports in the first port set that is corresponding to the public network IP address is not greater than the first threshold value, where a port saved in the first port set is a port that is assigned to the private network user equipment that has not been assigned any public network IP address.</p><p id="p0081" num="0081">Specifically, a method for the fourth assigning unit 902 to determine that no public network IP address is assigned to the private network user equipment may be: searching a database that stores a private network user list, where an IP address and a public network port of a private network user that has been assigned a public network IP address are stored in information of the private network user list, and when a private network user list that stores a private network IP address of the private network user equipment is not found by searching the database, determining that no public network IP address is assigned to the private network user equipment.</p><p id="p0082" num="0082">The first threshold value is used to limit the maximum number of ports in the first port set that is corresponding to the first public network IP address and the second threshold value<!-- EPO <DP n="24"> --> is used to limit the maximum number of ports in the second port set that is corresponding to the first public network IP address. Exemplarily, when the fifth assigning unit 903 determines that all ports that range from 3812 to 4812 in the first idle port set and are saved to the first port set are occupied and an idle port exists among ports that are corresponding to the first public network IP address, a second idle port set, such as one with ports ranging from 50678 to 60678, is assigned to the private network user equipment, where the second idle port set includes at least one port. The port in the second idle port set is saved to the second port set that is corresponding to the first public network IP address and the number of ports in the second port set is not greater than the second threshold value. That is, if a port that is corresponding to the first network IP address needs to be reassigned to the private network user equipment, it needs to be determined that the number of ports in the second port set that is corresponding to the first public network IP address is not greater than the second threshold value, and then the second idle port is assigned to the private network user equipment from an idle port that is corresponding to the first public network IP address, where the sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</p><p id="p0083" num="0083">Further, to determine that all ports saved from the first idle port set to the first port set are occupied, as shown in <figref idrefs="f0007">FIG. 9</figref>, the apparatus 90 further includes:
<ul><li>a fourth receiving unit 904, configured to receive a second request packet sent by the private network user equipment and trigger detection on occupancy conditions of all ports saved from the first idle port set to the first port set, where the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or</li><li>a second starting and triggering unit 905, configured to start a detection timer, and when the detection timer expires, trigger detection on occupancy conditions of all ports saved from the first idle port set to the first port set.</li></ul></p><p id="p0084" num="0084">Further, as shown in <figref idrefs="f0007">FIG. 10</figref>, the apparatus 90 further includes:
<ul><li>a sixth assigning unit 906, configured to assign a third public network IP address to the private network when it is determined that no public network IP address is assigned to the private network user equipment, a second public network IP address does not exist in the public network address pool, and the number of ports in a first port set that is corresponding to the second public network IP address is smaller than a third threshold value; assign a third idle port set to the private network user equipment from an idle port that is corresponding to the third public network IP address, where the third idle port set includes at least one port; and<!-- EPO <DP n="25"> --> save the port in the third idle port set to a second port set, where the second port set is corresponding to the third public network IP address and the number of ports in the second port set is not greater than a fourth threshold value.</li></ul></p><p id="p0085" num="0085">Benefits of such implementation are as follows: When another private network user equipment needs to apply for a public network IP address and at this time, if the number of ports in a first port set that is corresponding to each public network IP address in the public network address pool reaches a threshold value, the sixth assigning unit 906 assigns one public network IP address to the another private network user equipment, where an idle port of the assigned public network IP address exists and the number of ports in a second port set of the assigned public network IP address does not reach the threshold value; and assigns a public network port to the another private network user equipment from the idle port of the assigned public network IP address, and in this way, it can be ensured that a private network user equipment is assigned a public network IP address and a port in time and that communication is established in time between the private network user equipment and a network equipment that is on a public network.</p><p id="p0086" num="0086">Optionally, as shown in <figref idrefs="f0007">FIG. 10</figref>, the apparatus 90 further includes:
<ul><li>a fifth reclaiming unit 907, configured to receive an offline notification message sent by the private network user equipment and reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0087" num="0087">Specifically, when the private network user equipment does not need public network address and public network port resources any more, the private network user equipment sends an offline notification message that carries a private network IP address. After the fifth reclaiming unit 907 receives the offline notification, a public network IP address and a public network port that are assigned to the private network user equipment are released, so that the public network IP address resource can be reassigned to another private network user equipment. In this way, the public network IP address is fully used, and a resource is saved.</p><p id="p0088" num="0088">Optionally, as shown in <figref idrefs="f0007">FIG. 10</figref>, the apparatus 90 further includes:
<ul><li>a sixth reclaiming unit 908, configured to, if no packet sent by the private network user equipment is received within a preset time threshold, reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim a port t saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul><!-- EPO <DP n="26"> --></p><p id="p0089" num="0089">Exemplarily, if the sixth reclaiming unit 908 does not receive, within the preset time threshold, a packet that carries the private network IP address 10.0.0.1, the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address are reclaimed. When the third idle port set is assigned to the private network user equipment, a port saved from the third idle port set to the second port set that is corresponding to the third public network IP address further needs to be reclaimed. In this way, a public network IP address and a port that is corresponding to the public network IP address are fully used, and a resource utilization ratio is improved.</p><p id="p0090" num="0090">Optionally, as shown in <figref idrefs="f0007">FIG. 10</figref>, the apparatus 90 further includes:
<ul><li>a seventh reclaiming unit 909, configured to, if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold, reclaim the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0091" num="0091">Exemplarily, if the seventh reclaiming unit 909 does not receive, within a preset time threshold, a packet sent by a public network equipment to the private network user equipment, that is, no packet that carries the private network address 10.0.0.1 is sent, the port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address are reclaimed. When the third idle port set is assigned to the private network user equipment, the port saved from the third idle port set to the second port set that is corresponding to the third public network IP address further needs to be reclaimed. In this way, a public network IP address and a port that is corresponding to the public network IP address are fully used, and a resource utilization ratio is improved.</p><p id="p0092" num="0092">Optionally, as shown in <figref idrefs="f0007">FIG. 10</figref>, the apparatus 90 further includes:
<ul><li>an eighth reclaiming unit 910, configured to, when the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied, reclaim the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</li></ul></p><p id="p0093" num="0093">The reclaiming of the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address may be performed without waiting for<!-- EPO <DP n="27"> --> an offline notification sent by the private network user. The port saved from the second idle port set to the second port set that is corresponding to the first public network IP address can be reclaimed as long as the eighth reclaiming unit 910 determines that the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied. In this way, the reclaiming of the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address can be accelerated, thereby further improving a utilization ratio of a port of the first public network IP address, and increasing a probability that when a new connection is added between the private network user equipment and the network equipment that is on the public network, the private network user equipment applies for a port from a port set that is corresponding to the first public network IP address.</p><p id="p0094" num="0094">Optionally, the foregoing units provided in this embodiment of the present invention may be integrated into one or multiple units. During implementation, the third receiving unit 901 and the fourth receiving unit 904 may be implemented by one or multiple physical interfaces, the fourth assigning unit 902, the fifth assigning unit 903, and the sixth assigning unit 906 may be a processor, the second starting and triggering unit 905 may be a timer, and the fifth reclaiming unit 907, the sixth reclaiming unit 908, the seventh reclaiming unit 909, and the eighth reclaiming unit 910 may also be a processor. The one or multiple physical interfaces and processors enable the apparatus to implement operations executed in this embodiment.</p><p id="p0095" num="0095">It can be seen that, with the apparatus for assigning a public network address provided in this embodiment of the present invention, the number of ports, which are among ports of a public network IP address and assigned to a private network equipment that applies for a public network IP address for the first time, is limited within a first threshold value. Furthermore, ports whose number is equivalent to a second threshold value are reserved among the ports of the public network IP address and are used for port assignment that is performed when a new connection is added between the private network equipment and a public network equipment, so that when a newly added connection is established between the private network equipment and the public network equipment, a probability that the private network user fails to be assigned a public network port when adding a new connection to the public network equipment is lowered.</p><p id="p0096" num="0096">In all embodiments of the present invention, the apparatus for assigning a public network address may be implemented by using a router that supports a NAT function, a switch that supports a NAT function, or a carrier grade address translation (its full name is Carrier Grade<!-- EPO <DP n="28"> --> NAT in English, and its abbreviation is CGN in English) equipment, or may be implemented by using another network equipment that supports a NAT function.</p><p id="p0097" num="0097">Persons of ordinary skills in the art may understand that all or part of steps in the foregoing method embodiments of the present invention may be implemented by a program instructing relevant hardware. The program may be stored in a computer readable storage medium. When the program is run, the steps in the foregoing method embodiments are performed. The storage medium includes various mediums capable of storing program codes, such as a ROM, a RAM, a magnetic disk, or an optical disk.</p><p id="p0098" num="0098">Finally, it should be noted that the foregoing embodiments are merely intended for describing the technical solutions of the present invention rather than limiting the present invention. Although the present invention is described in detail with reference to the foregoing embodiments, persons of ordinary skill in the art should understood that they may still make modifications to the technical solutions described in the foregoing embodiments, or make equivalent replacements to some technical features of the technical solutions, as long as these modifications and equivalent replacements do not cause the essence of corresponding technical solutions to depart from the scope of the technical solutions in the embodiments of the present invention.</p></description><claims mxw-id="PCLM56982301" lang="EN" load-source="patent-office"><!-- EPO <DP n="29"> --><claim id="c-en-0001" num="0001"><claim-text>A method for assigning a public network address, comprising:
<claim-text>receiving a first request packet sent by a private network user equipment, wherein the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</claim-text>
<claim-text>assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network Internet Protocol IP address is assigned to the private network user equipment, wherein ports are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set comprises at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assigning a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, wherein the first idle port set comprises at least one port; and</claim-text>
<claim-text>when it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assigning a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, wherein the second idle port set comprises at least one port.</claim-text></claim-text></claim><claim id="c-en-0002" num="0002"><claim-text>The method according to claim 1, before it is determined that all ports in the first idle port set are occupied, further comprising:
<claim-text>receiving a second request packet sent by the private network user equipment and triggering detection on occupancy conditions of all ports in the first idle port set, wherein the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or</claim-text>
<claim-text>starting a detection timer, and when the detection timer expires, triggering detection on occupancy conditions of all ports in the first idle port set.</claim-text></claim-text></claim><claim id="c-en-0003" num="0003"><claim-text>The method according to claim 1 or claim 2, further comprising:
<claim-text>assigning a third public network IP address to the private network user equipment when it is determined that no public network IP address is assigned to the private network user equipment, and a second public network IP address does not exist in the public network address pool, ports that is corresponding to the second public network IP address are classified into a first port set and a second port set, and an idle port exists in the first port set<!-- EPO <DP n="30"> --> that is corresponding to the second public network IP address, wherein ports that are corresponding to the third public network IP address are classified into a first port set and a second port set, and an idle port exists in the second port set that is corresponding to the third public network IP address; and assigning a third idle port set to the private network user equipment from an idle port in the second port set that is corresponding to the third public network IP address, wherein the third idle port set comprises at least one port.</claim-text></claim-text></claim><claim id="c-en-0004" num="0004"><claim-text>The method according to any one of claims 1 to 3, further comprising:
<claim-text>receiving an offline notification message sent by the private network user equipment, and reclaiming the first idle port set and the second idle port set; or</claim-text>
<claim-text>reclaiming the first idle port set and the second idle port set if no packet sent by the private network user equipment is received within a preset time threshold; or</claim-text>
<claim-text>reclaiming the first idle port set and the second idle port set if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold.</claim-text></claim-text></claim><claim id="c-en-0005" num="0005"><claim-text>The method according to any one of claims 1 to 4, further comprising:
<claim-text>reclaiming the second idle port set when no port in the second idle port set is occupied.</claim-text></claim-text></claim><claim id="c-en-0006" num="0006"><claim-text>A method for assigning a public network address, comprising:
<claim-text>receiving a first request packet sent by a private network user equipment, wherein the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</claim-text>
<claim-text>assigning a first public network IP address to the private network user equipment from a public network address pool when it is determined that no public network Internet Protocol IP address is assigned to the private network user equipment; assigning a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, wherein the first idle port set comprises at least one port; and saving all ports in the first idle port set to a first port set that is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value; and</claim-text>
<claim-text>assigning a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set to the first port set are occupied and an idle port exists among ports that are corresponding to the first public network IP address, wherein the second idle port set comprises at least one port; and saving the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value,<!-- EPO <DP n="31"> --> and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</claim-text></claim-text></claim><claim id="c-en-0007" num="0007"><claim-text>The method according to claim 6, before it is determined that all ports saved from the first idle port set to the first port set are occupied, further comprising:
<claim-text>receiving a second request packet sent by the private network user equipment and triggering detection on occupancy conditions of all ports saved from the first idle port set to the first port set, wherein the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or</claim-text>
<claim-text>starting a detection timer, and when the detection timer expires, triggering detection on occupancy conditions of all ports saved from the first idle port set to the first port set.</claim-text></claim-text></claim><claim id="c-en-0008" num="0008"><claim-text>The method according to claim 6 or claim 7, further comprising:
<claim-text>assigning a third public network IP address to the private network when it is determined that no public network IP address is assigned to the private network user equipment, a second public network IP address does not exist in the public network address pool, and the number of ports in a first port set that is corresponding to the second public network IP address is smaller than a third threshold value; assigning a third idle port set to the private network user equipment from an idle port that is corresponding to the third public network IP address, wherein the third idle port set comprises at least one port; and saving the port in the third idle port set to a second port set that is corresponding to the third public network IP address and the number of ports in the second port set is not greater than a fourth threshold value.</claim-text></claim-text></claim><claim id="c-en-0009" num="0009"><claim-text>The method according to any one of claims 6 to 8, further comprising:
<claim-text>receiving an offline notification message sent by the private network user equipment and reclaiming a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaiming a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address; or</claim-text>
<claim-text>if no packet sent by the private network user equipment is received within a preset time threshold, reclaiming a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address, and reclaiming a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address; or</claim-text>
<claim-text>if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold, reclaiming a port saved from the first idle port set to<!-- EPO <DP n="32"> --> the first port set that is corresponding to the first public network IP address, and reclaiming a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</claim-text></claim-text></claim><claim id="c-en-0010" num="0010"><claim-text>The method according to any one of claims 6 to 9, further comprising:
<claim-text>when a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied, reclaiming the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</claim-text></claim-text></claim><claim id="c-en-0011" num="0011"><claim-text>An apparatus for assigning a public network address, comprising:
<claim-text>a first receiving unit, configured to receive a first request packet sent by a private network user equipment, wherein the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</claim-text>
<claim-text>a first assigning unit, configured to assign a first public network Internet Protocol IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user equipment, wherein ports that are corresponding to the first public network IP address are classified into a first port set and a second port set, the second port set comprises at least one port, and an idle port exists in the first port set that is corresponding to the first public network IP address; and assign a first idle port set to the private network user equipment from the idle port in the first port set that is corresponding to the first public network IP address, wherein the first idle port set comprises at least one port; and</claim-text>
<claim-text>a second assigning unit, configured to, when it is determined that all ports in the first idle port set are occupied and an idle port exists in the second port set that is corresponding to the first public network IP address, assign a second idle port set to the private network user equipment from the idle port in the second port set that is corresponding to the first public network IP address, wherein the second idle port set comprises at least one port.</claim-text></claim-text></claim><claim id="c-en-0012" num="0012"><claim-text>The apparatus according to claim 11, further comprising:
<claim-text>a second receiving unit, configured to receive a second request packet sent by the private network user equipment and trigger detection on occupancy conditions of all ports in the first idle port set, wherein the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or</claim-text>
<claim-text>a first starting and triggering unit, configured to start a detection timer, and when the detection timer expires, trigger detection on occupancy conditions of all ports in the first idle<!-- EPO <DP n="33"> --> port set.</claim-text></claim-text></claim><claim id="c-en-0013" num="0013"><claim-text>The apparatus according to claim 11 or claim 12, further comprising:
<claim-text>a third assigning unit, configured to assign a third public network IP address to the private network user equipment when it is determined that no public network IP address is assigned to the private network user equipment, and a second public network IP address does not exist in the public network address pool, ports that are corresponding to the second public network IP address are classified into a first port set and a second port set, and an idle port exists in the first port set that is corresponding to the second public network IP address, wherein ports that are corresponding to the third public network IP address are classified into a first port set and a second port set, and an idle port exists in the second port set that is corresponding to the third public network IP address; and assign a third idle port set to the private network user equipment from an idle port in the second port set that is corresponding to the third public network IP address, wherein the third idle port set comprises at least one port.</claim-text></claim-text></claim><claim id="c-en-0014" num="0014"><claim-text>The apparatus according to any one of claims 11 to 13, further comprising:
<claim-text>a first reclaiming unit, configured to receive an offline notification message sent by the private network user equipment, and reclaim the first idle port set and the second idle port set;</claim-text>
<claim-text>a second reclaiming, configured to reclaim the first idle port set and the second idle port set if no packet sent by the private network user equipment is received within a preset time threshold; or</claim-text>
<claim-text>a third reclaiming unit, configured to reclaim the first idle port set and the second idle port set if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold.</claim-text></claim-text></claim><claim id="c-en-0015" num="0015"><claim-text>The apparatus according to any one of claims 11 to 14, further comprising:
<claim-text>a fourth reclaiming unit, configured to reclaim the second idle port set when no port in the second idle port set is occupied.</claim-text></claim-text></claim><claim id="c-en-0016" num="0016"><claim-text>An apparatus for assigning a public network address, comprising:
<claim-text>a third receiving unit, configured to receive a first request packet sent by a private network user equipment, wherein the first request packet is used to establish a connection between the private network user equipment and a network equipment that is on a public network;</claim-text>
<claim-text>a fourth assigning unit, configured to assign a first public network Internet Protocol IP address to the private network user equipment from a public network address pool when it is determined that no public network IP address is assigned to the private network user<!-- EPO <DP n="34"> --> equipment; assign a first idle port set to the private network user equipment from an idle port that is corresponding to the first public network IP address, wherein the first idle port set comprises at least one port; and save the port in the first idle port set to a first port set that is corresponding to the first public network IP address and the number of ports in the first port set is not greater than a first threshold value; and</claim-text>
<claim-text>a fifth assigning unit, configured to assign a second idle port set to the private network user equipment when it is determined that all ports saved from the first idle port set to the first port set are occupied and an idle port exists among ports that are corresponding to the first public network IP address, wherein the second idle port set comprises at least one port; and save the port in the second idle port set to a second port set that is corresponding to the first public network IP address, the number of ports in the second port set is not greater than a second threshold value, and a sum of the first threshold value and the second threshold value is not greater than the number of all ports that are corresponding to the first public network IP address.</claim-text></claim-text></claim><claim id="c-en-0017" num="0017"><claim-text>The apparatus according to claim 16, wherein the apparatus for assigning a public network address, further comprising:
<claim-text>a fourth receiving unit, configured to receive a second request packet sent by the private network user equipment and trigger detection on occupancy conditions of all ports saved from the first idle port set to the first port set, wherein the second request packet is used to establish a connection between the private network user equipment and the network equipment that is on the public network; or</claim-text>
<claim-text>a second starting and triggering unit, configured to start a detection timer, and when the detection timer expires, trigger detection on occupancy conditions of all ports saved from the first idle port set to the first port set.</claim-text></claim-text></claim><claim id="c-en-0018" num="0018"><claim-text>The apparatus according to claim 16 or claim 17, further comprising:
<claim-text>a sixth assigning unit, configured to assign a third public network IP address to the private network when it is determined that no public network IP address is assigned to the private network user equipment, a second public network IP address does not exist in the public network address pool, and the number of ports in a first port set that is corresponding to the second public network IP address is smaller than a third threshold value; assign a third idle port set to the private network user equipment from an idle port that is corresponding to the third public network IP address, wherein the third idle port set comprises at least one port; and save the port in the third idle port set to a second port set that is corresponding to the third public network IP address and the number of ports in the second port set is not greater than a<!-- EPO <DP n="35"> --> fourth threshold value.</claim-text></claim-text></claim><claim id="c-en-0019" num="0019"><claim-text>The apparatus according to any one of claims 16 to 18, further comprising:
<claim-text>a fifth reclaiming unit, configured to receive an offline notification message sent by the private network user equipment and reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address; or</claim-text>
<claim-text>a sixth reclaiming unit, configured to, if no packet sent by the private network user equipment is received within a preset time threshold, reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address, and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address; or</claim-text>
<claim-text>a seventh reclaiming unit, configured to, if no packet sent by a public network equipment to the private network user equipment is received within a preset time threshold, reclaim a port saved from the first idle port set to the first port set that is corresponding to the first public network IP address, and reclaim a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</claim-text></claim-text></claim><claim id="c-en-0020" num="0020"><claim-text>The apparatus according to any one of claims 16 to 19, further comprising:
<claim-text>an eighth reclaiming unit, configured to, when a port saved from the second idle port set to the second port set that is corresponding to the first public network IP address is not occupied, reclaim the port saved from the second idle port set to the second port set that is corresponding to the first public network IP address.</claim-text></claim-text></claim></claims><drawings mxw-id="PDW16670685" load-source="patent-office"><!-- EPO <DP n="36"> --><figure id="f0001" num="1,2"><img id="if0001" file="imgf0001.tif" wi="165" he="161" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="37"> --><figure id="f0002" num="3"><img id="if0002" file="imgf0002.tif" wi="160" he="174" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="38"> --><figure id="f0003" num="4"><img id="if0003" file="imgf0003.tif" wi="160" he="222" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="39"> --><figure id="f0004" num="5"><img id="if0004" file="imgf0004.tif" wi="165" he="187" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="40"> --><figure id="f0005" num="6"><img id="if0005" file="imgf0005.tif" wi="145" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="41"> --><figure id="f0006" num="7,8"><img id="if0006" file="imgf0006.tif" wi="75" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="42"> --><figure id="f0007" num="9,10"><img id="if0007" file="imgf0007.tif" wi="73" he="233" img-content="drawing" img-format="tif"/></figure></drawings><search-report-data><doc-page id="srep0001" file="srep0001.tif" wi="165" he="233" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="165" he="233" type="tif"/></search-report-data><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
