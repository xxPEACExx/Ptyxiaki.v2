<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2681734-A1" country="EP" doc-number="2681734" kind="A1" date="20140108" family-id="46798434" file-reference-id="318295" date-produced="20180822" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="146586072" ucid="EP-2681734-A1"><document-id><country>EP</country><doc-number>2681734</doc-number><kind>A1</kind><date>20140108</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-11860420-A" is-representative="NO"><document-id mxw-id="PAPP154848264" load-source="docdb" format="epo"><country>EP</country><doc-number>11860420</doc-number><kind>A</kind><date>20110704</date><lang>EN</lang></document-id><document-id mxw-id="PAPP176177417" load-source="docdb" format="original"><country>EP</country><doc-number>11860420.6</doc-number><date>20110704</date><lang>EN</lang></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC140547932" ucid="SE-2011050899-W" linkage-type="W" load-source="docdb"><document-id format="epo"><country>SE</country><doc-number>2011050899</doc-number><kind>W</kind><date>20110704</date></document-id></priority-claim><priority-claim mxw-id="PPC140548200" ucid="US-201161449230-P" load-source="docdb"><document-id format="epo"><country>US</country><doc-number>201161449230</doc-number><kind>P</kind><date>20110304</date></document-id></priority-claim></priority-claims><technical-data><classification-ipc><edition>7</edition><main-classification>G10L  19/14</main-classification></classification-ipc><classifications-ipcr><classification-ipcr mxw-id="PCL-1857156899" load-source="docdb">G10L  21/0232      20130101ALI20170110BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1857156900" load-source="docdb">G10L  19/083       20130101ALI20170110BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1857156901" load-source="docdb">G10L  19/032       20130101AFI20170110BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-1624975400" load-source="docdb" scheme="CPC">G10L  19/0212      20130101 LI20180620BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1624975401" load-source="docdb" scheme="CPC">G10L  19/0204      20130101 LI20180620BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1624975402" load-source="docdb" scheme="CPC">G10L  19/02        20130101 LI20180620BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1727837234" load-source="docdb" scheme="CPC">G10L  19/038       20130101 FI20171125BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1730496057" load-source="docdb" scheme="CPC">G10L  19/083       20130101 LI20171116BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1730496059" load-source="docdb" scheme="CPC">G10L  19/032       20130101 LI20131212BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1730496060" load-source="docdb" scheme="CPC">G10L  21/0232      20130101 LI20171116BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT132362849" lang="DE" load-source="patent-office">VERSTÄRKUNGSKORREKTUR NACH QUANTISIERUNG BEI DER AUDIOCODIERUNG</invention-title><invention-title mxw-id="PT132362850" lang="EN" load-source="patent-office">POST-QUANTIZATION GAIN CORRECTION IN AUDIO CODING</invention-title><invention-title mxw-id="PT132362851" lang="FR" load-source="patent-office">CORRECTION DE GAIN POST-QUANTIFICATION DANS LE CODAGE AUDIO</invention-title></technical-data><parties><applicants><applicant mxw-id="PPAR919525234" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>ERICSSON TELEFON AB L M</last-name><address><country>SE</country></address></addressbook></applicant><applicant mxw-id="PPAR919540226" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>TELEFONAKTIEBOLAGET L M ERICSSON (PUBL)</last-name></addressbook></applicant><applicant mxw-id="PPAR919014966" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Telefonaktiebolaget L M Ericsson (PUBL)</last-name><iid>101131063</iid><address><city>164 83 Stockholm</city><country>SE</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR919508784" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>NORVELL ERIK</last-name><address><country>SE</country></address></addressbook></inventor><inventor mxw-id="PPAR919541905" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>NORVELL, ERIK</last-name></addressbook></inventor><inventor mxw-id="PPAR919019463" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>NORVELL, ERIK</last-name><address><street>Brantingsgatan 15</street><city>S-115 35 Stockholm</city><country>SE</country></address></addressbook></inventor><inventor mxw-id="PPAR919520912" load-source="docdb" sequence="2" format="epo"><addressbook><last-name>GRANCHAROV VOLODYA</last-name><address><country>SE</country></address></addressbook></inventor><inventor mxw-id="PPAR919531442" load-source="docdb" sequence="2" format="intermediate"><addressbook><last-name>GRANCHAROV, VOLODYA</last-name></addressbook></inventor><inventor mxw-id="PPAR919006923" load-source="patent-office" sequence="2" format="original"><addressbook><last-name>GRANCHAROV, VOLODYA</last-name><address><street>Ankdammsgatan 29</street><city>S-171 67 Solna</city><country>SE</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR919017095" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Egrelius, Fredrik</last-name><suffix>et al</suffix><iid>101307911</iid><address><street>Ericsson AB Patent Unit Kista Device, Service &amp; Media Torshamnsgatan 21-23</street><city>164 80 Stockholm</city><country>SE</country></address></addressbook></agent></agents></parties><international-convention-data><pct-or-regional-filing-data ucid="SE-2011050899-W"><document-id><country>SE</country><doc-number>2011050899</doc-number><kind>W</kind><date>20110704</date><lang>EN</lang></document-id></pct-or-regional-filing-data><pct-or-regional-publishing-data ucid="WO-2012121637-A1"><document-id><country>WO</country><doc-number>2012121637</doc-number><kind>A1</kind><date>20120913</date><lang>EN</lang></document-id></pct-or-regional-publishing-data><designated-states><ep-contracting-states><country mxw-id="DS549755897" load-source="docdb">AL</country><country mxw-id="DS549832590" load-source="docdb">AT</country><country mxw-id="DS549755898" load-source="docdb">BE</country><country mxw-id="DS549763546" load-source="docdb">BG</country><country mxw-id="DS549844233" load-source="docdb">CH</country><country mxw-id="DS549756654" load-source="docdb">CY</country><country mxw-id="DS549756655" load-source="docdb">CZ</country><country mxw-id="DS549913149" load-source="docdb">DE</country><country mxw-id="DS549755899" load-source="docdb">DK</country><country mxw-id="DS549755900" load-source="docdb">EE</country><country mxw-id="DS549833726" load-source="docdb">ES</country><country mxw-id="DS549763547" load-source="docdb">FI</country><country mxw-id="DS549763548" load-source="docdb">FR</country><country mxw-id="DS549913150" load-source="docdb">GB</country><country mxw-id="DS549755909" load-source="docdb">GR</country><country mxw-id="DS549913151" load-source="docdb">HR</country><country mxw-id="DS549756656" load-source="docdb">HU</country><country mxw-id="DS549844238" load-source="docdb">IE</country><country mxw-id="DS549755910" load-source="docdb">IS</country><country mxw-id="DS549763573" load-source="docdb">IT</country><country mxw-id="DS549755911" load-source="docdb">LI</country><country mxw-id="DS549913152" load-source="docdb">LT</country><country mxw-id="DS549832591" load-source="docdb">LU</country><country mxw-id="DS549763574" load-source="docdb">LV</country><country mxw-id="DS549913153" load-source="docdb">MC</country><country mxw-id="DS549832592" load-source="docdb">MK</country><country mxw-id="DS549832593" load-source="docdb">MT</country><country mxw-id="DS549833727" load-source="docdb">NL</country><country mxw-id="DS549830907" load-source="docdb">NO</country><country mxw-id="DS549833728" load-source="docdb">PL</country><country mxw-id="DS549832598" load-source="docdb">PT</country><country mxw-id="DS549844239" load-source="docdb">RO</country><country mxw-id="DS549832599" load-source="docdb">RS</country><country mxw-id="DS549833729" load-source="docdb">SE</country><country mxw-id="DS549756665" load-source="docdb">SI</country><country mxw-id="DS549830908" load-source="docdb">SK</country><country mxw-id="DS549830909" load-source="docdb">SM</country><country mxw-id="DS549763575" load-source="docdb">TR</country></ep-contracting-states></designated-states></international-convention-data><office-specific-data><eptags><ep-no-a-document-published>*</ep-no-a-document-published></eptags></office-specific-data></bibliographic-data><abstract mxw-id="PA100066798" ref-ucid="WO-2012121637-A1" lang="EN" load-source="patent-office"><p num="0000">A gain adjustment apparatus (60) for use in decoding of audio that has been encoded with separate gain and shape representations includes an accuracy meter (62) configured to estimate an accuracy measure (A(b)) of the shape representation (Ñ(b)), and to determine a gain correction (g<sub>c</sub>(b)) based on the estimated accuracy measure (A(b)). It also includes an envelope adjuster (64) configured to adjust the gain representation (Ê(b)) based on the determined gain correction.</p></abstract><abstract mxw-id="PA100335902" ref-ucid="WO-2012121637-A1" lang="EN" source="national office" load-source="docdb"><p>A gain adjustment apparatus (60) for use in decoding of audio that has been encoded with separate gain and shape representations includes an accuracy meter (62) configured to estimate an accuracy measure (A(b)) of the shape representation (Ñ(b)), and to determine a gain correction (gc(b)) based on the estimated accuracy measure (A(b)). It also includes an envelope adjuster (64) configured to adjust the gain representation (Ê(b)) based on the determined gain correction.</p></abstract><abstract mxw-id="PA100066799" ref-ucid="WO-2012121637-A1" lang="FR" load-source="patent-office"><p num="0000">Un appareil de réglage de gain (60) permettant de décoder des données audio qui ont été codées avec des représentations de gain et de forme séparées comprend un compteur de précision (62) configuré pour estimer une mesure de précision (A(b)) de la représentation de forme (Ñ(b)), et pour déterminer une correction de gain (g<sub>c</sub>(b)) d'après la mesure de précision (A(b)) estimée. Il comprend également un dispositif de réglage d'enveloppe (64) configuré pour régler la représentation de gain (Ê(b)) d'après la correction de gain déterminée.</p></abstract><abstract mxw-id="PA100335903" ref-ucid="WO-2012121637-A1" lang="FR" source="national office" load-source="docdb"><p>Un appareil de réglage de gain (60) permettant de décoder des données audio qui ont été codées avec des représentations de gain et de forme séparées comprend un compteur de précision (62) configuré pour estimer une mesure de précision (A(b)) de la représentation de forme (Ñ(b)), et pour déterminer une correction de gain (gc(b)) d'après la mesure de précision (A(b)) estimée. Il comprend également un dispositif de réglage d'enveloppe (64) configuré pour régler la représentation de gain (Ê(b)) d'après la correction de gain déterminée.</p></abstract><description mxw-id="PDES51372928" ref-ucid="WO-2012121637-A1" lang="EN" load-source="patent-office"><!-- EPO <DP n="2"/>--><p id="p0001" num="0001"> POST-QUANTIZATION GAIN CORRECTION IN AUDIO CODING </p><p id="p0002" num="0002"> TECHNICAL FIELD </p><p id="p0003" num="0003">The present technology relates to gain correction in audio coding based on quantization schemes where the quantization is divided into a gain representation and a shape representation, so called gain-shape audio coding, and especially to post-quantization gain correction. </p><p id="p0004" num="0004">BACKGROUND </p><p id="p0005" num="0005">Modern telecommunication services are expected to handle many different types of audio signals. While the main audio content is speech signals, there is a desire to handle more general signals such as music and mixtures of music and speech. Although the capacity in telecommunication networks is continuously increasing, it is still of great interest to limit the required bandwidth per communication channel. In mobile networks smaller transmission bandwidths for each call yields lower power consumption in both the mobile device and the base station. This translates to energy and cost saving for the mobile operator, while the end user will experience prolonged battery life and increased talk- time. Further, with less consumed bandwidth per user the mobile network can service a larger number of users in parallel. </p><p id="p0006" num="0006">Today, the dominating compression technology for mobile voice services is CELP (Code Excited Linear Prediction), which achieves good audio quality for speech at low bandwidths. It is widely used in deployed codecs such as AMR (Adaptive MultiRate), AMR-WB (Adaptive MultiRate WideBand) and GSM- EFR (Global System for Mobile communications - Enhanced FullRate) . However, for general audio signals such as music the CELP technology has poor performance. These signals can often be better represented by using frequency transform based coding, for example the ITU-T codecs G.722.1 [1] and G.719 [2]. However, transform domain codecs generally operate at a 
<!-- EPO <DP n="3"/>-->
 higher bitrate than the speech codecs. There is a gap between the speech and general audio domains in terms of coding and it is desirable to increase the performance of transform domain codecs at lower bitrates. </p><p id="p0007" num="0007">Transform domain codecs require a compact representation of the frequency domain transform coefficients. These representations often rely on vector quantization (VQ), where the coefficients are encoded in groups. Among the various methods for vector quantization is the gain-shape VQ. This approach applies normalization to the vectors before encoding the individual coefficients. The normalization factor and the normalized coefficients are referred to as the gain and the shape of the vector, which may be encoded separately. The gain-shape structure has many benefits. By dividing the gain and the shape the codec can easily be adapted to varying source input levels by designing the gain quantizer. It is also beneficial from a perceptual perspective where the gain and shape may carry different importance in different frequency regions. Finally, the gain-shape division simplifies the quantizer design and makes it less complex in terms of memory and computational resources compared to an unconstrained vector quantizer. A functional overview of a gain- shape quantizer can be seen in Fig 1. </p><p id="p0008" num="0008">If applied to a frequency domain spectrum, the gain-shape structure can be used to form a spectral envelope and fine structure representation. The sequence of gain values forms the envelope of the spectrum while the shape vectors give the spectral detail. From a perceptual perspective it is beneficial to partition the spectrum using a non-uniform band structure which follows the frequency resolution of the human auditory system. This generally means that narrow bandwidths are used for low frequencies while larger bandwidths are used for high frequencies. The perceptual importance of the spectral fine structure varies with the frequency, but is also dependent on the characteristics of the signal itself. Transform coders often employ an auditory model to determine the important parts of the fine structure and assign the available resources to the most important parts. The spectral en- 
<!-- EPO <DP n="4"/>-->
 quantizes the shape vectors using the assigned bits. See Fig 2 for an example of a transform based coding system with an auditory model. </p><p id="p0009" num="0009">Depending on the accuracy of the shape quantizer, the gain value used to reconstruct the vector may be more or less appropriate. Especially when the allocated bits are few, the gain value drifts away from the optimal value. One way to solve this is to encode a correcting factor which accounts for the gain mismatch after the shape quantization. Another solution is to encode the shape first and then compute the optimal gain factor given the quantized shape. </p><p id="p0010" num="0010">The solution to encode a gain correction factor after shape quantization may consume considerable bitrate. If the rate is already low, this means more bits have to be taken elsewhere and may perhaps reduce the available bitrate for the fine structure. </p><p id="p0011" num="0011">To encode the shape before encoding the gain is a better solution, but if the bitrate for the shape quantizer is decided from the quantized gain value, then the gain and shape quantization would depend on each other. An iterative solution could likely solve this co-dependency but it could easily become too complex to be run in real-time on a mobile device. </p><p id="p0012" num="0012">SUMMARY </p><p id="p0013" num="0013">An object is to obtain a gain adjustment in decoding of audio that has been encoded with separate gain and shape representations. </p><p id="p0014" num="0014">This object is achieved in accordance with the attached claims. </p><p id="p0015" num="0015">A first aspect involves a gain adjustment method that includes the following steps: </p><p id="p0016" num="0016"> • An accuracy measure of the shape representation is estimated. 
<!-- EPO <DP n="5"/>-->
 • A gain correction is determined based on the estimated accuracy measure. </p><p id="p0017" num="0017"> • The gain representation is adjusted based on the determined gain correction. </p><p id="p0018" num="0018">A second aspect involves a gain adjustment apparatus that includes: </p><p id="p0019" num="0019"> • An accuracy meter configured to estimate an accuracy measure of the shape representation, and to determine a gain correction based on the estimated accuracy measure. </p><p id="p0020" num="0020"> • An envelope adjuster configured to adjust the gain representation based on the determined gain correction. </p><p id="p0021" num="0021">A third aspect involves a decoder including a gain adjustment apparatus in accordance with the second aspect. </p><p id="p0022" num="0022">A fourth aspect involves a network node including a decoder in accordance with the third aspect. </p><p id="p0023" num="0023">The proposed scheme for gain correction improves the perceived quality of a gain-shape audio coding system. The scheme has low computational complexity and does require few additional bits, if any. </p><p id="p0024" num="0024">BRIEF DESCRIPTION OF THE DRAWINGS </p><p id="p0025" num="0025">The present technology, together with further objects and advantages thereof, may best be understood by making reference to the following description taken together with the accompanying drawings, in which: </p><p id="p0026" num="0026"> Fig. 1 illustrates an example gain-shape vector quantization scheme;</p><p id="p0027" num="0027">Fig. 2 illustrates an example transform domain coding and decoding scheme; </p><p id="p0028" num="0028"> Fig. 3A-C illustrates gain-shape vector quantization in a simplified case; 
<!-- EPO <DP n="6"/>-->
 Fig. 4 illustrates an example transform domain decoder using an accuracy measure to determine an envelope correction; </p><p id="p0029" num="0029"> Fig. 5A-B illustrates an example result of scaling the synthesis with gain factors when the shape vector is a sparse pulse vector; </p><p id="p0030" num="0030"> Fig. 6A-B illustrates how the largest pulse height can indicate the accuracy of the shape vector; </p><p id="p0031" num="0031"> Fig. 7 illustrates an example of a rate based attenuation function for embodiment 1; </p><p id="p0032" num="0032"> Fig. 8 illustrates an example of a rate and maximum pulse height de- pendent gain adjustment function for embodiment 1 ; </p><p id="p0033" num="0033"> Fig. 9 illustrates another example of a rate and maximum pulse height dependent gain adjustment function for embodiment 1 ; </p><p id="p0034" num="0034"> Fig. 10 illustrates an embodiment of the present technology in the context of an MDCT based audio coder and decoder system; </p><p id="p0035" num="0035"> Fig. 11 illustrates an example of a mapping function from the stability measure to the gain adjustment limitation factor; </p><p id="p0036" num="0036"> Fig. 12 illustrates an example of an AD PCM encoder and decoder system with an adaptive step size; </p><p id="p0037" num="0037"> Fig. 13 illustrates an example in the context of a subband AD PCM based audio coder and decoder system; </p><p id="p0038" num="0038"> Fig. 14 illustrates an embodiment of the present technology in the context of a subband AD PCM based audio coder and decoder system; </p><p id="p0039" num="0039"> Fig. 15 illustrates an example transform domain encoder including a signal classifier; </p><p id="p0040" num="0040"> Fig. 16 illustrates another example transform domain decoder using an accuracy measure to determine an envelope correction; </p><p id="p0041" num="0041"> Fig. 17 illustrates an embodiment of a gain adjustment apparatus in accordance with the present technology; </p><p id="p0042" num="0042"> Fig. 18 illustrates an embodiment of gain adjustment in accordance with the present technology in more detail; </p><p id="p0043" num="0043"> Fig. 19 is a flow chart illustrating the method in accordance with the present technology; 
<!-- EPO <DP n="7"/>-->
 Fig. 20 is a flow chart illustrating an embodiment of the method in accordance with the present technology; and </p><p id="p0044" num="0044"> Fig. 21 illustrates an embodiment of a network in accordance with the present technology. </p><p id="p0045" num="0045">DETAILED DESCRIPTION </p><p id="p0046" num="0046">In the following description the same reference designations will be used for elements performing the same or similar function. </p><p id="p0047" num="0047">Before the present technology is described in detail, gain-shape coding will be illustrated with reference to Fig. 1-3. </p><p id="p0048" num="0048">Fig. 1 illustrates an example gain-shape vector quantization scheme. The upper part of the figure illustrates the encoder side. An input vector x is forwarded to a norm calculator 10, which determines the vector norm (gain) g , typically the Euclidian norm. This exact norm is quantized in a norm quantizer 12, and the inverse 1 / g of the quantized norm g is forwarded to a multiplier 14 for scaling the input vector x into a shape. The shape is quantized in a shape quantizer 16. Representations of the quantized gain and shape are forwarded to a bitstream multiplexer (mux) 18. These representations are illustrated by dashed lines to indicate that they may, for example, constitute indices into tables (code books) rather than the actual quantized values. </p><p id="p0049" num="0049">The lower part of Fig. 1 illustrates the decoder side. A bitstream demultiplexer (demux) 20 receives the gain and shape representations. The shape representation is forwarded to a shape dequantizer 22, and the gain representation is forwarded to a gain dequantizer 24. The obtained gain g is forwarded to a multiplier 26, where it scales the obtained shape, which gives the reconstructed vector x . 
<!-- EPO <DP n="8"/>-->
 Fig. 2 illustrates an example transform domain coding and decoding scheme. The upper part of the figure illustrates the encoder side. An input signal is forwarded to a frequency transformer 30, for example based on the Modified Discrete Cosine Transform (MDCT), to produce the frequency transform X . The frequency transform X is forwarded to an envelope calculator 32, which determines the energy E (b) of each frequency band b . These energies are quantized into energies E (b) in an envelope quantizer 34. The quantized energies E {b) are forwarded to an envelope normalizer 36, which scales the coefficients of frequency band b of the transform X with the inverse of the corresponding quantized energy E {b) of the envelope. The resulting scaled shapes are forwarded to a fine structure quantizer 38. The quantized energies E b) are also forwarded to a bit allocator 40, which allocates bits for fine structure quantization to each frequency band b . As noted above, the bit allocation R(b) may be based on a model of the human auditory system. </p><p id="p0050" num="0050">Representations of the quantized gains E {b) and corresponding quantized shapes are forwarded to bitstream multiplexer 18. </p><p id="p0051" num="0051">The lower part of Fig. 2 illustrates the decoder side. The bitstream demultiplexer 20 receives the gain and shape representations. The gain representations are forwarded to an envelope dequantizer 42. The generated envelope energies E(b) are forwarded to a bit allocator 44, which determines the bit allocation R(b) of the received shapes. The shape representations are forwarded to a fine structure dequantizer 46, which is controlled by the bit allocation R(b) . The decoded shapes are forwarded to en envelope shaper 48, which scales them with the corresponding envelope energies E(b) to form a reconstructed frequency transform. This transform is forwarded to an in<sup>¬</sup> verse frequency transformer 50, for example based on the Inverse Modified Discrete Cosine Transform (IMDCT), which produces an output signal repre<sup>¬</sup> senting synthesized audio. 
<!-- EPO <DP n="9"/>-->
 Fig. 3A-C illustrates gain-shape vector quantization described above in a simplified case where the frequency band b is represented by the 2- dimensional vector X(b) in Fig. 3A. This case is simple enough to be illustrated in a drawing, but also general enough to illustrate the problem with gain-shape quantization (in practice the vectors typically have 8 or more dimensions) . The right hand side of Fig. 3A illustrates an exact gain-shape representation of the vector X(b) with a gain E(b) and a shape (unit length vector) N ' (b) . </p><p id="p0052" num="0052">However, as illustrated in Fig. 3B, the exact gain E (b) is encoded into a quantized gain -E (b) on the encoder side. Since the inverse of the quantized gain E (b) is used for scaling of the vector X(b) , the resulting scaled vector N (b) will point in the correct direction, but will not necessarily be of unit length. During shape quantization the scaled vector N (b) is quantized into the quantized shape N (b) . In this case the quantization is based on a pulse coding scheme [3], which constructs the shape (or direction) from a sum of signed integer pulses. The pulses may be added on top of each other for each dimension. This means that the allowed shape quantization positions are represented by the large dots in the rectangular grids illustrated in Fig. 3B- C. The result is that the quantized shape N (b) will in general not coincide with the shape (direction) of N (b) (and JV '(fa)). </p><p id="p0053" num="0053">Fig. 3C illustrates that the accuracy of the shape quantization depends on the allocated bits R (b) , or equivalently the total number of pulses available for shape quantization. In the left part of Fig. 3C the shape quantization is based on 8 pulses, whereas the shape quantization in the right part uses only 3 pulses (the example in Fig. 3B uses 4 pulses). 
<!-- EPO <DP n="10"/>-->
 Thus, it is appreciated that depending on the accuracy of the shape quantizer, the gain value E (b) used to reconstruct the vector X (b) on the decoder side may be more or less appropriate. In accordance with the present technology a gain correction can be based on an accuracy measure of the quantized shape. </p><p id="p0054" num="0054">The accuracy measure used to correct the gain may be derived from parameters already available in the decoder, but it may also depend on additional parameters designated for the accuracy measure. Typically, the parameters would include the number of allocated bits for the shape vector and the shape vector itself, but it may also include the gain value associated with the shape vector and pre-stored statistics about the signals that are typical for the encoding and decoding system. An overview of a system incorporating an accuracy measure and gain correction or adjustment is shown in Fig. 4. </p><p id="p0055" num="0055">Fig. 4 illustrates an example transform domain decoder 300 using an accuracy measure to determine an envelope correction. In order to avoid cluttering of the drawing, only the decoder side is illustrated. The encoder side may be implemented as in Fig. 2. The new feature is a gain adjustment apparatus 60. The gain adjustment apparatus 60 includes an accuracy meter 62 configured to estimate an accuracy measure A (b) of the shape representation </p><p id="p0056" num="0056">N (b) , and to determine a gain correction g<sub>c</sub> (b) based on the estimated accuracy measure A(b) . It also includes an envelope adjuster 64 configured to adjust the gain representation E b) based on the determined gain correction. </p><p id="p0057" num="0057">As indicated above, the gain correction may in some embodiments be per<sup>¬</sup> formed without spending additional bits. This is done by estimating the gain correction from parameters already available in the decoder. This process can be described as an estimation of the accuracy of the encoded shape. Typically this estimation includes deriving the accuracy measure A (b) from 
<!-- EPO <DP n="11"/>-->
 shape quantization characteristics indicating the resolution of the shape quantization. </p><p id="p0058" num="0058">Embodiment 1 </p><p id="p0059" num="0059"> In one embodiment, the present technology is used in an audio encoder/decoder system. The system is transform based and the transform used is the Modified Discrete Cosine Transform (MDCT) using sinusoidal windows with 50% overlap. However, it is understood that any transform suitable for transform coding may be used together with appropriate segmentation and windowing. </p><p id="p0060" num="0060">Encoder of embodiment 1 </p><p id="p0061" num="0061"> The input audio is extracted into frames using 50% overlap and windowed with a symmetric sinusoidal window. Each windowed frame is then transformed to an MDCT spectrum X . The spectrum is partitioned into subbands for processing, where the subband widths are non-uniform. The spectral coefficients of frame m belonging to band b are denoted X(b, m) and have the bandwidth BW(b) . Since most encoder and decoder steps can be described within one frame, we omit the frame index and just use the notation X(b) . The bandwidths should preferably increase with increasing frequency to comply with the frequency resolution of the human auditory system. The root-mean- square (RMS) value of each band is used as a normalization factor and is denoted E(b) :</p><p id="p0062" num="0062"><img id="imgf000011_0001" he="14" wi="98" file="imgf000011_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 where X{bf denotes the transpose of X (b) . </p><p id="p0063" num="0063">The RMS value can be seen as the energy value per coefficient. The sequence of normalization factors E(b) for b = l,2,..., N<sub>bmds</sub> forms the envelope of the MDCT spectrum, where N<sub>bands</sub> denotes the number of bands. Next, the se<sup>¬</sup> 
<!-- EPO <DP n="12"/>-->
 quence is quantized in order to be transmitted to the decoder. To ensure that the normalization can be reversed in the decoder, the quantized envelope E(b) is obtained. In this example embodiment the envelope coefficients are scalar quantized in log domain using a step size of 3 dB and the quantizer indices are differentially encoded using Huffman coding. The quantized envelope is used for normalization of the spectral bands, i.e. : 
<img id="imgf000012_0001" he="11" wi="32" file="imgf000012_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0064" num="0064">Note that if the non-quantized envelope E(b) is used for normalization, the shape would have RMS = 1 , i.e. : </p><p id="p0065" num="0065">N'(b N'{b) </p><p id="p0066" num="0066"> X(b) </p><p id="p0067" num="0067"> E(b) ' BW{b) </p><p id="p0068" num="0068">By using the quantized envelope E(b) , the shape vector will have an RMS value close to 1. This feature will be used in the decoder to create an approximation of the gain value. </p><p id="p0069" num="0069">The union of the normalized shape vectors N(b) forms the fine structure of the MDCT spectrum. The quantized envelope is used to produce a bit allocation R(b) for encoding of the normalized shape vectors N(b) . The bit allocation algorithm preferably uses an auditory model to distribute the bits to the perceptually most relevant parts. Any quantizer scheme may be used for encoding the shape vector. Common for all is that they may be designed under the assumption that the input is normalized, which simplifies quantizer de<sup>¬</sup> sign. In this embodiment the shape quantization is done using a pulse coding scheme which constructs the synthesis shape from a sum of signed inte<sup>¬</sup> ger pulses [3]. The pulses may be added on top of each other to form pulses of different height. In this embodiment the bit allocation R(b) denotes the number of pulses assigned to band b . 
<!-- EPO <DP n="13"/>-->
 The quantizer indices from the envelope quantization and shape quantization are multiplexed into a bitstream to be stored or transmitted to a decoder. </p><p id="p0070" num="0070">Decoder of embodiment 1 </p><p id="p0071" num="0071"> The decoder demultiplexes the indices from the bitstream and forwards the relevant indices to each decoding module. First, the quantized envelope E(b) is obtained. Next, the fine structure bit allocation is derived from the quantized envelope using a bit allocation identical the one used in the encoder. The shape vectors N(b) of the fine structure are decoded using the indices and the obtained bit allocation R(b) . </p><p id="p0072" num="0072">Now, before scaling the decoded fine structure with the envelope, additional gain correction factors are determined. First, the RMS matching gain is obtained as: 
<img id="imgf000013_0001" he="13" wi="101" file="imgf000013_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0073" num="0073">The g<sub>ms</sub> (b) factor is a scaling factor that normalizes the RMS value to 1, i.e.: </p><p id="p0074" num="0074"><img id="imgf000013_0002" he="16" wi="64" file="imgf000013_0002.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/></p><p id="p0075" num="0075">In this embodiment we seek to minimize the mean squared error (MSE) of the synthesis: </p><p id="p0076" num="0076"> g<sub>MSE</sub>{b) = arg min|jV(b) - g · N{b) (6) </p><p id="p0077" num="0077"> 9 </p><p id="p0078" num="0078">with the solution 
<img id="imgf000013_0003" he="12" wi="82" file="imgf000013_0003.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 
<!-- EPO <DP n="14"/>-->
 Since g<sub>MSE</sub> (b) depends on the input shape N(b) , it is not known in the decoder. In this embodiment the impact is estimated by using an accuracy measure. The ratio of these gains is defined as a gain correction factor g<sub>c</sub> (b) : 
<img id="imgf000014_0001" he="12" wi="16" file="imgf000014_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0079" num="0079">When the accuracy of the shape quantization is good, the correction factor is close to 1 , i.e. : </p><p id="p0080" num="0080"> N{b)→ N(b) = g<sub>c</sub>{b)→ 1 (9) </p><p id="p0081" num="0081">However, when the accuracy of N(b) is low, g<sub>MSE</sub> (b) and g<sub>ms</sub> (b) will diverge. In this embodiment, where the shape is encoded using a pulse coding scheme, a low rate will make the shape vector sparse and g^s ib) will give an overestimate of the appropriate gain in terms of MSE. For this case g<sub>c</sub> (b) should be lower than 1 to compensate for the overshoot. See Fig. 5A-B for an example illustration of the low rate pulse shape case. Fig. 5A-B illustrates an example of scaling the synthesis with g<sub>MSE</sub> (Fig. 5B) and g^ (Fig. 5A) gain factors when the shape vector is a sparse pulse vector. The g<sub>ms</sub> scaling gives pulses that are too high in an MSE sense. </p><p id="p0082" num="0082">On the other hand, a peaky or sparse target signal can be well represented with a pulse shape. While the sparseness of the input signal may not be known in the synthesis stage, the sparseness of the synthesis shape may serve as an indicator of the accuracy of the synthesized shape vector. One way to measure the sparseness of the synthesis shape is the height of the maximum peak in the shape. The reasoning behind this is that a sparse in<sup>¬</sup> put signal is more likely to generate high peaks in the synthesis shape. See Fig 7A-B for an illustration of how the peak height can indicate the accuracy of two equal rate pulse vectors. In Fig. 7A there are 5 pulses available (jR(b) = 5) to represent the dashed shape. Since the shape is rather con- 
<!-- EPO <DP n="15"/>-->
 stant, the coding generated 5 distributed pulses of equal height 1, i.e. p<sub>max</sub> = 1 . In Fig. 7B there are also 5 pulses available to represent the dashed shape. However, in this case the shape is peaky or sparse, and the largest peak is represented by 3 pulses on top of each other, i.e. p<sub>max</sub> = 3 . This indicates that the gain correction g<sub>c</sub> (b) depends on an estimated sparseness Pmax °f the quantized shape. </p><p id="p0083" num="0083">As noted above, the input shape N(b) is not known by the decoder. Since g<sub>MSE</sub> (b) depends on the input shape N(b) , this means that the gain correction or compensation g<sub>c</sub> (b) can in practice not be based on the ideal equation (8). In this embodiment the gain correction g<sub>c</sub> (b) is instead decided based on the bit-rate in terms of the number of pulses R(b) , the height of the largest pulse in the shape vector p<sub>mm</sub> {b) and the frequency band b , i.e.: </p><p id="p0084" num="0084">9<sub>c</sub>(b) = f (R(b) , <sub>Pm</sub> b) , b) (10) </p><p id="p0085" num="0085">It has been observed that the lower rates generally require an attenuation of the gain to minimize the MSE. The rate dependency may be implemented as a lookup table t(R(b)) which is trained on relevant audio signal data. An example lookup table can be seen in Fig 7. Since the shape vectors in this embodiment have different widths, the rate may preferably be expressed as number of pulses per sample. In this way the same rate dependent attenuation can be used for all bandwidths. An alternative solution, which is used in this embodiment, is to use a step size T in the table depending on the width of the band. Here, we use 4 different bandwidths in 4 different groups and hence require 4 step sizes. An example of step sizes is found in Table 1. Using the step size, the lookup value is obtained by using a rounding operation t (_R(b) - T]) , where |_ J represents rounding to the closest integer. 
<!-- EPO <DP n="16"/>-->
 Table 1 </p><p id="p0086" num="0086"><img id="imgf000016_0001" he="60" wi="92" file="imgf000016_0001.tif" img-format="tif" img-content="table" orientation="portrait" inline="no"/></p><p id="p0087" num="0087">Another example lookup table is given in Table 2. </p><p id="p0088" num="0088">Table 2 </p><p id="p0089" num="0089"><img id="imgf000016_0002" he="59" wi="92" file="imgf000016_0002.tif" img-format="tif" img-content="table" orientation="portrait" inline="no"/></p><p id="p0090" num="0090">The estimated sparseness can be implemented as another lookup table u(R(b), /?<sub>max</sub> (6)) based on both the number of pulses R{b) and the height of the maximum pulse p<sub>ms</sub> b) . An example lookup table is shown in Fig 8. The lookup table u serves as an accuracy measure A{b) for band b , i.e.: </p><p id="p0091" num="0091">A(b) = u (R(b),p<sub>m</sub> b)) (1 1) </p><p id="p0092" num="0092">It was noted that the approximation of g<sub>MSE</sub> was more suitable for the lower frequency range from a perceptual perspective. For the higher frequencies the fine structure becomes less perceptually important and the matching of 
<!-- EPO <DP n="17"/>-->
 the energy or RMS value becomes vital. For this reason, the gain attenuation may be applied only below a certain band number b<sub>mR</sub> . In this case the gain correction g<sub>c</sub>(b) will have an explicit dependence on the frequency band b . The resulting gain correction function can in this case be defined as: 
<img id="imgf000017_0001" he="13" wi="66" file="imgf000017_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 e </p><p id="p0093" num="0093">The description up to this point may also be used to describe the essential features of the example embodiment of Fig. 4. Thus, in the embodiment of</p><p id="p0094" num="0094">Fig. 4, the final synthesis X(b) is calculated as: b) = 9Ab)g<sub>RMS</sub>{b)E(n) N{b) (13) </p><p id="p0095" num="0095"> W) </p><p id="p0096" num="0096">As an alternative the function u(R(b),p<sub>mm</sub>(b)) may be implemented as a linear function of the maximum pulse height p<sub>mgx</sub> and the allocated bit rate R(b) , for example as: </p><p id="p0097" num="0097"> u {R(b),<sub>Pmax</sub>(b)) = k<sup>■</sup> (p<sub>m</sub> b) - R(b)) + 1 (14) where the inclination k is determined by: 
<img id="imgf000017_0002" he="13" wi="47" file="imgf000017_0002.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0098" num="0098"> Aa = (a<sub>max</sub> - a<sub>min</sub>)/R(b) (15) </p><p id="p0099" num="0099">R(b) - 1 </p><p id="p0100" num="0100">The function depends on the tuning parameter a<sub>min</sub> which gives the initial attenuation factor for R(b) = l and p<sub>mm</sub> b) = \ . The function is illustrated in 
<!-- EPO <DP n="18"/>-->
 Fig 9, with the tuning parameter a<sub>lllin</sub> = 0.41 . Typically u<sub>max</sub> e [0.7, 1.4] and <sup>u</sup>min <sup>e</sup> [° &gt; <sup>u</sup>max ] <sup>■ In</sup> equation ( 14) u is linear in the difference between p<sub>max</sub> (b) and R(b) . Another possibility is to have different inclination factors for 
<img id="imgf000018_0001" he="6" wi="39" file="imgf000018_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0101" num="0101">The bitrate for a given band may change drastically for a given band between adjacent frames. This may lead to fast variations of the gain correction. Such variations are especially critical when the envelope is fairly stable, i.e. the total changes between frames are quite small. This often happens for music signals which typically have more stable energy envelopes. To avoid that the gain attenuation introduces instability, an additional adaptation may be added. An overview of such an embodiment is given in Fig 10, in which a stability meter 66 has been added to the gain adjustment apparatus 60 in the decoder 300. </p><p id="p0102" num="0102">The adaptation can for example be based on a stability measure of the envelope E (b) . An example of such a measure is to compute the squared Euclidian distance between adjacent log2 envelope vectors: </p><p id="p0103" num="0103">AE(m) = - £ (\og<sub>2</sub> E(b,m) - \og<sub>2</sub> E(b,m - l)) (16) </p><p id="p0104" num="0104"> N bands b=Q </p><p id="p0105" num="0105">Here, AE(m) denotes the squared Euclidian distance between the envelope vectors for frame m and frame m - 1 . The stability measure may also be low- pass filtered to have a smoother adaptation: </p><p id="p0106" num="0106">AE(m) = aAE{m) + (1 - a)AE{m - 1) (1 ) </p><p id="p0107" num="0107">A suitable value for the forgetting factor may be 0. 1. The smoothened sta<sup>¬</sup> bility measure may then be used to create a limitation of the attenuation us<sup>¬</sup> ing, for example, a sigmoid function such as: 
<!-- EPO <DP n="19"/>-->
 1 </p><p id="p0108" num="0108"><sub>1 + e</sub>C,(A£(»i)-C<sub>2</sub>)-C<sub>3</sub> ' (18) </p><p id="p0109" num="0109">where the parameters may be set to C, = 6, C<sub>2</sub> = 2 and C<sub>3</sub> =1.9. It should be noted that these parameters are to be seen as examples, while the actual values may be chosen with more freedom. For instance: </p><p id="p0110" num="0110">Q 6 [1,10] </p><p id="p0111" num="0111"> C<sub>2</sub> e[l,4] </p><p id="p0112" num="0112"> C<sub>3</sub> e[-5,10] </p><p id="p0113" num="0113">Fig. 11 illustrates an example of a mapping function from the stability meas- ure AE(m) to the gain adjustment limitation factor g<sub>min</sub> . The above expression for g<sub>min</sub> is preferably implemented as a lookup table or with a simple step function, such as: g<sup>rain</sup> 
<img id="imgf000019_0001" he="14" wi="54" file="imgf000019_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 <sup>[</sup> ' The attenuation limitation variable g<sub>mill</sub> e [θ,ΐ] may be used to create a stability adapted gain modification g<sub>c</sub>(b) as: g<sub>c</sub>{b) = max(g<sub>c</sub>(b),g<sub>mhl</sub>) (20) </p><p id="p0114" num="0114">After the estimation of the gain, the final synthesis X{b) is calculated as: </p><p id="p0115" num="0115">X(b) = g<sub>c</sub>(b)g<sub>RMS</sub>(b)E(n)N(b) (21) </p><p id="p0116" num="0116"> E(n) </p><p id="p0117" num="0117">In the described variations of embodiment 1 the union of the synthesized vectors X(b) forms the synthesized spectrum X , which is further processed 
<!-- EPO <DP n="20"/>-->
 using the inverse MDCT transform, windowed with the symmetric sine window and added to the output synthesis using the overlap-and-add strategy. </p><p id="p0118" num="0118">Embodiment 2 </p><p id="p0119" num="0119"> In another example embodiment, the shape is quantized using a QMF (Quadrature Mirror Filter) filter bank and an ADPCM (Adaptive Differential Pulse-Code Modulation) scheme for shape quantization. An example of a subband ADPCM scheme is the ITU-T G.722 [4]. The input audio signal is preferably processed in segments. An example ADPCM scheme is shown in Fig 12, with an adaptive step size S . Here, the adaptive step size of the shape quantizer serves as an accuracy measure that is already present in the decoder and does not require additional signaling. However, the quantization step size needs to be extracted from the parameters used by the decoding process and not from the synthesized shape itself. An overview of this embodiment is shown in Fig 14. However, before this embodiment is described in detail, an example ADPCM scheme based on a QMF filter bank will be described with reference to Fig. 12 and 13. </p><p id="p0120" num="0120">Fig. 12 illustrates an example of an ADPCM encoder and decoder system with an adaptive quantization step size. An ADPCM quantizer 70 includes an adder 72, which receives an input signal and subtracts an estimate of the previous input signal to form an error signal e . The error signal is quantized in a quantizer 74, the output of which is forwarded to the bitstream multiplexer 18, and also to a step size calculator 76 and a dequantizer 78. The step size calculator 76 adapts the quantization step size S to obtain an acceptable error. The quantization step size S is forwarded to the bitstream multiplexer 18, and also controls the quantizer 74 and the dequantizer 78. The dequantizer 78 outputs an error estimate e to an adder 80. The other input of the adder 80 receives an estimate of the input signal which has been delayed by a delay element 82. This forms a current estimate of the input signal, which is forwarded to the delay element 82. The delayed signal is also forwarded to the step size calculator 76 and to (with a sign change) the adder 72 to form the error signal e . 
<!-- EPO <DP n="21"/>-->
 An ADPCM dequantizer 90 includes a step size decoder 92, which decodes the received quantization step size S and forwards it to a dequantizer 94. The de- quantizer 94 decodes the error estimate e , which is forwarded to an adder 98, the other input of which receives the output signal from the adder delayed by a delay element 96. </p><p id="p0121" num="0121">Fig. 13 illustrates an example in the context of a subband ADPCM based audio encoder and decoder system. The encoder side is similar to the encoder side of the embodiment of Fig. 2. The essential differences are that the frequency transformer 30 has been replaced by a QMF (Quadrature Mirror Filter) analysis filter bank 100, and that fine structure quantizer 38 has been replaced by an ADPCM quantizer, such as the quantizer 70 in Fig. 12. The decoder side is similar to the decoder side of the embodiment of Fig. 2. The essential differences are that the inverse frequency transformer 50 has been replaced by a QMF synthesis filter bank 102, and that fine structure dequantizer 46 has been replaced by an ADPCM dequantizer, such as the dequantizer 90 in Fig. 12. </p><p id="p0122" num="0122">Fig. 14 illustrates an embodiment of the present technology in the context of a subband ADPCM based audio coder and decoder system. In order to avoid cluttering of the drawing, only the decoder side 300 is illustrated. The encoder side may be implemented as in Fig. 13. </p><p id="p0123" num="0123">Encoder of embodiment 2 </p><p id="p0124" num="0124"> The encoder applies the QMF filter bank to obtain the subband signals. The RMS values of each subband signal are calculated and the subband signals are normalized. The envelope E(b) , subband bit allocation R(b) and normalized shape vectors N(b) are obtained as in embodiment 1. Each normalized subband is fed to the ADPCM quantizer. In this embodiment the ADPCM operates in a forward adaptive fashion, and determines a scaling step S(b) to be used for subband b . The scaling step is chosen to minimize the MSE 
<!-- EPO <DP n="22"/>-->
 across the subband frame. In this embodiment the step is chosen by trying all possible steps and selecting the one which gives the minimum MSE: </p><p id="p0125" num="0125">S[b) = min— ^—(N(b) - Q (N(b), s)f (N(b) - Q(N(b),s)) (22) </p><p id="p0126" num="0126">where Q{x, s) is the ADPCM quantizing function of the variable x using a step size of s . The selected step size may be used to generate the quantized shape: </p><p id="p0127" num="0127"> N{b) = Q (N(b), S(b)) (23) </p><p id="p0128" num="0128">The quantizer indices from the envelope quantization and shape quantization are multiplexed into a bitstream to be stored or transmitted to a decoder. </p><p id="p0129" num="0129">Decoder of embodiment 2 </p><p id="p0130" num="0130"> The decoder demultiplexes the indices from the bitstream and forwards the relevant indices to each decoding module. The quantized envelope E(b) and the bit allocation R(b) are obtained as in embodiment 1. The synthesized shape vectors N(b) are obtained from the ADPCM decoder or dequantizer together with the adaptive step sizes S(b) . The step sizes indicate an accuracy of the quantized shape vector, where a smaller step size corresponds to a higher accuracy and vice versa. One possible implementation is to make the accuracy A(b) inversely proportional to the step size using a proportionality factor γ : </p><p id="p0131" num="0131">A(b) = r— (24) ' <sup>r</sup> S{b) where γ should be set to achieve the desired relation. One possible choice is / = S<sub>min</sub> where ^<sub>min</sub> is the minimum step size, which gives accuracy 1 for S(b) = S<sub>mia</sub> . 
<!-- EPO <DP n="23"/>-->
 The gain correction factor g<sub>c</sub> may be obtained using a mapping function: g<sub>c</sub>(b) = h (R(b), b) . A(b) (25) </p><p id="p0132" num="0132">The mapping function h may be implemented as a lookup table based on the rate R(b) and frequency band b . This table may be defined by clustering the optimal gain correction values g<sub>MSE</sub> jg<sub>ms</sub> by these parameters and computing the table entry by averaging the optimal gain correction values for each cluster. </p><p id="p0133" num="0133">After the estimation of the gain correction, the subband synthesis X(b) is calculated as: (26) 
<img id="imgf000023_0001" he="15" wi="57" file="imgf000023_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 </p><p id="p0134" num="0134">The output audio frame is obtained by applying the synthesis QMF filter bank to the subbands. </p><p id="p0135" num="0135">In the example embodiment illustrated in Fig. 14 the accuracy meter 62 in the gain adjustment apparatus 60 receives the not yet decoded quantization step size S (b) directly from the received bitstream. An alternative, as noted above, is to decode it in the ADPCM dequantizer 90 and forward it in decoded form to the accuracy meter 62. </p><p id="p0136" num="0136">Further alternatives </p><p id="p0137" num="0137"> The accuracy measure could be complemented with a signal class parameter derived in the encoder. This may for instance be a speech/ music discrimina<sup>¬</sup> tor or a background noise level estimator. An overview of a system incorporating a signal classifier is shown in Fig 15- 16. The encoder side in Fig. 15 is similar to the encoder side in Fig. 2, but has been provided with a signal 
<!-- EPO <DP n="24"/>-->
 classifier 104. The decoder side 300 in Fig. 16 is similar to the decoder side in Fig. 4, but has been provided with a further signal class input to the accuracy meter 62. </p><p id="p0138" num="0138">The signal class could be incorporated in the gain correction for instance by having a class dependent adaptation. If we assume the signal classes are speech or music corresponding to the values C = 1 and C = 0 respectively, we can constrain the gain adjustment to be effective only during speech, i.e. : </p><p id="p0139" num="0139">{R(b)) - A (b) , b &lt; b<sub>THR</sub> A C </p><p id="p0140" num="0140"> otherwise </p><p id="p0141" num="0141">In another alternative embodiment the system can act as a predictor together with a partially coded gain correction or compensation. In this embodiment the accuracy measure is used to improve the prediction of the gain correction or compensation such that the remaining gain error may be coded with fewer bits. </p><p id="p0142" num="0142">When creating the gain correction or compensation factor g<sub>c</sub> one might want to do a trade-off between matching the RMS value or energy and minimizing the MSE. In some cases matching the energy becomes more important than an accurate waveform. This is for instance true for higher frequencies. To accommodate this, the final gain correction may, in a further embodiment, be formed by using a weighted sum of the different gain values: </p><p id="p0143" num="0143">PQRMS + i<sup>1</sup> P)9MSE = β + (1 - β) 3Μ3Ε_ <sub>=</sub> β <sub>+</sub> _ (28) 
<img id="imgf000024_0001" he="5" wi="56" file="imgf000024_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/>
 where g<sub>c</sub> is the gain correction obtained in accordance with one of the ap<sup>¬</sup> proaches described above. The weighting factor β can be made adaptive to e.g. the frequency, bitrate or signal type. 
<!-- EPO <DP n="25"/>-->
 The steps, functions, procedures and/ or blocks described herein may be implemented in hardware using any conventional technology, such as discrete circuit or integrated circuit technology, including both general-purpose electronic circuitry and application-specific circuitry. </p><p id="p0144" num="0144">Alternatively, at least some of the steps, functions, procedures and/or blocks described herein may be implemented in software for execution by a suitable processing device, such as a micro processor, Digital Signal Processor (DSP) and/ or any suitable programmable logic device, such as a Field Programmable Gate Array (FPGA) device. </p><p id="p0145" num="0145">It should also be understood that it may be possible to reuse the general processing capabilities of the decoder. This may, for example, be done by repro- gramming of the existing software or by adding new software components. </p><p id="p0146" num="0146">Fig. 17 illustrates an embodiment of a gain adjustment apparatus 60 in accordance with the present technology. This embodiment is based on a processor 1 10, for example a micro processor, which executes a software component 120 for estimating the accuracy measure, a software component 130 for determining gain the correction, and a soft- ware component 140 for adjusting the gain representation. These software components are stored in memory 150. The processor 1 10 communicates with the memory over a system bus. The parameters N (b) , R(b) , E {b) are received by an input/ output (I/O) controller 160 controlling an I/O bus, to which the processor 1 10 and the memory 150 are connected. In this embodiment the parameters received by the I/O controller 160 are stored in the memory 150, where they are processed by the software components. Software components 120, 130 may implement the functionality of block 62 in the embodiments described above. Software component 140 may implement the functionality of block 64 in the embodiments described above. The adjusted gain representation E (b) obtained from soft<sup>¬</sup> ware component 140 is outputted from the memory 150 by the I/O controller 160 over the I/O bus. 
<!-- EPO <DP n="26"/>-->
 Fig. 18 illustrates an embodiment of gain adjustment in accordance with the present technology in more detail. An attenuation estimator 200 is configured to use the received bit allocation R b) to determine a gain attenuation </p><p id="p0147" num="0147">The attenuation estimator 200 may, for example, be implemented as a lookup table or in software based on a linear equation such as equation (14) above. The bit allocation R(b) is also forwarded to a shape accuracy estimator 202, which also receives an estimated sparseness p<sub>max</sub> (b) of the quantized shape, for example represented by the height of the highest pulse in the shape representation N (b) . The shape accuracy estimator 202 may, for example, be implemented as a lookup table. The estimated attenuation and the estimated shape accuracy A(b) are multiplied in a multiplier 204. In one embodiment this product · A (b) directly forms the gain correction g<sub>c</sub> (b) . In another embodiment the gain correction g<sub>c</sub> (fo) is formed in accordance with equation (12) above. This requires a switch 206 controlled by a comparator 208, which determines whether the frequency band b is less than a frequency limit b<sub>THR</sub> . If this is the case, then g<sub>c</sub> (fo) is equal to (£&gt;)) · A (b) . Otherwise g<sub>c</sub> (b) is set to 1. The gain correction g<sub>c</sub> (b) is forwarded to another multiplier 210, the other input of which receives the RMS matching gain g<sub>RMA</sub> (b) . The RMS matching gain g<sub>RMA</sub> (b) is determined by an RMS matching gain calculator 212 based on the received shape representation N (b) and corresponding bandwidth BW (b) , see equation (4) above. The resulting product is forwarded to another multiplier 214, which also receives the shape representation N (b) and the gain representa<sup>¬</sup> tion E{b) , and forms the synthesis X(b) . </p><p id="p0148" num="0148">The stability detection described with reference to Fig. 10 may be incorpo<sup>¬</sup> rated into embodiment 2 as well as the other embodiments described above. 
<!-- EPO <DP n="27"/>-->
 Fig. 19 is a flow chart illustrating the method in accordance with the present technology. Step S I estimates an accuracy measure A {b) of the shape representation N (b) . The accuracy measure may, for example, be derived from shape quantization characteristics, such as R(b) , S (b) , indicating the resolution of the shape quantization. Step S2 determines a gain correction, such as g<sub>c</sub> {b) , g<sub>c</sub> {b) , g<sub>c</sub>' {b) , based on the estimated accuracy measure. Step S3 adjusts the gain representation E{b) based on the determined gain correction. </p><p id="p0149" num="0149">Fig. 20 is a flow chart illustrating an embodiment of the method in accordance with the present technology, in which the shape has been encoded using a pulse coding scheme and the gain correction depends on an estimated sparseness p<sub>max</sub> (b) of the quantized shape. It is assumed that an accuracy measure has already been determined a step S I (Fig. 19) . Step S4 estimates a gain attenuation that depends on allocated bit rate. Step S5 determines a gain correction based on the estimated accuracy measure and the estimated gain attenuation. Thereafter the procedure proceeds to step S3 (Fig. 19) to adjust the gain representation. </p><p id="p0150" num="0150">Fig. 21 illustrates an embodiment of a network in accordance with the present technology. It includes a decoder 300 provided with a gain adjustment apparatus in accordance with the present technology. This embodiment illustrates a radio terminal, but other network nodes are also feasible. For example, if voice over IP (Internet Protocol) is used in the network, the nodes may comprise computers. </p><p id="p0151" num="0151">In the network node in Fig. 21 an antenna 302 receives a coded audio signal. A radio unit 304 transforms this signal into audio parameters, which are forwarded to the decoder 300 for generating a digital audio signal, as described with reference to the various embodiments above. The digital audio signal is 
<!-- EPO <DP n="28"/>-->
 then D/A converted and amplified in a unit 306 and finally forwarded to a loudspeaker 308. </p><p id="p0152" num="0152">Although the description above focuses on transform based audio coding, the same principles may also be applied to time domain audio coding with separate gain and shape representations, for example CELP coding. </p><p id="p0153" num="0153">It will be understood by those skilled in the art that various modifications and changes may be made to the present technology without departure from the scope thereof, which is defined by the appended claims. </p><p id="p0154" num="0154">ABBREVIATIONS </p><p id="p0155" num="0155">AD PCM Adaptive Differential Pulse-Code Modulation </p><p id="p0156" num="0156"> AMR Adaptive MultiRate </p><p id="p0157" num="0157"> AMR-WB Adaptive MultiRate WideBand </p><p id="p0158" num="0158"> CELP Code Excited Linear Prediction </p><p id="p0159" num="0159"> GSM-EFR Global System for Mobile communications - Enhanced FullRate</p><p id="p0160" num="0160">DSP Digital Signal Processor </p><p id="p0161" num="0161"> FPGA Field Programmable Gate Array </p><p id="p0162" num="0162"> IP Internet Protocol </p><p id="p0163" num="0163"> MDCT Modified Discrete Cosine Transform </p><p id="p0164" num="0164"> MSE Mean Squared Error </p><p id="p0165" num="0165"> QMF Quadrature Mirror Filter </p><p id="p0166" num="0166"> RMS Root-Mean-Square </p><p id="p0167" num="0167"> VQ Vector Quantization 
<!-- EPO <DP n="29"/>-->
 REFERENCES </p><p id="p0168" num="0168">"ITU-T G.722.1 ANNEX C: A NEW LOW-COMPLEXITY 14 KHZ AUDIO CODING STANDARD", ICASSP 2006 </p><p id="p0169" num="0169">"ITU-T G.719: A NEW LOW-COMPLEXITY FULL-BAND (20 KHZ) AUDIO CODING STANDARD FOR HIGH-QUALITY CONVERSATIONAL APPLICATIONS", WASPA 2009 </p><p id="p0170" num="0170">U. Mittal, J. Ashley, E. Cruz-Zeno, "Low Complexity Factorial Pulse Coding of MDCT Coefficients using Approximation of Combinatorial Functions," ICASSP 2007 </p><p id="p0171" num="0171">[4] "7 kHz Audio Coding Within 64 kbit/s", [G.722], IEEE JOURNAL ON SELECTED AREAS IN COMMUNICATIONS, 1988 
</p></description><claims mxw-id="PCLM44997507" ref-ucid="WO-2012121637-A1" lang="EN" load-source="patent-office"><claim-statement><!-- EPO <DP n="30"/>-->CLAIMS </claim-statement><claim id="clm-0001" num="1"><claim-text>1. A gain adjustment method in decoding of audio that has been encoded with separate gain and shape representations, said method including the steps of: </claim-text><claim-text> estimating (S I) an accuracy measure of the shape representation (N (b)) ; determining (S2) a gain correction [g<sub>c</sub> (b)) based on the estimated accuracy measure (.A (fo)) ; adjusting (S3) the gain representation based on the determined gain correction. </claim-text></claim><claim id="clm-0002" num="2"><claim-text>2. The method of claim 1 , wherein the estimating step includes deriving the accuracy measure {A { †j from shape quantization characteristics </claim-text><claim-text>(R(b) , S(b)) indicating the resolution of the shape quantization. </claim-text></claim><claim id="clm-0003" num="3"><claim-text>3. The method of claim 2, wherein the shape has been encoded using a pulse coding scheme and the gain correction (g<sub>c</sub> (b)) depends on an estimated sparseness (p<sub>max</sub> ( )) of the quantized shape. </claim-text></claim><claim id="clm-0004" num="4"><claim-text>4. The method of claim 3, wherein the gain correction (g<sub>c</sub> (b)) depends on at least the following shape characteristics: </claim-text><claim-text> allocated bit rate (i? (b)) , maximum pulse height ( <sub>max</sub> (£»)) . </claim-text></claim><claim id="clm-0005" num="5"><claim-text>5. The method of claim 4, wherein the gain correction [g<sub>c</sub> (¾)) also depends on the frequency band (b) . <!-- EPO <DP n="31"/>--> </claim-text></claim><claim id="clm-0006" num="6"><claim-text>6. The method of any of the preceding claims 3-5, including the steps of estimating (S4) a gain attenuation (i (/? (¾))) that depends on allocated bit rate (R(b)) determining (S5) the gain correction (g<sub>c</sub> (£&gt;)) based on the estimated accuracy measure (A (b) and the estimated gain attenuation (t(R (¾))) . </claim-text></claim><claim id="clm-0007" num="7"><claim-text>7. The method of claim 6, wherein the gain attenuation i is estimated from a lookup table (200) . </claim-text></claim><claim id="clm-0008" num="8"><claim-text>8. The method of claim 6 or 7, including the step of estimating (S5) the shape accuracy measure (-A(£&gt;)) from a lookup table (202) . </claim-text></claim><claim id="clm-0009" num="9"><claim-text>9. The method of claim 6 or 7, including the step of estimating the shape accuracy measure (A (fo)) from a linear function of the maximum pulse height </claim-text><claim-text>(Pmax ) <sup>an</sup>d the allocated bit rate </claim-text></claim><claim id="clm-0010" num="10"><claim-text>10. The method of claim 1 or 2, wherein the shape has been encoded using an adaptive differential pulse-code modulation scheme and the gain correction [g<sub>c</sub> {b ^ depends on at least a shape quantization step size (S(b)) . </claim-text></claim><claim id="clm-0011" num="11"><claim-text>1 1. The method of claim 10, wherein the gain correction (g<sub>c</sub> (b)) further depends on the following shape characteristics: </claim-text><claim-text> allocated bit rate (R (¾)) , frequency band (b) . </claim-text></claim><claim id="clm-0012" num="12"><claim-text>12. The method of claim 10 or 1 1 , wherein the shape accuracy measure (A (b)) is inversely proportional to the shape quantization step size (S (£&gt;)) · <!-- EPO <DP n="32"/>--> </claim-text></claim><claim id="clm-0013" num="13"><claim-text>13. The method of any of the preceding claims 1- 12, including the step of adapting the gain correction [g<sub>c</sub> (fa)) to a determined audio signal class. </claim-text></claim><claim id="clm-0014" num="14"><claim-text>14. A gain adjustment apparatus (60) for use in decoding of audio that has been encoded with separate gain and shape representations, said apparatus including: </claim-text><claim-text> an accuracy meter (62) configured to estimate an accuracy measure (-A(fa)) of the shape representation (N (b j , and to determine a gain correction (gr<sub>c</sub> (fa)) based on the estimated accuracy measure (A (fa)) ; </claim-text><claim-text> an envelope adjuster (64) configured to adjust the gain representation (E(b)) based on the determined gain correction. </claim-text></claim><claim id="clm-0015" num="15"><claim-text>15. The apparatus of claim 43, wherein the accuracy meter is configured to derive the accuracy measure (^ (fa)) from shape quantization characteristics </claim-text><claim-text>(i? (fa) , S(fa)) indicating the resolution of the shape quantization. </claim-text></claim><claim id="clm-0016" num="16"><claim-text>16. The apparatus of claim 15, wherein the accuracy meter (62) is configured to determine the gain correction g<sub>c</sub> (fa)) based on a shape that has been encoded using a pulse coding scheme and wherein the gain correction [g<sub>c</sub> (fa)) depends on an estimated sparseness (p<sub>max</sub> (fa)) of the quantized shape. </claim-text></claim><claim id="clm-0017" num="17"><claim-text>17. The apparatus of claim 16, wherein the gain correction (g<sub>c</sub> (fa)) depends on at least the following shape characteristics: </claim-text><claim-text> allocated bit rate (i?(fa)) , maximum pulse height ( p<sub>max</sub> (fa)) . <!-- EPO <DP n="33"/>--> </claim-text></claim><claim id="clm-0018" num="18"><claim-text>18. The apparatus of claim 17, wherein the gain correction (gr<sub>c</sub> (b)) also depends on the frequency band (b) . </claim-text></claim><claim id="clm-0019" num="19"><claim-text>19. The apparatus of any of the preceding claims 16- 18, wherein the accuracy meter includes </claim-text><claim-text> an attenuation estimator (200) configured to estimate a gain attenuation (i that depends on allocated bit rate (i? (£&gt;)) ; a shape accuracy estimator (202) configured to estimate the accuracy measure (A (b)) ; </claim-text><claim-text> a gain corrector (204, 206, 208) configured to determine a gain correction {g<sub>c</sub> ( ) based on the estimated accuracy measure and the estimated gain attenuation</claim-text><claim-text> <img id="imgf000033_0001" he="8" wi="20" file="imgf000033_0001.tif" img-format="tif" img-content="drawing" orientation="portrait" inline="no"/> </claim-text></claim><claim id="clm-0020" num="20"><claim-text>20. The apparatus of claim 19, wherein the attenuation estimator (200) is implemented as a lookup table. </claim-text></claim><claim id="clm-0021" num="21"><claim-text>21. The apparatus of claim 19 or 20, wherein the shape accuracy estimator (202) is a lookup table. </claim-text></claim><claim id="clm-0022" num="22"><claim-text>22. The apparatus of claim 19 or 20, wherein the shape accuracy estimator (202) is configured to estimate the shape accuracy measure from a linear function of the maximum pulse height (p<sub>max</sub>) and the allocated bit rate (R(b)) . </claim-text></claim><claim id="clm-0023" num="23"><claim-text>23. The apparatus of claim 14 or 15, wherein the accuracy meter (62) is con<sup>¬</sup> figured to determine the gain correction g<sub>c</sub> (b)) based on a shape that has been encoded using an adaptive differential pulse-code modulation scheme <!-- EPO <DP n="34"/>--> and wherein the gain correction g<sub>c</sub> (b)J depends on at least a shape quantization step size (S (b)) . </claim-text></claim><claim id="clm-0024" num="24"><claim-text>24. The apparatus of claim 23, wherein the gain correction (g<sub>c</sub> (b)) further depends on the following shape characteristics: </claim-text><claim-text> allocated bit rate [R (b)) , frequency band (b) . </claim-text></claim><claim id="clm-0025" num="25"><claim-text>25. The apparatus of claim 23 or 24, wherein the shape accuracy estimator (202) is configured to estimate the shape accuracy measure (^ ( )) to be inversely proportional to the quantization step size [S (b)) . </claim-text></claim><claim id="clm-0026" num="26"><claim-text>26. The apparatus of any of the preceding claims 14-25, wherein the accuracy meter (62) is configured to adapt the gain correction (g<sub>c</sub> (b)) to a determined audio signal class. </claim-text></claim><claim id="clm-0027" num="27"><claim-text>27. A decoder including a gain adjustment apparatus (60) in accordance with any of the claims 14-26. </claim-text></claim><claim id="clm-0028" num="28"><claim-text>28. A network node including a decoder in accordance with claim 27. </claim-text></claim></claims><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
