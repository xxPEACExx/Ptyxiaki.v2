<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2959740-A1" country="EP" doc-number="2959740" kind="A1" date="20151230" family-id="51390954" file-reference-id="315106" date-produced="20180826" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="160452361" ucid="EP-2959740-A1"><document-id><country>EP</country><doc-number>2959740</doc-number><kind>A1</kind><date>20151230</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-14753848-A" is-representative="NO"><document-id mxw-id="PAPP193867690" load-source="docdb" format="epo"><country>EP</country><doc-number>14753848</doc-number><kind>A</kind><date>20140214</date><lang>EN</lang></document-id><document-id mxw-id="PAPP193867691" load-source="patent-office" format="original"><country>EP</country><doc-number>14753848.2</doc-number><date>20140214</date><lang>EN</lang></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC162028153" ucid="JP-2013033505-A" load-source="docdb"><document-id format="epo"><country>JP</country><doc-number>2013033505</doc-number><kind>A</kind><date>20130222</date></document-id></priority-claim><priority-claim mxw-id="PPC162029830" ucid="JP-2014000767-W" linkage-type="W" load-source="docdb"><document-id format="epo"><country>JP</country><doc-number>2014000767</doc-number><kind>W</kind><date>20140214</date></document-id></priority-claim></priority-claims><technical-data><classifications-ipcr><classification-ipcr mxw-id="PCL-1894790008" load-source="docdb">H04W  76/02        20090101AFI20160909BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-1660023346" load-source="docdb" scheme="CPC">H04W  76/14        20180201 LI20180314BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1660023347" load-source="docdb" scheme="CPC">H04W  76/10        20180201 LI20180314BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1984697160" load-source="docdb" scheme="CPC">H04W  72/048       20130101 LI20160107BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1984697347" load-source="docdb" scheme="CPC">H04W  72/0406      20130101 FI20160107BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1984697922" load-source="docdb" scheme="CPC">H04L  67/06        20130101 LI20160107BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1984705050" load-source="docdb" scheme="CPC">H04W  48/16        20130101 LI20160107BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT165548549" lang="DE" load-source="patent-office">KOMMUNIKATIONSVORRICHTUNG, STEUERUNGSVERFAHREN DAFÜR UND PROGRAMM</invention-title><invention-title mxw-id="PT165548550" lang="EN" load-source="patent-office">COMMUNICATION APPARATUS, CONTROL METHOD THEREOF, AND PROGRAM</invention-title><invention-title mxw-id="PT165548551" lang="FR" load-source="patent-office">APPAREIL DE COMMUNICATION, PROCÉDÉ DE COMMANDE ASSOCIÉ ET PROGRAMME</invention-title></technical-data><parties><applicants><applicant mxw-id="PPAR1103321189" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>CANON KK</last-name><address><country>JP</country></address></addressbook></applicant><applicant mxw-id="PPAR1103318976" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>CANON KABUSHIKI KAISHA</last-name></addressbook></applicant><applicant mxw-id="PPAR1101644497" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Canon Kabushiki Kaisha</last-name><iid>101093230</iid><address><street>30-2 Shimomaruko 3-chome Ohta-ku</street><city>Tokyo 146-8501</city><country>JP</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR1103316259" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>TAKAHASHI SEIJI</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR1103332574" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>TAKAHASHI, SEIJI</last-name></addressbook></inventor><inventor mxw-id="PPAR1101648198" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>TAKAHASHI, SEIJI</last-name><address><street>c/o CANON KABUSHIKI KAISHA 30-2 Shimomaruko 3-chome Ohta-ku</street><city>Tokyo 146-8501</city><country>JP</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR1101641037" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Garner, Jonathan Charles Stapleton</last-name><iid>101129203</iid><address><street>Canon Europe Ltd European Patent Department 3 The Square</street><city>Stockley Park Uxbridge, Middlesex UB11 1ET</city><country>GB</country></address></addressbook></agent></agents></parties><international-convention-data><pct-or-regional-filing-data ucid="JP-2014000767-W"><document-id><country>JP</country><doc-number>2014000767</doc-number><kind>W</kind><date>20140214</date><lang>EN</lang></document-id></pct-or-regional-filing-data><pct-or-regional-publishing-data ucid="WO-2014129155-A1"><document-id><country>WO</country><doc-number>2014129155</doc-number><kind>A1</kind><date>20140828</date><lang>EN</lang></document-id></pct-or-regional-publishing-data><designated-states><ep-contracting-states><country mxw-id="DS660621144" load-source="docdb">AL</country><country mxw-id="DS660623056" load-source="docdb">AT</country><country mxw-id="DS660621146" load-source="docdb">BE</country><country mxw-id="DS660787905" load-source="docdb">BG</country><country mxw-id="DS660706268" load-source="docdb">CH</country><country mxw-id="DS660622594" load-source="docdb">CY</country><country mxw-id="DS660623057" load-source="docdb">CZ</country><country mxw-id="DS660621155" load-source="docdb">DE</country><country mxw-id="DS660622603" load-source="docdb">DK</country><country mxw-id="DS660622604" load-source="docdb">EE</country><country mxw-id="DS660700466" load-source="docdb">ES</country><country mxw-id="DS660787906" load-source="docdb">FI</country><country mxw-id="DS660706269" load-source="docdb">FR</country><country mxw-id="DS660621156" load-source="docdb">GB</country><country mxw-id="DS660622605" load-source="docdb">GR</country><country mxw-id="DS660621157" load-source="docdb">HR</country><country mxw-id="DS660623058" load-source="docdb">HU</country><country mxw-id="DS660700483" load-source="docdb">IE</country><country mxw-id="DS660622606" load-source="docdb">IS</country><country mxw-id="DS660706270" load-source="docdb">IT</country><country mxw-id="DS660622615" load-source="docdb">LI</country><country mxw-id="DS660787907" load-source="docdb">LT</country><country mxw-id="DS660700956" load-source="docdb">LU</country><country mxw-id="DS660787908" load-source="docdb">LV</country><country mxw-id="DS660787909" load-source="docdb">MC</country><country mxw-id="DS660700957" load-source="docdb">MK</country><country mxw-id="DS660700958" load-source="docdb">MT</country><country mxw-id="DS660700963" load-source="docdb">NL</country><country mxw-id="DS660706279" load-source="docdb">NO</country><country mxw-id="DS660700964" load-source="docdb">PL</country><country mxw-id="DS660700484" load-source="docdb">PT</country><country mxw-id="DS660718651" load-source="docdb">RO</country><country mxw-id="DS660700485" load-source="docdb">RS</country><country mxw-id="DS660700965" load-source="docdb">SE</country><country mxw-id="DS660621167" load-source="docdb">SI</country><country mxw-id="DS660706280" load-source="docdb">SK</country><country mxw-id="DS660706281" load-source="docdb">SM</country><country mxw-id="DS660622616" load-source="docdb">TR</country></ep-contracting-states><ep-extended-states><ep-extended-state-data><country>BA</country></ep-extended-state-data><ep-extended-state-data><country>ME</country></ep-extended-state-data></ep-extended-states></designated-states></international-convention-data><office-specific-data><eptags><ep-no-a-document-published>*</ep-no-a-document-published></eptags></office-specific-data></bibliographic-data><abstract mxw-id="PA139076743" ref-ucid="WO-2014129155-A1" lang="EN" load-source="patent-office"><p num="0000">A method for controlling a communication apparatus, includes specifying, before joining a wireless network, an external device that will be a data transmitting source, receiving related information relating to data to be transmitted from the specified external device, determining whether to receive the data to be transmitted based on the received related information, joining a wireless network when it is determined to receive the data to be transmitted, and receiving the data to be transmitted from the specified external device after joining the wireless network.</p></abstract><abstract mxw-id="PA139543712" ref-ucid="WO-2014129155-A1" lang="EN" source="national office" load-source="docdb"><p>A method for controlling a communication apparatus, includes specifying, before joining a wireless network, an external device that will be a data transmitting source, receiving related information relating to data to be transmitted from the specified external device, determining whether to receive the data to be transmitted based on the received related information, joining a wireless network when it is determined to receive the data to be transmitted, and receiving the data to be transmitted from the specified external device after joining the wireless network.</p></abstract><abstract mxw-id="PA139076744" ref-ucid="WO-2014129155-A1" lang="FR" load-source="patent-office"><p num="0000">L'invention concerne un procédé pour commander un appareil de communication, consistant à spécifier, avant la connexion à un réseau sans fil, un dispositif externe qui sera une source d'émission de données, à recevoir des informations liées relatives aux données à faire émettre par le dispositif externe spécifié, à déterminer s'il faut recevoir les données à émettre d'après les informations liées reçues, à se connecter à un réseau sans fil si l'on a déterminé qu'il faut recevoir les données à émettre, et à recevoir du dispositif externe spécifié les données à émettre après la connexion au réseau sans fil.</p></abstract><abstract mxw-id="PA139543713" ref-ucid="WO-2014129155-A1" lang="FR" source="national office" load-source="docdb"><p>L'invention concerne un procédé pour commander un appareil de communication, consistant à spécifier, avant la connexion à un réseau sans fil, un dispositif externe qui sera une source d'émission de données, à recevoir des informations liées relatives aux données à faire émettre par le dispositif externe spécifié, à déterminer s'il faut recevoir les données à émettre d'après les informations liées reçues, à se connecter à un réseau sans fil si l'on a déterminé qu'il faut recevoir les données à émettre, et à recevoir du dispositif externe spécifié les données à émettre après la connexion au réseau sans fil.</p></abstract><description mxw-id="PDES78479390" ref-ucid="WO-2014129155-A1" lang="EN" load-source="patent-office"><invention-title lang="EN">COMMUNICATION APPARATUS, CONTROL METHOD THEREOF, AND PROGRAM</invention-title><technical-field><p num="0001">
The present invention relates to a communication apparatus capable of communicating with an external device.
</p></technical-field><background-art><p num="0002">
With the spread of wireless communication, an image file can now be transmitted by mounting a wireless communication function even on a portable terminal, such as a digital camera (PTL 1).  For example, when performing data communication using a wireless local area network (LAN), such a method as first joining a wireless LAN network and then establishing communication with an external device on the network may be employed.  In this case, the confirmation of whether the transmission and reception of the file to/from an external device is being properly performed is typically performed after communication has been established with the external device.
</p></background-art><citation-list><patent-literature><p num="0003"><patcit num="1"><text>Japanese Patent Application Laid-Open No. 2009-152689</text></patcit></p></patent-literature></citation-list><?BRFSUM description="Brief Summary" end="lead"?><summary-of-invention><tech-problem><p num="0004">
However, after a connection based on a wireless layer and communication with an external device have been established, if it is determined that the transmission and reception of data with the external device cannot be performed properly, the connection processing performed up to that point is wasted.
</p></tech-problem><tech-solution><p num="0005">
 According to an aspect of the present invention, a communication apparatus includes a specifying unit configured to, before joining a wireless network, specify an external device that will be a data transmitting source, a first receiving unit configured to receive related information relating to data to be transmitted from the external device specified by the specifying unit, a determination unit configured to determine whether to receive the data to be transmitted based on the related information received by the receiving unit, a network joining unit configured to join a wireless network when the determination unit determines to receive the data to be transmitted, and a second receiving unit configured to receive the data to be transmitted from the external device specified by the specifying unit after the communication apparatus has joined the wireless network via the joining unit.
</p></tech-solution><advantageous-effects><p num="0006">
According to the present invention, the probability of wasteful connection processing being executed can be reduced.
</p></advantageous-effects></summary-of-invention><?BRFSUM description="Brief Summary" end="tail"?><description-of-drawings><p num="0007"><figref num="1">Fig. 1 is a block diagram of a communication apparatus according to the present invention.</figref><figref num="2">Fig. 2 is a software function block diagram of a communication apparatus according to the present invention.</figref><figref num="3">Fig. 3 illustrates an example of a network configuration by a communication apparatus according to the present invention.</figref><figref num="4">Fig. 4 illustrates an example of management information in a communication apparatus according to the present invention.</figref><figref num="5">Fig. 5 is a sequence diagram between communication apparatuses according to the present invention.</figref><figref num="6">Fig. 6 is a flowchart illustrating operation of a communication apparatus according to the present invention.</figref><figref num="7">Fig. 7 illustrates an example of a GUI screen of a communication apparatus according to the present invention.</figref></p></description-of-drawings><description-of-embodiments><p num="0008">
A communication apparatus according to a first exemplary embodiment will now be described with reference to the drawings.  Although the following description will be made using a wireless LAN system based on the Institute of Electrical and Electronics Engineers (IEEE) 802.11 series as an example, the communication format is not limited to a wireless LAN system based on IEEE 802.11.
</p><p num="0009">
An example of the hardware configuration according to the present exemplary embodiment will now be described.
</p><p num="0010">
Fig. 1 is a block diagram illustrating an example of the configuration of the respective apparatuses that are described below according to an exemplary embodiment to which the present invention can be applied.  An overall apparatus 101 includes a control unit 102, which controls the overall apparatus by executing a control program stored in a storage unit 103.  The control unit 102 includes one or a plurality of processors, such as a central processing unit (CPU) or a micro-processing unit (MPU).  The control unit 102 also controls the setting of a communication parameter between this apparatus and another apparatus.  The storage unit 103 stores the control program executed by the control unit 102 and various kinds of information, such as a communication parameter.  Further, image data and files generated by the communication apparatus or received from an external device may also be stored in the storage unit 103.  The storage unit 103 may be configured from various types of memories, such as a read-only memory (ROM), a random-access memory (RAM), a hard disk drive (HDD), and a flash memory.  Each of the operations that are described below is performed by the control unit 102 executing a control program stored in the storage unit 103.
</p><p num="0011">
A wireless unit 104 performs wireless LAN communication based on the IEEE 802.11 series.  A display unit 105 for presenting various displays has a function of outputting visually perceivable information like a liquid crystal display (LCD) or a light-emitting diode (LED), or a function capable of outputting sound like a speaker.  The display unit 105 includes at least either the function of outputting visual information or sound information.
</p><p num="0012">
An antenna control unit 106 controls an antenna 107, so that signals are transmitted and received by wireless communication.  An operation unit 108 lets the user perform various inputs for operating the communication apparatus.  The operation unit 108 is configured from various buttons, a touch panel, and the like.
</p><p num="0013">
A service providing unit 109 includes a function of providing service information about an application level provided by the communication apparatus.  For example, if this communication apparatus is a printer, the service providing unit 109 provides a printing function, and if the communication apparatus is a digital camera, the service providing unit 109 provides an imaging function.
</p><p num="0014">
Note that Fig. 1 is merely an example.  The communication apparatus 101 may include hardware units other than the hardware units illustrated in Fig. 1.
</p><p num="0015">
Fig. 2 is a block diagram illustrating an example of a configuration of the software function blocks executing the communication control functions described below.  A overall software function block 201 includes a Discovery control unit 202 that operates search processing for searching for a communication apparatus that will be a communication counterparty.
</p><p num="0016">
A GO Negotiation control unit 203 performs control based on a Wi-Fi Direct protocol specification to determine the roles to be performed in the wireless layer, such as which communication apparatus will serve as an access point and which communication apparatus will serve as a wireless LAN station.  In Wi-Fi Direct, the communication apparatus performing the wireless LAN access point function is referred to as a P2P group owner (hereinafter, "GO"), and the communication apparatus performing the wireless LAN station function is referred to as a P2P client (hereinafter, "CL").  If the communication apparatus is to act as the GO or the wireless LAN access point, a below-described wireless LAN access point function control unit 211 is started.  If the communication apparatus is to act as the CL or the wireless LAN station, a below-described wireless LAN station function control unit 210 is started.  The protocol of this GO Negotiation is determined based on the Wi-Fi Direct protocol specification.  Since this is not a major point of the present invention, a description thereof will be omitted here.  In Wi-Fi Direct, a network built by GO is referred to as a P2P group.  In the present specification too, a network is also sometimes described as a P2P group.  In the present exemplary embodiment, these terms are used with the same meaning.
</p><p num="0017">
Further, in the present specification, the P2P group owner (GO), P2P client (CL), and a group of communication apparatuses whose roles have not yet been determined are collectively referred to as P2P devices.
</p><p num="0018">
A dynamic host configuration protocol (DHCP) client control unit 204 is started when the role of the communication apparatus is determined by the GO Negotiation control unit 203 to be as a wireless LAN station.  A DHCP server control unit 205 is started when the role of the communication apparatus is determined by the GO Negotiation control unit 203 to be as a wireless LAN access point.
</p><p num="0019">
A Wi-Fi protected setup (WPS) enrollee control unit 206 receives a communication parameter required for wireless LAN communication from another WPS registrar apparatus.  Similar to the DHCP client control unit 204, the WPS enrollee control unit 206 is started when the role of that communication apparatus is determined to be as a wireless LAN station.  A WPS registrar control unit 207 provides a communication parameter required for wireless LAN communication to another WPS enrollee apparatus.  Similar to the DHCP server control unit 205, the WPS registrar control unit 207 is started when the role of that communication apparatus is determined to be as a wireless LAN access point.  Examples of the communication parameter provided by the WPS registrar include a service set identifier (SSID) as a network identifier, an encryption key, an encryption method, an authentication key, an authentication method and the like.
</p><p num="0020">
A wireless LAN packet receiving unit 208 and a wireless LAN packet transmission unit 209 control the transmission and reception of all packets, including those for higher layer transmission protocol.  The wireless LAN station function control unit 210 performs authentication and encryption processing when the apparatus operates as a wireless LAN station, and joins a wireless network built by an apparatus operating as a wireless LAN access point.  The wireless LAN access point function control unit 211 builds a wireless network when that apparatus operates as a wireless LAN access point, and performs authentication and encryption processing and manages communication apparatus counterparties, for example.  The wireless LAN station function control unit 210 and the wireless LAN access point function control unit 211 can operate just either one of these functions or operate both of these functions simultaneously.
</p><p num="0021">
A packet routing control unit 212 performs bridging and routing of communication packets when the wireless LAN access point function control unit 211 is operating.  A data storage unit 213 stores the software itself, wireless LAN parameters, and various tables such as a DHCP address table and Address Resolution Protocol (ARP) table.
</p><p num="0022">
A service discovery control unit 214 controls a service discovery function that is unique to Wi-Fi Direct.  The service discovery function exchanges service information held by a communication counterparty apparatus by transmitting and receiving an action frame defined in IEEE 802.11u.  Specifically, the service discovery control unit 214 transmits an SD query, and receives an SD response as a response.  Alternatively, the service discovery control unit 214 receives an SD query from a counterparty apparatus, and transmits an SD response as a response.
</p><p num="0023">
A P2P invitation function control unit 215 controls an invitation function defined in the Wi-Fi Direct standard.  Since this invitation function is defined in the Wi-Fi Direct standard, a description thereof will be omitted here, although it is a function that prompts a P2P device whose role as a GO device or as a CL device has not yet been determined to be connected as a P2P client.
</p><p num="0024">
A service providing unit 216 provides an application layer service.  The term application layer refers to a service providing layer that is fifth layer or higher in the open systems interconnection (OSI) reference model.  In other words, the service providing unit 216 provides, for example, a printing service or a file transmitting service.
</p><p num="0025">
A service utilization unit 217 in the application layer utilizes the service provided by the service providing unit 216 of the application layer of the counterparty apparatus.  In other words, the service utilization unit 217 controls a function of transmitting a printed product to the printing service providing apparatus.
</p><p num="0026">
Not all of the function blocks illustrated in Fig. 2 have to be provided by software, at least a portion of the function blocks may be provided by software.  Further, each of the function blocks illustrated in Fig. 2 is interrelated with the other blocks.  Moreover, the respective function blocks illustrated in Fig. 2 are just an example.  A plurality of function blocks may configure one function block, or any one of the function blocks may be divided into a plurality blocks to perform a plurality of functions.
</p><p num="0027">
Further, in the present exemplary embodiment, the service in the application layer is realized by an apparatus that provides that service and an apparatus that utilizes that service.  If, for example, the service in the application layer is a printing service, the service providing apparatus 216 is a printer, and printing is performed by receiving print data transmitted from a personal computer (PC) and the like.  In this example, the service utilizing apparatus is an apparatus such as a PC, which generates print data and transmits the generated print data to the printer as the service providing apparatus.  Moreover, if, for example, the service is an image streaming service, the service providing apparatus 216 is a display apparatus, which receives and displays image data transmitted from a PC and the like.  In this example, the service utilizing apparatus is an apparatus such as a PC, which generates image data and transmits the generated image data to the display apparatus as the service providing apparatus.
</p><p num="0028">
Fig. 3 illustrates a network A31 (hereinafter, "network A") configured from a communication apparatus A32 (hereinafter, "STA-A") and a communication apparatus B33 (hereinafter, "STA-B").  All of these apparatuses have the configuration illustrated in the above-described Figs. 1 and 2.
</p><p num="0029">
Fig. 4 illustrates an example of file reception history information in the communication apparatus.  The reception history information is managed by the storage unit 103.  In the reception history information, information (file name and size) about files received in the past is recorded.  The method for recording the reception history information will be described below with reference to Fig. 6.
</p><p num="0030">
Fig. 5 is a schematic diagram illustrating an operation sequence between communication apparatuses.  In the example illustrated in Fig. 5, the STA-A acts as the file transmitting service providing apparatus, and the STA-B acts as the file transmitting service utilizing apparatus.
</p><p num="0031">
In step F501, the STA-A starts an operation for providing a file transmitting service.
</p><p num="0032">
In step F502, to utilize the file transmitting service, the STA-B transmits an inquiry signal to detect the communication apparatus that is providing the file transmitting service.  Then, in step F503, since the STA-A, which has received the inquiry signal, is providing the file transmitting service, the STA-A transmits a detection response signal to the STA-B.  If the STA-A does not support or is not providing the service indicated by the detection signal (i.e., the file transmitting service), the STA-A either does not respond to the detection signal, or issues an error response.  Based on this processing, the STA-A and the STA-B can specify each of the devices supporting the file transmitting service as a device capable of transmitting and receiving data.  If there is a plurality of devices supporting a file transmitting service in the vicinity, a list of the detected services may be displayed on the display unit 105 of the STA-A, and the service that is transmitting and receiving data (i.e., the device that will be the communication counterparty) may be specified based on a user operation.
</p><p num="0033">
In step F504, the STA-B, which has received the detection response signal, transmits to the STA-A a signal requesting a wireless LAN connection.  In this step, the STA-B also notifies the file information (file name and size), which is related information about the file to be transmitted, by utilizing a Public Action frame described in IEEE 802.11.  In step F505, the STA-A, which has received the connection request signal, determines whether the file indicated by the file information has already been received, and if that file has not already been received, transmits to the STA-B a signal permitting the wireless LAN connection.  This determination method will be described below with reference to Fig. 6.  Further, in the present exemplary embodiment, at the stage of step F505, the STA-A and the STA-B are not connected by the wireless layer.  In other words, the STA-A and the STA-B have not yet started connection processing based on Wi-Fi Direct, and have not joined a wireless LAN network.
</p><p num="0034">
In step F506, the STA-B, which has received the permission response signal, performs connection processing with the STA-A based on the wireless layer, and the predetermined connection processing prescribed in the file transmitting service.  Connection processing based on the wireless layer is connection processing that is based on the above-described Wi-Fi Direct specification.  More specifically, either one of the STA-A and the STA-B becomes the P2P group owner, and the other becomes the P2P client.  A connection is made by the CL joining a wireless network built by the GO.  By performing such network joining processing, the STA-A and the STA-B belong to the same wireless network.
</p><p num="0035">
Although an example is described here in which the apparatus according to the present exemplary embodiment performs connection processing based on the wireless layer after service detection, the connection processing based on the wireless layer may be performed in advance, and in step F506 only the service connection processing may be performed.
</p><p num="0036">
After the connection processing has been completed, in step F507, the STA-B transmits the file to the STA-A by utilizing the file transmitting service.
</p><p num="0037">
After file transmission has been completed, in step F508, the STA-B transmits a wireless LAN connection finishing request to the STA-A.  In step F509, the STA-A, which has received the finishing request, transmits a finishing response to the STA-B.
</p><p num="0038">
If, for example, after the wireless LAN connection has finished, in step F510, the STA-B again transmits to the STA-A a signal requesting a wireless LAN connection, and in this case, in step F512, the file information included in the connection request signal is the same as the file information transmitted.  Since the STA-A that received the connection request signal has already received the file indicated by the file information, in step F504, the STA-A transmits a signal rejecting a wireless LAN connection.  This rejection response may include an error message that the file to be transmitted has already been received.
</p><p num="0039">
Fig. 6 is a flowchart illustrating a case in which the communication apparatus according to the present exemplary embodiment operates as a file transmitting service providing apparatus.  This flowchart illustrates operations that are performed after the STA-A has transmitted the response in step F503 illustrated in Fig. 5.  Each step in this flowchart is performed by the control unit 102 executing a program stored in the storage unit 103.
</p><p num="0040">
In step S601, the STA-A waits to receive a wireless connection request signal from the STA-B.  If a signal is not received (NO in step S601), the STA-A continues to wait until a predetermined time has elapsed.  If a signal is received (YES in step S601), the processing proceeds to step S602.
</p><p num="0041">
In step S602, the STA-A temporarily stores the file information received in step S601 in the storage unit 103.
</p><p num="0042">
In step S603, the STA-A determines whether the file indicated by the file information received in step S601 has already been received.  Specifically, the STA-A refers to the reception history information illustrated in Fig. 4, and determines whether a combination is present that matches both the file name and size in the file information.  If a combination is not present, it is determined that the subject file has not been received (NO in step S603), and the processing proceeds to step S604.  On the other hand, if a combination is present, it is determined that the subject file has already been received (YES in step S603), and the processing proceeds to step S610.
</p><p num="0043">
In step S604, the STA-A transmits to the STA-B a signal for permitting the wireless LAN connection.  Step S604 corresponds to the processing by the STA-A performed in step F505 in Fig. 5.
</p><p num="0044">
In step S605, the STA-A performs connection processing with the STA-B based on a wireless layer, and the predetermined connection processing prescribed in the file transmitting service.  Step S605 corresponds to the processing by the STA-A performed in step F506 in Fig. 5.
</p><p num="0045">
In step S606, the STA-A receives the file from the STA-B by utilizing the file transmitting service.  Step S606 corresponds to the processing by the STA-A performed in step F507 in Fig. 5.
</p><p num="0046">
In step S607, the STA-A determines whether the receiving processing performed in step S606 was successful.  For example, if the time taken for the file receiving processing exceeds a predetermined duration, the STA-A determines that the receiving processing was not successful.  If it is determined that the receiving processing was successful (YES in step S607), the processing proceeds to step S608, and if it is determined that the receiving processing was not successful (NO in step S607), the processing proceeds to step S611.
</p><p num="0047">
In step S608, the STA-A adds and records the file information stored in step S602 in the reception history information illustrated in Fig. 4.
</p><p num="0048">
In step S609, the STA-A finishes the wireless connection with the STA-B.  Step S609 corresponds to the processing by the STA-A performed in steps F508 and F509 in Fig. 5.
</p><p num="0049">
In step S610, the STA-A transmits to the STA-B a signal for rejecting the wireless LAN connection.  Step S610 corresponds to the processing by the STA-A performed in step F512 in Fig. 5.  In this case, the STA-A can reject the connection with the STA-B before establishing a connection based on a wireless layer.
</p><p num="0050">
In step S611, the STA-A transmits to the STA-B the fact that file reception was not successful.
</p><p num="0051">
In step S612, the STA-A deletes the file information stored in step S602 from the storage unit 103.
</p><p num="0052">
Fig. 7 is an example of a communication apparatus graphical user interface (GUI) according to the present exemplary embodiment.  The screen illustrated in Fig. 7 is displayed on the 105 under the control of the control unit 102, and the user can request predetermined processing by operating the operation unit 108.
</p><p num="0053">
A file transmitting error screen 701 is displayed when the connection rejection response described in step F512 is received while the communication apparatus is operating as the service utilizing apparatus (STA-B) illustrated in Fig. 5.  This rejection response includes an error message indicating that the file to be transmitted has already been received.  When an icon 702 is selected, the STA-B changes the file name included in the wireless connection request, and transmits a request signal to the STA-A.  When an icon 703 is selected, the file transmitting service utilization processing is finished.
</p><p num="0054">
Thus, according to the present exemplary embodiment, a communication apparatus operating as a service providing apparatus can prevent unnecessary wireless connections by issuing a response rejecting a connection when a wireless connection is requested for the file transmission of an already received file.<br/>
 
</p><p num="0055">
The above-described first exemplary embodiment, which illustrates an example for carrying out the present invention, may be subjected to various modifications, as long as such modifications do not depart from the gist of the present invention.
</p><p num="0056">
The communication apparatus according to the above-described first exemplary embodiment is not limited to a digital camera, a printer, and the like.  The communication apparatus may be a PC, a tablet terminal, or a mobile terminal such as a mobile telephone or a smartphone.  Further, the communication apparatus may be an image processing apparatus, such as a copying machine, a scanner, a facsimile machine, a multifunction peripheral, or a digital household appliance, such as a television or a recorder.
</p><p num="0057">
Although the above-described first exemplary embodiments is described using a wireless LAN based on IEEE 802.11 as an example, the present invention may also be performed based on other types of wireless communication, such as wireless universal serial bus (USB), MultiBand OFDM Alliance (MBOA), Bluetooth (registered trade mark), ultra-wide band (UWB), and ZigBee (registered trade mark).  Further, the present invention may also be performed in a wired communication medium, such as wired LAN.  Further, UWB includes wireless USB, wireless 1394, WINET, and the like.
</p><p num="0058">
Further, the information used to determine whether a file has already been received is not limited to the above-described file information (file name and size). For example, when the wireless connection request is received, the transmitting source may be determined by acquiring the media access control (MAC) address of the transmitting source apparatus from the received frame, and performing the following processing.  Specifically, if the transmitting source is different, a wireless LAN connection may be established even if the file name is the same, and the file is received.  If the transmitting source is the same, a wireless LAN connection is not established.
</p><p num="0059">
In addition, time and date information about the received file may be stored as the reception history information, and files received before a predetermined time may be excluded from the files that are subjected to processing to determine whether they have already been received.
</p><p num="0060">
The reception history information may also be synchronized with a file system in the communication apparatus.  For example, the reception history information may be configured so that if a file in the communication apparatus is deleted, then the information about that corresponding file is also deleted from the reception history.
</p><p num="0061">
Further, if a change request for the file information is received from the transmitting apparatus before the file is received, the file information recorded in the reception history may be changed based on the request content.  With this configuration, a determination can be made regarding whether a file has already been received based on the changed file information.
</p><p num="0062">
In addition, the applications of the file information are also not limited to determining whether a file has already been received.  For example, in Fig. 5, the STA-A may compare the file size included in the file information with the available capacity in its own storage unit, and if it is determined that there is not enough available capacity to receive the file, transmit a rejection response to the STA-B.
</p><p num="0063">
Still further, the STA-A may also determine whether the file to be transmitted is in a file format that can be handled by the STA-A based on the file name extension included in the file information.  If the file to be transmitted is in a file format that can be handled by the STA-A, the STA-A transmits a permission response, and if the file to be transmitted is not in a file format that can be handled by the STA-A, the STA-A transmits a rejection response.
</p><p num="0064">
Aspects of the present invention can also be realized by a computer of a system or apparatus (or devices such as a CPU or MPU) that reads out and executes software (a program code) recorded on a memory device (computer-readable medium) to perform the functions of the above-described embodiments.  In such a case, this program, and the storage medium in which the program is stored, are included as being within the scope of the present invention.<br/>
[0065]    While the present invention has been described with reference to exemplary embodiments, it is to be understood that the invention is not limited to the disclosed exemplary embodiments.  The scope of the following claims is to be accorded the broadest interpretation so as to encompass all such modifications and equivalent structures and functions.<br/>
[0066]    This application claims the benefit of Japanese Patent Application No. 2013-033505 filed February 22, 2013, which is hereby incorporated by reference herein in its entirety.<br/>
 
</p></description-of-embodiments></description><claims mxw-id="PCLM70079696" ref-ucid="WO-2014129155-A1" lang="EN" load-source="patent-office"><claim num="1"><claim-text>
A communication apparatus comprising:<br/>
a specifying unit configured to, before joining a wireless network, specify an external device that will be a data transmitting source;<br/>
a first receiving unit configured to receive related information relating to data to be transmitted from the external device specified by the specifying unit;<br/>
a determination unit configured to determine whether to receive the data to be transmitted based on the related information received by the receiving unit;<br/>
a network joining unit configured to join a wireless network when the determination unit determines to receive the data to be transmitted; and<br/>
a second receiving unit configured to receive the data to be transmitted from the external device specified by the specifying unit after the communication apparatus has joined the wireless network via the joining unit.
</claim-text></claim><claim num="2"><claim-text>
The communication apparatus according to claim 1,<br/>
wherein the related information includes a name of the data to be transmitted, and<br/>
wherein the determination unit is configured to determine not to receive the data to be transmitted if the communication apparatus has data with the same name as the name of the data to be transmitted.
</claim-text></claim><claim num="3"><claim-text>
The communication apparatus according to claim 2, further comprising a transmitting unit configured to transmit a rejection signal to the external device if the determination unit determines not to receive the data to be transmitted.
</claim-text></claim><claim num="4"><claim-text>
The communication apparatus according to claim 2, further comprising a transmitting unit configured to transmit a permission signal to the external device before joining a wireless network via the joining unit if i the determination unit determines to receive the data to be transmitted.
</claim-text></claim><claim num="5"><claim-text>
The communication apparatus according to any one of claims 1 to 4, wherein the joining of the wireless network by the joining unit is performed not via a device other than the external device.
</claim-text></claim><claim num="6"><claim-text>
A method for controlling a communication apparatus, the method comprising:<br/>
specifying, before joining a wireless network, an external device that will be a data transmitting source;<br/>
receiving related information relating to data to be transmitted from the specified external device;<br/>
determining whether to receive the data to be transmitted based on the received related information;<br/>
joining a wireless network when it is determined to receive the data to be transmitted; and<br/>
receiving the data to be transmitted from the specified external device after joining the wireless network.
</claim-text></claim><claim num="7"><claim-text>
A computer-readable program that causes a computer to function as each unit in the communication apparatus according to any one claims 1 to 5.<br/>
 
</claim-text></claim></claims><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
