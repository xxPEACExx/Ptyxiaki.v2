<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2961098-A1" country="EP" doc-number="2961098" kind="A1" date="20151230" family-id="51912365" file-reference-id="318327" date-produced="20180824" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="160451234" ucid="EP-2961098-A1"><document-id><country>EP</country><doc-number>2961098</doc-number><kind>A1</kind><date>20151230</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-14873118-A" is-representative="NO"><document-id mxw-id="PAPP193865436" load-source="docdb" format="epo"><country>EP</country><doc-number>14873118</doc-number><kind>A</kind><date>20140402</date><lang>ZH</lang></document-id><document-id mxw-id="PAPP193865437" load-source="patent-office" format="original"><country>EP</country><doc-number>14873118.5</doc-number><date>20140402</date><lang>ZH</lang></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC162029038" ucid="CN-2014074584-W" linkage-type="A" load-source="docdb"><document-id format="epo"><country>CN</country><doc-number>2014074584</doc-number><kind>W</kind><date>20140402</date></document-id></priority-claim></priority-claims><technical-data><classifications-ipcr><classification-ipcr mxw-id="PCL-1984697213" load-source="docdb">G06F  11/22        20060101ALI20151218BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1984698212" load-source="docdb">G06F  13/42        20060101ALI20151218BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1984699205" load-source="docdb">G06F  13/40        20060101ALI20151218BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1984703166" load-source="docdb">H04L  12/24        20060101AFI20151218BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-1984703757" load-source="docdb">G06F  11/30        20060101ALI20151218BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-1702753174" load-source="docdb" scheme="CPC">G06F  11/0745      20130101 LI20180130BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1925885486" load-source="docdb" scheme="CPC">G06F  13/4221      20130101 LA20151113BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1987786314" load-source="docdb" scheme="CPC">G06F  11/3027      20130101 FI20151113BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1987799108" load-source="docdb" scheme="CPC">G06F  13/4022      20130101 LI20151113BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1987800707" load-source="docdb" scheme="CPC">G06F  11/221       20130101 LI20151113BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT165545168" lang="DE" load-source="patent-office">VERFAHREN, VORRICHTUNG UND SYSTEM ZUR VERARBEITUNG EINES PCIE-VERBINDUNGSFEHLERS</invention-title><invention-title mxw-id="PT165545169" lang="EN" load-source="patent-office">METHOD, DEVICE AND SYSTEM FOR PROCESSING PCIE LINK FAILURE</invention-title><invention-title mxw-id="PT165545170" lang="FR" load-source="patent-office">PROCÉDÉ, DISPOSITIF ET SYSTÈME DE TRAITEMENT DE DÉFAILLANCE DE LIAISON PCIE</invention-title></technical-data><parties><applicants><applicant mxw-id="PPAR1103314110" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>HUAWEI TECH CO LTD</last-name><address><country>CN</country></address></addressbook></applicant><applicant mxw-id="PPAR1103333802" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>HUAWEI TECHNOLOGIES CO. LTD.</last-name></addressbook></applicant><applicant mxw-id="PPAR1101653092" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Huawei Technologies Co. Ltd.</last-name><iid>101551478</iid><address><street>Huawei Administration Building Bantian Longgang District</street><city>Shenzhen, Guangdong 518129</city><country>CN</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR1103321453" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>DU GE</last-name><address><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR1103317162" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>DU, Ge</last-name></addressbook></inventor><inventor mxw-id="PPAR1101639500" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>DU, Ge</last-name><address><street>Huawei Administration Building Bantian Longgang</street><city>Shenzhen Guangdong 518129</city><country>CN</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR1101642601" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Pfenning, Meinig &amp; Partner GbR</last-name><iid>100060642</iid><address><street>Patent- und Rechtsanwälte Theresienhöhe 11a</street><city>80339 München</city><country>DE</country></address></addressbook></agent></agents></parties><international-convention-data><pct-or-regional-filing-data ucid="CN-2014074584-W"><document-id><country>CN</country><doc-number>2014074584</doc-number><kind>W</kind><date>20140402</date><lang>ZH</lang></document-id></pct-or-regional-filing-data><pct-or-regional-publishing-data ucid="WO-2015149293-A1"><document-id><country>WO</country><doc-number>2015149293</doc-number><kind>A1</kind><date>20151008</date><lang>ZH</lang></document-id></pct-or-regional-publishing-data><designated-states><ep-contracting-states><country mxw-id="DS660607180" load-source="docdb">AL</country><country mxw-id="DS660604191" load-source="docdb">AT</country><country mxw-id="DS660607182" load-source="docdb">BE</country><country mxw-id="DS660684332" load-source="docdb">BG</country><country mxw-id="DS660681806" load-source="docdb">CH</country><country mxw-id="DS660606958" load-source="docdb">CY</country><country mxw-id="DS660604192" load-source="docdb">CZ</country><country mxw-id="DS660607183" load-source="docdb">DE</country><country mxw-id="DS660606963" load-source="docdb">DK</country><country mxw-id="DS660606964" load-source="docdb">EE</country><country mxw-id="DS660682305" load-source="docdb">ES</country><country mxw-id="DS660684333" load-source="docdb">FI</country><country mxw-id="DS660684334" load-source="docdb">FR</country><country mxw-id="DS660607184" load-source="docdb">GB</country><country mxw-id="DS660606965" load-source="docdb">GR</country><country mxw-id="DS660607185" load-source="docdb">HR</country><country mxw-id="DS660604193" load-source="docdb">HU</country><country mxw-id="DS660681815" load-source="docdb">IE</country><country mxw-id="DS660606966" load-source="docdb">IS</country><country mxw-id="DS660684343" load-source="docdb">IT</country><country mxw-id="DS660606971" load-source="docdb">LI</country><country mxw-id="DS660681746" load-source="docdb">LT</country><country mxw-id="DS660604194" load-source="docdb">LU</country><country mxw-id="DS660681751" load-source="docdb">LV</country><country mxw-id="DS660681752" load-source="docdb">MC</country><country mxw-id="DS660782309" load-source="docdb">MK</country><country mxw-id="DS660782310" load-source="docdb">MT</country><country mxw-id="DS660682306" load-source="docdb">NL</country><country mxw-id="DS660604199" load-source="docdb">NO</country><country mxw-id="DS660782311" load-source="docdb">PL</country><country mxw-id="DS660606972" load-source="docdb">PT</country><country mxw-id="DS660682311" load-source="docdb">RO</country><country mxw-id="DS660606973" load-source="docdb">RS</country><country mxw-id="DS660782312" load-source="docdb">SE</country><country mxw-id="DS660607186" load-source="docdb">SI</country><country mxw-id="DS660604200" load-source="docdb">SK</country><country mxw-id="DS660782313" load-source="docdb">SM</country><country mxw-id="DS660681816" load-source="docdb">TR</country></ep-contracting-states><ep-extended-states><ep-extended-state-data><country>BA</country></ep-extended-state-data><ep-extended-state-data><country>ME</country></ep-extended-state-data></ep-extended-states></designated-states></international-convention-data></bibliographic-data><abstract mxw-id="PA166479604" lang="EN" load-source="patent-office"><p id="pa01" num="0001">The present invention discloses a method, device, and system for processing a PCIe link fault. When detecting that a fault occurs in a lane of a link between a PCIe apparatus and a downstream PCIe apparatus, the PCIe apparatus sends an MSI message to a CPU, and negotiates a current lane width value with the downstream PCIe apparatus; the CPU acquires a lane negotiation capability value M and the current lane width value M of the PCIe apparatus from the PCIe apparatus according to the MSI message, and compares N and M/2; when N&lt;M/2, the PCIe apparatus performs a lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus, and then negotiates a new current lane width value with the downstream PCIe apparatus. In this way, when a fault occurs in a lane of a link between PCIe apparatuses, using the technical solutions of the present invention can ensure that half lanes of the original link can be provided for the two PCIe apparatuses to continue to perform data transmission regardless of a number of the faulty lane, which eases restriction of a lane number of a faulty lane that is imposed on a link width in the prior art, so that an optimal link width can be achieved after re-negotiation.<img id="iaf01" file="imgaf001.tif" wi="78" he="100" img-content="drawing" img-format="tif"/></p></abstract><abstract mxw-id="PA166759416" lang="EN" source="EPO" load-source="docdb"><p>The present invention discloses a method, device, and system for processing a PCIe link fault. When detecting that a fault occurs in a lane of a link between a PCIe apparatus and a downstream PCIe apparatus, the PCIe apparatus sends an MSI message to a CPU, and negotiates a current lane width value with the downstream PCIe apparatus; the CPU acquires a lane negotiation capability value M and the current lane width value M of the PCIe apparatus from the PCIe apparatus according to the MSI message, and compares N and M/2; when N&lt;M/2, the PCIe apparatus performs a lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus, and then negotiates a new current lane width value with the downstream PCIe apparatus. In this way, when a fault occurs in a lane of a link between PCIe apparatuses, using the technical solutions of the present invention can ensure that half lanes of the original link can be provided for the two PCIe apparatuses to continue to perform data transmission regardless of a number of the faulty lane, which eases restriction of a lane number of a faulty lane that is imposed on a link width in the prior art, so that an optimal link width can be achieved after re-negotiation.</p></abstract><description mxw-id="PDES98404305" lang="EN" load-source="patent-office"><!-- EPO <DP n="1"> --><heading id="h0001"><b>TECHNICAL FIELD</b></heading><p id="p0001" num="0001">The present invention relates to the field of data transmission technologies, and in particular, to a method, device, and system for processing a PCIe link fault.</p><heading id="h0002"><b>BACKGROUND</b></heading><p id="p0002" num="0002">Currently, in the field of data transmission technologies, the PCIe (Peripheral Component Interconnect Express, Peripheral Component Interconnect Express) protocol has been widely applied. When the PCIe protocol is applied to devices, data transmission is performed between the devices in a point-to-point form. Devices performing data transmission by using the PCIe protocol are collectively referred to as PCIe apparatuses. In a system, a link connection can be implemented for communication between two PCIe apparatus by using a serializer/de-serializer (serdes, Serializer/De-Serializer) circuit. When the two PCIe apparatuses perform data transmission, data transmission is performed by using the serdes at a negotiated rate. A link between the two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 serdeses. When there are multiple serdeses, these serdeses are successively numbered by using continuous numbers in ascending order. One serdes is one lane (lane) of the link, and a serdes number is referred to as a lane number.</p><p id="p0003" num="0003">A bandwidth (W) of data transmission between two PCIe apparatuses is equal to a product of a quantity of lanes (N) and a negotiated rate (S), that is, a bandwidth formula is W=N×S. The negotiated rate (S) of the link between the two PCIe apparatuses varies with a version of the used PCIe protocol, and currently, there are four types of negotiated rates, which are GEN1 (2.5 GT/s), GEN2 (5.0 GT/s), GEN3 (8.0 GT/s), and GEN4 (16.0 GT/s), indicating a capacity of data that can be transmitted by one circuit in one second. Generally, a negotiated rate (S) supported by a link of one PCIe apparatus is fixed, and in this case, to meet increasingly high user requirements of a communication bandwidth (W), the bandwidth can be improved only by increasing the quantity of lanes (N) of the link.</p><p id="p0004" num="0004">When two PCIe apparatuses transmit data, all lanes of a link between the two PCIe apparatuses need to be used simultaneously. If a fault occurs in one of the lanes, data transmission is interrupted. In the prior art, when a fault occurs in a lane connected to a PCIe apparatus, the PCIe<!-- EPO <DP n="2"> --> apparatus performs link negotiation according to a re-negotiation mechanism of the PCIe protocol. During link negotiation, negotiation is performed starting from a lane with a smallest lane number, and link negotiation is successively performed in ascending order of lane number. A manner of performing link re-negotiation continuously in ascending order of lane number is referred to as upward negotiation. For example, when a fault occurs in a lane No. 2 of a PCIe apparatus that originally needs to negotiate for a rate of GEN2 and a link width of 16 (PCIe2.0×16), the PCIe apparatus performs link negotiation upward starting from a lane No. 0 according to the re-negotiation mechanism of the PCIe protocol. Negotiation cannot be performed successfully on the lane No. 2 because of the fault in the lane No. 2, and after negotiation is performed from the lane No. 0 to a lane No. 1, link negotiation cannot continue. In this case, negotiation is performed successfully only on 2 lanes: the lane No. 0 and the lane No. 1; that is, data transmission can continue only in the lane No. 0 and the lane No. 1. According to a lane width of a link between two PCIe apparatuses that is stipulated in the PCIe protocol, a lane width of the link between the two PCIe apparatuses is 2, which is obtained by means of re-negotiation; that is, only 2 lanes can be provided for the PCIe apparatuses to transmit data. In this case, N in the bandwidth formula is changed from the original 16 to 2, and performance of data transmission between the PCIe apparatuses is only 1/8 of original performance. However, if a fault occurs in the lane No. 1, only one lane can be negotiated for according to the foregoing re-negotiation method; in this case, data transmission performance is only 1/16 of the original performance.</p><p id="p0005" num="0005">It can be seen that in the prior art, when a fault occurs in a lane of a link between PCIe apparatuses, re-negotiation for a lane width of the link is greatly restricted by a lane number of the faulty lane, which leads to uncertainty about the lane width obtained by means of re-negotiation and a case in which the lane width is greatly reduced, severely affecting data transmission performance of a lane.</p><heading id="h0003"><b>SUMMARY</b></heading><p id="p0006" num="0006">In view of this, the present invention provides a method, device, and system for processing a PCIe link fault, so as to overcome the problem in the prior art that due to restriction of a lane number of a lane in which a fault occurs, uncertainty exists in a lane width obtained by means of re-negotiation and a case in which the lane width is greatly reduced may occur, which severely affects transmission performance of a lane.</p><p id="p0007" num="0007">A first aspect of the present invention provides a method for processing a PCIe link fault, including:
<ul><li>detecting, by a PCIe apparatus, that a fault occurs in a lane of a link between the PCIe<!-- EPO <DP n="3"> --> apparatus and a downstream PCIe apparatus, and sending a Message Signaled Interrupts MSI message to a central processing unit CPU, where the MSI message includes a device ID of the PCIe apparatus;</li><li>negotiating, by the PCIe apparatus, with the downstream PCIe apparatus to obtain a current lane width value N;</li><li>acquiring, by the CPU, a lane negotiation capability value M and the current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID in the received MSI message;</li><li>comparing, by the CPU, N and M/2;</li><li>if N&lt;M/2, instructing, by the CPU, the PCIe apparatus to perform a lane reversal operation;</li><li>performing, by the PCIe apparatus, the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus; and</li><li>negotiating, by the PCIe apparatus, with the downstream PCIe apparatus to obtain a new current lane width value N', and continuing to perform data transmission with the downstream PCIe apparatus by using N' lanes.</li></ul></p><p id="p0008" num="0008">In a first possible implementation manner of the first aspect, the method further includes: if N≥M/2, continuing, by the PCIe apparatus, to perform data transmission with the downstream PCIe apparatus by using N lanes obtained by means of negotiation.</p><p id="p0009" num="0009">With reference to the first aspect, or the first possible implementation manner of the first aspect, in a second possible implementation manner, if N&lt;M/2, the method further includes: disabling, by the CPU, lanes No. 0 to No. (M/2-1) of the link between the PCIe apparatus and the downstream PCIe apparatus.</p><p id="p0010" num="0010">A second aspect of the present invention provides a method for processing a PCIe link fault, including:
<ul><li>receiving a Message Signaled Interrupts MSI message reported by a PCIe apparatus, where the MSI message includes a device ID of the PCIe apparatus;</li><li>acquiring a lane negotiation capability value M and a current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID, where the current lane width value N is obtained by negotiating by the PCIe apparatus with a downstream PCIe apparatus;</li><li>comparing N and M/2; and if N&lt;M/2, instructing the PCIe apparatus to perform a lane reversal operation.</li></ul></p><p id="p0011" num="0011">In a first possible implementation manner of the second aspect, if N&lt;M/2, the method further includes: disabling lanes No. 0 to No. (M/2-1) of a link between the PCIe apparatus and the<!-- EPO <DP n="4"> --> downstream PCIe apparatus.</p><p id="p0012" num="0012">With reference to the second aspect, or the first possible implementation manner of the second aspect, in a second possible implementation manner, the lane negotiation capability value M of the PCIe apparatus is equal to a total quantity of lanes of the link between the PCIe apparatus and the downstream PCIe apparatus.</p><p id="p0013" num="0013">A third aspect of the present invention provides a method for processing a PCIe link fault, including:
<ul><li>detecting, by a PCIe apparatus, that a fault occurs in a lane of a link between the PCIe apparatus and a downstream PCIe apparatus, and sending a Message Signaled Interrupts MSI message to a central processing unit CPU, where the MSI message includes a device ID of the PCIe apparatus;</li><li>negotiating with the downstream PCIe apparatus to obtain a current lane width value N;</li><li>receiving an instruction of performing a lane reversal operation that is sent by the CPU, and performing the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus; and</li><li>negotiating with the downstream PCIe apparatus to obtain a new current lane width value N', and continuing to perform data transmission with the downstream PCIe apparatus by using N' lanes.</li></ul></p><p id="p0014" num="0014">In a first possible implementation manner of the third aspect, the PCIe apparatus continues to perform data transmission with the downstream PCIe apparatus by using N lanes if the PCIe apparatus does not receive, within predetermined time, the instruction of performing a lane reversal operation that is sent by the CPU.</p><p id="p0015" num="0015">A fourth aspect of the present invention provides a system for processing a PCIe link fault, where the system includes a central processing unit CPU, a PCIe apparatus, and a downstream PCIe apparatus, the CPU is connected to the PCIe apparatus, and the PCIe apparatus is connected to the downstream PCIe apparatus by using a link, where:
<ul><li>the PCIe apparatus is configured to detect whether a fault occurs in a lane of the link between the PCIe apparatus and the downstream PCIe apparatus, and report a Message Signaled Interrupts MSI message to the CPU when a fault occurs, where the MSI message includes a device ID of the PCIe apparatus; the PCIe apparatus is further configured to negotiate with the downstream PCIe apparatus to obtain a current lane width value N;</li><li>the CPU is configured to: acquire a lane negotiation capability value M and the current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID in the MSI message, and compare N and M/2; and when N&lt;M/2, instruct the PCIe apparatus to perform a<!-- EPO <DP n="5"> --> lane reversal operation; and</li><li>the PCIe apparatus is further configured to: after receiving an instruction of performing a lane reversal operation that is sent by the CPU, perform the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus, and negotiate with the downstream PCIe apparatus to obtain a new current lane width value N'.</li></ul></p><p id="p0016" num="0016">In a first possible implementation manner of the fourth aspect, when N&lt;M/2, the CPU is further configured to: disable lanes No. 0 to No. (M/2-1) of the link between the PCIe apparatus and the downstream PCIe apparatus.</p><p id="p0017" num="0017">A fifth aspect of the present invention provides a PCIe apparatus for processing a PCIe link fault, including a detecting module 5031, an MSI module 5033, a negotiating module 5035, a register 5037, and a lane reversal module 5039, where:
<ul><li>the register 5037 stores a current lane width value N and a lane negotiation capability value M of the PCIe apparatus;</li><li>the detecting module 5031 is configured to monitor a communication condition of a link 504 between the PCIe apparatus 503 and a downstream PCIe apparatus, and when detecting that a fault occurs in a lane of the link 504, send a lane fault instruction message to the MSI module 5033;</li><li>the MSI module 5033 is configured to: after receiving the lane fault instruction message sent by the detecting module 5031, send an MSI message to a central processing unit CPU 501, where the MSI message carries a device ID of the PCIe apparatus 503;</li><li>the negotiating module 5035 is configured to negotiate a lane width of the link between the PCIe apparatus and the downstream PCIe apparatus; and</li><li>the lane reversal module 5039 is configured to: after receiving an instruction of performing a lane reversal operation that is sent by the CPU, perform the lane reversal operation on the lane of the link between the PCIe apparatus and the downstream PCIe apparatus.</li></ul></p><p id="p0018" num="0018">It can be known from the foregoing technical solutions that, compared with the prior art, the present invention discloses the method, device, and system for processing a PCIe link fault, and by comparing a current lane width value of a PCIe apparatus and a lane negotiation capability value M, this method can ensure that a lane width of the PCIe apparatus remains half the lane negotiation capability value regardless of a lane number of a lane in which a fault occurs. The method, device, and system for processing a PCIe link fault that are disclosed in the present invention greatly ease the restriction of a lane number of a faulty lane that is imposed on link re-negotiation, so that an optimal link width can be achieved after re-negotiation.<!-- EPO <DP n="6"> --></p><heading id="h0004"><b>BRIEF DESCRIPTION OF DRAWINGS</b></heading><p id="p0019" num="0019">To describe the technical solutions in the embodiments of the present invention or in the prior art more clearly, the following briefly introduces the accompanying drawings required for describing the embodiments or the prior art. Apparently, the accompanying drawings in the following description show merely the embodiments of the present invention, and a person of ordinary skill in the art may still derive other drawings from the provided accompanying drawings.
<ul><li><figref idrefs="f0001">FIG. 1</figref> is a schematic diagram of connections between PCIe apparatuses disclosed in an embodiment of the present invention;</li><li><figref idrefs="f0001">FIG. 2</figref> is a simplified schematic diagram of a connection between PCIe apparatus disclosed in an embodiment of the present invention;</li><li><figref idrefs="f0002">FIG. 3</figref> is a simplified schematic diagram of another connection between PCIe apparatus disclosed in an embodiment of the present invention;</li><li><figref idrefs="f0003">FIG. 4</figref> is a flowchart of a method for processing a link fault of a PCIe apparatus disclosed in an embodiment of the present invention; and</li><li><figref idrefs="f0004">FIG. 5</figref> is a schematic structural diagram of a PCIe apparatus disclosed in an embodiment of the present invention.</li></ul></p><heading id="h0005"><b>DESCRIPTION OF EMBODIMENTS</b></heading><p id="p0020" num="0020">The following clearly and completely describes the technical solutions in the embodiments of the present invention with reference to the accompanying drawings in the embodiments of the present invention. Apparently, the described embodiments are merely some but not all of the embodiments of the present invention.</p><p id="p0021" num="0021">The present invention provides a new method for processing a link fault of a PCIe (Peripheral Component Interconnect Express, Peripheral Component Interconnect Express) device. Devices that perform data transmission by using the PCIe protocol are collectively referred to as PCIe apparatuses. A PCIe apparatus may be a chip integrated in an independent device, or may be a physically independent device, which is not limited herein. For a connection relationship between the PCIe apparatuses, reference may be made to <figref idrefs="f0001">FIG. 1</figref>. As shown in <figref idrefs="f0001">FIG. 1</figref>, two PCIe apparatuses may be directly connected to perform data transmission, for example, a downstream port of a root complex (root complex) device is directly connected to an upstream port of a PCIe apparatus 1 to implement data transmission between the root complex and the PCIe apparatus 1. Data transmission may also be indirectly performed between the two PCIe apparatuses, for example, implementing data transmission by using a switch. For example, the downstream port of the root complex is<!-- EPO <DP n="7"> --> connected to an upstream port of the switch, and a downstream port of the switch is connected to an upstream port of a PCIe apparatus 2, so as to implement data transmission between the root complex and the PCIe apparatus 2. One PCIe apparatus may be simultaneously connected to multiple PCIe apparatuses, and as shown in <figref idrefs="f0001">FIG. 1</figref>, the root complex is simultaneously connected with the PCIe apparatus 1 and the switch. These PCIe apparatuses may be managed by a central processing unit CPU in a centralized manner.</p><p id="p0022" num="0022">Data transmission is implemented between two PCIe apparatuses by means of a link connection, and a link may be a serializer/de-serializer (serdes, Serializer/De-Serializer) circuit. For example, the downstream port of the root complex is connected to the upstream port of the PCIe apparatus 1 by using multiple serdeses, and these serdeses form a link between the root complex and the PCIe apparatus 1. There may be 1, 2, 4, 8, 16, or 32 serdeses between two PCIe apparatuses, and a serdes between the two PCIe apparatuses forms a link between the two PCIe apparatuses. A bandwidth (W) of data transmission between two PCIe apparatuses is equal to a product of a quantity of lanes (N) and a negotiated rate (S), that is, a bandwidth formula is W=N×S. The negotiated rate (S) of a link between the two PCIe apparatuses varies with a version of the used PCIe protocol, and currently, there are four types of negotiated rates, which are GEN1 (2.5 GT/s), GEN2 (5.0 GT/s), GEN3 (8.0 GT/s), and GEN4 (16.0 GT/s), indicating a capacity of data that can be transmitted by one circuit in one second. Generally, a negotiated rate (S) supported by a link of one PCIe apparatus is fixed, and in this case, to meet increasingly high user requirements of a communication bandwidth (W), the bandwidth can be improved only by increasing the quantity of lanes (N) of the link.</p><p id="p0023" num="0023">When there are multiple serdeses, these serdeses are numbered successively by using continuous numbers in ascending order; in this case, one serdes is a lane (lane) of a link between two PCIe apparatuses, and a serdes number is referred to as a lane number. For example, lanes between the root complex and the PCIe apparatus 1 that are shown in <figref idrefs="f0001">FIG. 1</figref> are numbered from left to right successively by using numbers 0 to 15. The serdes described herein uses an existing serdes structure and supports an existing function, which is not separately described herein again.</p><p id="p0024" num="0024">When two PCIe apparatuses are connected, one PCIe apparatus initiating link negotiation is referred to as an upstream PCIe apparatus, and the other one connected to the one PCIe apparatus is referred to as a downstream PCIe apparatus. As shown in <figref idrefs="f0001">FIG. 1</figref>, when the root complex and the PCIe apparatus 1 are connected, the root complex is the upstream PCIe apparatus, and the PCIe apparatus 1 is the downstream PCIe apparatus. When the root complex and the switch are connected, the root complex is the upstream PCIe apparatus, and the switch is the downstream PCIe apparatus. The switch is further connected to the PCIe apparatus 2; in this case, the switch is<!-- EPO <DP n="8"> --> the upstream PCIe apparatus, and the PCIe apparatus 2 is the downstream PCIe apparatus. When one PCIe apparatus is simultaneously connected to multiple PCIe apparatuses, data transmission is performed between the one PCIe apparatus and every other PCIe apparatus by using an independent link. For example, a PCIe switch is simultaneously connected to the PCIe apparatus 2 and a PCIe apparatus 3; data transmission is implemented between the PCIe switch and the PCIe apparatus 2 by using a link 1, and data transmission is implemented between the switch and the PCIe apparatus 3 by using a link 2. The link 1 and the link 2 exist independent of each other, and do not affect each other. Quantities of lanes of the link 1 and the link 2 may be the same or may be different. However, data transmission is performed between the PCIe apparatuses by using the links in a same manner. In the following, description is provided by using an example of a method for processing a fault that occurs in a link between two PCIe apparatuses.</p><p id="p0025" num="0025">To make the entire process clearer and more explicit, as shown in <figref idrefs="f0001">FIG. 2</figref>, a connection relationship between two PCIe apparatuses is simplified, where a first PCIe apparatus is an upstream PCIe apparatus, and performs lane negotiation with a second PCIe apparatus. The second PCIe apparatus is a downstream PCIe apparatus. A central processing unit CPU manages the two PCIe apparatuses. A link between the first PCIe apparatus and the second PCIe apparatus includes 16 serdeses, each serdes is a lane of the link between the first PCIe apparatus and the second PCIe apparatus, and the 16 lanes are continuously numbered starting from 0 to 15 from left to right. As shown in <figref idrefs="f0001">FIG. 2</figref>, a lane with a number 0 is referred to as a lane No. 0, a lane with a number 1 is referred to as a lane No. 1, and by analogy, a lane with a number 15 is a lane No. 15. The quantity of lanes herein is merely used for description. In actual use, 1, 2, 4, 8, or 32 lanes may be configured according to a requirement, and an implementation principle thereof is the same as an implementation principle of the 16 lanes.</p><p id="p0026" num="0026">A Message Signaled Interrupts (MSI, message signal interrupt) function is configured in the first PCIe apparatus. When detecting that a fault occurs in one or more lanes of the link connected between the first PCIe apparatus and the second PCIe apparatus, the first PCIe apparatus reports an MSI message to the CPU, where the MSI message carries a device ID of the first PCIe apparatus. The first PCIe apparatus stores a lane number of the faulty lane in a register. The first PCIe apparatus performs lane re-negotiation with the second PCIe apparatus according to a re-negotiation mechanism of the PCIe protocol, to obtain a current lane width value N of the link between the first PCIe apparatus and the second PCIe apparatus. During lane re-negotiation, according to a lane negotiation mechanism stipulated in the PCIe protocol, the first PCIe apparatus continuously performs link negotiation with the second PCIe apparatus upward in ascending order of lane number, starting from a lane with a smallest lane number until negotiation is performed on<!-- EPO <DP n="9"> --> the faulty lane. Because negotiation cannot be successfully performed on the faulty lane, the re-negotiation process is terminated. The first PCIe apparatus further determines the current lane width value N of the link according to a quantity of lanes of a link between two PCIe apparatuses that is specified in the PCIe protocol. Because lane numbers need to be continuous, and link negotiation starts from a lane with a smallest number, a quantity of lanes obtained by means of re-negotiation varies with a lane number of a faulty lane, and uncertainty exists. When the lane number of the faulty lane is relatively small, the quantity of lanes obtained by means of re-negotiation is also greatly reduced, that is, the obtained current lane width value N is greatly reduced, therefore severely affecting performance of data transmission between the two PCIe apparatuses. For example, when a fault occurs in a lane No. 3 between the first PCIe apparatus and the second PCIe apparatus, the first PCIe apparatus performs, starting from the lane No. 0, link negotiation with the second PCIe apparatus according to the negotiation mechanism of the PCIe protocol. No fault occurs in the lane No. 0, and therefore negotiation succeeds; negotiation proceeds to the lane No. 1 and negotiation on the lane No. 1 succeeds; negotiation proceeds to a lane No. 2, negotiation on the lane No. 2 succeeds, and negotiation proceeds to the lane No. 3. Because the fault occurs in the lane No. 3, negotiation cannot be performed successfully. Further, because the lane numbers need to be continuous, negotiation cannot continue after being interrupted on the lane No. 3. In this case, only 3 lanes, that is, the lane No. 0, the lane No. 1, and the lane No. 2 are available. In addition, because a link between two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes according to the PCIe protocol, the current lane width value N obtained by negotiation between the first PCIe apparatus and the second PCIe apparatus is 2. Originally, there are 16 lanes between the first PCIe apparatus and the second PCIe apparatus that can be used to perform data transmission, but after the fault occurs in the lane No. 3, there are only 2 lanes that are obtained by means of re-negotiation and that can be used to perform data transmission, which is 1/8 of the original. In this case, a lane width of the link between the first PCIe apparatus and the second PCIe apparatus is greatly reduced, and data transmission performance deteriorates obviously. If a fault occurs in the lane No. 1 between the first PCIe apparatus and the second PCIe apparatus, similarly, only the lane No. 0 is available. In this case, the current lane width value N obtained by re-negotiation between the first PCIe apparatus and the second PCIe apparatus is 1, which is 1/16 of the original, and data transmission performance deteriorates significantly.</p><p id="p0027" num="0027">In this embodiment of the present invention, after receiving the MSI message reported by the first PCIe apparatus, the CPU enters an interrupt processing process. The CPU acquires the current lane width value N of the first PCIe apparatus and a lane negotiation capability value M of the first PCIe apparatus from the first PCIe apparatus according to the device ID of the first PCIe<!-- EPO <DP n="10"> --> apparatus in the MSI message. The lane negotiation capability value M of the first PCIe apparatus refers to a maximum lane width value that can be obtained by negotiating by the first PCIe apparatus with the second PCIe apparatus. The maximum lane width value that can be obtained by negotiating by the first PCIe apparatus is a total quantity of lanes of the link between the first PCIe apparatus and the second PCIe apparatus. In this embodiment, there are 16 lanes of the link between the first PCIe apparatus and the second PCIe apparatus; therefore, the maximum lane width value that can be obtained by negotiating by the first PCIe apparatus with the second PCIe apparatus is 16, and the lane negotiation capability value M of the first PCIe apparatus is 16. The current lane width value N of the first PCIe apparatus is the current lane width value N obtained by re-negotiating by the first PCIe apparatus with the second PCIe apparatus. For example, as described above, there are 16 lanes connecting the first PCIe apparatus and the second PCIe apparatus, and when a fault occurs in the lane No. 3 between the first PCIe apparatus and the second PCIe apparatus, the first PCIe apparatus re-negotiates with the second PCIe apparatus according to the re-negotiation mechanism of the PCIe protocol, to obtain the current lane width value N being 2.</p><p id="p0028" num="0028">The CPU compares the acquired current lane width value N of the first PCIe apparatus and lane negotiation capability value M. In the present invention, the CPU compares N and M/2 according to a rule for a quantity of lanes of a link between two PCIe apparatuses.</p><p id="p0029" num="0029">If N≥M/2, the CPU does not perform processing. If the first PCIe apparatus does not receive, within predetermined time, an instruction sent by the CPU, the first PCIe apparatus continues to perform data transmission with the second PCIe apparatus by using N lanes obtained by means of re-negotiation. In this case, N≥M/2 indicates that the lane number of the faulty lane is greater than (M/2-1); because the link between the two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes, the current lane width value N obtained by re-negotiating by the first PCIe apparatus with the second PCIe apparatus is M/2, and the first PCIe apparatus continues to perform data transmission with the second PCIe apparatus by using a link lane obtained by means of re-negotiation.</p><p id="p0030" num="0030">If N&lt;M/2, the CPU instructs the first PCIe apparatus to perform a lane reversal operation on the link between the first PCIe apparatus and the second PCIe apparatus. When N&lt;M/2, the current lane width obtained by re-negotiating by the first PCIe apparatus with the second PCIe apparatus is less than half a total link width, indicating that the lane number of the faulty lane is less than M/2. The lane reversal operation indicates that the first PCIe apparatus re-numbers the lanes of the link between the first PCIe apparatus and the second PCIe apparatus in a reverse direction. If the lanes of the link between the first PCIe apparatus and the second PCIe apparatus are originally numbered starting from 0 to 15 from left to right, then after the PCIe apparatus performs the lane<!-- EPO <DP n="11"> --> reversal operation, the lanes of the link between the first PCIe apparatus and the second PCIe apparatus are numbered from 0 to 15 from right to left, and vice versa. For example, in this embodiment, after the first PCIe apparatus performs the lane reversal operation, a lane number of the original lane No. 15 is changed from 15 to 0, that is, the original lane No. 15 is changed to a lane No. 0; a lane number of an original lane No. 14 is changed from 14 to 1, that is, the original lane No. 14 is changed to a lane No. 1; the rest can be deduced by analogy. Before instructing the first PCIe apparatus to perform the lane reversal operation, the CPU may further disable the lane No. 0 to a lane No. (M/2-1) between the first PCIe apparatus and the second PCIe apparatus. After the lanes No. 0 to No. (M/2-1) are disabled, the first PCIe apparatus does not need to number the disabled lanes any more. In this case, the first PCIe apparatus performs the lane reversal operation, changing a lane number of an original lane No. M to 0, changing a lane number of an original lane No. (M-1) to 1, and so on, until a lane number of an original lane No. M/2 is changed to (M/2-1).</p><p id="p0031" num="0031">After performing the lane reversal operation, the first PCIe apparatus performs re-negotiation on a new current lane width with the second PCIe apparatus, to obtain a new current lane width value N'. A method for re-negotiating, by the first PCIe apparatus, the current lane width with the second PCIe apparatus is the same as the foregoing re-negotiation method. According to a requirement of the PCIe protocol, the first PCIe apparatus performs negotiation starting from a lane with a smallest number after reversal, and performs link negotiation again with the second PCIe apparatus continuously upward in ascending order of lane number. That is, the first PCIe apparatus performs negotiation starting from a reversed lane No. 0, and then performs negotiation on a lane No. 1 and a lane No. 2 successively, until negotiation is performed on a lane No. (M/2-1). The first PCIe apparatus performs the lane reversal operation in a case of N&lt;M/2; in this case, a lane number of the faulty lane is less than M/2, that is, the faulty lane is one of the lanes No. 0 to No. (M/2-1); the lanes No. 0 to No. (M/2-1) are disabled, but no fault occurs in the lanes No. M/2 to No. M, and data transmission can be performed. Therefore, after the first PCIe apparatus performs lane reversal, no fault occurs in the new lanes No. 0 to No. (M/2-1), and the new current lane width value N' obtained byre-negotiating by the first PCIe apparatus with the second PCIe apparatus is M/2.</p><p id="p0032" num="0032">When a fault occurs in a lane of a PCIe apparatus, using the solution of the present invention can ensure that a lane width obtained by means of re-negotiation is 1/2 of an original lane width regardless of a lane number of the faulty lane, avoiding that a lane value of the PCIe apparatus is greatly reduced when the lane number of the faulty lane is relatively small and therefore a speed of data transmission between PCIe apparatuses is affected.</p><p id="p0033" num="0033">The technical solutions of the present invention are described and explained in detail in the following by using specific examples. A connection relationship between PCIe apparatuses is<!-- EPO <DP n="12"> --> shown in <figref idrefs="f0002">FIG. 3</figref>, and for a method process, refer to <figref idrefs="f0003">FIG. 4</figref>.</p><p id="p0034" num="0034">The PCIe apparatus described in the following refers to a device communicating with another device by using the PCIe protocol. As shown in <figref idrefs="f0002">FIG. 3</figref>, a root complex (root complex) device represents a PCIe apparatus communicating with a downstream PCIe apparatus by using the PCIe protocol, that is, an upstream PCIe apparatus, such as the first PCIe apparatus shown in <figref idrefs="f0001">FIG. 2</figref>. A PCIe apparatus 1 (PCIe apparatus 1) represents a PCIe apparatus communicating with the upstream PCIe apparatus by using the PCIe protocol, that is, the downstream PCIe apparatus, such as the second PCIe apparatus shown in <figref idrefs="f0001">FIG. 2</figref>. In addition, the PCIe apparatus may be a physically independent device, or may be a chip integrated in a device, but is not limited to the PCIe apparatus shown in <figref idrefs="f0001">FIG. 1</figref>.</p><p id="p0035" num="0035">The root complex is connected to an upstream port of the PCIe apparatus 1 by using a downstream port to implement data transmission. This embodiment is described by using an example in which there are 16 serdeses between the root complex and the PCIe apparatus 1. The 16 serdeses form a link between the root complex and the PCIe apparatus 1, and one serdes is referred to as 1 lane. That is, a quantity of lanes between the root complex and the PCIe apparatus 1 is 16, namely, X16. Moreover, the 16 lanes are continuously numbered from 0 to 15 from left to right. In this case, a maximum lane width value between the root complex and the PCIe apparatus 1 is 16. A lane negotiation capability value M of the root complex is equal to the maximum lane width value of the root complex, and the maximum lane width value of the root complex refers to a maximum quantity of lanes between the root complex and the PCIe apparatus 1 that can be obtained by negotiating by the root complex. In this embodiment, the lane negotiation capability value M of the root complex is equal to 16. The root complex stores the lane negotiation capability value M of the root complex in a register. According to stipulation of the PCIe protocol, a link between two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes. This embodiment is described by using 16 lanes as an example. When a link includes 1, 2, 4, 8, or 32 lanes, an implementation manner thereof is the same as an implementation manner of the 16 lanes.</p><p id="p0036" num="0036">The root complex may further be connected to another PCIe apparatuses. When the root complex is connected to multiple PCIe apparatuses, as shown in <figref idrefs="f0001">FIG. 1</figref>, the root complex may further be connected to a switch, and lane negotiation capability values between the root complex and the PCIe apparatuses may be separately recorded as M1, M2, and M3 to distinguish one from another. In the following method, description is provided by using an example in which the root complex is connected to one PCIe apparatus. When the root complex is connected to multiple PCIe apparatuses, a method for processing a fault in a lane between the root complex and any of the PCIe apparatuses is similar to that in this embodiment.<!-- EPO <DP n="13"> --></p><p id="p0037" num="0037">A Message Signaled Interrupts (MSI, message signal interrupt) function is configured in the root complex. The root complex monitors a lane connected to the PCIe apparatus 1, and when detecting that a lane width between the root complex and the PCIe apparatus 1 is changed, the root complex reports an MSI message to a CPU. When the root complex performs data transmission with the PCIe apparatus 1, all lanes (that is, all serdeses) connected between the two devices are used. When a fault occurs in any one or more lanes thereof, the root complex detects that the lane width between the root complex and the PCIe apparatus 1 is changed, and the root complex generates an MSI message, and reports the MSI message to the CPU. The MSI message includes a device ID of the root complex, such as B:D:F (bus number:device number:function number) of a port of the root complex. The root complex stores a lane number of the faulty lane in the register. In this embodiment, a fault occurs in a lane No. 5 between the root complex and the PCIe apparatus 1, and the root complex detects that the fault occurs in the lane No. 5, and stores lane number information of the faulty lane in the register.</p><p id="p0038" num="0038">After reporting the MSI message to the CPU, the root complex re-negotiates with the PCIe apparatus 1 to obtain a current lane width value N. According to stipulation of the PCIe protocol, lane negotiation of a link between PCIe apparatuses starts from a lane with a smallest number, until negotiation is performed on a lane in which a fault occurs. In this way, lane numbers of lanes on which negotiation is successfully performed are still continuous, and a quantity of lanes that can be used to transmit data may be obtained. In this embodiment, the root complex negotiates with the PCIe apparatus 1 starting from a lane No. 0, and after negotiation performed on the lane No. 0 succeeds (that is, the lane No. 0 is normal and can be used to transmit data), negotiation is then performed on a lane No. 1. The rest can be deduced by analogy. When negotiation is performed on the lane No. 5, because the fault occurs in the lane No. 5, negotiation performed on the lane No. 5 is unsuccessful, and the root complex stops negotiating with the PCIe apparatus 1. Negotiation is successfully performed on the lanes No. 0 to No. 4 between the root complex and the PCIe apparatus 1, that is, negotiation is successfully performed on 5 lanes between the root complex and the PCIe apparatus 1. Then, according to stipulation of the PCIe protocol in which a link between two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes, it is determined that the current lane width value N between the root complex and the PCIe apparatus 1 is 4. The root complex stores, in the register, the current lane width value N obtained by means of re-negotiation.</p><p id="p0039" num="0039">After receiving the MSI message reported by the root complex, the CPU enters an interrupt processing process. The CPU extracts an ID of the root complex from the MSI message, and then reads the current lane width value N and the lane negotiation capability value M of the root complex from the register of the root complex according to the acquired ID. The current lane width<!-- EPO <DP n="14"> --> value N of the root complex is obtained by re-negotiating with the PCIe apparatus 1 after the root complex detects that a fault occurs in a lane between the root complex and the PCIe apparatus 1. In this embodiment, after the fault occurs in the serdes lane No. 5 between the root complex and the PCIe apparatus 1, the current lane width value N obtained by means of re-negotiation is 4. A specific negotiation method is described in the previous paragraph and is not separately described herein again. In addition, as described above, in this embodiment, there are 16 lanes between the root complex and the PCIe apparatus 1, and therefore the lane negotiation capability value M of the root complex is 16.</p><p id="p0040" num="0040">The CPU compares the current lane width value N of the root complex and the lane negotiation capability value M of the root complex. In the present invention, the CPU compares N and M/2 according to a rule for a quantity of lanes of a link between two PCIe apparatuses.</p><p id="p0041" num="0041">When N≥M/2, the current lane width value obtained by negotiating by the root complex with the PCIe apparatus 1 is half the maximum lane width value, and in this case, the CPU does not perform processing. If the root complex does not receive, within predetermined time, an instruction sent by the CPU, the root complex continues to perform data transmission with the PCIe apparatus 1 by using N link lanes obtained by means of re-negotiation.</p><p id="p0042" num="0042">When N&lt;M/2, the current lane width value obtained by negotiating by the root complex with the PCIe apparatus 1 is less than half the maximum lane width value, and in this case, a width of the link between the root complex and the PCIe apparatus 1 is greatly reduced. In this case, the CPU disables the lane No. 0 to a lane No. (M/2-1) between the root complex and the PCIe apparatus 1, and instructs the root complex to start a lane reversal operation. The lane reversal operation indicates that a PCIe apparatus re-numbers lanes of a link between the PCIe apparatus and a downstream PCIe apparatus in a reverse direction. After starting the lane reversal operation, the root complex re-numbers the lanes between the root complex and the PCIe apparatus 1 in a reverse direction. The lanes between the root complex and the PCIe apparatus 1 are continuously numbered from left to right and in ascending order. After starting the lane reversal operation, the root complex continuously numbers the lanes between the root complex and the PCIe apparatus 1 from right to left and in ascending order. Related description of a specific numbering process is provided in the foregoing and is not separately described herein again. Because the original lanes No. 0 to No. (M/2-1) are disabled, the root complex does not number the disabled lanes after starting the lane reversal operation. In this way, the root complex continuously numbers the lanes between the root complex and the PCIe apparatus 1 starting from 0 to (M/2-1) from right to left and in ascending order.</p><p id="p0043" num="0043">After completing the lane reversal operation, the root complex then performs lane width<!-- EPO <DP n="15"> --> negotiation with the PCIe apparatus 1 to obtain a new current lane width value N' of the link between the root complex and the PCIe apparatus. According to regulations of the PCIe protocol, negotiation between PCIe apparatuses starts from a lane with a smallest number, until negotiation is performed on a lane in which a fault occurs. After completing the lane reversal operation, the root complex performs negotiation starting from a new lane No. 0, until negotiation is performed on the lane in which the fault occurs, and determines a quantity of lanes that can be used for communication. The root complex then determines the new current lane width value N' according to a requirement, stipulated in the PCIe protocol, of the quantity of lanes of the link between the two PCIe apparatuses. The root complex continues to perform data transmission with the PCIe apparatus 1 by using lanes in a quantity of the new N' obtained by means of negotiation.</p><p id="p0044" num="0044">In this embodiment, the fault occurs in the lane No. 5, N is 4, M is 16, and 4&lt;8 (N&lt;M/2). The CPU disables the lanes No. 0 to No. (M/2-1) (that is, No. 7) between the root complex and the PCIe apparatus 1, and instructs the root complex to perform the lane reversal operation. After receiving the instruction, the root complex re-numbers the lanes between the root complex and the PCIe apparatus 1 in a reverse direction. A lane number of a lane No. 15 is changed from 15 to 0, that is, the original lane No. 15 is changed to a lane No. 0; a lane number of a lane No. 14 is changed from 14 to 1, that is, the original lane No. 14 is changed to a lane No. 1; the rest can be deduced by analogy. Because the lanes No. 0 to No. (M/2-1) (that is, No. 7) are disabled, a lane reversal process is ended after an original lane No. M/2 (that is, No. 8) is changed to a lane No. (M/2-1) (that is, No. 7). After completing lane reversal, the root complex performs lane re-negotiation with the PCIe apparatus 1, negotiation is performed starting from a new reversed lane No. 0, and negotiation is continuously performed upward according to lane numbers. Because data transmission can be performed on the original lane No. 8 to the original lane No. 15 in which no fault occurs, negotiation is successfully performed on 8 lanes when the root complex performs lane renegotiation with the PCIe apparatus 1 again. Further, because the PCIe protocol stipulates that a lane width is one of 1, 2, 4, 8, 16, and 32, the new current lane width value N' obtained by re-negotiating by the root complex with the PCIe apparatus 1 is 8.</p><p id="p0045" num="0045">The root complex continues to perform data transmission by using a new reversed lane No. 0 to a new reversed lane No. 7 (that is, 8 lanes) between the root complex and the PCIe apparatus 1. A specific data transmission process is similar to an existing implementation manner, which is not separately described herein again.</p><p id="p0046" num="0046">In this way, in a case in which a fault occurs in a lane of a link between two PCIe apparatuses, using the solution provided in the present invention can ensure that lanes in a quantity that is half a lane negotiation capability value of the PCIe apparatus can be used regardless of a lane<!-- EPO <DP n="16"> --> number of the faulty lane, which ensures a transmission speed and performance of the link between the PCIe apparatuses to the greatest extent.</p><p id="p0047" num="0047">The present invention further provides a system for processing a link fault of a PCIe apparatus, and composition of the system is shown in <figref idrefs="f0001">FIG. 2</figref>. The system includes a central processing unit CPU 201, a first PCIe apparatus 203, and a second PCIe apparatus 205. The first PCIe apparatus and the second PCIe apparatus are connected by using multiple serializer/de-serializer (serdes, Serializer/De-Serializer) circuits. The multiple serdeses form a link 204 that is used to transmit data between the first PCIe apparatus and the second PCIe apparatus, each serdes is a lane, and lanes are continuously numbered in an order. There may be 1, 2, 4, 8, 16, or 32 serdeses between the two PCIe apparatuses, and this embodiment is described by using 16 serdeses as an example. That is, there are 16 serdeses, namely, 16 lanes, between the first PCIe apparatus 203 and the second PCIe apparatus 205, and the 16 lanes are continuously and sequentially numbered starting from 0 to 15 from left to right. A lane with a number 0 is a lane No. 0, and by analogy, a lane with a number 15 is a lane No. 15. The serdes uses an existing serdes structure and supports an existing function, which is not separately described herein again. In this embodiment of the present invention, no matter how many serdeses are in the link, implementation principles thereof are similar.</p><p id="p0048" num="0048">A Message Signaled Interrupts (MSI, message signal interrupt) function is configured in the first PCIe apparatus 203. When detecting that a fault occurs in one or more lanes of the link 204 connected to the second PCIe apparatus 205, the first PCIe apparatus 203 reports an MSI message to the CPU 201, where the MSI message carries a device ID of the first PCIe apparatus 203.</p><p id="p0049" num="0049">The first PCIe apparatus 203 performs lane re-negotiation with the second PCIe apparatus 205 according to a re-negotiation mechanism of the PCIe protocol, to obtain a current lane width value N of the link 204 between the first PCIe apparatus 203 and the second PCIe apparatus 205. During lane re-negotiation, according to a lane negotiation mechanism stipulated in the PCIe protocol, the first PCIe apparatus 203 continuously performs link negotiation again with the second PCIe apparatus 205 upward in ascending order of lane number, starting from a lane with a smallest lane number until negotiation is performed on the faulty lane. Because negotiation cannot be successfully performed on the faulty lane, the re-negotiation process is terminated. The first PCIe apparatus 203 further determines the current lane width value N of the link according to a quantity of lanes of a link between two PCIe apparatuses that is stipulated in the PCIe protocol.</p><p id="p0050" num="0050">Because lane numbers need to be continuous, and link negotiation starts from a lane with a smallest number, a quantity of lanes obtained by means of re-negotiation varies with a lane number of a faulty lane, and uncertainty exists. When the lane number of the faulty lane is relatively<!-- EPO <DP n="17"> --> small, the quantity of lanes obtained by means of re-negotiation is also greatly reduced, that is, the obtained current lane width value N is greatly reduced, therefore severely affecting performance of data transmission between the two PCIe apparatuses.</p><p id="p0051" num="0051">In this embodiment of the present invention, after receiving the MSI message reported by the first PCIe apparatus 203, the CPU 201 enters an interrupt processing process. The CPU 201 acquires the current lane width value N of the first PCIe apparatus 203 and a lane negotiation capability value M of the first PCIe apparatus 203 from the first PCIe apparatus 203 according to the device ID of the first PCIe apparatus 203 in the MSI message. The lane negotiation capability value M of the first PCIe apparatus 203 refers to a maximum lane width value that can be obtained by negotiating by the first PCIe apparatus 203 with the second PCIe apparatus 205, that is, a total quantity of lanes between the first PCIe apparatus 203 and the second PCIe apparatus 205. In this embodiment, there are 16 lanes between the first PCIe apparatus 203 and the second PCIe apparatus 205; therefore, the maximum lane width value that can be obtained by negotiating by the first PCIe apparatus 203 with the second PCIe apparatus 205 is 16, and the lane negotiation capability value M of the first PCIe apparatus 203 is 16. The current lane width value N of the first PCIe apparatus 203 is the current lane width value N obtained by re-negotiating by the first PCIe apparatus 203 with the second PCIe apparatus 205.</p><p id="p0052" num="0052">The CPU 201 compares the acquired current lane width value N of the first PCIe apparatus 203 and the lane negotiation capability value M. In the present invention, the CPU 201 compares N and M/2 according to a rule for a quantity of lanes of a link between two PCIe apparatuses.</p><p id="p0053" num="0053">If N≥M/2, the first PCIe apparatus 203 continues to perform data transmission with the second PCIe apparatus 205 by using a link lane obtained by means of re-negotiation. In this case, N≥M/2 indicates that the lane number of the faulty lane is greater than (M/2-1); because the link between the two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes, the current lane width value N obtained by re-negotiating by the first PCIe apparatus 203 with the second PCIe apparatus 205 is M/2, and the first PCIe apparatus 203 continues to perform data transmission with the second PCIe apparatus 205 by using the link lane obtained by means of re-negotiation. The CPU 201 does not perform processing in such a condition. The first PCIe apparatus 203 may set a time period, and if the first PCIe apparatus 203 does not receive an instruction of the CPU 201 within the set time period, the first PCIe apparatus 203 continues to perform data transmission with the second PCIe apparatus 205 by using the link lane obtained by means of re-negotiation.</p><p id="p0054" num="0054">If N&lt;M/2, the CPU 201 instructs the first PCIe apparatus 203 to perform a lane reversal operation. When N&lt;M/2, the current lane width obtained by re-negotiating by the first PCIe<!-- EPO <DP n="18"> --> apparatus 203 with the second PCIe apparatus 205 is less than half a total link width, indicating that the lane number of the faulty lane is less than M/2. The lane reversal operation indicates that the first PCIe apparatus 203 re-numbers the lanes between the first PCIe apparatus 203 and the second PCIe apparatus 205 in a reverse direction. For example, in this embodiment, the lanes between the first PCIe apparatus 203 and the second PCIe apparatus 205 are originally numbered starting from 0 to 15 from left to right. After the first PCIe apparatus 203 performs the lane reversal operation, a lane number of the original lane No. 15 is changed from 15 to 0, that is, the original lane No. 15 is changed to a lane No. 0; a lane number of an original lane No. 14 is changed from 14 to 1, that is, the original lane No. 14 is changed to a lane No. 1; the rest can be deduced by analogy. Before instructing the first PCIe apparatus to perform the lane reversal operation, the CPU 201 may further disable the lane No. 0 to a lane No. (M/2-1) between the first PCIe apparatus and the second PCIe apparatus. After the lanes No. 0 to No. (M/2-1) are disabled, the first PCIe apparatus 203 performs the lane reversal operation, changing a lane number of an original lane No. M to 0, changing a lane number of an original lane No. (M-1) to 1, and so on, until a lane number of an original lane No. M/2 is changed to (M/2-1). After performing the lane reversal operation, the first PCIe apparatus 203 performs re-negotiation on a new current lane width with the second PCIe apparatus 205, to obtain a new current lane width value N'. A method for re-negotiating, by the first PCIe apparatus 203, the current lane width with the second PCIe apparatus 205 is the same as the foregoing re-negotiation method. According to a requirement of the PCIe protocol, the first PCIe apparatus 203 performs negotiation starting from the lane with a smallest number after reversal, and performs link negotiation again with the second PCIe apparatus 205 continuously upward in ascending order of lane number. That is, the first PCIe apparatus 203 performs negotiation starting from a reversed lane No. 0, and then performs negotiation on a lane No. 1 and a lane No. 2 successively, until negotiation is performed on a lane No. (M/2-1). The first PCIe apparatus 203 performs the lane reversal operation in a case of N&lt;M/2; in this case, a lane number of the faulty lane is less than M/2, that is, the faulty lane is one of the lanes No. 0 to No. (M/2-1); the lanes No. 0 to No. (M/2-1) are disabled, but no fault occurs in the lanes No. M/2 to No. M, and data transmission can be performed. Therefore, after the first PCIe apparatus 203 performs lane reversal, no fault occurs in the new lanes No. 0 to No. (M/2-1), and the new current lane width value N' obtained by re-negotiating by the first PCIe apparatus 203 with the second PCIe apparatus 205 is M/2. The first PCIe apparatus 203 continues to perform data transmission with the second PCIe apparatus 205 by using a new lane link obtained by means of re-negotiation.</p><p id="p0055" num="0055">When a fault occurs in a lane of a PCIe apparatus, using the solution of the present invention can ensure that a lane width obtained by means of re-negotiation is 1/2 of an original lane<!-- EPO <DP n="19"> --> width regardless of a lane number of the faulty lane, avoiding that a lane value of the PCIe apparatus is greatly reduced when the lane number of the faulty lane is relatively small and therefore a speed of data transmission between PCIe apparatus is affected.</p><p id="p0056" num="0056">For an internal structural diagram of a first PCIe apparatus 503 in an embodiment of the present invention, refer to <figref idrefs="f0004">FIG. 5</figref>. As shown in <figref idrefs="f0004">FIG. 5</figref>, the first PCIe apparatus 503 includes a detecting module 5031, an MSI module 5033, a negotiating module 5035, a register 5037, and a lane reversal module 5039.</p><p id="p0057" num="0057">The detecting module 5031 is configured to monitor a communication condition of a link 504 between the first PCIe apparatus 503 and a second PCIe apparatus 505. The link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 504 includes multiple serializer/de-serializer (serdes, Serializer/De-Serializer) circuits, and each serdes is a lane (lane). When detecting that a fault occurs in one or more lanes of the link 504, the detecting module 5031 sends a lane fault instruction message to the MSI module 5033, and sends information about the faulty lane to the register 5037 for storage.</p><p id="p0058" num="0058">The MSI module 5033 is configured to: after receiving the lane fault instruction message of the detecting module 5031, send an MSI message to a central processing unit CPU 501. The sent MSI message carries a device ID of the first PCIe apparatus 503.</p><p id="p0059" num="0059">The negotiating module 5035 is configured to negotiate a lane width between the first PCIe apparatus 503 and the second PCIe apparatus 505. Lanes of the link between the two PCIe apparatuses are continuously numbered in an order. The link between the two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes, and this embodiment is described by using 16 lanes as an example. For example, as shown in <figref idrefs="f0004">FIG. 5</figref>, the lanes of the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505 are continuously numbered from left to right starting from 0. There are a lane No. 0, a lane No. 1, a lane No. 2 ..., and a lane No. 15 successively from left to right. According to a negotiation mechanism of the PCIe protocol, when link negotiation is performed, negotiation is performed starting from a lane with a smallest number, and link negotiation is performed again with the second PCIe apparatus 505 continuously upward in ascending order of lane number, until negotiation is performed on the faulty lane. Because negotiation cannot be successfully performed on the faulty lane, a re-negotiation process is terminated. The first PCIe apparatus 503 further determines a current lane width value N of the link between the first PCIe apparatus 503 and the second PCIe apparatus 505 according to a quantity of lanes of a link between two PCIe apparatuses that is stipulated in the PCIe protocol.</p><p id="p0060" num="0060">The register 5037 is configured to store information, including information, such as a lane negotiation capability value M and the current lane width value N of the first PCIe apparatus<!-- EPO <DP n="20"> --> 503.</p><p id="p0061" num="0061">The lane reversal module 5039 is configured to: after receiving an instruction of performing a lane reversal operation, perform the lane reversal operation on the lanes in the link 504.</p><p id="p0062" num="0062">When detecting that the fault occurs in the one or more lanes of the link 504, the detecting module 5031 sends the lane fault instruction message to the MSI module 5033, and sends the information about the faulty lane to the register 5037 for storage.</p><p id="p0063" num="0063">The negotiating module 5035 initiates re-negotiation, and determines the current lane width value N between the first PCIe apparatus 503 and the second PCIe apparatus 505. The negotiating module 5035 performs negotiation starting from a lane with a smallest number in the link 504, that is, performs negotiation starting from a lane No. 0; after negotiation is successfully performed on the lane No. 0, negotiation is performed on a lane No. 1, and the rest can be deduced by analogy, until negotiation is performed on the faulty lane. In this embodiment, it is assumed that the fault occurs in a lane No. 5 in the link 504. When the negotiating module 5035 initiates re-negotiation, negotiation is successfully performed on the lane No. 0 to a lane No. 4. In this case, 5 lanes can be used for communication, but the link between the two PCIe apparatuses may include 1, 2, 4, 8, 16, or 32 lanes, and therefore the current lane width value N between the first PCIe apparatus 503 and the second PCIe apparatus 505 is 4.</p><p id="p0064" num="0064">After receiving the MSI message sent by the MSI module 5033, the CPU 501 acquires a lane negotiation capability value M and the current lane width value N of the first PCIe apparatus from the register 5037 of the first PCIe apparatus 503 according to the device ID carried in the MSI message. In this embodiment, a quantity of lanes of the link between the first PCIe apparatus and the second PCIe apparatus is 16, and therefore, the lane negotiation capability value M of the first PCIe apparatus that is acquired by the CPU 501 is 16. The current lane width value N is 4.</p><p id="p0065" num="0065">The CPU 501 compares the acquired lane negotiation capability value M and the current lane width value N. In the present invention, the CPU 501 compares N and M/2 according to a rule for a quantity of lanes of a link between two PCIe apparatuses.</p><p id="p0066" num="0066">When N&lt;M/2, the CPU 501 instructs the lane reversal module 5039 of the first PCIe apparatus 503 to perform a lane reversal operation that is, to re-number the lanes of the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505 in a reverse direction. For example, as shown in <figref idrefs="f0004">FIG. 5</figref>, currently, the lanes of the link 504 are continuously numbered starting from 0 to 15 from left to right. Performing the lane reversal operation means: a lane number of the lane No. 15 of the link 504 is changed from 15 to 0, that is, the lane No. 15 is changed to the lane No. 0; a lane number of a lane No. 14 is changed to 1, that is, the lane No. 14 is changed to the lane<!-- EPO <DP n="21"> --> No. 1; the rest can be deduced by analogy. After the lane reversal operation is performed, the lanes of the link 504 are continuously numbered starting from 0 to 15 from right to left. After the lane reversal module 5039 of the first PCIe apparatus 503 completes the lane reversal operation, the negotiating module 5035 then re-initiates lane negotiation on the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505, and determines a new current lane width value N'; a negotiation manner is the same as the foregoing manner, which is not separately described herein again. The first PCIe apparatus 503 performs data transmission with the second PCIe apparatus 505 by using the new current lane width obtained by means of negotiation. Because N&lt;M/2 indicates that a lane number of the faulty lane is less than (M/2-1), the new current lane width value obtained by means of re-negotiation is greater than or equal to M/2. In this case, it can be ensured that a lane width value obtained by means of re-negotiation after a fault occurs in a lane of the link 504 is greater than or equal to M/2, which ensures transmission performance of the link 504.</p><p id="p0067" num="0067">When N&lt;M/2, the CPU 501 may further first disable the lane No. 0 to a lane No. (M/2-1) of the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505, and then instruct the lane reversal module 5039 of the first PCIe apparatus 503 to perform the lane reversal operation. Because N&lt;M/2, and the current lane width obtained by means of negotiation is less than M/2, it indicates that the lane number of the faulty lane is less than (M/2-1). No fault occurs in a lane No. M/2 to a lane No. M, and data transmission can be performed. In this way, the CPU 501 disables the lanes No. 0 to No. (M/2-1) of the link 504; when performing the lane reversal operation, the lane reversal module 5039 of the first PCIe apparatus 503 changes a lane number of the lane No. M from M to 0, changes a lane number of a lane No. (M-1) from (M-1) to 0, and so on, until a lane number of the lane No. M/2 is changed from M/2 to (M/2-1). Because the original lane No. 0 to the original lane No. (M/2-1) of the link are disabled, the lane reversal module 5039 of the first PCIe apparatus 503 does not perform lane reversal on these disabled lanes any more. After lane reversal is completed, the negotiating module 5035 re-initiates lane negotiation on the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505, and determines the new current lane width value N'. In this case, a new lane No. 0 to a new lane No. (M/2-1) of the link 504 can be used for communication. That is, after a fault occurs in a lane of the link 504, a lane width value obtained by means of re-negotiation is equal to M/2, ensuring transmission performance of the link 504.</p><p id="p0068" num="0068">When N≥M/2, it indicates that the current lane width of the link between the first PCIe apparatus 503 and the second PCIe apparatus 505 is greater than or equal to M/2, and in this case, performance of the link 504 is retained to the greatest extent. The CPU 501 does not perform processing. If the first PCIe apparatus 503 does not receive an instruction of the CPU 501 within a predetermined time limit, the first PCIe apparatus 503 performs data transmission with the second<!-- EPO <DP n="22"> --> PCIe apparatus 504 by using the current lane width N obtained by means of negotiation. Transmission performance of the link 504 is also ensured.</p><p id="p0069" num="0069">In this embodiment of the present invention, the lane negotiation capability value M of the first PCIe apparatus 503 is 16, the fault occurs in the lane No. 5 of the link 504, and the current lane width value N obtained by re-negotiating by the negotiation module 5035 of the first PCIe apparatus with the second PCIe apparatus 505 is 4. In this case, 4&lt;16/2, that is, N&lt;M/2; the CPU 501 disables the lane No. 0 to a lane No. 7 of the link 504, and instructs the lane reversal module 5039 of the first PCIe apparatus 503 to perform lane reversal. The lane reversal module 5039 of the first PCIe apparatus 503 changes the lane number of the lane No. 15 of the link 504 to 0, and changes the lane number of the lane No. 14 to 1, until a lane number of a lane No. 8 is changed to 7. Because the original lane No. 0 to the original lane No. 7 of the link 504 are disabled, the lane reversal module 5039 does not number them any more. In this way, the link 504 between the first PCIe apparatus 503 and the second PCIe apparatus 505 now includes 8 lanes. The negotiating module 5035 of the first PCIe apparatus 503 performs lane re-negotiation with the second PCIe apparatus 505, to obtain a new current lane width value N' being 8. The first PCIe apparatus 503 continues to perform data transmission with the second PCIe apparatus 505 by using 8 lanes of the link 504.</p><p id="p0070" num="0070">In this way, by using the technical solutions provided in the present invention, when a fault occurs in a lane of a link between two PCIe apparatuses, it can be ensured that half lanes of the original link can be provided for the two PCIe apparatuses to continue to perform data transmission regardless of a number of the faulty lane, which eases restriction of a lane number of a faulty lane that is imposed on a link width in the prior art, so that an optimal link width can be achieved after re-negotiation.</p><p id="p0071" num="0071">It should further be noted that in this specification, relational terms such as first and second are only used to distinguish one entity or operation from another, and do not necessarily require or imply that any actual relationship or sequence exists between these entities or operations. Moreover, the terms "include", "include", or their any other variant is intended to cover a non-exclusive inclusion, so that a process, a method, an article, or an apparatus that includes a list of elements not only includes those elements but also includes other elements which are not expressly listed, or further includes elements inherent to such process, method, article, or apparatus. An element preceded by "includes a ..." does not, without more constraints, preclude the existence of additional identical elements in the process, method, article, or apparatus that includes the element.</p><p id="p0072" num="0072">A person skilled in the art may implement or use the present invention according to the<!-- EPO <DP n="23"> --> foregoing description of the disclosed embodiments. An ordinary principle defined in this specification may be implemented in other embodiments without departing from the spirit or the scope of the present invention. Therefore, the present invention will not be limited to the embodiments described in this specification but extends to the widest scope that complies with the principles and novelty disclosed in this specification.</p></description><claims mxw-id="PCLM90459236" lang="EN" load-source="patent-office"><!-- EPO <DP n="24"> --><claim id="c-en-0001" num="0001"><claim-text>A method for processing a PCIe link fault, wherein the method comprises:
<claim-text>detecting, by a PCIe apparatus, that a fault occurs in a lane of a link between the PCIe apparatus and a downstream PCIe apparatus, and sending a Message Signaled Interrupts MSI message to a central processing unit CPU, wherein the MSI message comprises a device ID of the PCIe apparatus;</claim-text>
<claim-text>negotiating, by the PCIe apparatus, with the downstream PCIe apparatus to obtain a current lane width value N;</claim-text>
<claim-text>acquiring, by the CPU, a lane negotiation capability value M and the current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID in the received MSI message;</claim-text>
<claim-text>comparing, by the CPU, N and M/2;</claim-text>
<claim-text>if N&lt;M/2, instructing, by the CPU, the PCIe apparatus to perform a lane reversal operation;</claim-text>
<claim-text>performing, by the PCIe apparatus, the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus; and</claim-text>
<claim-text>negotiating, by the PCIe apparatus, with the downstream PCIe apparatus to obtain a new current lane width value N', and continuing to perform data transmission with the downstream PCIe apparatus by using N' lanes.</claim-text></claim-text></claim><claim id="c-en-0002" num="0002"><claim-text>The method according to claim 1, wherein the method further comprises:
<claim-text>if N≥M/2, continuing, by the PCIe apparatus, to perform data transmission with the downstream PCIe apparatus by using N lanes obtained by means of negotiation.</claim-text></claim-text></claim><claim id="c-en-0003" num="0003"><claim-text>The method according to claim 1 or 2, wherein if N&lt;M/2, the method further comprises:
<claim-text>disabling, by the CPU, lanes No. 0 to No. (M/2-1) of the link between the PCIe apparatus and the downstream PCIe apparatus.</claim-text></claim-text></claim><claim id="c-en-0004" num="0004"><claim-text>A method for processing a PCIe link fault, wherein the method comprises:
<claim-text>receiving a Message Signaled Interrupts MSI message reported by a PCIe apparatus, wherein the MSI message comprises a device ID of the PCIe apparatus;</claim-text>
<claim-text>acquiring a lane negotiation capability value M and a current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID, wherein the current lane width value N is obtained by negotiating by the PCIe apparatus with a downstream PCIe apparatus;</claim-text>
<claim-text>comparing N and M/2; and</claim-text>
<claim-text>if N&lt;M/2, instructing the PCIe apparatus to perform a lane reversal operation.</claim-text><!-- EPO <DP n="25"> --></claim-text></claim><claim id="c-en-0005" num="0005"><claim-text>The method according to claim 4, wherein if N&lt;M/2, the method further comprises:
<claim-text>disabling lanes No. 0 to No. (M/2-1) of a link between the PCIe apparatus and the downstream PCIe apparatus.</claim-text></claim-text></claim><claim id="c-en-0006" num="0006"><claim-text>The method according to claim 4 or 5, wherein the lane negotiation capability value M of the PCIe apparatus is equal to a total quantity of lanes of the link between the PCIe apparatus and the downstream PCIe apparatus.</claim-text></claim><claim id="c-en-0007" num="0007"><claim-text>A method for processing a PCIe link fault, wherein the method comprises:
<claim-text>detecting, by a PCIe apparatus, that a fault occurs in a lane of a link between the PCIe apparatus and a downstream PCIe apparatus, and sending a Message Signaled Interrupts MSI message to a central processing unit CPU, wherein the MSI message comprises a device ID of the PCIe apparatus;</claim-text>
<claim-text>negotiating with the downstream PCIe apparatus to obtain a current lane width value N;</claim-text>
<claim-text>receiving an instruction of performing a lane reversal operation that is sent by the CPU, and performing the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus; and</claim-text>
<claim-text>negotiating with the downstream PCIe apparatus to obtain a new current lane width value N', and continuing to perform data transmission with the downstream PCIe apparatus by using N' lanes.</claim-text></claim-text></claim><claim id="c-en-0008" num="0008"><claim-text>The method according to claim 7, wherein the method further comprises:
<claim-text>continuing, by the PCIe apparatus, to perform data transmission with the downstream PCIe apparatus by using N lanes if the PCIe apparatus does not receive, within predetermined time, the instruction of performing a lane reversal operation that is sent by the CPU.</claim-text></claim-text></claim><claim id="c-en-0009" num="0009"><claim-text>A system for processing a PCIe link fault, wherein the system comprises a central processing unit CPU, a PCIe apparatus, and a downstream PCIe apparatus, the CPU is connected to the PCIe apparatus, and the PCIe apparatus is connected to the downstream PCIe apparatus by using a link, wherein:
<claim-text>the PCIe apparatus is configured to detect whether a fault occurs in a lane of the link between the PCIe apparatus and the downstream PCIe apparatus, and report a Message Signaled Interrupts MSI message to the CPU when a fault occurs, wherein the MSI message comprises a device ID of the PCIe apparatus; the PCIe apparatus is further configured to negotiate with the downstream PCIe apparatus to obtain a current lane width value N;</claim-text>
<claim-text>the CPU is configured to: acquire a lane negotiation capability value M and the current lane width value N of the PCIe apparatus from the PCIe apparatus according to the device ID in the MSI message, and compare N and M/2; and when N&lt;M/2, instruct the PCIe apparatus to perform a lane reversal operation; and<!-- EPO <DP n="26"> --></claim-text>
<claim-text>the PCIe apparatus is further configured to: after receiving an instruction of performing a lane reversal operation that is sent by the CPU, perform the lane reversal operation on the link between the PCIe apparatus and the downstream PCIe apparatus, and negotiate with the downstream PCIe apparatus to obtain a new current lane width value N'.</claim-text></claim-text></claim><claim id="c-en-0010" num="0010"><claim-text>The processing system according to claim 9, wherein when N&lt;M/2, the CPU is further configured to disable lanes No. 0 to No. (M/2-1) of the link between the PCIe apparatus and the downstream PCIe apparatus.</claim-text></claim><claim id="c-en-0011" num="0011"><claim-text>A PCIe apparatus 503 for processing a PCIe link fault, wherein the PCIe apparatus 503 comprises a detecting module 5031, an MSI module 5033, a negotiating module 5035, a register 5037, and a lane reversal module 5039, wherein:
<claim-text>the register 5037 stores a current lane width value N and a lane negotiation capability value M of the PCIe apparatus;</claim-text>
<claim-text>the detecting module 5031 is configured to monitor a communication condition of a link 504 between the PCIe apparatus 503 and a downstream PCIe apparatus, and when detecting that a fault occurs in a lane of the link 504, send a lane fault instruction message to the MSI module 5033;</claim-text>
<claim-text>the MSI module 5033 is configured to: after receiving the lane fault instruction message sent by the detecting module 5031, send an MSI message to a central processing unit CPU 501, wherein the MSI message carries a device ID of the PCIe apparatus 503;</claim-text>
<claim-text>the negotiating module 5035 is configured to negotiate a lane width of the link between the PCIe apparatus and the downstream PCIe apparatus; and</claim-text>
<claim-text>the lane reversal module 5039 is configured to: after receiving an instruction of performing a lane reversal operation that is sent by the CPU, perform the lane reversal operation on the lane of the link between the PCIe apparatus and the downstream PCIe apparatus.</claim-text></claim-text></claim></claims><drawings mxw-id="PDW20421971" load-source="patent-office"><!-- EPO <DP n="27"> --><figure id="f0001" num="1,2"><img id="if0001" file="imgf0001.tif" wi="164" he="230" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="28"> --><figure id="f0002" num="3"><img id="if0002" file="imgf0002.tif" wi="129" he="118" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="29"> --><figure id="f0003" num="4"><img id="if0003" file="imgf0003.tif" wi="165" he="211" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="30"> --><figure id="f0004" num="5"><img id="if0004" file="imgf0004.tif" wi="155" he="192" img-content="drawing" img-format="tif"/></figure></drawings><search-report-data><doc-page id="srep0001" file="srep0001.tif" wi="165" he="230" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="165" he="224" type="tif"/></search-report-data><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
