<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2680507-A1" country="EP" doc-number="2680507" kind="A1" date="20140101" family-id="46929471" file-reference-id="318302" date-produced="20180824" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="146549181" ucid="EP-2680507-A1"><document-id><country>EP</country><doc-number>2680507</doc-number><kind>A1</kind><date>20140101</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-12763865-A" is-representative="YES"><document-id mxw-id="PAPP154823104" load-source="docdb" format="epo"><country>EP</country><doc-number>12763865</doc-number><kind>A</kind><date>20120329</date><lang>ZH</lang></document-id><document-id mxw-id="PAPP174952977" load-source="docdb" format="original"><country>EP</country><doc-number>12763865.8</doc-number><date>20120329</date><lang>ZH</lang></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC140446606" ucid="CN-201110077032-A" load-source="docdb"><document-id format="epo"><country>CN</country><doc-number>201110077032</doc-number><kind>A</kind><date>20110329</date></document-id></priority-claim><priority-claim mxw-id="PPC140448584" ucid="CN-2012073259-W" linkage-type="W" load-source="docdb"><document-id format="epo"><country>CN</country><doc-number>2012073259</doc-number><kind>W</kind><date>20120329</date></document-id></priority-claim></priority-claims><technical-data><classification-ipc><edition>7</edition><main-classification>H04L  12/56</main-classification></classification-ipc><classifications-ipcr><classification-ipcr mxw-id="PCL1988098697" load-source="docdb">H04L  29/12        20060101AFI20131204BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-1915457185" load-source="docdb" scheme="CPC">H04L  67/2842      20130101 LI20160721BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1915457363" load-source="docdb" scheme="CPC">H04L2212/00        20130101 LA20160721BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1987651252" load-source="docdb" scheme="CPC">H04L  61/6059      20130101 LI20151219BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1987658170" load-source="docdb" scheme="CPC">H04L  61/2015      20130101 LI20151219BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2094113073" load-source="docdb" scheme="CPC">H04L  67/28        20130101 LA20150202BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2137522355" load-source="docdb" scheme="CPC">H04L  47/10        20130101 LI20141113BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2137531487" load-source="docdb" scheme="CPC">H04L  45/741       20130101 LI20141114BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2137532469" load-source="docdb" scheme="CPC">H04L  45/74        20130101 FI20141113BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT132180027" lang="DE" load-source="patent-office">PAKETWEITERLEITUNGSVERFAHREN UND -SYSTEM SOWIE RELAISAGENTENVORRICHTUNG</invention-title><invention-title mxw-id="PT132180028" lang="EN" load-source="patent-office">PACKET FORWARDING METHOD AND SYSTEM, AND RELAY AGENT DEVICE</invention-title><invention-title mxw-id="PT132180029" lang="FR" load-source="patent-office">PROCÉDÉ ET SYSTÈME D'ACHEMINEMENT DE PAQUET, ET DISPOSITIF D'AGENT DE RELAIS</invention-title></technical-data><parties><applicants><applicant mxw-id="PPAR918143802" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>HUAWEI TECH CO LTD</last-name><address><country>CN</country></address></addressbook></applicant><applicant mxw-id="PPAR918167759" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>HUAWEI TECHNOLOGIES CO., LTD.</last-name></addressbook></applicant><applicant mxw-id="PPAR918986031" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Huawei Technologies Co., Ltd.</last-name><iid>101263435</iid><address><street>Huawei Administration Building Bantian, Longgang</street><city>Shenzhen, Guangdong 518129</city><country>CN</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR918169420" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>LI CHENGGANG</last-name><address><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR918154654" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>LI, CHENGGANG</last-name></addressbook></inventor><inventor mxw-id="PPAR918987818" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>LI, CHENGGANG</last-name><address><street>Huawei Administration Building Bantian Longgang</street><city>Shenzhen Guangdong 518129</city><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR918166348" load-source="docdb" sequence="2" format="epo"><addressbook><last-name>LI HONGYU</last-name><address><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR918162943" load-source="docdb" sequence="2" format="intermediate"><addressbook><last-name>LI, HONGYU</last-name></addressbook></inventor><inventor mxw-id="PPAR918980553" load-source="patent-office" sequence="2" format="original"><addressbook><last-name>LI, HONGYU</last-name><address><street>Huawei Administration Building Bantian Longgang</street><city>Shenzhen Guangdong 518129</city><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR918161422" load-source="docdb" sequence="3" format="epo"><addressbook><last-name>LUO YONG</last-name><address><country>CN</country></address></addressbook></inventor><inventor mxw-id="PPAR918159910" load-source="docdb" sequence="3" format="intermediate"><addressbook><last-name>LUO, YONG</last-name></addressbook></inventor><inventor mxw-id="PPAR918994082" load-source="patent-office" sequence="3" format="original"><addressbook><last-name>LUO, YONG</last-name><address><street>Huawei Administration Building Bantian Longgang</street><city>Shenzhen Guangdong 518129</city><country>CN</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR918992856" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Pfenning, Meinig &amp; Partner GbR</last-name><iid>101364905</iid><address><street>Joachimstaler Strasse 12</street><city>10719 Berlin</city><country>DE</country></address></addressbook></agent></agents></parties><international-convention-data><pct-or-regional-filing-data ucid="CN-2012073259-W"><document-id><country>CN</country><doc-number>2012073259</doc-number><kind>W</kind><date>20120329</date><lang>ZH</lang></document-id></pct-or-regional-filing-data><pct-or-regional-publishing-data ucid="WO-2012130151-A1"><document-id><country>WO</country><doc-number>2012130151</doc-number><kind>A1</kind><date>20121004</date><lang>ZH</lang></document-id></pct-or-regional-publishing-data><designated-states><ep-contracting-states><country mxw-id="DS548867854" load-source="docdb">AL</country><country mxw-id="DS548801739" load-source="docdb">AT</country><country mxw-id="DS548867855" load-source="docdb">BE</country><country mxw-id="DS548802980" load-source="docdb">BG</country><country mxw-id="DS548848217" load-source="docdb">CH</country><country mxw-id="DS548854260" load-source="docdb">CY</country><country mxw-id="DS548801740" load-source="docdb">CZ</country><country mxw-id="DS548867856" load-source="docdb">DE</country><country mxw-id="DS548854261" load-source="docdb">DK</country><country mxw-id="DS548854262" load-source="docdb">EE</country><country mxw-id="DS548837249" load-source="docdb">ES</country><country mxw-id="DS548802981" load-source="docdb">FI</country><country mxw-id="DS548847905" load-source="docdb">FR</country><country mxw-id="DS548867857" load-source="docdb">GB</country><country mxw-id="DS548854263" load-source="docdb">GR</country><country mxw-id="DS548867858" load-source="docdb">HR</country><country mxw-id="DS548801741" load-source="docdb">HU</country><country mxw-id="DS548848218" load-source="docdb">IE</country><country mxw-id="DS548854264" load-source="docdb">IS</country><country mxw-id="DS548847906" load-source="docdb">IT</country><country mxw-id="DS548854265" load-source="docdb">LI</country><country mxw-id="DS548802982" load-source="docdb">LT</country><country mxw-id="DS548853879" load-source="docdb">LU</country><country mxw-id="DS548802983" load-source="docdb">LV</country><country mxw-id="DS548802984" load-source="docdb">MC</country><country mxw-id="DS548853880" load-source="docdb">MK</country><country mxw-id="DS548853881" load-source="docdb">MT</country><country mxw-id="DS548801742" load-source="docdb">NL</country><country mxw-id="DS548837250" load-source="docdb">NO</country><country mxw-id="DS548848219" load-source="docdb">PL</country><country mxw-id="DS548802985" load-source="docdb">PT</country><country mxw-id="DS548801743" load-source="docdb">RO</country><country mxw-id="DS548802990" load-source="docdb">RS</country><country mxw-id="DS548848220" load-source="docdb">SE</country><country mxw-id="DS548847907" load-source="docdb">SI</country><country mxw-id="DS548837251" load-source="docdb">SK</country><country mxw-id="DS548848221" load-source="docdb">SM</country><country mxw-id="DS548854190" load-source="docdb">TR</country></ep-contracting-states></designated-states></international-convention-data></bibliographic-data><abstract mxw-id="PA128669851" lang="EN" load-source="patent-office"><p id="pa01" num="0001">The present invention provides a message forwarding method and system, and a relay agent device. The forwarding method includes: receiving a first DHCPv6 message from a DHCPv6 client through a layer-3 interface; generating a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of the layer-3 interface is added therein; and sending the Relay-forward message to a DHCPv6 server. With the technical solution of the present invention, the relay agent device can correctly forward messages, resources of global unicast addresses or site-local addresses can be saved, and layer-3 forwarding performance of the relay agent device can be improved.<img id="iaf01" file="imgaf001.tif" wi="104" he="81" img-content="drawing" img-format="tif"/></p></abstract><abstract mxw-id="PA128499224" lang="EN" source="EPO" load-source="docdb"><p>The present invention provides a message forwarding method and system, and a relay agent device. The forwarding method includes: receiving a first DHCPv6 message from a DHCPv6 client through a layer-3 interface; generating a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of the layer-3 interface is added therein; and sending the Relay-forward message to a DHCPv6 server. With the technical solution of the present invention, the relay agent device can correctly forward messages, resources of global unicast addresses or site-local addresses can be saved, and layer-3 forwarding performance of the relay agent device can be improved.</p></abstract><description mxw-id="PDES63955281" lang="EN" load-source="patent-office"><!-- EPO <DP n="1"> --><p id="p0001" num="0001">This application claims priority to Chinese Patent Application No. <patcit id="pcit0001" dnum="CN201110077032"><text>201110077032.8</text></patcit>, filed with the Chinese Patent Office on March 29, 2011 and entitled "MESSAGE FORWARDING METHOD, SYSTEM, AND RELAY AGENT DEVICE", which is incorporated herein by reference in its entirety.</p><heading id="h0001"><b>TECHNICAL FIELD</b></heading><p id="p0002" num="0002">Embodiments of the present invention relate to network communications technologies, and in particular to a message forwarding method and system, and a relay agent device.</p><heading id="h0002"><b>BACKGROUND</b></heading><p id="p0003" num="0003">A Dynamic Host Configuration Protocol (Dynamic Host Configuration Protocol for IPv6, DHCPv6 for short) for Internet Protocol version 6 (Internet Protocol Version 6, IPv6 for short) network system includes a DHCPv6 client, a DHCPv6 server, and a DHCPv6 relay agent, where the DHCPv6 relay agent may further be classified into two large categories: DHCPv6 layer-3 relay agent and DHCPv6 layer-2 relay agent. In the network, the DHCPv6 layer-3 relay agent is located between the DHCPv6 client and the DHCPv6 server, and relays and forwards messages between the DHCPv6 client and the DHCPv6 server.</p><p id="p0004" num="0004">According to a request for comments (Request For Comments, RFC for short) 3315, the DHCPv6 layer-3 relay agent reconstructs a Relay-forward (Relay-forward) message when performing layer-3 relay processing for an upstream DHCPv6 message, and encapsulates the original upstream DHCPv6 message into the Relay-forward message for forwarding to the DHCPv6 server. After receiving the Relay-forward message forwarded by the DHCPv6 layer-3 relay agent, the DHCPv6 server constructs a Relay-reply (Relay-reply) message and<!-- EPO <DP n="2"> --> encapsulates the message sent to the DHCPv6 client into the Relay-reply message layer by layer, and sends the encapsulated message to the DHCPv6 layer-3 relay agent. The DHCPv6 layer-3 relay agent extracts a new downstream DHCPv6 message from the Relay-reply message when performing layer-3 relay processing for the Relay-reply message, and forwards the DHCPv6 message to a lower-level device according to a peer address (peer-address) field, a link address (link-address) field, and an interface identifier option (Interface-ID Option) field in the Relay-reply message. The peer-address is an IPv6 address of the lower-level device connected to the DHCPv6 layer-3 relay agent, the link-address is an IPv6 address of a layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, and the Interface-ID Option is an identifier of a user port for connecting the DHCPv6 layer-3 relay agent to the lower-level device. As provided by the protocol, only a global unicast address or a site-local address can be filled in the link-address; if the layer-3 interface is not configured with any global unicast address or site-local address, only an unspecified address (::) can be filled in the link-address; and the Interface-ID Option is used to carry identifier information of the user port.</p><p id="p0005" num="0005">When the lower-level device uses a link-local address and the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device also uses a link-local address, in the Relay-reply message, the peer-address is a link-local address and the link-address is an unspecified address. In this case, the DHCPv6 layer-3 relay agent needs to send the downstream DHCPv6 message to the lower-level device according to the user port identified by the Interface-ID Option. The user port is a physical port on the layer-3 relay agent device, and a manner of using the physical port is configuring it as a layer-3 interface and receiving and sending a layer-3 message by using a configured IPv6 address. However, the user port of the DHCPv6 layer-3 relay agent generally does not correspond to the layer-3 interface on a one-to-one basis. For example, in a triple-play (Triple-play) scenario, multiple service streams need to be configured on a user port of the DHCPv6 layer-3 relay agent. The service streams are used to separately bear different services of a same user, and a virtual local area network (Virtual Local Area Network, VLAN for short) bears a same service on different user ports. Each VLAN is configured with a layer-3 interface, that is, the user port and the VLAN or the layer-3 interface are in a many-to-many relationship. In this case, the DHCPv6 layer-3 relay<!-- EPO <DP n="3"> --> agent can find only a unique user port according to the Interface-ID Option, but cannot find a unique layer-3 interface, and therefore cannot send the downstream DHCPv6 message to the lower-level device through a correct layer-3 interface.</p><p id="p0006" num="0006">To forward the DHCPv6 message to the lower-level device correctly, there exists the following solutions in the prior art: One solution is configuring a global unicast address or a site-local address for the lower-level device according to RFC 3315, so that the DHCPv6 layer-3 relay agent may query a routing table by using the peer-address to find the layer-3 interface, and send the downstream DHCPv6 message to the lower-level device through a correct layer-3 interface. Another solution is configuring, according to RFC 3315, a global unicast address or a site-local address for the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, so that the DHCPv6 layer-3 relay agent may use the link-address to find the layer-3 interface, and send the downstream DHCPv6 message to the lower-level device through a correct layer-3 interface. Still another solution is configuring a layer-3 interface for each user port of the DHCPv6 layer-3 relay agent according to RFC 3315 to make the user port correspond to the layer-3 interface on a one-to-one basis, so that the layer-3 relay agent may first use the Interface-ID Option to find a unique user port, and then find a unique corresponding layer-3 interface according to the user port, and send the downstream DHCPv6 message to the lower-level device through a correct layer-3 interface. In a process of implementing the present invention, the inventor finds that the prior art has at least the following problems: No matter a global unicast address or a site-local address is configured for the lower-level device, or for the layer-3 interface of the DHCPv6 layer-3 relay agent, the planning and configuration workload of the global unicast address or a site-local address is increased, and resources of global unicast addresses or site-local addresses are wasted. The solution of configuring a layer-3 interface for each user port increases the number of layer-3 interfaces on the DHCPv6 layer-3 relay agent, which greatly increases the workload of layer-3 forwarding of the DHCPv6 layer-3 relay agent, reduces layer-3 forwarding performance, and wastes IPv6 address resources.<!-- EPO <DP n="4"> --></p><heading id="h0003"><b>SUMMARY</b></heading><p id="p0007" num="0007">Embodiments of the present invention provide a message forwarding method and system, and a relay agent device, which are used to overcome disadvantages of the prior art, forward messages between a client and a server through a correct layer-3 interface, and improve a success ratio of message forwarding.</p><p id="p0008" num="0008">An embodiment of the present invention provides a message forwarding method, including:
<ul><li>receiving a first DHCPv6 message from a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 client through a layer-3 interface;</li><li>generating a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of the layer-3 interface is added therein; and</li><li>sending the Relay-forward message to a DHCPv6 server.</li></ul></p><p id="p0009" num="0009">The present invention provides a relay agent device, including:
<ul><li>a first receiving module, configured to receive a first DHCPv6 message from a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 client;</li><li>a message generating module, configured to generate a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3 interface receiving the first DHCPv6 message is added therein; and</li><li>a first forwarding module, configured to send the Relay-forward message to a DHCPv6 server.</li></ul></p><p id="p0010" num="0010">An embodiment of the present invention provides a message forwarding system, including a relay agent device and a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 server, where:
<ul><li>the relay agent device is configured to construct a Relay-forward message after receiving a first DHCPv6 message from a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 client, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3<!-- EPO <DP n="5"> --> interface receiving the first DHCPv6 message is added therein, and send the Relay-forward message to the DHCPv6 server; and</li><li>the DHCPv6 server is configured to receive the Relay-forward message sent by the relay agent device, and generate, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface.</li></ul></p><p id="p0011" num="0011">According to the message forwarding method and system, and the relay agent device provided by the embodiments of the present invention, a Relay-forward message carries an identifier of a layer-3 interface on which a relay agent device receives a message sent by a DHCPv6 client to a DHCPv6 server, so that the server generates, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface; therefore, the relay agent device can send the message of the DHCPv6 server to the DHCPv6 client through a correct layer-3 interface, which improves a success ratio of message forwarding between the DHCPv6 client and the DHCPv6 server; and in addition, compared with the prior art, the embodiments of the present invention may further save resources of global unicast addresses or site-local addresses, reduce the forwarding workload of the relay agent device, and improve layer-3 forwarding performance.</p><heading id="h0004"><b>BRIEF DESCRIPTION OF DRAWINGS</b></heading><p id="p0012" num="0012">To illustrate the technical solutions in the embodiments of the present invention or in the prior art more clearly, the following briefly introduces the accompanying drawings required for describing the embodiments or the prior art. Apparently, the accompanying drawings in the following description show merely some embodiments of the present invention, and a person of ordinary skill in the art may still derive other drawings from these accompanying drawings without creative efforts.
<ul><li><figref idrefs="f0001">FIG. 1</figref> is a flowchart of a message forwarding method according to Embodiment 1 of the present invention;</li><li><figref idrefs="f0001">FIG. 2</figref> is a flowchart of a message generating method according to Embodiment 2 of the present invention;<!-- EPO <DP n="6"> --></li><li><figref idrefs="f0002">FIG. 3</figref> is a flowchart of a message forwarding method according to Embodiment 3 of the present invention;</li><li><figref idrefs="f0003">FIG. 4A</figref> is a flowchart of a message processing method according to Embodiment 4 of the present invention;</li><li><figref idrefs="f0003">FIG. 4B</figref> is a schematic structural diagram of an existing link-local address according to Embodiment 4 of the present invention;</li><li><figref idrefs="f0004">FIG. 5</figref> is a flowchart of a message processing method according to Embodiment 5 of the present invention;</li><li><figref idrefs="f0005">FIG. 6A</figref> is a flowchart of a message processing method according to Embodiment 6 of the present invention;</li><li><figref idrefs="f0005">FIG. 6B</figref> is a schematic diagram of an existing structure of an Interface-ID Option field according to Embodiment 6 of the present invention;</li><li><figref idrefs="f0006">FIG. 6C</figref> is a schematic structural diagram of an Interface-ID Option field according to Embodiment 6 of the present invention;</li><li><figref idrefs="f0006">FIG. 7A</figref> is a flowchart of a message processing method according to Embodiment 7 of the present invention;</li><li><figref idrefs="f0007">FIG. 7B</figref> is a schematic structural diagram of a layer-3 identifier field according to Embodiment 7 of the present invention;</li><li><figref idrefs="f0007">FIG. 8</figref> is a schematic structural diagram of a relay agent device according to Embodiment 8 of the present invention;</li><li><figref idrefs="f0007">FIG. 9</figref> is another schematic structural diagram of the relay agent device according to Embodiment 8 of the present invention;</li><li><figref idrefs="f0008">FIG. 10</figref> is another schematic structural diagram of the relay agent device according to Embodiment 8 of the present invention;</li><li><figref idrefs="f0009">FIG. 11</figref> is still another schematic structural diagram of the relay agent device according to Embodiment 9 of the present invention; and</li><li><figref idrefs="f0009">FIG. 12</figref> is a schematic structural diagram of a message forwarding system according to Embodiment 9 of the present invention.</li></ul><!-- EPO <DP n="7"> --></p><heading id="h0005"><b>DESCRIPTION OF EMBODIMENTS</b></heading><p id="p0013" num="0013">To make the objectives, technical solutions, and advantages of the embodiments of the present invention more comprehensible, the following clearly and completely describes the technical solutions in the embodiments of the present invention with reference to the accompanying drawings in the embodiments of the present invention. Apparently, the described embodiments are merely a part rather than all of the embodiments of the present invention. All other embodiments obtained by a person of ordinary skill in the art based on the embodiments of the present invention without creative efforts shall fall within the protection scope of the present invention.</p><p id="p0014" num="0014"><figref idrefs="f0001">FIG. 1</figref> is a flowchart of a message forwarding method according to Embodiment 1 of the present invention. As shown in <figref idrefs="f0001">FIG. 1</figref>, the method of this embodiment includes:
<ul><li>Step 11. Receive a first DHCPv6 message from a DHCPv6 client through a layer-3 interface.</li><li>Step 12. Generate a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of the layer-3 interface is added therein.</li></ul></p><p id="p0015" num="0015">Specifically, a DHCPv6 layer-3 relay agent receives, through its layer-3 interface, a DHCPv6 message sent by a DHCPv6 client (referred to as a client below) to a DHCPv6 server (referred to as a server below), that is, a first DHCPv6 message. The DHCPv6 layer-3 relay agent reconstructs a Relay-forward message when performing layer-3 relay processing for the first DHCPv6. The Relay-forward message includes a relay message option (Relay-message Option (Option 9)) field. The DHCPv6 layer-3 relay agent encapsulates the first DHCPv6 message into the Relay-message Option field, and then fills information in the peer-address field, the link-address field, and the Interface-ID Option (that is, Option 18) field in the Relay-forward message.</p><p id="p0016" num="0016">In this embodiment, the IPv6 address of a lower-level device connected to the DHCPv6 layer-3 relay agent is filled in the peer-address field; the IPv6 address of the layer-3 interface (that is, the layer-3 interface on which the DHCPv6 layer-3 relay agent receives the first DHCPv6 message) for connecting the DHCPv6 layer-3 relay agent to the lower-level device is filled in the link-address field, and if the IPv6 address of the layer-3 interface is a link-local address, an unspecified address is filled in the field; and the Interface-ID Option field is an<!-- EPO <DP n="8"> --> identifier of a user port for connecting the DHCPv6 layer-3 relay agent to the lower-level device. In this embodiment, the lower-level device refers to a lower-level DHCPv6 device directly connected to the DHCPv6 layer-3 relay agent through the layer-3 interface, and may be a DHCPv6 client or may further be a next-level DHCPv6 layer-3 relay agent. If the lower-level device is a client, the DHCPv6 layer-3 relay agent directly receives, through its layer-3 interface, the first DHCPv6 message sent by the client; and if the lower-level device is a next-level DHCPv6 layer-3 relay agent, the DHCPv6 layer-3 relay agent receives, through its layer-3 interface, the first DHCPv6 message of the client forwarded by the next-level DHCPv6 layer-3 relay agent.</p><p id="p0017" num="0017">In this embodiment, the DHCPv6 layer-3 relay agent adds the identifier of the layer-3 interface receiving the first DHCPv6 message to the Relay-forward message when encapsulating the first DHCPv6 message into the Relay-forward message, where the identifier is used to uniquely identify the layer-3 interface receiving the first DHCPv6 message or forwarding the DHCPv6 message to the client. The identifier of the layer-3 interface may be a VLAN ID corresponding to the layer-3 interface or an Internet Protocol (Internet Protocol, IP for short) address of the layer-3 interface (the IP address is generally a link-local IP address), and may further be other information that can uniquely identify the layer-3 interface.</p><p id="p0018" num="0018">Step 13. Send the Relay-forward message to the DHCPv6 server.</p><p id="p0019" num="0019">Specifically, the DHCPv6 layer-3 relay agent sends the Relay-forward message to the server; and the server receives the Relay-forward message, parses the message to acquire the first DHCPv6 message, and performs subsequent processing according to the first DHCPv6 message.</p><p id="p0020" num="0020">According to the message forwarding method of this embodiment, a DHCPv6 layer-3 relay agent adds an identifier of a layer-3 interface receiving a first DHCPv6 message to a Relay-forward message for sending to a server, and the server may generate, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface, and send the Relay-reply message to the DHCPv6 layer-3 relay agent. In a scenario where a lower-level device uses a link-local address, the layer-3 interface connecting the lower-level device also uses a link-local address, and a user port and the layer-3 interface are in a many-to-many mapping, the DHCPv6 layer-3 relay agent may find the layer-3 interface<!-- EPO <DP n="9"> --> according to the identifier of the layer-3 interface in the Relay-reply message by using the method of this embodiment, and forward the message sent by the server to a client, to the client through a correct layer-3 interface. Compared with the prior art, the method of this embodiment may save resources of global unicast addresses or site-local addresses; and in addition, no one-to-one mapping is required for the user port and the layer-3 interface, which reduces the number of layer-3 interfaces and ensures layer-3 forwarding performance of the DHCPv6 layer-3 relay agent.</p><p id="p0021" num="0021"><figref idrefs="f0001">FIG. 2</figref> is a flowchart of a message generating method according to Embodiment 2 of the present invention. As shown in <figref idrefs="f0001">FIG. 2</figref>, the method of this embodiment includes:
<ul><li>Step 21. Receive a Relay-forward message sent by a relay agent device, where the Relay-forward message includes a first DHCPv6 message sent by a client to a server and an identifier of a layer-3 interface on which the relay agent device receives the first DHCPv6 message.</li></ul></p><p id="p0022" num="0022">The relay agent device mainly refers to a DHCPv6 layer-3 relay agent. Specifically, the server receives the Relay-forward message sent by the DHCPv6 layer-3 relay agent, where the Relay-forward message includes the first DHCPv6 message sent by the client to the server, and the identifier of the layer-3 interface on which the DHCPv6 layer-3 relay agent receives the first DHCPv6 message. The layer-3 interface is further a forwarding interface on which the DHCPv6 layer-3 relay agent forwards the second DHCPv6 message sent by the server to the client, to the client.</p><p id="p0023" num="0023">Step 22. Generate, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface.</p><p id="p0024" num="0024">Specifically, the server constructs a response Relay-reply message after receiving the Relay-forward message sent by the DHCPv6 layer-3 relay agent. The Relay-reply message also includes a Relay-message Option (Option 9) field. The server encapsulates, according to the encapsulation layers of the received Relay-forward message, the second DHCPv6 message sent to the client into the Relay-message Option field layer by layer. If the Relay-forward message received by the server is relayed by multiple DHCPv6 layer-3 relay agents, and includes multiple layers of encapsulation of the Relay-message Option field, the Relay-reply message must correspondingly include multiple layers of encapsulation of the<!-- EPO <DP n="10"> --> Relay-message Option field. Then the server separately copies the peer-address field, the link-address field, and the Interface-ID Option field at each layer in the Relay-forward message to the response Relay-reply message.</p><p id="p0025" num="0025">In this embodiment, the server needs to copy the identifier of the layer-3 interface identifier in the Relay-forward message to the Relay-reply message.</p><p id="p0026" num="0026">Afterward, the server sends the Relay-reply message to the DHCPv6 layer-3 relay agent, and the DHCPv6 layer-3 relay agent forwards, through its layer-3 interface, the second DHCPv6 message encapsulated into the Relay-reply message to the client.</p><p id="p0027" num="0027">According to the message generating method of this embodiment, a server generates, according to a received Relay-forward message, a Relay-reply message including an identifier of a layer-3 interface; when a DHCPv6 layer-3 relay agent receives the Relay-reply message, if the DHCPv6 layer-3 relay agent cannot forward a second DHCPv6 message to a client according to information in a peer-address field, a link-address field, or an Interface-ID Option field in the Relay-reply message, the DHCPv6 layer-3 relay agent may find a correct layer-3 interface according to the identifier of the layer-3 interface, thereby forwarding the second DHCPv6 message to the client through the correct layer-3 interface (the forwarding process may be implemented by a lower-level device). Compared with the prior art, the method of this embodiment is used to generate a Relay-reply message including an identifier of a layer-3 interface, and it is unnecessary to configure global unicast addresses or site-local addresses of a lower-level device or a layer-3 interface, which saves resources of global unicast addresses or site-local addresses; in addition, no one-to-one mapping is required for the user port and the layer-3 interface, which reduces the number of layer-3 interfaces and workload of the DHCPv6 layer-3 relay agent, and improves the forwarding performance of the DHCPv6 layer-3 relay agent; and the reduction of the layer-3 interfaces further helps to save IP address resources.</p><p id="p0028" num="0028"><figref idrefs="f0002">FIG. 3</figref> is a flowchart of a message forwarding method according to Embodiment 3 of the present invention. This embodiment is implemented based on Embodiment 1, and as shown in <figref idrefs="f0002">FIG. 3</figref>, after step 13, the method of this embodiment includes:<!-- EPO <DP n="11"> -->
<ul><li>Step 31. Receive a Relay-reply message from the server, where a second DHCPv6 message sent by the server to the client and an identifier of the layer-3 interface are encapsulated into the Relay-reply message.</li></ul></p><p id="p0029" num="0029">The second DHCPv6 message is a downstream DHCPv6 message sent by the server to the client. For the process of generating a Relay-reply message by the server according to the Relay-forward message, reference may be made to the embodiment shown in <figref idrefs="f0001">FIG. 2</figref>. The identifier of the layer-3 interface in the Relay-reply message is the identifier of the layer-3 interface in the corresponding Relay-forward message, and is used to identify a layer-3 interface on which the DHCPv6 layer-3 relay agent forwards the second DHCPv6 message. Step 32. Forward the second DHCPv6 message to the client according to the identifier of the layer-3 interface in the Relay-reply message.</p><p id="p0030" num="0030">Specifically, the DHCPv6 layer-3 relay agent extracts the second DHCPv6 message from the Relay-message Option field of the Relay-reply message when performing layer-3 relay processing for the Relay-reply message, and forwards the second DHCPv6 message to the lower-level device through the layer-3 interface.</p><p id="p0031" num="0031">Generally, the DHCPv6 layer-3 relay agent forwards the second DHCPv6 message according to the peer-address field, the link-address field, or the Interface-ID Option field in the Relay-reply message. For example, if the lower-level device uses a global unicast address or a site-local address, the DHCPv6 layer-3 relay agent may directly query a routing table according to the peer-address field to find a layer-3 interface, and forward the second DHCPv6 message to the lower-level device through the layer-3 interface, where the second DHCPv6 message is finally forwarded to the client. For another example, if the lower-level device uses a link-local address, but the layer-3 interface uses a global unicast address or a site-local address, the DHCPv6 layer-3 relay agent may directly find a layer-3 interface according to the link-address field, and forward the second DHCPv6 message to the lower-level device through the layer-3 interface, where the second DHCPv6 message is finally forwarded to the client. For another example, if both the lower-level device and the layer-3 interface use link-local addresses, the DHCPv6 layer-3 relay agent may further find a unique user port according to the Interface-ID Option field, find a unique layer-3 interface according to a one-to-one mapping between the user port and the layer-3 interface, and<!-- EPO <DP n="12"> --> forward the second DHCPv6 message to the lower-level device through the layer-3 interface, where the second DHCPv6 message is finally forwarded to the client. However, if the user port and the layer-3 interface are not in a one-to-one mapping in this case, the DHCPv6 layer-3 relay agent cannot find a correct layer-3 interface according to the Interface-ID Option field.</p><p id="p0032" num="0032">In a scenario where both the lower-level device and the layer-3 interface use link-local addresses, and there is a many-to-many mapping between the user port and the layer-3 interface, the DHCPv6 layer-3 relay agent of this embodiment may find a correct layer-3 interface according to the identifier of the layer-3 interface in the Relay-reply message, and forward the second DHCPv6 message to the lower-level device, where the second DHCPv6 message is finally forwarded to the client. The identifier of the layer-3 interface may uniquely identify a layer-3 interface on the DHCPv6 layer-3 relay agent, for example, a VLAN ID of the VLAN where the layer-3 interface is located, or an IP address of the layer-3 interface, and so on. No matter the user port of the DHCPv6 layer-3 relay agent and the layer-3 interface are in a one-to-one mapping or a many-to-many mapping, there is a mapping between the identifier of the user port and the identifier of the layer-3 interface which are encapsulated into the Relay-forward message and the Relay-reply message; and if the user port and the layer-3 interface have a many-to-many mapping, the identifier of the layer-3 interface in the Relay-forward message and the Relay-reply message is an identifier of one layer-3 interface in the multiple layer-3 interfaces corresponding to the user port.</p><p id="p0033" num="0033">In addition, in other scenarios, the DHCPv6 layer-3 relay agent of this embodiment may further find a correct layer-3 interface directly according to the identifier of the layer-3 interface in the Relay-reply message, and forward the second DHCPv6 message to the lower-level device, where the second DHCPv6 message is finally forwarded to the client.</p><p id="p0034" num="0034">In the above forwarding process, if the lower-level device is a client, the second DHCPv6 message is directly sent by the DHCPv6 layer-3 relay agent to the client through the layer-3 interface of the DHCPv6 layer-3 relay agent.</p><p id="p0035" num="0035">According to the message forwarding method of this embodiment, a DHCPv6 layer-3 relay agent can find a correct layer-3 interface according to an identifier of a layer-3 interface in a Relay-reply message in any scenario, and forward a second DHCPv6 message to a<!-- EPO <DP n="13"> --> lower-level device through the layer-3 interface to finally forward the second DHCPv6 message to the client, so that both the lower-level device and the layer-3 interface do not need to be configured with a global unicast address or a site-local address, and do not require a one-to-one mapping between the layer-3 interface and a user port. Therefore, not only resources of global unicast addresses or site-local addresses are saved, but also the number of layer-3 interfaces of the DHCPv6 layer-3 relay agent is reduced, and forwarding performance of the DHCPv6 layer-3 relay agent is improved.</p><p id="p0036" num="0036"><figref idrefs="f0003">FIG. 4A</figref> is a flowchart of a message processing method according to Embodiment 4 of the present invention. This embodiment may be implemented based on Embodiment 1 to Embodiment 3. As shown in <figref idrefs="f0003">FIG. 4</figref>, the method of this embodiment includes:
<ul><li>Step 41. A DHCPv6 layer-3 relay agent encapsulates an upstream DHCPv6 message into the Relay-message Option field of a Relay-forward message, fills in the peer-address field, the link-address field, and the Interface-ID Option field, adds the identifier of an layer-3 interface to the peer-address field of the Relay-forward message, and then sends the Relay-forward message to a server.</li></ul></p><p id="p0037" num="0037">The upstream DHCPv6 message is a DHCPv6 message sent by a client to the server, that is, the first DHCPv6 message in Embodiment 1. As described above, the peer-address field is used to carry an IPv6 address of a lower-level device. If the lower-level device uses a link-local address, a link-local address is filled in the peer-address field. According to RFC 2373, the prefix of the link-local address is 64-bit FE80::/10. The method for automatically generating a link-local address is first generating an EUI-64 identifier as an identifier of the interface according to the link-layer address of the interface for connecting the lower-level device to the DHCPv6 layer-3 relay agent, and then combining the 64-bit prefix FE80:: with the 64-bit identifier to form a 128-bit link-local address whose format is shown in <figref idrefs="f0003">FIG. 4B</figref>. As known from <figref idrefs="f0003">FIG. 4B</figref>, the 10<sup>th</sup> bit (bit) to 63<sup>rd</sup> bit (that is, bit 10 to bit 63) of the automatically generated link local address are fixed to 0, and are also not the prefix of the link-local address, and belong to spare bits. Therefore, in this embodiment, the DHCPv6 layer-3 relay agent specifically inserts the identifier of the layer-3 interface between bit 10 and bit 63 of the peer-address field. For example, in the case that the VLAN is configured with a<!-- EPO <DP n="14"> --> layer-3 interface, the VLAN ID or the IP address and so on of the VLAN interface (that is, the layer-3 interface) may be inserted between bit 10 and bit 63.</p><p id="p0038" num="0038">Step 42. The server receives the Relay-forward message, encapsulates a downstream DHCPv6 message into the Relay-message Option field of a Relay-reply message, and copies the peer-address field, the link-address field, and the Interface-ID Option field in the Relay-reply message to the response Relay-reply message, and then sends the Relay-reply message to the DHCPv6 layer-3 relay agent.</p><p id="p0039" num="0039">The downstream DHCPv6 message is a response message, that is, the second DHCPv6 message in Embodiment 2, which is sent by the server to the client according to the upstream DHCPv6 message. The identifier of the layer-3 interface is inserted between bit 10 and bit 63 in the peer-address field of the Relay-reply message.</p><p id="p0040" num="0040">Step 43. The DHCPv6 layer-3 relay agent receives the Relay-reply message, extracts the downstream DHCPv6 message from the Relay-reply message, extracts the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, from the peer-address field of the Relay-reply message, locates the layer-3 interface according to the identifier of the layer-3 interface, and sends the downstream DHCPv6 message to the lower-level device through the layer-3 interface, where the downstream DHCPv6 message is finally forwarded to the client.</p><p id="p0041" num="0041">According to the message processing method of this embodiment, an identifier of a layer-3 interface connected to a lower-level device is inserted in spare bits of a peer-address field, so that a DHCPv6 layer-3 relay agent may correctly locate a layer-3 interface forwarding a downstream DHCPv6 message, thereby correctly forwarding the downstream DHCPv6 message. Compared with the prior art, the message processing method of this embodiment has advantages of saving global unicast addresses or site-local addresses and reducing the number of layer-3 interfaces, and can improve the layer-3 forwarding efficiency of the DHCPv6 layer-3 relay agent.</p><p id="p0042" num="0042">In addition, because the Interface-ID Option field is a variable-length field, the identifier of the layer-3 interface may further be carried by the Interface-ID Option field. The following embodiments of the present invention provide several implementations in which the Interface-ID Option field carries the identifier of the layer-3 interface identifier.<!-- EPO <DP n="15"> --></p><p id="p0043" num="0043"><figref idrefs="f0004">FIG. 5</figref> is a flowchart of a message processing method according to Embodiment 5 of the present invention. This embodiment may be implemented based on Embodiment 1 to Embodiment 3. As shown in <figref idrefs="f0004">FIG. 5</figref>, the method of this embodiment includes:
<ul><li>Step 51. A DHCPv6 layer-3 relay agent encapsulates an upstream DHCPv6 message into the Relay-message Option field of an internal-layer Relay-forward message, fills in the peer-address field, the link-address field, and the Interface-ID Option field of the internal-layer Relay-forward message, encapsulates the internal-layer Relay-forward message as a new message into the Relay-message Option field of an external-layer Relay-forward message, and fills in the peer-address field, the link-address field, and the Interface-ID Option field of the external-layer Relay-forward message, and then sends the Relay-forward message to a server. The same content is filled in the peer-address field and the link-address field of the external-layer Relay-forward message and the internal-layer Relay-forward message. One of the two Interface-ID Option fields is used to add an identifier of a user port specified by the protocol, and the other is used to add an identifier of a layer-3 interface.</li></ul></p><p id="p0044" num="0044">In this embodiment, the DHCPv6 layer-3 relay agent performs double encapsulation for the upstream DHCPv6 message, and provides two Interface-ID Option fields, where one of the Interface-ID Option fields is used to carry the identifier of the layer-3 interface. This embodiment uses an example in which the Interface-ID Option field of the external-layer Relay-forward message carries the identifier of the layer-3 interface.</p><p id="p0045" num="0045">If the Interface-ID Option field of the internal-layer Relay-forward message carries the identifier of the layer-3 interface, after the identifier of the layer-3 interface is added to the Interface-ID Option field of the internal-layer Relay-forward message, the internal-layer Relay-forward message is encapsulated into the Relay-message Option field of the external-layer Relay-forward message.</p><p id="p0046" num="0046">Step 52. The server receives the Relay-forward message, encapsulates a downstream DHCPv6 message into the Relay-message Option field of an internal-layer Relay-reply message, and copies the peer-address field, the link-address field, and the Interface-ID Option field in the internal-layer Relay-forward message to the response internal-layer Relay-reply message, then encapsulates the internal-layer Relay-reply message as a new message into the Relay-message Option field of an external-layer Relay-reply message, and copies the<!-- EPO <DP n="16"> --> peer-address field, the link-address field, and the Interface-ID Option field in the external-layer Relay-forward message to the response external-layer Relay-reply message, and sends the Relay-reply message to the DHCPv6 layer-3 relay agent.</p><p id="p0047" num="0047">The server separately constructs an internal-layer Relay-reply message and an external-layer Relay-reply message according to the form of the received Relay-forward message (including an internal-layer Relay-forward message and an external-layer Relay-forward), and carries the identifier of the layer-3 interface in the generated Relay-reply message by separately copying the peer-address field, the link-address field, and the Interface-ID Option field of the internal-layer Relay-forward message and the external-layer Relay-forward message.</p><p id="p0048" num="0048">Step 53. The DHCPv6 layer-3 relay agent extracts the internal-layer Relay-reply message from the Relay-message Option field of the external-layer Relay-reply message, extracts the downstream DHCPv6 message from the Relay-message Option field of the internal-layer Relay-reply message, extracts the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to a lower-level device, from the Interface-ID Option field of the external-layer Relay-reply message, and sends the downstream DHCPv6 message to the lower-level device through the layer-3 interface located by the identifier of the layer-3 interface, where the downstream DHCPv6 message is finally forwarded to the client.</p><p id="p0049" num="0049">When the identifier of the layer-3 interface is encapsulated into the internal-layer Relay-reply message, the DHCPv6 layer-3 relay agent extracts the downstream DHCPv6 message from the Relay-message Option field of the internal-layer Relay-reply message, and extracts the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, from the Interface-ID Option field of the internal-layer Relay-reply message.</p><p id="p0050" num="0050">According to the message processing method of this embodiment, a DHCPv6 layer-3 relay agent performs double encapsulation for an upstream DHCPv6 message, and provides two Interface-ID Option fields, where one of the Interface-ID Option fields is used to carry an identifier of a layer-3 interface, thereby solving the problems in the prior art.</p><p id="p0051" num="0051"><figref idrefs="f0005">FIG. 6A</figref> is a flowchart of a message processing method according to Embodiment 6 of the present invention. This embodiment may be implemented based on Embodiment 1 to Embodiment 3. As shown in <figref idrefs="f0005">FIG. 6A</figref>, the method of this embodiment includes:<!-- EPO <DP n="17"> --></p><p id="p0052" num="0052">Step 61. A DHCPv6 layer-3 relay agent extends the Interface-ID Option field of a Relay-forward message, encapsulates an upstream DHCPv6 message into the Relay-message Option field of the Relay-forward message, and fills in the peer-address field, the link-address field, and the extended Interface-ID Option field of the Relay-forward message (adds the identifier of a layer-3 interface to the extended Interface-ID Option field while filling in the Interface-ID Option field), and then sends the Relay-forward message to a server. The identifier of a user port specified by the protocol and the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to a lower-level device are filled in the extended Interface-ID Option field.</p><p id="p0053" num="0053">According to RFC 3315, the Interface-ID Option field is used to carry the identifier of the user port for connecting the DHCPv6 layer-3 relay agent to the lower-level device. The format of the field is shown in <figref idrefs="f0005">FIG. 6B</figref>, and includes an identifier of the field (OPTION_INTERFACE_ID), a length option (option-len), and an interface identifier (interface-id) field. The interface-id field is used to carry the identifier of the user port.</p><p id="p0054" num="0054">In this embodiment, the Interface-ID Option field is extended as follows: adding a layer-3 interface identifier (13-interface-id) field before or after the interface-id field. The interface-id field and the 13-interface-id field may be distinguished by specifying the 13-interface-id field as a fixed length, for example, specifying that the 13-interface-id field fixedly occupies four octets; or it may be specified that the interface-id field and the 13-interface-id field are separated by a specific separator, for example, it is specified that the interface-id field and the 13-interface-id field are separated by 0x00. For example, in the case that the VLAN is configured with a layer-3 interface, a 13-interface-id field fixedly occupying four octets may be added after the interface-id field to carry the VLAN ID or the IP address of the VLAN interface (that is, a layer-3 interface connecting the lower-level device), and the specific structure of the 13-interface-id field is shown in <figref idrefs="f0006">FIG. 6C</figref>.</p><p id="p0055" num="0055">Step 62. The server receives the Relay-forward message, extends the Interface-ID Option field of a Relay-reply message, encapsulates a downstream DHCPv6 message into the Relay-message Option field of the Relay-reply message, copies the peer-address field, the link-address field, and the Interface-ID Option field of the Relay-forward message to the<!-- EPO <DP n="18"> --> response Relay-reply message, and sends the Relay-reply message to the DHCPv6 layer-3 relay agent.</p><p id="p0056" num="0056">The Interface-ID Option field of the Relay-reply message has the same extension structure as the Interface-ID Option field in the Relay-forward message. As shown in <figref idrefs="f0006">FIG. 6C</figref>, the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device is filled in the 13-interface-id field.</p><p id="p0057" num="0057">Step 63. The DHCPv6 layer-3 relay agent extracts the downstream DHCPv6 message from the Relay-message Option field of the Relay-reply message, extracts the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, from the Interface-ID Option field of the Relay-reply message, and sends the downstream DHCPv6 message to the lower-level device through the layer-3 interface located by the identifier of the layer-3 interface, where the downstream DHCPv6 message is finally forwarded to a client.</p><p id="p0058" num="0058">According to the message processing method of this embodiment, an Interface-ID Option field is extended so that the Interface-ID Option field carries both an identifier of a port specified by a protocol and an identifier of a layer-3 interface connecting a lower-level device, thereby solving the problems in the prior art.</p><p id="p0059" num="0059">In addition, in the above embodiment, the server may further construct a Relay-forward message and a Relay-reply message that include a layer-2 identifier field, where the layer-2 identifier field carries the identifier of the user port (that is, a user port corresponding to the layer-3 interface) specified by the protocol, and the Interface-ID Option field originally carrying the identifier of the user port carries the identifier of the layer-3 interface. Specifically, the server adds a layer-2 identifier field to the Relay-forward message and the Relay-reply message, and then adds the identifier of the user port specified by the protocol to the added layer-2 identifier field, and adds the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, to the Interface-ID Option field that is originally filled with the identifier of the user port. After receiving the Relay-forward message, the server correspondingly constructs a Relay-reply message including the layer-2 identifier field. The identifier of the user port corresponding to the layer-3 interface is added to the layer-2 identifier field of the Relay-reply message, and the identifier of the layer-3<!-- EPO <DP n="19"> --> interface is added to the Interface-ID Option field of the Relay-reply message. The specific implementation of carrying the identifier of the layer-3 interface by the Interface-ID Option field is similar to that of Embodiment 7. The specific implementation process is not described herein. For details, reference may be made to the description in Embodiment 7. This embodiment may also solve the problems in the prior art.</p><p id="p0060" num="0060"><figref idrefs="f0006">FIG. 7A</figref> is a flowchart of a message processing method according to Embodiment 7 of the present invention. This embodiment may be implemented based on Embodiment 1 to Embodiment 3. As shown in <figref idrefs="f0006">FIG. 7A</figref>, the method of this embodiment includes:
<ul><li>Step 71. A DHCPv6 layer-3 relay agent adds a layer-3 identifier field to a Relay-forward message, encapsulates an upstream DHCPv6 message into the Relay-message Option field of the Relay-forward message, and fills in the peer-address field, the link-address field, and the Interface-ID Option field of the Relay-forward message. In addition, the DHCPv6 layer-3 relay agent adds the identifier of a layer-3 interface for connecting the DHCPv6 layer-3 relay agent to a lower-level device, to the new layer-3 identifier field, and then sends the Relay-forward message to a server.</li></ul></p><p id="p0061" num="0061"><figref idrefs="f0007">FIG. 7B</figref> is a schematic structural diagram of a layer-3 identifier field according to this embodiment, specifically including: a layer-3 identifier field identifier (OPTION_L3_INTERFACE_ID), a length option (option-len), and a layer-3 interface identifier (13-interface-id) field, where the 13-interface-id field is used to carry the identifier of the layer-3 interface connecting the lower-level device.</p><p id="p0062" num="0062">Step 72. The server receives the Relay-forward message, adds a layer-3 identifier field to a Relay-reply message, encapsulates a downstream DHCPv6 message into the Relay-message Option field of the Relay-reply message, separately copies the peer-address field, the link-address field, the Interface-ID Option field, and the layer-3 identifier field of the Relay-forward message to the response Relay-reply message, and sends the Relay-reply message to the DHCPv6 layer-3 relay agent.</p><p id="p0063" num="0063">Specifically, according to the Relay-forward message, the server constructs a Relay-reply message including the layer-3 identifier field, adds the identifier of the layer-3 interface in the layer-3 identifier field in the Relay-forward message to the layer-3 identifier field of the Relay-reply message, and then sends the Relay-reply message to the DHCPv6 layer-3 relay<!-- EPO <DP n="20"> --> agent. The structure of the layer-3 identifier field in the Relay-reply message is similar to that of the Relay-forward message. Reference may be made to <figref idrefs="f0007">FIG. 7B</figref>.</p><p id="p0064" num="0064">Step 73. The DHCPv6 layer-3 relay agent extracts the downstream DHCPv6 message from the Relay-message Option field of the Relay-reply message, extracts the identifier of the layer-3 interface for connecting the DHCPv6 layer-3 relay agent to the lower-level device, from the layer-3 identifier field of the Relay-reply message, and sends the downstream DHCPv6 message to the lower-level device through the layer-3 interface located by the identifier of the layer-3 interface, where the downstream DHCPv6 message is finally forwarded to a client.</p><p id="p0065" num="0065">According to the message processing method of this embodiment, a layer-3 identifier field is added to a Relay-forward message and a Relay-reply message, and the new layer-3 identifier field carries an identifier of a layer-3 interface, thereby solving the problems in the prior art. In the above embodiments, various methods are used to carry an identifier of a layer-3 interface for connecting a DHCPv6 layer-3 relay agent to a lower-level device (that is, an identifier of a layer-3 interface receiving an upstream DHCPv6 message and forwarding a downstream DHCPv6 message), so that the DHCPv6 layer-3 relay agent may find a correct layer-3 interface and complete forwarding of the message, thereby solving the problems in the prior art.</p><p id="p0066" num="0066"><figref idrefs="f0007">FIG. 8</figref> is a schematic structural diagram of a relay agent device according to Embodiment 8 of the present invention. The relay agent device of this embodiment mainly refers to a DHCPv6 layer-3 relay agent, as shown in <figref idrefs="f0007">FIG. 8</figref>, including: a first receiving module 80, a message generating module 81, and a first forwarding module 82.</p><p id="p0067" num="0067">The first receiving module 80 is configured to receive a first DHCPv6 message from a DHCPv6 client and provide the first DHCPv6 message to the message generating module 81. The message generating module 81 is configured to generate a Relay-forward message, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3 interface receiving the first DHCPv6 message is added therein; and the layer-3 interface is a layer-3 interface for connecting the relay agent device of this embodiment to a lower-level device. The first forwarding module 82 is connected to a server and the message generating module 81 and configured to send the Relay-forward message to the server.<!-- EPO <DP n="21"> --></p><p id="p0068" num="0068">The functional modules of the relay agent device in this embodiment may be configured to execute the procedure in which the DHCPv6 layer-3 relay agent forwards the DHCPv6 message sent by the client to the server. The working principles of the functional modules are not further described in detail. For details, reference may be made to the description in the method embodiments.</p><p id="p0069" num="0069">The relay agent device of this embodiment carries an identifier of a layer-3 interface in the Relay-forward message, so that a server generates, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface, and therefore the relay agent device can forward the message according to the identifier of a correct layer-3 interface, thereby solving the problems in the prior art, for example, saving resources of global unicast addresses or site-local addresses, reducing the number of layer-3 interfaces, and ensuring the forwarding performance of the relay agent device.</p><p id="p0070" num="0070">Further, as shown in <figref idrefs="f0007">FIG. 9</figref>, the message generating module 81 of this embodiment includes a generating unit 810 and any one of the following adding units: a first adding unit 811, a second adding unit 812, and a third adding unit 813. The generating unit 810 is configured to encapsulate a DHCPv6 message into a Relay-message Option field of a Relay-forward message; the first adding unit 811 is configured to add an identifier of a layer-3 interface to a peer-address field of the Relay-forward message; the second adding unit 812 is configured to add the identifier of the layer-3 interface to an Interface-ID Option field of the Relay-forward message; and the third adding unit 813 is configured to add the identifier of the layer-3 interface to a new layer-3 identifier field of the Relay-forward message.</p><p id="p0071" num="0071">The first adding unit 811 is specifically configured to insert the identifier of the layer-3 interface between bit 10 and bit 63 of the peer-address field of the Relay-forward message.</p><p id="p0072" num="0072">The second adding unit 812 is specifically configured to extend the Interface-ID Option field of the Relay-forward message, and add the identifier of the layer-3 interface to the extended Interface-ID Option field; or specifically configured to add a layer-2 identifier field to the Relay-forward message, add an identifier of a user port corresponding to the layer-3 interface to the layer-2 identifier field, and add the identifier of the layer-3 interface to the Interface-ID Option field of the Relay-forward message.<!-- EPO <DP n="22"> --></p><p id="p0073" num="0073">The third adding unit 813 is specifically configured to add a layer-3 identifier field to optional fields of the Relay-forward message, and add the identifier of the layer-3 interface to the layer-3 identifier field.</p><p id="p0074" num="0074">When the Relay-forward message includes an internal-layer Relay-forward message and an external-layer Relay-forward message (that is, when the relay agent device performs double encapsulation for the first DHCPv6 message sent by the client to the server), the generating unit 810 is specifically configured to encapsulate the first DHCPv6 message into the Relay-message Option field of the internal-layer Relay-forward message; the second adding unit 812 is specifically configured to add the identifier of the layer-3 interface to the Interface-ID Option field of the internal-layer Relay-forward message, and then encapsulate the internal-layer Relay-forward message into the external-layer Relay-forward message; or specifically configured to encapsulate the internal-layer Relay-forward message into the external-layer Relay-forward message, and add the identifier of the layer-3 interface to the Interface-ID Option field of the external-layer Relay-forward message.</p><p id="p0075" num="0075">The functional units of this embodiment may execute the corresponding procedure in which the DHCPv6 layer-3 relay agent forwards the message sent by the client to the server. The working principles of the functional units are not further described in detail. For details, reference may be made to the description in the method embodiments.</p><p id="p0076" num="0076">The relay agent device of this embodiment adds, by using various methods, an identifier of a layer-3 interface connecting a lower-level device, to a Relay-forward message, so that a server generates a Relay-reply message including the identifier of the layer-3 interface, and therefore the relay agent device can find a correct layer-3 interface according to the identifier of the layer-3 interface and correctly forward the message, thereby solving the problems in the prior art, saving resources of global unicast addresses or site-local addresses, reducing the number of layer-3 interfaces, and improving the forwarding performance.</p><p id="p0077" num="0077">Further, as shown in <figref idrefs="f0008">FIG. 10</figref>, the relay agent device of this embodiment includes: a second receiving module 91 and a second forwarding module 92.</p><p id="p0078" num="0078">The second receiving module 91, connected to the server, is configured to receive a Relay-reply message from the server, where the Relay-reply message is generated by the server according to the received Relay-forward message, where a second DHCPv6 message<!-- EPO <DP n="23"> --> sent by the server to the client and the identifier of the layer-3 interface carried in the Relay-forward message are encapsulated into the Relay-reply message, where the layer-3 interface is a layer-3 interface on which the relay agent device forwards the second DHCPv6 message in this embodiment, that is, a layer-3 interface on which the relay agent device receives the first DHCPv6 message sent by the client to the server. The second forwarding module 92, connected to the second receiving module 91, is configured to forward the second DHCPv6 message to the client according to the identifier of the layer-3 interface in the Relay-reply message. Specifically, the relay agent device forwards the second DHCPv6 message to the lower-level device through the layer-3 interface located by the identifier of the layer-3 interface, and then the second DHCPv6 message is forwarded to the client through the lower-level device.</p><p id="p0079" num="0079">The functional modules of the relay agent device in this embodiment may be configured to execute the procedure in which the DHCPv6 layer-3 relay agent forwards the DHCPv6 message sent by the server to the client. The working principles of the functional modules are not further described in detail. For details, reference may be made to the description in the method embodiments.</p><p id="p0080" num="0080">The relay agent device of this embodiment adds, by using various methods, an identifier of a layer-3 interface connecting a lower-level device, to a Relay-forward message, so that a server generates a Relay-reply message including the identifier of the layer-3 interface, and then finds, according to the identifier of the layer-3 interface, a correct layer-3 interface forwarding the second DHCPv6 message, and successfully forwards the second DHCPv6 message to a client, thereby solving the problems in the prior art, saving global unicast addresses or site-local addresses, reducing the number of layer-3 interfaces, and improving the forwarding performance.</p><p id="p0081" num="0081">Further, as shown in <figref idrefs="f0009">FIG. 11</figref>, the second forwarding module 92 of this embodiment includes a parsing submodule 921 and a forwarding submodule 922. The parsing submodule 921, connected to the second receiving module 91, is configured to parse the Relay-reply message to acquire the identifier of the layer-3 interface and the second DHCPv6 message; and the forwarding submodule 922, connected to the parsing submodule 921, is configured to forward<!-- EPO <DP n="24"> --> the second DHCPv6 message to the client through the layer-3 interface located by the identifier of the layer-3 interface.</p><p id="p0082" num="0082">Further, the parsing submodule 921 includes any one of the following parsing units: a first parsing unit, a second parsing unit, or a third parsing unit. The first parsing unit is configured to acquire the identifier of the layer-3 interface from the peer-address field of the Relay-reply message; the second parsing unit is configured to acquire the identifier of the layer-3 interface from the Interface-ID Option field of the Relay-reply message; and the third parsing unit is configured to acquire the identifier of the layer-3 interface from the new layer-3 identifier field in the Relay-reply message.</p><p id="p0083" num="0083">The first parsing unit is specifically configured to acquire the identifier of the layer-3 interface between bit 10 and bit 63 of the peer-address field of the Relay-reply message.</p><p id="p0084" num="0084">The second parsing unit is specifically configured to acquire the identifier of the layer-3 interface from the extended Interface-ID Option field of the Relay-reply message; or specifically configured to acquire the identifier of the layer-3 interface from the Interface-ID Option field of the Relay-reply message including the new layer-2 identifier field, where an identifier of a user port corresponding to the layer-3 interface is added to the new layer-2 identifier field. Alternatively, when the Relay-reply message includes an internal-layer Relay-reply message and an external-layer Relay-reply message, the second parsing unit is specifically configured to acquire the identifier of the layer-3 interface from the Interface-ID Option field in the Relay-reply message; or specifically configured to acquire the internal-layer Relay-reply message from the external-layer Relay-reply message, and acquire the identifier of the layer-3 interface from the Interface-ID Option field of the internal-layer Relay-reply message.</p><p id="p0085" num="0085">The relay agent device of this embodiment acquires, by using various parsing methods, an identifier of a layer-3 interface, and further finds a correct layer-3 interface according to the identifier of the layer-3 interface to correctly forward a message, thereby solving the problems in the prior art, saving global unicast addresses or site-local addresses, reducing the number of layer-3 interfaces, and improving the forwarding performance.<!-- EPO <DP n="25"> --></p><p id="p0086" num="0086"><figref idrefs="f0009">FIG. 12</figref> is a schematic structural diagram of a message forwarding system according to Embodiment 9 of the present invention. As shown in <figref idrefs="f0009">FIG. 12</figref>, the system of this embodiment includes a relay agent device 141 and a server 142. The server 142 refers to a DHCPv6 server. The relay agent device 141 is configured to construct a Relay-forward message after receiving a first DHCPv6 message from a DHCPv6 client, where the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3 interface receiving the first DHCPv6 message is added therein, and send the Relay-forward message to the server 142.</p><p id="p0087" num="0087">The server 142 is configured to receive the Relay-forward message sent by the relay agent device 141, and generate, according to the Relay-forward message, a Relay-reply message including the identifier of the layer-3 interface.</p><p id="p0088" num="0088">The server 142 is specifically configured to construct, according to the Relay-forward message, a Relay-reply message including a layer-3 identifier field, and add the identifier of the layer-3 interface to the layer-3 identifier field of the Relay-reply message.</p><p id="p0089" num="0089">The server 142 is further specifically configured to construct, according to the Relay-forward message, a Relay-reply message including a layer-2 identifier field, add an identifier of a user port corresponding to the layer-3 interface to the layer-2 identifier field of the Relay-reply message, and add the identifier of the layer-3 interface to the Interface-ID Option field of the Relay-reply message.</p><p id="p0090" num="0090">The implementation of constructing a Relay-reply message by the server 142 is mainly determined according to the structure of the Relay-forward message, and is not limited to the above methods.</p><p id="p0091" num="0091">Further, the server 142 is further configured to send the Relay-reply message to the relay agent device 141. The relay agent device 141 is further configured to receive the Relay-reply message sent by the server 142, and forward a second DHCPv6 message in the Relay-reply message to the client according to the identifier of the layer-3 interface in the Relay-reply message.</p><p id="p0092" num="0092">For the specific working principle and structure of the relay agent device 141 of this embodiment, reference may be made to the embodiments shown in <figref idrefs="f0007 f0008 f0009">FIG. 8 to FIG. 11</figref>. For the<!-- EPO <DP n="26"> --> working principle of the server 142 reference may be made to the description in the method embodiments shown in <figref idrefs="f0002 f0003 f0004 f0005 f0006 f0007">FIG. 3 to FIG. 7</figref>. Details are omitted herein.</p><p id="p0093" num="0093">According to the message forwarding system of this embodiment, a Relay-forward message and a Relay-reply message carry an identifier of a layer-3 interface for connecting a relay agent device to a lower-level device, so that the relay agent device may find a correct layer-3 interface according to the identifier of the layer-3 interface and successfully send the message sent by a server to a client, to the client, thereby solving the problems in the prior art, saving global unicast addresses or site-local addresses, reducing the number of layer-3 interfaces of the relay agent device, and improving the forwarding performance of the relay agent device. A person of ordinary skill in the art may understand that, all or a part of the steps of the foregoing method embodiments may be implemented by a program instructing relevant hardware. The foregoing programs may be stored in a computer readable storage medium. When the program runs, the foregoing steps included in the method embodiments are performed. The foregoing storage medium includes various mediums capable of storing program codes, such as a ROM, a RAM, a magnetic disk or an optical disk.</p><p id="p0094" num="0094">Finally, it should be noted that the foregoing embodiments are merely intended for describing the technical solutions of the present invention other than limiting the present invention. Although the present invention is described in detail with reference to the foregoing embodiments, a person of ordinary skill in the art should understand that they may still make modifications to the technical solutions described in the foregoing embodiments, or make equivalent replacements to some technical features thereof, without departing from the spirit and scope of the technical solutions of the embodiments of the present invention.</p></description><claims mxw-id="PCLM56976196" lang="EN" load-source="patent-office"><!-- EPO <DP n="27"> --><claim id="c-en-0001" num="0001"><claim-text>A message forwarding method, comprising:
<claim-text>receiving a first DHCPv6 message from a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 client through a layer-3 interface;</claim-text>
<claim-text>generating a Relay-forward message, wherein the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of the layer-3 interface is added therein; and</claim-text>
<claim-text>sending the Relay-forward message to a DHCPv6 server.</claim-text></claim-text></claim><claim id="c-en-0002" num="0002"><claim-text>The message forwarding method according to claim 1, wherein the generating a Relay-forward message comprises:
<claim-text>encapsulating the first DHCPv6 message into a Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>adding the identifier of the layer-3 interface to a peer-address field of the Relay-forward message.</claim-text></claim-text></claim><claim id="c-en-0003" num="0003"><claim-text>The message forwarding method according to claim 1, wherein the generating a Relay-forward message comprises:
<claim-text>encapsulating the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>adding the identifier of the layer-3 interface to an Interface-ID Option field of the Relay-forward message.</claim-text></claim-text></claim><claim id="c-en-0004" num="0004"><claim-text>The message forwarding method according to claim 1, wherein the generating a Relay-forward message comprises:
<claim-text>encapsulating the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>adding the identifier of the layer-3 interface to a new layer-3 identifier field of the Relay-forward message.</claim-text><!-- EPO <DP n="28"> --></claim-text></claim><claim id="c-en-0005" num="0005"><claim-text>The message forwarding method according to claim 2, wherein the adding the identifier of the layer-3 interface to a peer address peer-address field of the Relay-forward message comprises:
<claim-text>inserting the identifier of the layer-3 interface between bit 10 and bit 63 of the peer-address field.</claim-text></claim-text></claim><claim id="c-en-0006" num="0006"><claim-text>The message forwarding method according to claim 3, wherein the adding the identifier of the layer-3 interface to an interface identifier option Interface-ID Option field of the Relay-forward message comprises:
<claim-text>extending the Interface-ID Option field, and adding the identifier of the layer-3 interface to the extended Interface-ID Option field; or</claim-text>
<claim-text>adding a layer-2 identifier field to the Relay-forward message, adding an identifier of a user port corresponding to the layer-3 interface to the layer-2 identifier field, and adding the identifier of the layer-3 interface to the Interface-ID Option field.</claim-text></claim-text></claim><claim id="c-en-0007" num="0007"><claim-text>The message forwarding method according to claim 3, wherein: the Relay-forward message comprises an internal-layer Relay-forward message and an external-layer Relay-forward message;<br/>
the encapsulating the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message comprises:
<claim-text>encapsulating the first DHCPv6 message into a Relay-message Option field of the internal-layer Relay-forward message; and</claim-text>
<claim-text>the adding the identifier of the layer-3 interface to an interface identifier option Interface-ID Option field of the Relay-forward message comprises:
<claim-text>adding the identifier of the layer-3 interface to an Interface-ID Option field of the internal-layer Relay-forward message, and then encapsulating the internal-layer Relay-forward message into the external-layer Relay-forward message; or</claim-text>
<claim-text>encapsulating the internal-layer Relay-forward message into the external-layer Relay-forward message, and adding the identifier of the layer-3 interface to an Interface-ID Option field of the external-layer Relay-forward message.</claim-text></claim-text></claim-text></claim><claim id="c-en-0008" num="0008"><claim-text>The message forwarding method according to any one of claims 1 to 7, further comprising:<!-- EPO <DP n="29"> -->
<claim-text>receiving a Relay-reply message from the DHCPv6 server, wherein a second DHCPv6 message sent by the DHCPv6 server to the DHCPv6 client and the identifier of the layer-3 interface are encapsulated into the Relay-reply message; and</claim-text>
<claim-text>forwarding the second DHCPv6 message to the DHCPv6 client according to the identifier of the layer-3 interface in the Relay-reply message.</claim-text></claim-text></claim><claim id="c-en-0009" num="0009"><claim-text>The message forwarding method according to claim 8, wherein the receiving a Relay-reply message from the DHCPv6 server comprises:
<claim-text>receiving, from the DHCPv6 server, a Relay-reply message comprising a layer-3 identifier field, wherein the identifier of the layer-3 interface is added to the layer-3 identifier field; or</claim-text>
<claim-text>receiving, from the DHCPv6 server, a Relay-reply message comprising a layer-2 identifier field, wherein the identifier of the user port corresponding to the layer-3 interface is added to the layer-2 identifier field, and the identifier of the layer-3 interface is added to an Interface-ID Option field of the Relay-reply message.</claim-text></claim-text></claim><claim id="c-en-0010" num="0010"><claim-text>A relay agent device, comprising:
<claim-text>a first receiving module, configured to receive a first DHCPv6 message from a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 client;</claim-text>
<claim-text>a message generating module, configured to generate a Relay-forward message, wherein the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3 interface receiving the first DHCPv6 message is added therein; and</claim-text>
<claim-text>a first forwarding module, configured to send the Relay-forward message to a DHCPv6 server.</claim-text></claim-text></claim><claim id="c-en-0011" num="0011"><claim-text>The relay agent device according to claim 10, wherein the message generating module comprises:
<claim-text>a generating unit, configured to encapsulate the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>a first adding unit, configured to add the identifier of the layer-3 interface to a peer address peer-address field of the Relay-forward message.</claim-text></claim-text></claim><claim id="c-en-0012" num="0012"><claim-text>The relay agent device according to claim 10, wherein the message generating module comprises:<!-- EPO <DP n="30"> -->
<claim-text>a generating unit, configured to encapsulate the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>a second adding unit, configured to add the identifier of the layer-3 interface to an interface identifier option Interface-ID Option field of the Relay-forward message.</claim-text></claim-text></claim><claim id="c-en-0013" num="0013"><claim-text>The relay agent device according to claim 10, wherein the message generating module comprises:
<claim-text>a generating unit, configured to encapsulate the first DHCPv6 message into a relay message option Relay-message Option field of the Relay-forward message; and</claim-text>
<claim-text>a third adding unit, configured to add the identifier of the layer-3 interface to a new layer-3 identifier field of the Relay-forward message.</claim-text></claim-text></claim><claim id="c-en-0014" num="0014"><claim-text>The relay agent device according to claim 11, wherein:
<claim-text>the first adding unit is specifically configured to insert the identifier of the layer-3 interface between bit 10 and bit 63 of the peer-address field.</claim-text></claim-text></claim><claim id="c-en-0015" num="0015"><claim-text>The relay agent device according to claim 12, wherein:
<claim-text>the second adding unit is specifically configured to extend the Interface-ID Option field, and add the identifier of the layer-3 interface to the extended Interface-ID Option field; or specifically configured to add a layer-2 identifier field to the Relay-forward message, add an identifier of a user port corresponding to the layer-3 interface to the layer-2 identifier field, and add the identifier of the layer-3 interface to the Interface-ID Option field.</claim-text></claim-text></claim><claim id="c-en-0016" num="0016"><claim-text>The relay agent device according to claim 13, wherein:
<claim-text>the third adding unit is specifically configured to add a layer-3 identifier field to optional fields of the Relay-forward message, and add the identifier of the layer-3 interface to the layer-3 identifier field.</claim-text></claim-text></claim><claim id="c-en-0017" num="0017"><claim-text>The relay agent device according to claim 12, wherein: the Relay-forward message comprises an internal-layer Relay-forward message and an external-layer Relay-forward message;<br/>
the generating unit is specifically configured to encapsulate the first DHCPv6 message into a Relay-message Option field of the internal-layer Relay-forward message; and<br/>
the second adding unit is specifically configured to add the identifier of the layer-3 interface to an Interface-ID Option field of the internal-layer Relay-forward message, and<!-- EPO <DP n="31"> --> then encapsulate the internal-layer Relay-forward message into the external-layer Relay-forward message; or encapsulate the internal-layer Relay-forward message into the external-layer Relay-forward message, and add the identifier of the layer-3 interface to an Interface-ID Option field of the external-layer Relay-forward message.</claim-text></claim><claim id="c-en-0018" num="0018"><claim-text>The relay agent device according to any one of claims 10 to 17, further comprising:
<claim-text>a second receiving unit, configured to receive a Relay-reply message from the DHCPv6 server, wherein a second DHCPv6 message sent by the DHCPv6 server to the DHCPv6 client and the identifier of the layer-3 interface are encapsulated into the Relay-reply message; and</claim-text>
<claim-text>a second forwarding module, configured to forward the second DHCPv6 message to the DHCPv6 client according to the identifier of the layer-3 interface in the Relay-reply message.</claim-text></claim-text></claim><claim id="c-en-0019" num="0019"><claim-text>A message forwarding system, comprising a relay agent device and a Dynamic Host Configuration Protocol for Internet Protocol version 6 DHCPv6 server, wherein:
<claim-text>the relay agent device is configured to construct a Relay-forward message after receiving a first DHCPv6 message from a DHCPv6 client, wherein the first DHCPv6 message is encapsulated into the Relay-forward message and an identifier of a layer-3 interface receiving the first DHCPv6 message is added therein, and send the Relay-forward message to the DHCPv6 server; and</claim-text>
<claim-text>the DHCPv6 server is configured to receive the Relay-forward message sent by the relay agent device, and generate, according to the Relay-forward message, a Relay-reply message comprising the identifier of the layer-3 interface.</claim-text></claim-text></claim><claim id="c-en-0020" num="0020"><claim-text>The message forwarding system according to claim 19, wherein:
<claim-text>the DHCPv6 server is specifically configured to construct, according to the Relay-forward message, the Relay-reply message comprising a layer-3 identifier field, and add the identifier of the layer-3 interface to the layer-3 identifier field; or</claim-text>
<claim-text>the DHCPv6 server is specifically configured to construct, according to the Relay-forward message, the Relay-reply message comprising a layer-2 identifier field, add an identifier of a user port corresponding to the layer-3 interface to the layer-2 identifier field of the Relay-reply message, and add the identifier of the layer-3 interface to an interface identifier option Interface-ID Option field of the Relay-reply message.</claim-text></claim-text></claim><claim id="c-en-0021" num="0021"><claim-text>The message forwarding system according to claim 19 or 20, wherein:<!-- EPO <DP n="32"> -->
<claim-text>the DHCPv6 server is further configured to send the Relay-reply message to the relay agent device; and</claim-text>
<claim-text>the relay agent device is further configured to receive the Relay-reply message sent by the DHCPv6 server, and forward a second DHCPv6 message in the Relay-reply message to the DHCPv6 client according to the identifier of the layer-3 interface in the Relay-reply message.</claim-text></claim-text></claim></claims><drawings mxw-id="PDW16666979" load-source="patent-office"><!-- EPO <DP n="33"> --><figure id="f0001" num="1,2"><img id="if0001" file="imgf0001.tif" wi="147" he="185" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="34"> --><figure id="f0002" num="3"><img id="if0002" file="imgf0002.tif" wi="141" he="184" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="35"> --><figure id="f0003" num="4A,4B"><img id="if0003" file="imgf0003.tif" wi="152" he="198" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="36"> --><figure id="f0004" num="5"><img id="if0004" file="imgf0004.tif" wi="150" he="189" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="37"> --><figure id="f0005" num="6A,6B"><img id="if0005" file="imgf0005.tif" wi="152" he="210" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="38"> --><figure id="f0006" num="6C,7A"><img id="if0006" file="imgf0006.tif" wi="148" he="224" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="39"> --><figure id="f0007" num="7B,8,9"><img id="if0007" file="imgf0007.tif" wi="134" he="226" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="40"> --><figure id="f0008" num="10"><img id="if0008" file="imgf0008.tif" wi="136" he="128" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="41"> --><figure id="f0009" num="11,12"><img id="if0009" file="imgf0009.tif" wi="135" he="189" img-content="drawing" img-format="tif"/></figure></drawings><search-report-data><doc-page id="srep0001" file="srep0001.tif" wi="165" he="232" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="165" he="230" type="tif"/></search-report-data><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
