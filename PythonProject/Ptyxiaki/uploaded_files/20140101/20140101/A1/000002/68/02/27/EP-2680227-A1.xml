<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2680227-A1" country="EP" doc-number="2680227" kind="A1" date="20140101" family-id="48771280" file-reference-id="318320" date-produced="20180824" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="146549377" ucid="EP-2680227-A1"><document-id><country>EP</country><doc-number>2680227</doc-number><kind>A1</kind><date>20140101</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-13173727-A" is-representative="YES"><document-id mxw-id="PAPP154823300" load-source="docdb" format="epo"><country>EP</country><doc-number>13173727</doc-number><kind>A</kind><date>20130626</date><lang>EN</lang></document-id><document-id mxw-id="PAPP168045542" load-source="docdb" format="original"><country>EP</country><doc-number>13173727.2</doc-number><date>20130626</date></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC140453327" ucid="JP-2012143739-A" load-source="docdb"><document-id format="epo"><country>JP</country><doc-number>2012143739</doc-number><kind>A</kind><date>20120627</date></document-id></priority-claim></priority-claims><technical-data><classifications-ipcr><classification-ipcr mxw-id="PCL-2083185784" load-source="docdb">G06K   9/00        20060101AFI20150318BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL-2083195627" load-source="docdb">G06T   7/00        20060101ALI20150318BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-2010933492" load-source="docdb" scheme="CPC">G06T   7/0002      20130101 LI20151030BHEP        </classification-cpc><classification-cpc mxw-id="PCL-2010938383" load-source="docdb" scheme="CPC">G06T2207/30252     20130101 LA20151030BHEP        </classification-cpc><classification-cpc mxw-id="PCL1991310097" load-source="docdb" scheme="CPC">G06K   9/00791     20130101 FI20131226BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT132180615" lang="DE" load-source="patent-office">Wasser- und Trockenflecken Detektion</invention-title><invention-title mxw-id="PT132180616" lang="EN" load-source="patent-office">Water and drying mark detection</invention-title><invention-title mxw-id="PT132180617" lang="FR" load-source="patent-office">Détection de marques d'eau et de sechage</invention-title><citations><patent-citations><patcit mxw-id="PCIT242652360" load-source="docdb" ucid="DE-10322087-A1"><document-id format="epo"><country>DE</country><doc-number>10322087</doc-number><kind>A1</kind><date>20041202</date></document-id><sources><source name="SEA" category="A" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652364" load-source="docdb" ucid="EP-1988389-A1"><document-id format="epo"><country>EP</country><doc-number>1988389</doc-number><kind>A1</kind><date>20081105</date></document-id><sources><source name="SEA" category="A" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652361" load-source="docdb" ucid="JP-2003259358-A"><document-id format="epo"><country>JP</country><doc-number>2003259358</doc-number><kind>A</kind><date>20030912</date></document-id><sources><source name="APP" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652362" load-source="docdb" ucid="US-20060115121-A1"><document-id format="epo"><country>US</country><doc-number>20060115121</doc-number><kind>A1</kind><date>20060601</date></document-id><sources><source name="SEA" category="A" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652363" load-source="docdb" ucid="US-20070115357-A1"><document-id format="epo"><country>US</country><doc-number>20070115357</doc-number><kind>A1</kind><date>20070524</date></document-id><sources><source name="SEA" category="A" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652365" load-source="docdb" ucid="WO-2010038223-A1"><document-id format="epo"><country>WO</country><doc-number>2010038223</doc-number><kind>A1</kind><date>20100408</date></document-id><sources><source name="SEA" category="A" created-by-npl="N"/></sources></patcit></patent-citations></citations></technical-data><parties><applicants><applicant mxw-id="PPAR918155783" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>CLARION CO LTD</last-name><address><country>JP</country></address></addressbook></applicant><applicant mxw-id="PPAR918135077" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>CLARION CO., LTD.</last-name></addressbook></applicant><applicant mxw-id="PPAR918993318" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Clarion Co., Ltd.</last-name><iid>101216579</iid><address><street>7-2, Shintoshin Chuo-ku Saitama-shi</street><city>Saitama 330-0081</city><country>JP</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR918138586" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>IRIE KOTA</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918163767" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>IRIE, KOTA</last-name></addressbook></inventor><inventor mxw-id="PPAR918992145" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>IRIE, KOTA</last-name><address><street>c/o Clarion Co., Ltd. 7-2, Shintoshin, Chuo-ku, Saitama-shi,</street><city>Saitama, 330-0081</city><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918141994" load-source="docdb" sequence="2" format="epo"><addressbook><last-name>MURAMATSU SHOJI</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918170904" load-source="docdb" sequence="2" format="intermediate"><addressbook><last-name>MURAMATSU, SHOJI</last-name></addressbook></inventor><inventor mxw-id="PPAR918990368" load-source="patent-office" sequence="2" format="original"><addressbook><last-name>MURAMATSU, SHOJI</last-name><address><street>c/o Hitachi, Ltd., Intellectual Property Group, 6-1, Marunouchi 1-chome, Chiyoda-ku,</street><city>Tokyo, 100-8220</city><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918133015" load-source="docdb" sequence="3" format="epo"><addressbook><last-name>KONDOU SHUNSUKE</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918134484" load-source="docdb" sequence="3" format="intermediate"><addressbook><last-name>KONDOU, SHUNSUKE</last-name></addressbook></inventor><inventor mxw-id="PPAR918988810" load-source="patent-office" sequence="3" format="original"><addressbook><last-name>KONDOU, SHUNSUKE</last-name><address><street>c/o Hitachi Information &amp; Telecommunication Engineering, Ltd., Queen's Tower B (22F), 3-3, Minatomirai 2-chome, Nishi-ku, Yokohama-shi</street><city>Kanagawa, 220-6122</city><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918135579" load-source="docdb" sequence="4" format="epo"><addressbook><last-name>KIYOHARA MASAHIRO</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918161794" load-source="docdb" sequence="4" format="intermediate"><addressbook><last-name>KIYOHARA, MASAHIRO</last-name></addressbook></inventor><inventor mxw-id="PPAR918991728" load-source="patent-office" sequence="4" format="original"><addressbook><last-name>KIYOHARA, MASAHIRO</last-name><address><street>c/o Hitachi, Ltd., Intellectual Property Group, 6-1, Marunouchi 1-chome, Chiyoda-ku,</street><city>Tokyo, 100-8220</city><country>JP</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR918987253" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>Ilgart, Jean-Christophe</last-name><suffix>et al</suffix><iid>101218753</iid><address><street>BREVALEX 95 rue d'Amsterdam</street><city>75378 Paris Cedex 8</city><country>FR</country></address></addressbook></agent></agents></parties><international-convention-data><designated-states><ep-contracting-states><country mxw-id="DS548863512" load-source="docdb">AL</country><country mxw-id="DS548877372" load-source="docdb">AT</country><country mxw-id="DS548863514" load-source="docdb">BE</country><country mxw-id="DS548889692" load-source="docdb">BG</country><country mxw-id="DS548804592" load-source="docdb">CH</country><country mxw-id="DS548803457" load-source="docdb">CY</country><country mxw-id="DS548877373" load-source="docdb">CZ</country><country mxw-id="DS548863515" load-source="docdb">DE</country><country mxw-id="DS548803462" load-source="docdb">DK</country><country mxw-id="DS548803463" load-source="docdb">EE</country><country mxw-id="DS548857973" load-source="docdb">ES</country><country mxw-id="DS548889693" load-source="docdb">FI</country><country mxw-id="DS548804593" load-source="docdb">FR</country><country mxw-id="DS548863516" load-source="docdb">GB</country><country mxw-id="DS548803464" load-source="docdb">GR</country><country mxw-id="DS548863517" load-source="docdb">HR</country><country mxw-id="DS548877374" load-source="docdb">HU</country><country mxw-id="DS548860688" load-source="docdb">IE</country><country mxw-id="DS548803465" load-source="docdb">IS</country><country mxw-id="DS548804594" load-source="docdb">IT</country><country mxw-id="DS548803470" load-source="docdb">LI</country><country mxw-id="DS548889874" load-source="docdb">LT</country><country mxw-id="DS548840701" load-source="docdb">LU</country><country mxw-id="DS548889875" load-source="docdb">LV</country><country mxw-id="DS548889876" load-source="docdb">MC</country><country mxw-id="DS548840702" load-source="docdb">MK</country><country mxw-id="DS548840703" load-source="docdb">MT</country><country mxw-id="DS548840704" load-source="docdb">NL</country><country mxw-id="DS548804595" load-source="docdb">NO</country><country mxw-id="DS548840705" load-source="docdb">PL</country><country mxw-id="DS548860689" load-source="docdb">PT</country><country mxw-id="DS548857974" load-source="docdb">RO</country><country mxw-id="DS548860690" load-source="docdb">RS</country><country mxw-id="DS548840710" load-source="docdb">SE</country><country mxw-id="DS548863887" load-source="docdb">SI</country><country mxw-id="DS548804596" load-source="docdb">SK</country><country mxw-id="DS548804597" load-source="docdb">SM</country><country mxw-id="DS548803471" load-source="docdb">TR</country></ep-contracting-states><ep-extended-states><ep-extended-state-data><country>BA</country></ep-extended-state-data><ep-extended-state-data><country>ME</country></ep-extended-state-data></ep-extended-states></designated-states></international-convention-data></bibliographic-data><abstract mxw-id="PA128670047" lang="EN" load-source="patent-office"><p id="pa01" num="0001">A white turbid state diagnostic apparatus has an imaging part installed on a vehicle and configured to convert a light signal from a periphery of the vehicle into an image signal, a region detection part configured to detect a region from the image signal, the region being constituted by pixels having brightness values over a predetermined brightness and being in a substantially circular shape having a predetermined area or more, a brightness gradient calculation part configured to calculate a brightness gradient on a line which is directed from a predetermined position in a predetermined direction based on brightness values of pixels on the line in the region, and a white turbid level calculation part configured to calculate a white turbid level of the lens based on the brightness gradient.
<img id="iaf01" file="imgaf001.tif" wi="110" he="86" img-content="drawing" img-format="tif"/></p></abstract><abstract mxw-id="PA128499420" lang="EN" source="EPO" load-source="docdb"><p>A white turbid state diagnostic apparatus has an imaging part installed on a vehicle and configured to convert a light signal from a periphery of the vehicle into an image signal, a region detection part configured to detect a region from the image signal, the region being constituted by pixels having brightness values over a predetermined brightness and being in a substantially circular shape having a predetermined area or more, a brightness gradient calculation part configured to calculate a brightness gradient on a line which is directed from a predetermined position in a predetermined direction based on brightness values of pixels on the line in the region, and a white turbid level calculation part configured to calculate a white turbid level of the lens based on the brightness gradient.</p></abstract><description mxw-id="PDES63955477" lang="EN" load-source="patent-office"><!-- EPO <DP n="1"> --><p id="p0001" num="0001">The present invention relates to a lens white-turbid state diagnostic apparatus for diagnosing a white turbid state of a lens of a camera, which is caused by impurities deposited by drying out water attached to a surface of the lens.</p><heading id="h0001">Description of the Related Art</heading><p id="p0002" num="0002">Recently, for a vehicle such as an automobile, vehicle periphery recognition systems have been in practical uses. In such a vehicle periphery recognition system, a camera is installed on a vehicle to image a periphery of the vehicle and the system detects a position of another vehicle, a position of a lane marker, or a position of a driving lane from an obtained image, and judges a possibility of contact with the another vehicle or a possibility of a lane departure to alert a driver.</p><p id="p0003" num="0003">In such a system, for example, while driving in the rain, water splashed by the vehicle can be attached to a lens surface of the camera. Also, while driving on a dirt road, dust stirred up by the vehicle can be attached to the lens surface of the camera. Further, while driving on a road where a snow-melting agent is spread, the snow-melting agent splashed by the vehicle can be attached to the lens surface of the camera. Those substances attached as described above are dried, and impurities in water, dust, or snow-melting agent are deposited and piled up on the lens surface to cause grime (hereinafter, white turbidity) on the lens surface.</p><p id="p0004" num="0004">When a white turbid part is generated on the lens surface, light entering the lens is scattered at the white turbid part and therefore blur or bleed occurs in the observed image. Since images of other cars or lane markers to be detected are deformed because of the blur or bleed, detection failure (no detection) of the other cars or lane markers or detection of non-existing other car or lane marker (false detection) occurs. Due to the occurrence of the detection failure or false detection, an appropriate alert to the driver may not be provided.<!-- EPO <DP n="2"> --></p><p id="p0005" num="0005">In a system where crews in the vehicle cannot visibly recognize the image obtained by the camera, the crews cannot confirm that the lens has a white-turbid part, and therefore the above detection failure or false detection gives the crew with a sense of uncertainty to the system.</p><p id="p0006" num="0006">A method as a technology for detecting a grime on a lens is disclosed (see, for example, Japanese Patent Application Publication <patcit id="pcit0001" dnum="JP2003259358A"><text>2003-259358</text></patcit>), in which a plurality of images are photographed at different timings, differences between the plurality of images are accumulated, and a region having a gray value (an accumulated value of the differences) which is a predetermined value or less and having an area which is a predetermined area value or more is detected as a grime on the lens.</p><p id="p0007" num="0007">In a grime detection device disclosed in Japanese Patent Application Publication <patcit id="pcit0002" dnum="JP2003259358A"><text>2003-259358</text></patcit>, the grime on the lens is detected based on the differences in the plurality of images photographed at different timings. In detection, the region is detected, where the accumulated value of the differences is the predetermined value or less, and the area is the predetermined area value or more.</p><p id="p0008" num="0008">However, in the grime detection device disclosed in Japanese Patent Application Publication <patcit id="pcit0003" dnum="JP2003259358A"><text>2003-259358</text></patcit>, in a plurality of images photographed at different timings, a region having small variation in gray values, such as a region of a dirt road or a uniform asphalt pavement surface in addition to a grime can be detected as a grime and therefore it is difficult to steadily detect only a grime on a lens.</p><p id="p0009" num="0009">An embodiment of the present invention is to provide a steady diagnosis of a white-turbid state by steadily detecting a grime on a lens due to white turbidity.</p><p id="p0010" num="0010">A white turbid state diagnostic apparatus according to an embodiment of the present invention diagnoses a white turbid state due to impurities deposited by drying water, dust, snow-melting agent, or the like attached to a lens surface of a camera based<!-- EPO <DP n="3"> --> on a brightness gradient which is a gradient of gray values in an image photographed by an imaging part.</p><p id="p0011" num="0011">More specifically, a white turbid state diagnostic apparatus according to an embodiment of the present invention, includes an imaging part installed on a vehicle and configured to observe a periphery of a vehicle via a lens, the imaging part having a photoelectric conversion section configured to convert a light signal of the observed periphery of the vehicle into an image signal; a region detection part configured to detect a region from the image signal, the region being constituted by pixels having brightness values over a predetermined brightness and being in a substantially circular shape having a predetermined area or more; a brightness gradient calculation part configured to calculate a brightness gradient on a line which is directed from a predetermined position in a predetermined direction based on brightness values of pixels on the line in the region; and a white turbid level calculation part configured to calculate a white turbid level of the lens based on the brightness gradient.</p><p id="p0012" num="0012">According to a white turbid state diagnostic apparatus of an embodiment of the present invention, in the imaging part installed in the vehicle and configured to image the periphery of the vehicle, the light signal transmitting the lens is converted into the image signal. The region detection part detects the region from the image signal obtained by the conversion such that the region has the brightness values over the predetermined brightness and is in a substantially circular shape having the area having the predetermined area or more.</p><p id="p0013" num="0013">The brightness gradient calculation part sets the line directed in the predetermined direction from the predetermined position in the detected region and reads the brightness values on the pixels on the set line to calculate the brightness gradient on the line.</p><p id="p0014" num="0014">The white turbid level calculation part calculates the white turbid level of the lens based on the brightness gradient calculated in the brightness gradient calculation part.<!-- EPO <DP n="4"> --> Thereby, by focusing only on the predetermined line in the region constituted by pixels having high brightness values, the brightness gradient varying according to the white turbid level of the lens can be steadily detected. Thus, the white turbid level can be certainly diagnosed.</p><p id="p0015" num="0015"><ul><li><figref idrefs="f0001">FIG. 1</figref> is a view explaining a blind spot warning (BSW) system as an example of an on-vehicle system where a white turbid state diagnostic apparatus according to Embodiment 1 is installed.</li><li><figref idrefs="f0002">FIG. 2</figref> is a block diagram schematically showing the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0003">FIGS. 3A and 3B</figref> are views explaining a situation where a white turbidity on a lens occurs: <figref idrefs="f0003">FIG. 3A</figref> showing an example of an image imaged in a condition without white turbidity and an example of brightness distribution in the image, and <figref idrefs="f0003">FIG. 3B</figref> showing an example of an image imaged in a condition with white turbidity and an example of brightness distribution in the image.</li><li><figref idrefs="f0004">FIG. 4</figref> is a flowchart of a main routine performing a diagnosis of a lens white turbid state in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0005">FIG. 5</figref> is a flowchart of a region detection processing performed in a region detection part of the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0005">FIG. 6</figref> is a view explaining a range to perform the region detection processing performed in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0006">FIGS. 7A to 7D</figref> are views showing an example of the region detection processing in the white turbid state diagnostic apparatus according to Embodiment 1: <figref idrefs="f0006">FIG. 7A</figref> showing an imaged image, <figref idrefs="f0006">FIG. 7B</figref> showing an image obtained by minifying the imaged image, <figref idrefs="f0006">FIG. 7C</figref> showing an image obtained by binarizing the image shown in <figref idrefs="f0006">FIG. 7B, and FIG. 7D</figref> showing a resulting region extracted from the image shown in <figref idrefs="f0006">FIG. 7C</figref> and satisfying conditions.<!-- EPO <DP n="5"> --></li><li><figref idrefs="f0007">FIGS. 8A and 8B</figref> are views explaining shapes of a region detected in the region detection part of the white turbid state diagnostic apparatus according to Embodiment 1: <figref idrefs="f0007">FIG. 8A</figref> showing an example of a shape to be detected, and <figref idrefs="f0007">FIG. 8B</figref> showing examples of shapes not to be detected.</li><li><figref idrefs="f0008">FIG. 9</figref> is a flowchart of a brightness gradient calculation processing performed in a brightness gradient calculation part in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0009">FIG. 10</figref> is a view explaining an example of a predetermined line to calculate a brightness gradient in the white turbid state diagnostic apparatus according to Embodiment 1 and an example of the brightness gradient.</li><li><figref idrefs="f0010">FIG. 11</figref> is a flowchart of processing to calculate a white turbid level performed in a white turbid level calculation part in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0011">FIG. 12</figref> is a view explaining a state shift showing a shift of a certainty of the white turbid level in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0011">FIG. 13</figref> is a flowchart showing a flow of processing after a diagnosis of the white turbid state in the white turbid state diagnostic apparatus according to Embodiment 1.</li><li><figref idrefs="f0012">FIG. 14</figref> is a block diagram schematically showing a configuration of a white turbid state diagnostic apparatus according to Embodiment 2.</li><li><figref idrefs="f0013">FIG. 15</figref> is a view explaining an example of a predetermined line to calculate a brightness gradient in the white turbid state diagnostic apparatus according to Embodiment 2 and an example of the brightness gradient.</li><li><figref idrefs="f0014">FIG. 16</figref> is a flowchart of a brightness gradient calculation processing performed in a brightness gradient calculation part in the white turbid state diagnostic apparatus according to Embodiment 2.</li><li><figref idrefs="f0015">FIGS. 17A to 17E</figref> are views explaining other examples of the predetermined line to calculate a brightness gradient in the white turbid state diagnostic apparatus according to<!-- EPO <DP n="6"> --> Embodiment 2: <figref idrefs="f0015">FIG. 17A</figref> showing an example where two lines having a bilaterally symmetric relationship and obliquely upwardly extending are set, <figref idrefs="f0015">FIG. 17B</figref> showing an example where a single horizontal line extending leftward is set, <figref idrefs="f0015">FIG. 17C</figref> showing an example where a single vertical line upwardly extending is set, <figref idrefs="f0015">FIG. 17D</figref> showing an example where two lines having a bilaterally symmetric relationship and obliquely upwardly extending and two horizontal lines extending leftward and rightward are set, and <figref idrefs="f0015">FIG. 17E</figref> showing an example where two rectangular regions extending horizontally are set.</li></ul></p><p id="p0016" num="0016">Hereinafter, embodiments of a white turbid state diagnostic apparatus according to the present invention will be explained with reference to drawings. In the following explanation, a gray value stored in an image is referred to as a brightness value.</p><heading id="h0002">(Embodiment 1)</heading><p id="p0017" num="0017">This embodiment is an example where a white turbid state diagnostic apparatus according to the present invention is applied to a vehicle having a BSW system which performs a backward monitoring of the vehicle while driving and performs alerting or warning when there is an approaching vehicle in an adjacent lane at a backward position of the vehicle.</p><p id="p0018" num="0018">First, operations of the BSW system will be explained with reference to <figref idrefs="f0001">FIG. 1</figref>. The BSW system 9 is installed on a rear part of a vehicle 5 in a backward direction. An imaging part 10 is installed to image a range ω including adjacent right and left lanes in a backward position of the vehicle 5 (a range including lanes L<sub>1</sub>, L<sub>2</sub>, and L<sub>3</sub> of a road 2) to obtain an image. The BSW system 9 detects an approaching vehicle existing in the lanes (L<sub>1</sub>, L<sub>3</sub>) adjacent to the lane where the vehicle 5 is running from the image obtained by the imaging part 10.</p><p id="p0019" num="0019">More specifically, the BSW system 9 is initiated when the vehicle 5 is running at a predetermined speed or more, and detects another vehicle in the lanes (L<sub>1</sub>, L<sub>3</sub>) adjacent to the lane L<sub>2</sub> where the vehicle 5 is running within a range of a distance d from the imaging<!-- EPO <DP n="7"> --> part 10. When it is confirmed that the detected another vehicle is approaching to the vehicle 5, the another vehicle is detected as an approaching vehicle.</p><p id="p0020" num="0020">In case of <figref idrefs="f0001">FIG. 1</figref>, a vehicle 6 existing in the lane L<sub>1</sub> is detected. It is judged that the vehicle 6 is approaching by recognizing that the vehicle detected from the obtained image becomes larger over time.</p><p id="p0021" num="0021">It is notified to a driver as visible information, for example, by lighting of an indicator or the like provided in the vehicle 5, that there exists the vehicle 6 approaching to the vehicle 5 in the lane L<sub>1</sub> (first alarm).</p><p id="p0022" num="0022">When the driver does not notice the visible information and tries to change a lane while putting on a direction indicator toward the lane L<sub>1</sub> where the vehicle 6 exists, the existence of the vehicle 6 is more clearly notified to the driver by flashing the indicator and making an alarm sound to encourage to stop changing the lane (second alarm).</p><p id="p0023" num="0023">Next, configurations of the white turbid state diagnostic apparatus according to Embodiment 1 will be explained with reference to <figref idrefs="f0002">FIG. 2. FIG. 2</figref> shows an example where the white turbid state diagnostic apparatus according to the present embodiment is applied to the above-described BSW system.</p><p id="p0024" num="0024">As shown in <figref idrefs="f0002">FIG. 2</figref>, the white turbid state diagnostic apparatus 8 according to Embodiment 1 is installed near a rear license plate of the vehicle 5 (shown in <figref idrefs="f0001">FIG. 1</figref>). The white turbid state diagnostic apparatus 8 includes the imaging part 10 observing the range ω shown in <figref idrefs="f0001">FIG. 1</figref>, a region detection part 20 to detect an image of a headlight of a following vehicle from the image obtained by the imaging part 10, a brightness gradient calculation part 30 to calculate a brightness gradient on a predetermined line in a region detected by the region detection part 20, a white turbid level calculation part 40 to calculate a white turbid level of a lens 12 based on the brightness gradient calculated by the brightness gradient calculation part 30, and a white turbid level delivering part 50 to deliver the white turbid level calculated by the white turbid level calculation part 40 to a later-described approaching vehicle detection section 60.<!-- EPO <DP n="8"> --></p><p id="p0025" num="0025">The white turbid level calculation part 40 has a brightness gradient average calculation section 42 to calculate an average value of brightness gradients on a plurality of predetermined lines, a similarity calculation section 44 to judge whether or not regions detected by the region detection part 20 at different times are images formed from the same light source, and a certainty determination section 46 to determine certainty of the calculated white turbid level.</p><p id="p0026" num="0026">The white turbid state diagnostic apparatus 8 according to Embodiment 1 cooperates with the BSW system 9 having the approaching vehicle detection section 60 to detect an approaching vehicle from the image obtained by the imaging part 10 and an alert output section 70 to alert by an indicator or a buzzer when the approaching vehicle is detected by the approaching vehicle detection section 60.</p><p id="p0027" num="0027">A diagnosis method in the white turbid state diagnostic apparatus 8 according to Embodiment 1 will be explained with reference to <figref idrefs="f0003">FIGS. 3A and 3B</figref>.</p><p id="p0028" num="0028">In the white turbid state diagnostic apparatus 8 according to Embodiment 1, by use of an image of a headlight of a following vehicle running in the same lane L<sub>2</sub> as the vehicle 5, obtained by the imaging part 10, a lens white turbid state is diagnosed based on the brightness gradients on the predetermined lines in the image of the headlight.</p><p id="p0029" num="0029">This is because the image of a strong light source such as the headlight is scattered by the white turbidity of the lens, a bright region of the image expands variously according to a white turbid level of the lens, and as the white turbid level is higher, the bright region is observed as a more widely expanding image. Since the headlight is strong, high SN image signals can be obtained. Thereby, the brightness gradient changes more largely and certainty of the diagnosis is improved.</p><p id="p0030" num="0030">According to this method, the diagnosis of the white turbid state of the lens 12 can be performed only at nighttime where the image of the headlight is observed. However, since strong light source such as the headlight barely directly enters the imaging part 10 at daytime, the operations of the BSW system 9 do not have any problem even if the lens 12<!-- EPO <DP n="9"> --> has some white turbidity.</p><p id="p0031" num="0031">Each of <figref idrefs="f0003">FIGS. 3A and 3B</figref> shows an image I (x, y) actually observed by the imaging part 10 of the white turbid state diagnostic apparatus 8, and including the headlight of the following vehicle running in the same lane as the vehicle 5. <figref idrefs="f0003">FIG. 3A</figref> shows an image in case where the lens 12 does not have white turbidity and <figref idrefs="f0003">FIG. 3B</figref> shows an image in case where the lens 12 has white turbidity.</p><p id="p0032" num="0032">Graphs shown below the images of <figref idrefs="f0003">FIGS. 3A, 3B</figref> each show distribution of brightness values (hereinafter, brightness distribution) in a scanning direction (line) OP extending leftward from a scanning start point O in the image of the headlight as a start point and brightness distribution in a scanning direction (line) OQ extending rightward from the scanning start point O in the image of the headlight as a start point, shown within one graphs.</p><p id="p0033" num="0033">In <figref idrefs="f0003">FIG. 3A</figref>, it is set that a left-right or horizontal direction pixel number from a point where the brightness distribution on the scanning direction OP goes down under a threshold value A (first threshold value) to a point where the brightness distribution goes down under a threshold value B (second threshold value) which is lower than the threshold value A is referred to as L<sub>w</sub>, and a left-right direction pixel number from a point the brightness distribution on the scanning direction OQ goes down under the threshold value A to a point where the brightness distribution goes down under the threshold value B which is lower than the threshold value A is referred to as R<sub>w</sub>. Then, the brightness gradient g is calculated by using brightness difference D<sub>l</sub> (=A-B) as D<sub>l</sub>/L<sub>w</sub> (brightness gradient on the scanning direction OP) and -D<sub>l</sub>/R<sub>w</sub> (brightness gradient on the scanning direction OQ). In case of <figref idrefs="f0003">FIG. 3A</figref> where the lens 12 does not have white turbidity, an absolute value of the brightness gradient g is a large value and the brightness distribution has small dispersion and is sharpened.</p><p id="p0034" num="0034">On the other hand, in case of <figref idrefs="f0003">FIG. 3B</figref>, an absolute value of the brightness gradient g is a small value and the brightness distribution is broadened.<!-- EPO <DP n="10"> --></p><p id="p0035" num="0035">The lens white turbid state diagnostic apparatus 8 according to Embodiment 1 diagnoses the lens white turbid state by use of magnitude of the brightness gradient g. That is, as the absolute value of the brightness gradient g is smaller, the lens white turbid state is diagnosed as a higher white turbid level. As described in detail later, in embodiments of the present invention, in order to improve certainty of the white turbid state diagnosis, it is judged that the white turbidity occurs when a state of low brightness gradient g is maintained for a certain period.</p><p id="p0036" num="0036">Next, a flow of the lens white turbid state diagnosis in the white turbid state diagnostic apparatus 8 according to Embodiment 1 will be explained with reference to <figref idrefs="f0004">FIG. 4</figref>.</p><p id="p0037" num="0037"><figref idrefs="f0004">FIG. 4</figref> shows a flowchart of a main routine performing a lens white turbid state diagnosis in the white turbid state diagnostic apparatus 8 according to Embodiment 1.</p><p id="p0038" num="0038">In step S10, a vehicle speed of the vehicle 5 is detected in the approaching vehicle detection section 60. When the vehicle speed is, for example, 30 km/hour or more, the process moves to step S11 to initiate the BSW system 9. On the other hand, when the vehicle speed is less than 30 km/hour, the process repeats step S10.</p><p id="p0039" num="0039">In step S12, an image of a backward of the vehicle 5 is obtained by the imaging part 10. A light signal transmitting the lens 12 is converted into an electric signal in a photoelectric conversion section 14 configured by a CMOS element, and the electric signal is amplified in a gain adjustment section 16 to generate an image signal I (x, y). Hereinafter, the image signal I (x, y) is simply referred to as the image I (x, y).</p><p id="p0040" num="0040">The gain adjustment section 16 confirms a level of the electric signal obtained by conversion in the photoelectric conversion section 14, provides an appropriate gain to amplify the electric signal so as to have a predetermined level to generate the image I (x, y). Thereby, even when the image is obtained under a dark environment, due to the appropriate gain, the image I (x, y) having a high SN ratio can be obtained. The gain adjustment is performed as needed together with imaging, and in the gain adjustment<!-- EPO <DP n="11"> --> section 16, the latest gain value can be monitored.</p><p id="p0041" num="0041">In step S13, it is judged whether or not a value of the gain is a predetermined value or more. If it is judged that the gain value is the predetermined value or more, that is, it is judged that the image I (x, y) is obtained at nighttime, the process moves to step S14. If not, it is judged that the image I (x, y) is obtained at daytime and the lens white turbid state diagnosis is not performed and only the BSW system 9 is set to be operated.</p><p id="p0042" num="0042">Next, in step S14, in the region detection part 20, a region of an image of a headlight of a following vehicle running in the same lane L<sub>2</sub> as the vehicle 5 is detected from the obtained image I (x, y). The processes are shown in <figref idrefs="f0005">FIG. 5</figref> and detailed explanation will be described later.</p><p id="p0043" num="0043">In step S15, in the brightness gradient calculation part 30, a brightness gradient within the region of the image of the headlight detected in step S14 is calculated. The processing is shown in <figref idrefs="f0008">FIG. 9</figref> and detailed explanation will be described later.</p><p id="p0044" num="0044">In step S16, in the white turbid level calculation part 40, a white turbid level of the lens 12 is calculated based on the brightness gradient calculated in step S15. The processing is shown in <figref idrefs="f0010">FIG. 11</figref> and detailed explanation will be described later.</p><p id="p0045" num="0045">In step S17, parameters such as a white turbid level U of the lens 12 calculated in step S16 are delivered to the approaching vehicle detection section 60 through the white turbid level delivering part 50.</p><p id="p0046" num="0046">In step S18, the approaching vehicle detection section 60 switches appropriately behaviors of the BSW system 9 according to the delivered white turbid level of the lens 12, or the like. The processing is shown in <figref idrefs="f0011">FIG. 13</figref> and detailed explanation will be described later.</p><p id="p0047" num="0047">Next, the region detection processing in step S14 shown in <figref idrefs="f0004">FIG. 4</figref> will be explained in detail with reference to a flowchart of <figref idrefs="f0005">FIG. 5</figref> and an image of <figref idrefs="f0006">FIG. 7</figref>.</p><p id="p0048" num="0048">In step S20 of <figref idrefs="f0005">FIG. 5</figref>, the image I (x, y) obtained by the imaging part is minified, for example, into a scale having 1/4 in a vertical direction and 1/6 in a horizontal direction to<!-- EPO <DP n="12"> --> generate a minified image I' (x, y).</p><p id="p0049" num="0049">The image is minified as described above to reduce a required memory upon image processing and to improve a processing speed. A specific scale is determined in view of used computer specifications and image resolution capable of diagnosing white turbid levels, and therefore is not limited to the above-described value.</p><p id="p0050" num="0050">The diminution of the image is performed by thinning pixels and can be performed by averaging brightness values of adjacent pixels. Due to the processing, the image shown in <figref idrefs="f0006">FIG. 7A</figref> is minified to the image shown in <figref idrefs="f0006">FIG. 7B</figref>.</p><p id="p0051" num="0051">In step S21, a region including the image of the headlight of the following vehicle running in the same lane L<sub>2</sub> as the vehicle 5 is set in the minified image I'(x, y) obtained in step S20. This is because a position of the headlight of the following vehicle can be previously expected and the following processings can be effectively performed.</p><p id="p0052" num="0052"><figref idrefs="f0005">FIG. 6</figref> shows a schematic view of the processing area set in this step. As shown in <figref idrefs="f0005">FIG. 6</figref>, the processing area E is set with an upper left position set as (x1, y1) and a lower right position set as (x2, y2) with respect to an image having m pixels in a horizontal direction and n pixels in a vertical direction.</p><p id="p0053" num="0053">A vertical position of the processing area E is set based on a position of a vertical coordinate V<sub>Y</sub> (see <figref idrefs="f0005">FIG. 6</figref>) of a disappearing point defined by an installed position of the imaging part 10 to the vehicle 5.</p><p id="p0054" num="0054">A horizontal position of the processing area E is set according to the installed position of the imaging part 10 to the vehicle 5. That is, when the imaging part 10 is set at a center of the vehicle 5, the processing area E is set in the minified image I'(x, y) in a symmetrical manner in the horizontal direction. In case of <figref idrefs="f0005">FIG. 6</figref>, the installed position of the imaging part 10 to the vehicle 5 is offset and therefore the processing area E is set in a symmetrical manner in the horizontal direction. By setting the processing area E as described above, it is not necessary to process an entire area of the minified image I'(x, y), and therefore processing efficiency is improved.<!-- EPO <DP n="13"> --></p><p id="p0055" num="0055">In step S22 of <figref idrefs="f0005">FIG. 5</figref>, the minified image I'(x, y) is binarized with a predetermined threshold value in the processing area E set in step S21. As the predetermined threshold value, a value with which the image of the headlight of the following vehicle running in the same lane L<sub>2</sub> as the vehicle 5 can be detected is previously obtained based on experiments or the like and stored in the region detection part 20. By the binarizing processing, the binarized image shown in <figref idrefs="f0006">FIG. 7C</figref> is obtained.</p><p id="p0056" num="0056">In step S23 of <figref idrefs="f0005">FIG. 5</figref>, a labeling processing is performed with respect to the binarized image generated in step S22. The labeling processing is a processing provided for a binarized image, and to number each region constituting the binarized image.</p><p id="p0057" num="0057">Next, in step S24 of <figref idrefs="f0005">FIG. 5</figref>, it is judged whether or not there exists an image of a headlight in the image where the labeling processing is performed in step S23. The processing performed in this step will be explained with reference to <figref idrefs="f0007">FIGS. 8A and 8B</figref>.</p><p id="p0058" num="0058">The image of the headlight of the following vehicle running in the same lane L<sub>2</sub> as the vehicle 5, which is imaged by the imaging part 10 has a substantially circular shape shown as a region R<sub>0</sub> in <figref idrefs="f0007">FIG. 8A</figref>. Accordingly, with respect to each region where the labeling processing is performed, when an area HW of a rectangular region (vertical pixel number H, horizontal pixel number W) is circumscribed to the region, it is judged that an area of the region occupies a predetermined ratio or more within the area HW and that a width and a height of the square circumscribed to the region are not different from each other at a predetermined ratio or more.</p><p id="p0059" num="0059">Criteria for judgment of the area is expressed by equation (1) and criteria for judgment of the width and the height of the circumscribed square is expressed by equation (2). <maths id="math0001" num="(1)"><math display="block"><mi mathvariant="normal">S</mi><mo>&gt;</mo><mi>HW</mi><mo>×</mo><msub><mi>Th</mi><mi mathvariant="normal">S</mi></msub></math><img id="ib0001" file="imgb0001.tif" wi="115" he="10" img-content="math" img-format="tif"/></maths> <maths id="math0002" num="(2)"><math display="block"><mi mathvariant="normal">W</mi><mo>&lt;</mo><mi mathvariant="normal">H</mi><mo>×</mo><msub><mi>Th</mi><mi mathvariant="normal">W</mi></msub><mspace width="1em"/><mi>and H</mi><mo>&lt;</mo><mi mathvariant="normal">W</mi><mo>×</mo><msub><mi>Th</mi><mi mathvariant="normal">H</mi></msub></math><img id="ib0002" file="imgb0002.tif" wi="115" he="10" img-content="math" img-format="tif"/></maths><br/>
Here, S is an area of the region, Th<sub>S</sub> is a threshold value (Th<sub>S</sub> &lt; 1) of an area occupancy with respect to the square region, Th<sub>W</sub> is a threshold value (Th<sub>W</sub> &gt; 1) restricting a<!-- EPO <DP n="14"> --> horizontal length of the square region, and Th<sub>H</sub> is a threshold value (Th<sub>H</sub> &gt; 1) restricting a vertical length of the square region.</p><p id="p0060" num="0060">According to the judgments, for example, a region having a shape such as a region R<sub>1</sub>, R<sub>2</sub>, or R<sub>3</sub> shown in <figref idrefs="f0007">FIG. 8B</figref> is judged as not being an image of the headlight and dismissed.</p><p id="p0061" num="0061">According to the judgments, as shown in <figref idrefs="f0006">FIG. 7D</figref>, one region satisfying the conditions is selected. When a plurality of regions satisfying the conditions are found, one region which has the largest area is selected. When no region satisfying the conditions is found (if step S24 is NO), the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>).</p><p id="p0062" num="0062">In step S25, a centroid position G of the region selected in step S24 is calculated. When a coordinate of the centroid position G of the region is set as G (Gx, Gy), a horizontal position Gx of the centroid position G is calculated by dividing a sum of horizontal coordinates of all pixels forming the region by the area of the region, and a vertical position Gy of the centroid position G is calculated by dividing a sum of vertical coordinates of the all pixels forming the region by the area of the region. Then, the processing in <figref idrefs="f0005">FIG. 5</figref> is terminated and the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>).</p><p id="p0063" num="0063">The brightness gradient calculation processing in step S15 of <figref idrefs="f0004">FIG. 4</figref> will be explained in detail with reference to <figref idrefs="f0008">FIGS. 9</figref> and <figref idrefs="f0009">10</figref>. <figref idrefs="f0008">FIG. 9</figref> is a flowchart showing a flow of the brightness gradient calculation processing performed in the brightness gradient calculation part 30. <figref idrefs="f0009">FIG. 10</figref> is a view explaining an example of predetermined lines to calculate a brightness gradients and an example of brightness gradients calculated on the predetermined lines.</p><p id="p0064" num="0064">In step S30 of <figref idrefs="f0008">FIG. 9</figref>, a scanning start point O to calculate a brightness gradient g is set in the minified image I'(x, y).</p><p id="p0065" num="0065">A method for setting the scanning start point O is explained with reference to <figref idrefs="f0009">FIG. 10. FIG. 10</figref> shows the region R<sub>0</sub> of the image of the headlight detected in the region detection processing explained with reference to <figref idrefs="f0005">FIG. 5</figref> and brightness distribution of the<!-- EPO <DP n="15"> --> predetermined line within the region.</p><p id="p0066" num="0066">For example, when driving in the rain, splash raised by the vehicle 5, reflection of a headlight of a following vehicle from a road surface, or headlight of a vehicle running in an adjacent lane appears as a bright image in the obtained image I(x, y). These images might appear at a position overlapping the region R<sub>0</sub> of the image of the headlight of the following vehicle running in the same lane L<sub>2</sub> as the vehicle 5, which is to be obtained or at a position close to the region R<sub>0</sub>. These images become factors to derange the brightness gradient g of the region R<sub>0</sub>.</p><p id="p0067" num="0067">Accordingly, it is necessary to set the scanning start point and a scanning direction (line) such that the brightness gradient g can be calculated without being affected by these images even when the images are included in the region.</p><p id="p0068" num="0068">In case where there exists water on a driving road surface, tires of the vehicle 5 can rotate and splash the water on the road surface in the air. In this case, fine water droplets floating in the air are illuminated by the headlight of the following vehicle, or the like to form a bright image at a lower part of the region R<sub>0</sub> in the minified image I'(x, y).</p><p id="p0069" num="0069">The reflection of the headlight of the following vehicle from the road surface appears at a part lower than the region R<sub>0</sub> in the minified image I'(x, y).</p><p id="p0070" num="0070">There is a high possibility that the image of the headlight of the vehicle running in an adjacent lane appears at a substantially same vertical position as the region R<sub>0</sub> in the minified image I'(x, y).</p><p id="p0071" num="0071">Accordingly, if the brightness gradient g of the region R<sub>0</sub> is calculated at as an upper part as possible from the centroid position G of the region R<sub>0</sub> in the minified image I'(x, y), the above described influence of the images can be reduced.</p><p id="p0072" num="0072">Therefore, in Embodiment 1, as shown in <figref idrefs="f0009">FIG. 10</figref>, the scanning start point O to calculate the brightness gradient g is set between the centroid position G of the region R<sub>0</sub> and an upmost point J of the region R<sub>0</sub>.</p><p id="p0073" num="0073">Actually, a vertical coordinate Oy of the scanning start point Oy is obtained by<!-- EPO <DP n="16"> --> equation (3): <maths id="math0003" num="(3)"><math display="block"><mi>Oy</mi><mo>=</mo><mi>Jy</mi><mo>+</mo><mfenced separators=""><mi>Gy</mi><mo>-</mo><mi>Jy</mi></mfenced><mo>/</mo><msub><mi>Th</mi><mi mathvariant="normal">y</mi></msub></math><img id="ib0003" file="imgb0003.tif" wi="98" he="14" img-content="math" img-format="tif"/></maths><br/>
where Jy is a vertical coordinate Jy of the upmost point J of the region R<sub>0</sub>. The threshold value Th<sub>y</sub> is set to a value which is larger than 0. The threshold value Th<sub>y</sub> may be set based on experiments or the like.</p><p id="p0074" num="0074">In step S31, the scanning direction to calculate the brightness gradient is set. In this embodiment, scanning directions parallel to a horizontal line passing the scanning start point O and the centroid position G are set as a scanning direction OP and a scanning direction OQ. The scanning direction OP and the scanning direction OQ set as described above are the above-described predetermined lines.</p><p id="p0075" num="0075">Next, in step S32, the brightness values stored in the minified image I'(x, y) are read from the scanning start point O to a point P on the scanning direction OP to calculate the brightness distribution.</p><p id="p0076" num="0076">In step S33, the brightness values stored in the minified image I'(x, y) are read on the scanning direction OQ to calculate the brightness distribution.</p><p id="p0077" num="0077">The brightness distributions calculated as described above are shown in a graph in a lower part of <figref idrefs="f0009">FIG. 10</figref>. The graph shows the brightness distribution on the scanning direction OP and the brightness distribution on the scanning direction OQ in a single graph for the sake of explanation.</p><p id="p0078" num="0078">In step S34, a size of a skirt of the brightness distribution in a horizontal direction is obtained. Here, a threshold value A of the brightness value and a threshold value B of the brightness value, which is less than the threshold value A are previously prepared. In the previously generated brightness distribution, the brightness values are scanned from the scanning start point O to the point P in a leftward direction to calculate an interval between a position where the brightness value goes down under the threshold value A and a position where the brightness value goes down under the threshold value B as a horizontal pixel number Lw. The brightness values is scanned from the scanning start<!-- EPO <DP n="17"> --> point O to the point Q in a rightward direction to calculate an interval between a position where the brightness value goes down under the threshold value A and a position where the brightness value goes down under the threshold value B as a horizontal pixel number Rw.</p><p id="p0079" num="0079">Although description is omitted in <figref idrefs="f0008">FIG. 9</figref>, the reading processing of the brightness values is stopped if, when the brightness value is read over the scanning direction, the brightness value goes down under the threshold value A and then goes up again over the threshold value A or if the brightness value increases by a threshold value C from the adjacent one, which is judged that an image from another light source is included. When the reading of the brightness values is stopped, the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>) to perform a next image input.</p><p id="p0080" num="0080">In step S35, the brightness gradient g is calculated. More specifically, the brightness difference D<sub>l</sub> (=A-B) which is a difference between the threshold value A and the threshold value B is used to calculate the brightness gradient g on the scanning direction OP as D<sub>l</sub>/Lw, and calculate the brightness gradient g on the scanning direction OQ as -D<sub>l</sub>/Rw. Then, the processing in <figref idrefs="f0008">FIG. 9</figref> is terminated and the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>).</p><p id="p0081" num="0081">Next, the white turbid level calculation processing in step S16 of <figref idrefs="f0004">FIG. 4</figref> will be explained in detail with reference to <figref idrefs="f0010">FIGS. 11</figref> and <figref idrefs="f0011">12</figref>. <figref idrefs="f0010">FIG. 11</figref> is a flowchart showing a flow of the white turbid level calculation processing performed in the white turbid level calculation part 40. <figref idrefs="f0011">FIG. 12</figref> is a view explaining state transition showing shifts of certainty of the white turbid level.</p><p id="p0082" num="0082">In step S40, it is judged whether or not the left and right brightness gradients g of the region R<sub>0</sub> have symmetry. The symmetry judgment is performed by confirming whether or not a gap G<sub>l</sub> of the brightness gradients g, calculated by equation (4) is a predetermined threshold value Th<sub>G</sub> or less. <maths id="math0004" num="(4)"><math display="block"><msub><mi mathvariant="normal">G</mi><mi mathvariant="normal">l</mi></msub><mo>=</mo><mfenced separators=""><mfenced open="|" close="|"><mi>Lw</mi></mfenced><mo>-</mo><mfenced open="|" close="|"><mi>Rw</mi></mfenced></mfenced><mo>/</mo><mfenced separators=""><mfenced open="|" close="|"><mi>Lw</mi></mfenced><mo>+</mo><mfenced open="|" close="|"><mi>Rw</mi></mfenced></mfenced></math><img id="ib0004" file="imgb0004.tif" wi="88" he="15" img-content="math" img-format="tif"/></maths><!-- EPO <DP n="18"> --></p><p id="p0083" num="0083">In case where a plurality of regions continuously appear in a horizontal direction, an amount of the left brightness gradient g is different from an amount of the right brightness gradient g and therefore the gap G<sub>l</sub> calculated by equation (4) becomes larger than the threshold value Th<sub>G</sub>. In this case, the calculation of the white turbid level is not performed and the process moves to step S48.</p><p id="p0084" num="0084">In step S41, the white turbid level U of the lens 12 is calculated. The white turbid level U is calculated by an average value of the left and right brightness gradients g calculated above, as shown in equation (5). <maths id="math0005" num="(5)"><math display="block"><mi mathvariant="normal">U</mi><mo>=</mo><mfenced open="{" close="}" separators=""><mfenced separators=""><msub><mi mathvariant="normal">D</mi><mi mathvariant="normal">l</mi></msub><mo>/</mo><mi>Lw</mi></mfenced><mo>+</mo><mfenced separators=""><msub><mi mathvariant="normal">D</mi><mi mathvariant="normal">l</mi></msub><mo>/</mo><mi>Rw</mi></mfenced></mfenced><mo>/</mo><mn mathvariant="normal">2</mn></math><img id="ib0005" file="imgb0005.tif" wi="98" he="12" img-content="math" img-format="tif"/></maths><br/>
The white turbid level U calculated as described above is the diagnosis result of the white turbid level by the white turbid state diagnostic apparatus 8. This processing is performed in the brightness gradient average value calculation section 42 shown in <figref idrefs="f0001">FIG. 1</figref>.</p><p id="p0085" num="0085">In step S42, it is judged whether or not the previously detected region R<sub>0</sub> is identical to a region R<sub>0</sub> detected at one step before, that is, whether or not the images are from the same light source.</p><p id="p0086" num="0086">This judgment is performed by comparing an average value Ave(U) of the white turbid levels U calculated in the previous processing with the latest white turbid level U calculated by equation (5). When a difference between the average value Ave(U) of the previous white turbid levels U and the latest white turbid level U is small, it is judged that the images are generated from the same light source at the region.</p><p id="p0087" num="0087">This processing is performed in the similarity calculation section 44 shown in <figref idrefs="f0001">FIG. 1</figref>. More specifically, when equation (6) is satisfied, it is judged that the images are generated from the same light source: <maths id="math0006" num="(6)"><math display="block"><msub><mi>Th</mi><mi>LOW</mi></msub><mo>&lt;</mo><mi mathvariant="normal">U</mi><mo>/</mo><mi>Ave</mi><mfenced><mi mathvariant="normal">U</mi></mfenced><mo>&lt;</mo><msub><mi>Th</mi><mi>HIGH</mi></msub></math><img id="ib0006" file="imgb0006.tif" wi="114" he="12" img-content="math" img-format="tif"/></maths><br/>
where Th<sub>LOW</sub> is a lower threshold value to judge that the images are from the same light source, and Th<sub>HIGH</sub> is an upper threshold value to judge that the images are from the same light source.<!-- EPO <DP n="19"> --></p><p id="p0088" num="0088">In step S43, if it is judged that the images are from the same light source in step 42, then an overall count T showing that the images which are considered from the same light source are continuously detected is incremented and the process moves to step S44. Processings after step S43 are performed in the certainty determination section 46 shown in <figref idrefs="f0001">FIG. 1</figref>. A value of the overall count T which is incremented in step S43 is stored as needed in the certainty determination section 46.</p><p id="p0089" num="0089">On the other hand, if it is judged that the images are not from the same light source in step S42, then in step S47, the overall count is decremented and the process moves to step S48. The processing in step S42 is performed by the certainty determination section 46 shown in <figref idrefs="f0001">FIG. 1</figref>. A value of the overall count T is stored as needed in the certainty determination section 46.</p><p id="p0090" num="0090">In step S44, the white turbid level U previously calculated in step S41 is stored in the certainty determination section 46.</p><p id="p0091" num="0091">In step S45, the white turbid level U previously calculated in step S41 is used to update an average value Ave(U) of the white turbid levels U calculated in the previous processings. The updated average value Ave(U) of the white turbid levels is stored in the certainty determination section 46.</p><p id="p0092" num="0092">Next, in step S46, an error e<sub>U</sub> of the white turbid level U is calculated. The error e<sub>U</sub> is obtained by equation (7) by using the updated average value Ave(U) of the white turbid levels in step S45 and a standard deviation STD(Ave(U)) calculated from the average value Ave(U). <maths id="math0007" num="(7)"><math display="block"><msub><mi mathvariant="normal">e</mi><mi mathvariant="normal">U</mi></msub><mo>=</mo><mi>STD</mi><mfenced separators=""><mi>Ave</mi><mfenced><mi mathvariant="normal">U</mi></mfenced></mfenced><mo>/</mo><mi>Ave</mi><mfenced><mi mathvariant="normal">U</mi></mfenced></math><img id="ib0007" file="imgb0007.tif" wi="104" he="14" img-content="math" img-format="tif"/></maths></p><p id="p0093" num="0093">Next, in step S48, a certainty F of the calculated white turbid level is judged. The certainty F is expressed by a value of the overall count T. As the value T is larger, that is, as more images considered from the same light source are continuously detected, the higher certainty F of the white turbid level U is judged.</p><p id="p0094" num="0094">In this embodiment, as shown in <figref idrefs="f0011">FIG. 12</figref>, the certainty F is managed by dividing<!-- EPO <DP n="20"> --> into 4 levels (Ph0, Ph1, Ph2, Ph3). The level of the certainty F is shifted according to the value T.</p><p id="p0095" num="0095">That is, in <figref idrefs="f0011">FIG. 12</figref>, in an initial state, the level of the certainty F is Ph0. If the value of the overall count T showing that the images considered from the same light source are continuously detected exceeds 39 (corresponding to 19.5 seconds with a processing period of 0.5 second), the level of the certainty F is shifted to Ph1. Then, if the value of the overall count T exceeds 79 (corresponding to 39.5 seconds with a processing period of 0.5 second), the level of the certainty F is shifted to Ph2. If the value of the overall count T exceeds 129 (corresponding to 64.5 seconds with a processing period of 0.5 second), the level of the certainty F is shifted to Ph3.</p><p id="p0096" num="0096">On the other hand, when the level of the certainty F is Ph3, and the value of the overall count T is decremented and goes down under 118, the level of the certainty F is shifted to Ph2. Then, if the value of the overall count T goes down under 78, the level of the certainty F is shifted to Ph1. If the value of the overall count T goes down under 38, the level of the certainty F is shifted to Ph0.</p><p id="p0097" num="0097">When the certainty F is shifted to another level, in order to prevent hunting where the certainty F returns back to the original level, if the certainty F is shifted to a higher level, ten counts may be added to the overall count T, and if the certainty F is shifted to a lower level, twenty counts may be subtracted from the overall count T. When the update of the certainty F is performed, the processing of <figref idrefs="f0010">FIG. 11</figref> is terminated and the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>).</p><p id="p0098" num="0098">Although it is not disclosed in <figref idrefs="f0010">FIG. 11</figref>, in case where it is judged that the left and right brightness gradients g of the region R<sub>0</sub> do not have symmetry in step S40, in step S48, the value of the overall count T may be decremented.</p><p id="p0099" num="0099">After the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>), in step S17 of <figref idrefs="f0004">FIG. 4</figref>, the white turbid level U of the lens 12, calculated in step S16, the error e<sub>U</sub> of the white turbid level, and the certainty F are delivered to the approaching vehicle detection section 60<!-- EPO <DP n="21"> --> through the white turbid level delivering part 50.</p><p id="p0100" num="0100">In step S18 of <figref idrefs="f0004">FIG. 4</figref>, in the approaching vehicle detection section 60 and the alert output section 70, the behavior control of the BSW system is performed according to the flowchart of <figref idrefs="f0011">FIG. 13</figref>. Hereinafter, the processing will be explained in detail with reference to <figref idrefs="f0011">FIG. 13</figref>.</p><p id="p0101" num="0101">In step S50 of <figref idrefs="f0011">FIG. 13</figref>, it is judged whether or not the white turbid level U is the threshold value Th<sub>U</sub> or less, the error e<sub>U</sub> of the white turbid level U is the threshold value The or less, and the certainty F is Ph3. That is, it is confirmed that it is judged that the white turbid level is high with high certainty.</p><p id="p0102" num="0102">If it is judged the conditions of step S50 are satisfied, it is judged that the white turbid level U of the lens 12 is high and the BSW system 9 is shifted to be in a fail-state. Then, the approaching vehicle detection section 60 and the alert output section 70 stop their functions and it is notified to the driver that the BSW system 9 is shifted to the fail-state because of the white turbidity of the lens 12. Then, the processing of <figref idrefs="f0003">FIGS. 3A and 3B</figref> is terminated and the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>).</p><p id="p0103" num="0103">Once the system is shifted to the fail-state, a preliminarily prepared timer is activated to maintain the fail-state until a predetermined time elapses.</p><p id="p0104" num="0104">The driver of the vehicle 5 may check the white turbid level of the lens 12 at a timing when stopping the vehicle 5 and remove the white turbidity as needed to have the BSW system 9 available again.</p><p id="p0105" num="0105">On the other hand, if it is judged that the conditions of step S50 are not satisfied, that is, it is not judged that the white turbid level U is high, the processing of <figref idrefs="f0011">FIG. 13</figref> is terminated, the process returns to the main routine (<figref idrefs="f0004">FIG. 4</figref>), and the BSW system 9 continues to operate.</p><p id="p0106" num="0106">The behavior control of the BSW system 9 is not limited to having the system be in a fail-state as described above. That is, if the white turbid level of the lens 12 is high, a threshold value for an edge detection in image processings performed in the approaching<!-- EPO <DP n="22"> --> vehicle detection section 60 may be reduced so that edge constituting points constituting the vehicle 6 can be certainly detected even when the white turbidity of the lens 12 causes blur or bleed. Further, another behavior control may be performed using the white turbid level U, the error e<sub>U</sub> of the white turbid level, and the certainty F.</p><p id="p0107" num="0107">As described above, according to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, in an imaging part 10 installed on a vehicle 5 and configured to image periphery of the vehicle 5, a light signal transmitting a lens 12 is converted into an image signal I(x, y) in a photoelectric conversion section 14; and a region detection part 20 detects a region R<sub>0</sub> having brightness values which are over a predetermined brightness and a substantially circular shape having an area which is a predetermined area or more. A brightness gradient calculation part 30 sets scanning directions (lines) OP, OQ from a scanning start point O in the detected region R<sub>0</sub>, and reads brightness values of pixels where the set lines pass to calculate brightness gradients on the lines. The white turbid level calculation part 40 calculates a white turbid level U of the lens 12 based on the brightness gradients g calculated by the brightness gradient calculation part 30. Therefore, by focusing on only predetermined lines in the region R<sub>0</sub> constituted by pixels having high brightness values, the brightness gradient g which varies according to the white turbid level U of the lens 12 can be steadily detected and thereby the white turbid level U can be certainly diagnosed.</p><p id="p0108" num="0108">According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, in a gain adjustment section 16 configured to adjust a gain when light around the vehicle 5 is converted into an image signal, the white turbid level U is calculated in the white turbid level calculation part 40 with respect to the image I(x, y) obtained by the imaging part 10 only when the gain is adjusted to be larger than a predetermined value. Accordingly, since the white turbid level U of the lens 12 is diagnosed only in dark environment where an image of a bright light source such as lighting, or the like is observed with a high SN ratio, an image expanded by being scattered<!-- EPO <DP n="23"> --> by the white turbidity of the lens 12 can be certainly detected and the white turbid level U can be certainly diagnosed.</p><p id="p0109" num="0109">According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, when a horizontal position of the scanning start point O is set to a horizontal position Gx of a centroid position G of the region R<sub>0</sub>, and a vertical position of the scanning start point O is set to a position between a horizontal line passing the centroid position G of the region R<sub>0</sub> and a horizontal line passing an upmost point of the region R<sub>0</sub>, scanning directions (lines) OP, OQ to calculate the brightness gradients g are set such that the scanning direction OP is directed leftward in the horizontal direction from the scanning start point O, and the scanning direction OQ is in a symmetry manner with the scanning direction OP in the horizontal direction with respect to a line extending vertically in the image and passing the centroid position G of the region R<sub>0</sub>. Therefore, splash from the vehicle 5, reflection of a headlight of a following vehicle from a road surface, a headlight of a vehicle running in an adjacent lane, and the like, which appear at a lower part of the image than the centroid position G of the region R<sub>0</sub> can be prevented from being included. Thereby, brightness gradient g with high certainty can be calculated and therefore a high certainty diagnosis of the white turbid level U can be performed. Since the scanning directions are set in a bilaterally symmetrical manner, a gap G<sub>l</sub> of the brightness gradient g can be evaluated by use of symmetry of expansion of an image of a light source. Thereby, brightness gradient g with high certainty can be calculated and the white turbid level U can be more certainly diagnosed.</p><p id="p0110" num="0110">According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, a white turbid level U is diagnosed based on a brightness gradient g in a region R<sub>0</sub> formed by a lighting headlight of another vehicle, imaged by the imaging part 10. Thereby, high SN image can be obtained and therefore the white turbid level U can be certainly diagnosed.</p><p id="p0111" num="0111">According to the white turbid state diagnostic apparatus 8 of an embodiment of<!-- EPO <DP n="24"> --> the present invention, a white turbid level U is diagnosed based on a brightness gradient g in a region R<sub>0</sub> formed by a lighting headlight of a vehicle running in the same lane as the vehicle 5 in a backward position of the vehicle 5. Therefore, an image of a light source can be observed at a position which is previously expected, and thereby a region to detect the image of the light source can be restricted to improve efficiency of image signal processings.</p><p id="p0112" num="0112">According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, a brightness gradient g is calculated as a pixel number between a position where a brightness value of a minified image I'(x, y) where predetermined scanning directions (lines) pass goes down under a first threshold value A and a position where the brightness value goes down under a second threshold value B which is less than the first threshold value A. Thereby, the brightness gradient g can be certainly calculated with a simple processing.<br/>
According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, a white turbid level calculation part 40 has a similarity calculation section 44 to calculate a similarity of regions R<sub>0</sub> detected from image signals I(x, y) imaged at different times, and a certainty determination section 46 to determine certainty F of a white turbid level U according to a number of imaging times when a state where the similarity is higher than a predetermined value is continuously detected. Therefore, certainty of diagnosis result of a white turbid level can be improved.</p><p id="p0113" num="0113">According to the white turbid state diagnostic apparatus 8 of an embodiment of the present invention, it is judged that similarity is high when a ratio of an average value Ave(U) of a plurality of previously obtained white turbid levels U and the latest white turbid level U is within a predetermined range. Therefore, the certainty of a diagnosis result of the white turbid level U can be improved with a simple signal.</p><p id="p0114" num="0114">In Embodiment 1, the white turbid level U is diagnosed when a vehicle speed of the vehicle 5 is a predetermined value or more. This is because the BSW system 9<!-- EPO <DP n="25"> --> executed at the same time as the diagnosis of the white turbid level U is a system which operates at a certain vehicle speed or more and the operation of the diagnosis of the white turbid level U is matched with the operation of the BSW system 9. However, it is not necessary to operate with restriction of a vehicle speed, and the diagnosis of the white turbid level U may be performed at a vehicle speed of 0.</p><p id="p0115" num="0115">In Embodiment 1, as the photoelectric conversion section 14 of the imaging part 10, a CMOS type element is used but it is not limited thereto. That is, a CCD type element may be used. If the CCD type element is used, when high brightness light source such as a headlight is imaged, a phenomenon (smear) where electrical charges stored in the photoelectric conversion section 14 overflow occurs and bright bands having the same width as an image of a headlight at upper and lower parts of the image occur. Accordingly, by performing a filtering processing to remove a vertically elongated rectangular region to remove the bands generated by the smear and then the above processing may be performed.</p><p id="p0116" num="0116">In Embodiment 1, an on-vehicle image processing system operated at the same time as the white turbid state diagnostic apparatus 8 is not limited to the BSW system 9. That is, a lane departure warning (LDW) system detecting a lane departure to alert or any other system may be applicable.</p><p id="p0117" num="0117">In Embodiment 1, a white turbid level occurring on a surface of the lens 12 is diagnosed. However, some on-vehicle image processing system executed at the same time as the diagnosis of the white turbid level may have a configuration where the imaging part 10 is installed in a vehicle interior and observes exterior through a windshield of the vehicle 5. In this case, a white turbidity occurs on a front surface of the windshield but not on the surface of the lens 12. In Embodiment 1, the white turbid level of the front surface of the windshield can be diagnosed by the same processings as those described above.</p><heading id="h0003">(Embodiment 2)</heading><!-- EPO <DP n="26"> --><p id="p0118" num="0118">Next, a second embodiment of the white turbid state diagnostic apparatus of the present invention will be explained.</p><p id="p0119" num="0119">This embodiment is an example where a white turbid state diagnostic apparatus according to the present invention is applied to a vehicle having a BSW system, similarly to Embodiment 1. Differences from Embodiment 1 are in a method for setting a predetermined line to calculate a brightness gradient for a diagnosis of a white turbid level and in that the apparatus has a lens cleaning function to clean a lens surface when the white turbid level is high.</p><p id="p0120" num="0120">Hereinafter, Embodiment 2 of the white turbid state diagnostic apparatus of the present invention will be explained with reference to drawings.</p><p id="p0121" num="0121"><figref idrefs="f0012">FIG. 14</figref> shows an example where the white turbid state diagnostic apparatus according to this embodiment.</p><p id="p0122" num="0122">As shown in <figref idrefs="f0012">FIG. 14</figref>, the white turbid state diagnostic apparatus 11 according to Embodiment 2 is installed near a rear license plate of the vehicle 5 (shown in <figref idrefs="f0001">FIG. 1</figref>). The white turbid state diagnostic apparatus 11 includes an imaging part 10 observing a range ω shown in <figref idrefs="f0001">FIG. 1</figref>, a region detection part 20 to detect an image of a headlight of a following vehicle from the image obtained by the imaging part 10, a brightness gradient calculation part 32 to calculate a brightness gradient on a predetermined line in a region detected by the region detection part 20, a white turbid level calculation part 41 to calculate a white turbid level of a lens 12 based on the brightness gradient calculated by the brightness gradient calculation part 32, and a white turbid level delivering part 52 to deliver the white turbid level calculated by the white turbid level calculation part 41 to a later-described lens cleaning section 54 and an approaching vehicle detection section 60.</p><p id="p0123" num="0123">The white turbid level calculation part 41 has a similarity calculation section 44 to judge whether or not regions detected by the region detection part 20 at different times are images formed from the same light source, and a certainty determination section 46 to determine certainty of the calculated white turbid level.<!-- EPO <DP n="27"> --></p><p id="p0124" num="0124">The white turbid state diagnostic apparatus 11 according to Embodiment 2 cooperates with the BSW system 9 having the approaching vehicle detection section 60 to detect an approaching vehicle from the image obtained by the imaging part 10 and an alert output section 70 to alert by an indicator or a buzzer when the approaching vehicle is detected by the approaching vehicle detection section 60.</p><p id="p0125" num="0125">The white turbid state diagnostic apparatus 11 according to Embodiment 2 has the lens cleaning section 54 having a cleaning function to clean a surface of the lens 12.</p><p id="p0126" num="0126">A diagnosis method in the white turbid state diagnostic apparatus 11 according to Embodiment 2 will be explained. The flow is substantially the same as <figref idrefs="f0004">FIG. 4</figref> and therefore only parts different therefrom will be explained below.</p><p id="p0127" num="0127">It is the same as Embodiment 1 that the diagnosis of the lens white turbid state is performed only when the value of the gain in the gain adjustment part 16 is larger than the predetermined value. It is also the same as Embodiment 1 that the diagnosis of the lens white turbid state is performed based on the brightness gradient on the predetermined line in the image of the headlight by use of the image of the headlight of the following vehicle running in the same lane L<sub>2</sub> as the vehicle 5.</p><p id="p0128" num="0128">A method for calculating a brightness gradient in the brightness gradient calculation part 32 is different from that in Embodiment 1. Hereinafter, the method for calculating the brightness gradient will be explained in detail with reference to <figref idrefs="f0013">FIGS. 15</figref> and <figref idrefs="f0014">16</figref>. <figref idrefs="f0013">FIG. 15</figref> is a view explaining an example of a predetermined line to calculate a brightness gradient and an example of a brightness gradient calculated on the predetermined line. <figref idrefs="f0014">FIG. 16</figref> is a flowchart showing a flow of the brightness gradient calculation processing performed in the brightness gradient calculation part 32.</p><p id="p0129" num="0129">In this embodiment, as shown in <figref idrefs="f0013">FIG. 15</figref>, a vertical coordination Oy of a scanning start point O is set between a centroid position G of a region R<sub>0</sub> and an upmost point J of the region R<sub>0</sub> (step S60).</p><p id="p0130" num="0130">A scanning direction OP to scan brightness values is set in a direction from the<!-- EPO <DP n="28"> --> centroid position G of the region R<sub>0</sub> to a circumferential edge of the region R<sub>0</sub> (step S61).</p><p id="p0131" num="0131">As shown in <figref idrefs="f0013">FIG. 15</figref>, the scanning direction OP from the scanning start point O to the circumferential edge of the region R<sub>0</sub> is set in a direction of an angle Θ with respect to a line passing the centroid position G from the centroid position G of the region R<sub>0</sub> in a vertical direction.</p><p id="p0132" num="0132">The brightness values on the scanning direction OP are read and a brightness distribution as shown in Graph of <figref idrefs="f0013">FIG. 15</figref> is obtained (step S62).</p><p id="p0133" num="0133">From the brightness distribution, a pixel number L<sub>Θ</sub> is calculated, which is a pixel number in the angle Θ direction from a position where the brightness distribution on the scanning direction OP goes down under a threshold value A (first threshold value) to a position where the brightness distribution goes down under a threshold value B (second threshold value) which is smaller than the threshold value A (step S63).</p><p id="p0134" num="0134">Then, by use of a brightness difference D<sub>l</sub> (=A-B), the brightness gradient g is calculated as D<sub>l</sub>/L<sub>Θ</sub> (step S64).</p><p id="p0135" num="0135">As described above, the scanning direction to calculate the brightness gradient g is not limited to the horizontal direction as described in Embodiment 1 and may be set to a direction with an angle Θ with respect to the vertical direction from the centroid position G of the region R<sub>0</sub>. Even with this setting, since the scanning direction can be set to an upper side from the centroid position G of the region R<sub>0</sub>, on the set scanning direction, an image due to splash from the vehicle 5, reflection of a headlight of a following vehicle from a road surface, or a headlight of a vehicle running in an adjacent lane is barely included. Accordingly, an accurate brightness gradient g without any affection of these images can be calculated.</p><p id="p0136" num="0136">Next, the calculated brightness gradient g is corrected according to a value of a gain adjusted in the gain adjustment part 16. That is, if the gain value is a predetermined value K or more (YES in step S65), the calculated brightness gradient g is multiplied by a logarithm natural of the predetermined value K to generate a new brightness gradient g<!-- EPO <DP n="29"> --> (step S66).</p><p id="p0137" num="0137">If the gain value is smaller than the predetermined value K (NO in step S65), the calculated brightness gradient g is multiplied by a logarithm natural of the current gain adjusted in the gain adjustment part 16 to generate a new brightness gradient g (step S67).</p><p id="p0138" num="0138">Due to such a correction, when the gain value is within a range from 0 to the predetermined value K, a relationship between the gain value and the brightness value of the obtained image can be approximated by a logarithmic function and therefore by multiplying the brightness value of the obtained image by a logarithm natural of the gain value used when the image is obtained to correct into the more accurate brightness value. By performing such a correction, more accurate brightness gradient g can be calculated and thereby the white turbid level U can be more accurately diagnosed.</p><p id="p0139" num="0139">As described above, after the brightness gradient g is calculated, in Embodiment 1, the left and right brightness gradients are averaged to calculate the white turbid level. However, in Embodiment 2, the brightness gradient g is calculated from the brightness distribution in one direction, and therefore the calculated brightness gradient is itself the white turbid level U.</p><p id="p0140" num="0140">In Embodiment 1, the gap G<sub>l</sub> is calculated based on the brightness distributions in two directions and evaluates the symmetry of the image of the light source. However, in Embodiment 2, the symmetry is not evaluated.</p><p id="p0141" num="0141">Therefore, the flow of the diagnosis of the white turbid level in Embodiment 2 is shown by the flowchart of <figref idrefs="f0010">FIG. 11</figref> explained in Embodiment 1, from which step S40 to evaluate the symmetry in the horizontal direction and step S41 to calculate a white turbid level by averaging the brightness gradients in two directions are eliminated.</p><p id="p0142" num="0142">Similarly to Embodiment 1, it is judged whether the images are from the same light source, and the certainty F is improved as more images from the same light source are continuously detected to improve the certainty of the diagnosis of the white turbid level U.</p><p id="p0143" num="0143">If the white turbid level U is the threshold value Th<sub>U</sub> or less (high white turbid level),<!-- EPO <DP n="30"> --> the error e<sub>U</sub> of the white turbid level U is the threshold value The or less, and the certainty F is Ph3, it is judged that the lens 12 has white turbidity, and the parameters such as the white turbid level U and the like are delivered to the approaching vehicle detection section 60 and the lens cleaning section 54 through the white turbid level delivering part 52.</p><p id="p0144" num="0144">Then, cleaning agent is sprayed onto the surface of the lens 12 in the lens cleaning section 54 to clean the surface of the lens 12.</p><p id="p0145" num="0145">The BSW system 9 performs behavior control such as setting the BSW system 9 in a fail-state during the cleaning of the lens 12 is performed after the parameters such as the white turbid level U and the like are received. After the cleaning of the lens 12 is completed, the BSW system 9 is activated again.</p><p id="p0146" num="0146">The BSW system may be activated after the cleaning of the lens 12 is completed, and then the above-described white turbid diagnosis is performed and it is confirmed that the white turbidity is clearly removed.</p><p id="p0147" num="0147">As described above, in Embodiment 2, the brightness gradient is calculated only in one direction. The scanning direction OP can be set to a direction where images other than the headlight of the following vehicle are barely included and therefore the brightness gradient with high certainty can be calculated and the white turbid level can be accurately diagnosed. Furthermore, the brightness distribution can be generated in a short time to improve efficiency of the processings.</p><p id="p0148" num="0148">The scanning direction to calculate the brightness gradient g is not limited to the above described direction and may be set as shown in <figref idrefs="f0015">FIGS. 17A to 17E</figref>.</p><p id="p0149" num="0149">That is, as shown in <figref idrefs="f0015">FIG. 17B</figref>, in the region R<sub>0</sub>, the scanning start point O is set at an upper position from the centroid position G of the region R<sub>0</sub> on a line extending in a vertical direction and passing the centroid position G. Then, a horizontal line extending from the scanning start point in a leftward direction may be set as the scanning direction O<sub>3</sub>P<sub>3</sub>. Further, as shown in <figref idrefs="f0015">FIG. 17C</figref>, in the region R<sub>0</sub>, a scanning start point O<sub>4</sub> is set at an<!-- EPO <DP n="31"> --> upper position from the centroid position G of the region R<sub>0</sub> on a line extending in a vertical direction and passing the centroid position G. Then, a vertical line extending from the scanning start point O<sub>4</sub> in an upward direction may be set as the scanning direction O<sub>4</sub>P<sub>4</sub>.</p><p id="p0150" num="0150">As explained in Embodiment 1, a plurality of scanning directions may be set. In this case, not only the scanning directions in the horizontal direction as described in Embodiment 1, but as shown in <figref idrefs="f0015">FIG. 17A</figref>, in the region R<sub>0</sub>, scanning directions O<sub>1</sub>P<sub>1</sub>, O<sub>2</sub>P<sub>2</sub> may be set, each extending in an upward and left or right direction with an angle Θ with respect to the vertical line from the centroid position G of the region R<sub>0</sub>. In this case also, the scanning start points O<sub>1</sub>, O<sub>2</sub> are set at an upper side from the centroid position G of the region R<sub>0</sub>.</p><p id="p0151" num="0151">In case where a plurality of scanning directions are set, as explained in Embodiment 1, the white turbid level U may be obtained by averaging the brightness gradients g calculated in the respective scanning directions. Furthermore, in case where a plurality of scanning directions are set, a gap G<sub>l</sub> of the brightness gradients may be calculated as explained in Embodiment 1 to judge validity of the detected region R<sub>0</sub> based on the gap G<sub>l</sub> of the brightness gradient g.</p><p id="p0152" num="0152">As the scanning directions, as shown in <figref idrefs="f0015">FIG. 17D</figref>, further more directions may be set. <figref idrefs="f0015">FIG. 17D</figref> shows an example where in addition to the scanning directions O<sub>1</sub>P<sub>1</sub>, O<sub>2</sub>P<sub>2</sub> set according to <figref idrefs="f0015">FIG. 17A</figref>, a scanning direction O<sub>3</sub>P<sub>3</sub> extending in a leftward direction and a scanning direction O<sub>4</sub>P<sub>4</sub> are set.</p><p id="p0153" num="0153">The brightness gradients g calculated in the respective scanning directions set as described above are averaged to obtain the white turbid level U and the gap G<sub>l</sub> of the brightness gradients g is calculated to judge validity of the detected region R<sub>0</sub>.</p><p id="p0154" num="0154">In <figref idrefs="f0015">FIGS. 17A and 17D</figref>, the plurality of scanning directions are set to have the symmetry in the horizontal direction with respect to a vertical line passing the centroid position G of the region R<sub>0</sub>. However, it is not limited thereto. That is, a plurality of<!-- EPO <DP n="32"> --> scanning directions may be set, which are not bilaterally symmetric with respect to the vertical line passing the centroid position G of the region R<sub>0</sub>.</p><p id="p0155" num="0155">Especially, in case where the white turbidity on the surface of the lens 12 is in a substantially circular shape, that is, the white turbidity has isotropy from the centroid position G of the region R<sub>0</sub>, the brightness gradient g along the scanning direction from the centroid position G of the region R<sub>0</sub> to the circumferential edge of the region R<sub>0</sub> is in the substantially same shape regardless of the direction. Accordingly, a plurality of scanning directions can be set without considering the bilateral symmetry in each scanning direction.</p><p id="p0156" num="0156">The brightness gradients g calculated in the respective scanning directions set as described above are averaged to obtain the white turbid level U and the gap G<sub>l</sub> of the brightness gradients g is calculated to judge validity of the detected region R<sub>0</sub>.</p><p id="p0157" num="0157">When further more scanning directions are set, after a brightness gradient g in each scanning direction is calculated, the scanning direction from which the brightness gradient g having an abnormal value is calculated may be dismissed and the brightness gradients g calculated from the other scanning directions may be averaged to calculate the white turbid level U. Thereby, in case where noise occurs unexpectedly in a particular direction, the brightness distribution is read in the other scanning directions than the particular direction to calculate the brightness gradients g and influence from noise is reduced. Therefore, the brightness gradient g with high certainty can be calculated and thereby the white turbid level U with high certainty can be calculated.</p><p id="p0158" num="0158">The scanning direction may be set as an elongated region as shown in <figref idrefs="f0015">FIG. 17E</figref> instead of a line. In <figref idrefs="f0015">FIG. 17E</figref>, the scanning start point O<sub>3</sub> is set on a vertical line passing the centroid position G of the region R<sub>0</sub> in the region R<sub>0</sub>, and a scanning direction O<sub>3</sub>P<sub>3</sub> extending in a leftward direction and a scanning direction O<sub>3</sub>P<sub>4</sub> extending in a rightward direction from the scanning start point O<sub>3</sub> are set. Then, a region having a thickness t in an orthogonal direction to the scanning direction O<sub>3</sub>P<sub>3</sub> and the scanning direction O<sub>3</sub>P<sub>4</sub> is<!-- EPO <DP n="33"> --> set.</p><p id="p0159" num="0159">In the brightness gradient calculation part 32, a value of a sum of the brightness values in a direction perpendicular to the scanning direction O<sub>3</sub>P<sub>3</sub> (thickness t direction) within the set region over the scanning direction O<sub>3</sub>P<sub>3</sub> is calculated to calculate a distribution of the value of the sum along the scanning direction O<sub>3</sub>P<sub>3</sub>.</p><p id="p0160" num="0160">From the distribution of the value of the sum, the brightness gradient g is calculated, similarly to the above-explanation. The first threshold value A and the second threshold value B set when calculating the brightness gradient g are set as other threshold values in accordance with the thickness t of the set region.</p><p id="p0161" num="0161">With respect to the scanning direction O<sub>3</sub>P<sub>4</sub>, similarly to the above, a value of a sum of the brightness values is calculated and then the brightness gradient g is calculated.</p><p id="p0162" num="0162">Then, the white turbid level U is calculated similarly to the above explanation to perform diagnosis of the white turbid level U.</p><p id="p0163" num="0163">As described above, by setting a region elongated in the scanning direction, even when unexpected noise is included, influence of the noise can be reduced compared to the case where a line is used as a scanning direction. Accordingly, a steady brightness gradient g can be calculated and diagnosis of the white turbid level U can be performed with high certainty.</p><p id="p0164" num="0164">As described above, according to the white turbid state diagnostic apparatus 11 of an embodiment of the present invention, when a horizontal position of the scanning start point O is set to a horizontal position Gx of a centroid position G of the region R<sub>0</sub>, and a vertical position of the scanning start point O is set to a position between a horizontal line passing the centroid position G of the region R<sub>0</sub> and a horizontal line passing an upmost point of the region R<sub>0</sub>, a scanning direction (line) to calculate the brightness gradient g is set such that the scanning direction OP is directed leftward in the horizontal direction from the scanning start point O. Therefore, splash from the vehicle 5, reflection of a headlight of a following vehicle from a road surface, a headlight of a vehicle running in an<!-- EPO <DP n="34"> --> adjacent lane, and the like, which appear at a lower part of the image than the centroid position G of the region R<sub>0</sub> can be prevented from being included. Thereby, a brightness gradient g with high certainty can be calculated and therefore a high certainty diagnosis of the white turbid level U can be performed. Since the scanning direction is set only in a single direction, the brightness distribution can be generated in a short time to improve efficiency of the processings.</p><p id="p0165" num="0165">According to the white turbid state diagnostic apparatus 11 of an embodiment of the present invention, the scanning direction (line) to calculate the brightness gradient g is set so as to extend from the centroid position G of the region R<sub>0</sub> to the circumferential edge of the region R<sub>0</sub> and the horizontal position of the scanning start point O is set between the horizontal line passing the centroid position G of the region R<sub>0</sub> and the horizontal line passing the upmost position of the region R<sub>0</sub>. Thereby, an image due to splash from the vehicle 5, reflection of a headlight of a following vehicle from a road surface, or a headlight of a vehicle running in an adjacent lane is barely included. Accordingly, an accurate brightness gradient g without any affection of these images can be calculated.</p><p id="p0166" num="0166">According to the white turbid state diagnostic apparatus 11 of an embodiment of the present invention, a plurality of scanning directions (lines) are set in combination. Thereby, even in case where unexpected noise occurs in a particular direction, influence from the noise can be reduced and the brightness gradient with high certainty can be calculated and thereby the white turbid level U with high certainty can be calculated.</p><p id="p0167" num="0167">According to the white turbid state diagnostic apparatus 11 of an embodiment of the present invention, the brightness gradient calculation part 32 corrects the brightness gradient g based on a gain value of the imaging part 10, which is adjusted by a gain adjustment part 16 to update the brightness gradient g. Therefore, more accurate brightness gradient g can be calculated and thus the white turbid level U can be more accurately diagnosed.<!-- EPO <DP n="35"> --></p><p id="p0168" num="0168">According to the white turbid state diagnostic apparatus 11 of an embodiment of the present invention, if the gain value of the imaging part 10, which is adjusted by the gain adjustment section 16 is less than a predetermined value K, the brightness gradient calculation part 32 corrects the brightness gradient g by being multiplied by a logarithm natural of the gain adjusted in the gain adjustment part 16 to generate a more accurate brightness gradient g. If the gain value adjusted by the gain adjustment section 16 is the predetermined value K or more, the brightness gradient calculation part 32 corrects the brightness gradient g by being multiplied by a logarithm natural of the predetermined value K to generate a more accurate brightness gradient g. Thereby, the white turbid level U can be more accurately diagnosed.</p><p id="p0169" num="0169">According to a white turbid state diagnostic apparatus of an embodiment of the present invention, a white turbid level of a lens due to grime is steadily detected and the white turbid level can be certainly diagnosed.</p><p id="p0170" num="0170">Although the preferred embodiments of the present invention have been described, the present invention is not limited thereto. Various changes and modifications can be made to the embodiments by those skilled in the art as long as such modifications and changes are within the scope of the present invention as defined by the claims.</p></description><claims mxw-id="PCLM56976394" lang="EN" load-source="patent-office"><!-- EPO <DP n="36"> --><claim id="c-en-0001" num="0001"><claim-text>A white turbid state diagnostic apparatus, comprising<br/>
an imaging part (10) installed on a vehicle and configured to observe a periphery of a vehicle via a lens (12), the imaging part having a photoelectric conversion section (14) configured to convert a light signal of the observed periphery of the vehicle into an image signal;<br/>
a region detection part (20) configured to detect a region from the image signal, the region being constituted by pixels having brightness values over a predetermined brightness and being in a substantially circular shape having a predetermined area or more;<br/>
a brightness gradient calculation part (30) configured to calculate a brightness gradient (g) on a line which is directed from a predetermined position in a predetermined direction based on brightness values of pixels on the line in the region; and<br/>
a white turbid level calculation part (40) configured to calculate a white turbid level of the lens based on the brightness gradient.</claim-text></claim><claim id="c-en-0002" num="0002"><claim-text>The lens white turbid status diagnostic apparatus according to claim 1, wherein the imaging part has a gain adjustment section configured to adjust a gain for converting the light signal into the image signal according to brightness of the periphery of the vehicle; and<br/>
if the gain is larger than a predetermined value, the white turbid level calculation part calculates the white turbid level.</claim-text></claim><claim id="c-en-0003" num="0003"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein<br/>
a starting point of the line has a horizontal position being at a horizontal position of a centroid position and a vertical position being at a position between a horizontal line<!-- EPO <DP n="37"> --> passing the centroid position of the region and a horizontal line passing an upmost position of the region;<br/>
the line extends in a leftward or a rightward direction from the starting point in the image signal.</claim-text></claim><claim id="c-en-0004" num="0004"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein<br/>
the line extends from a centroid position of the region to a circumferential edge of the region; and<br/>
a starting point of the line has a vertical position which is between a horizontal line passing the centroid position of the region and a horizontal line passing an upmost position of the region.</claim-text></claim><claim id="c-en-0005" num="0005"><claim-text>The white turbid state diagnostic apparatus according to claim 3, wherein the line is constituted by a plurality of lines in combination.</claim-text></claim><claim id="c-en-0006" num="0006"><claim-text>The white turbid state diagnostic apparatus according to claim 5, wherein the line is constituted by a plurality of lines having a bilaterally symmetric relationship with respect to a line passing the centroid position of the region and extending vertically in the image signal.</claim-text></claim><claim id="c-en-0007" num="0007"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein the region is a region formed by a lighting headlight of another vehicle imaged by the imaging part (10).</claim-text></claim><claim id="c-en-0008" num="0008"><claim-text>The white turbid state diagnostic apparatus according to claim 7, wherein the another vehicle is a vehicle running in a same lane as the vehicle at a backward position.<!-- EPO <DP n="38"> --></claim-text></claim><claim id="c-en-0009" num="0009"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein the brightness gradient (g) is calculated as a number of pixels on the line between a position where the brightness value on the line goes down under a first threshold value to a position where the brightness value on the line goes down under a second threshold value which is less than the first threshold value in a direction extending from a starting point of the line set in the image signal along the line.</claim-text></claim><claim id="c-en-0010" num="0010"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein the white turbid level calculation part (40) has<br/>
a brightness gradient average value calculation section (42) configured to calculate an average value of the brightness gradient calculated on the line to obtain a white turbid level;<br/>
a similarity calculation section (44) configured to calculate a similarity of regions detected from image signals imaged at different timings; and<br/>
a certainty determination section (46) configured to determine a certainty of the white turbid level according to a period where high similarities are continuously calculated.</claim-text></claim><claim id="c-en-0011" num="0011"><claim-text>The white turbid state diagnostic apparatus according to claim 1, wherein the similarity calculation section (44) judges that the similarity is high when a ratio of an average value of a plurality of previous white turbid levels and the latest white turbid level is within a predetermined range.</claim-text></claim><claim id="c-en-0012" num="0012"><claim-text>The white turbid state diagnostic apparatus according to claim 2, wherein the brightness gradient calculation part (30) corrects the brightness gradient based on a gain adjusted by the gain adjustment section (16).<!-- EPO <DP n="39"> --></claim-text></claim><claim id="c-en-0013" num="0013"><claim-text>The white turbid state diagnostic apparatus according to claim 12, wherein the brightness gradient calculation part (30) corrects the brightness gradient by being multiplied by a logarithmic nature of the gain adjusted by the gain adjustment section (16) when the gain adjusted by the gain adjustment section is less than a predetermined gain, and corrects the brightness gradient by being multiplied by a logarithmic nature of the predetermined gain when the gain adjusted by the gain adjustment section (16) is the predetermined gain or more.</claim-text></claim></claims><drawings mxw-id="PDW16667175" load-source="patent-office"><!-- EPO <DP n="40"> --><figure id="f0001" num="1"><img id="if0001" file="imgf0001.tif" wi="165" he="131" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="41"> --><figure id="f0002" num="2"><img id="if0002" file="imgf0002.tif" wi="165" he="209" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="42"> --><figure id="f0003" num="3A,3B"><img id="if0003" file="imgf0003.tif" wi="146" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="43"> --><figure id="f0004" num="4"><img id="if0004" file="imgf0004.tif" wi="114" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="44"> --><figure id="f0005" num="5,6"><img id="if0005" file="imgf0005.tif" wi="146" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="45"> --><figure id="f0006" num="7A,7B,7C,7D"><img id="if0006" file="imgf0006.tif" wi="160" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="46"> --><figure id="f0007" num="8A,8B"><img id="if0007" file="imgf0007.tif" wi="135" he="169" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="47"> --><figure id="f0008" num="9"><img id="if0008" file="imgf0008.tif" wi="139" he="176" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="48"> --><figure id="f0009" num="10"><img id="if0009" file="imgf0009.tif" wi="151" he="184" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="49"> --><figure id="f0010" num="11"><img id="if0010" file="imgf0010.tif" wi="151" he="214" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="50"> --><figure id="f0011" num="12,13"><img id="if0011" file="imgf0011.tif" wi="165" he="201" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="51"> --><figure id="f0012" num="14"><img id="if0012" file="imgf0012.tif" wi="165" he="220" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="52"> --><figure id="f0013" num="15"><img id="if0013" file="imgf0013.tif" wi="162" he="151" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="53"> --><figure id="f0014" num="16"><img id="if0014" file="imgf0014.tif" wi="165" he="178" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="54"> --><figure id="f0015" num="17A,17B,17C,17D,17E"><img id="if0015" file="imgf0015.tif" wi="158" he="233" img-content="drawing" img-format="tif"/></figure></drawings><search-report-data><doc-page id="srep0001" file="srep0001.tif" wi="157" he="233" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="156" he="233" type="tif"/></search-report-data><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
