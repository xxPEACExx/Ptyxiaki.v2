<?xml version="1.0" encoding="UTF-8"?>
<patent-document ucid="EP-2680126-A2" country="EP" doc-number="2680126" kind="A2" date="20140101" family-id="48576236" file-reference-id="267004" date-produced="20180824" status="corrected" lang="EN"><bibliographic-data><publication-reference fvid="146549504" ucid="EP-2680126-A2"><document-id><country>EP</country><doc-number>2680126</doc-number><kind>A2</kind><date>20140101</date><lang>EN</lang></document-id></publication-reference><application-reference ucid="EP-13169456-A" is-representative="YES"><document-id mxw-id="PAPP154823427" load-source="docdb" format="epo"><country>EP</country><doc-number>13169456</doc-number><kind>A</kind><date>20130528</date><lang>EN</lang></document-id><document-id mxw-id="PAPP198569498" load-source="docdb" format="original"><country>EP</country><doc-number>13169456.4</doc-number><date>20130528</date></document-id></application-reference><priority-claims><priority-claim mxw-id="PPC140449744" ucid="JP-2012144351-A" load-source="docdb"><document-id format="epo"><country>JP</country><doc-number>2012144351</doc-number><kind>A</kind><date>20120627</date></document-id></priority-claim></priority-claims><technical-data><classifications-ipcr><classification-ipcr mxw-id="PCL1988099313" load-source="docdb">H04L  29/08        20060101ALI20131007BHEP        </classification-ipcr><classification-ipcr mxw-id="PCL1988126256" load-source="docdb">G06F   3/06        20060101AFI20131007BHEP        </classification-ipcr></classifications-ipcr><classifications-cpc><classification-cpc mxw-id="PCL-1965269489" load-source="docdb" scheme="CPC">H04L  67/1097      20130101 LI20160302BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1965270237" load-source="docdb" scheme="CPC">G06F   3/0611      20130101 LI20160302BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1965270876" load-source="docdb" scheme="CPC">G06F   3/0659      20130101 LI20160302BHEP        </classification-cpc><classification-cpc mxw-id="PCL-1965271259" load-source="docdb" scheme="CPC">G06F   3/067       20130101 LI20160302BHEP        </classification-cpc><classification-cpc mxw-id="PCL1991315750" load-source="docdb" scheme="CPC">G06F  13/1657      20130101 FI20131226BHEP        </classification-cpc></classifications-cpc><invention-title mxw-id="PT132180996" lang="DE" load-source="patent-office">Speichervirtualisierungsvorrichtung, Speichervirtualisierungsverfahren und Speichervirtualisierungsprogramm</invention-title><invention-title mxw-id="PT132180997" lang="EN" load-source="patent-office">Storage virtualization apparatus, storage virtualization method and storage virtualization program</invention-title><invention-title mxw-id="PT132180998" lang="FR" load-source="patent-office">Appareil de virtualisation de stockage, procédé de virtualisation de stockage et programme de virtualisation de stockage</invention-title><citations><patent-citations><patcit mxw-id="PCIT242652564" load-source="docdb" ucid="JP-2004295860-A"><document-id format="epo"><country>JP</country><doc-number>2004295860</doc-number><kind>A</kind><date>20041021</date></document-id><sources><source name="APP" created-by-npl="N"/></sources></patcit><patcit mxw-id="PCIT242652565" load-source="docdb" ucid="JP-2005326935-A"><document-id format="epo"><country>JP</country><doc-number>2005326935</doc-number><kind>A</kind><date>20051124</date></document-id><sources><source name="APP" created-by-npl="N"/></sources></patcit></patent-citations></citations></technical-data><parties><applicants><applicant mxw-id="PPAR918135306" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>FUJITSU LTD</last-name><address><country>JP</country></address></addressbook></applicant><applicant mxw-id="PPAR918151084" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>FUJITSU LIMITED</last-name></addressbook></applicant><applicant mxw-id="PPAR918983581" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>FUJITSU LIMITED</last-name><iid>100126510</iid><address><street>1-1, Kamikodanaka 4-chome, Nakahara-ku</street><city>Kawasaki-shi, Kanagawa 211-8588</city><country>JP</country></address></addressbook></applicant></applicants><inventors><inventor mxw-id="PPAR918153967" load-source="docdb" sequence="1" format="epo"><addressbook><last-name>SHIOMI HIROSHI</last-name><address><country>JP</country></address></addressbook></inventor><inventor mxw-id="PPAR918160633" load-source="docdb" sequence="1" format="intermediate"><addressbook><last-name>SHIOMI, HIROSHI</last-name></addressbook></inventor><inventor mxw-id="PPAR918988050" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>SHIOMI, HIROSHI</last-name><address><street>c/o FUJITSU LIMITED 1-1, Kamikodanaka 4-chome Nakahara-ku Kawasaki-shi</street><city>Kanagawa, 211-8588</city><country>JP</country></address></addressbook></inventor></inventors><agents><agent mxw-id="PPAR918994010" load-source="patent-office" sequence="1" format="original"><addressbook><last-name>HOFFMANN EITLE</last-name><iid>100061036</iid><address><street>Patent- und Rechtsanwälte Arabellastrasse 4</street><city>81925 München</city><country>DE</country></address></addressbook></agent></agents></parties><international-convention-data><designated-states><ep-contracting-states><country mxw-id="DS548805366" load-source="docdb">AL</country><country mxw-id="DS548872358" load-source="docdb">AT</country><country mxw-id="DS548805368" load-source="docdb">BE</country><country mxw-id="DS548865742" load-source="docdb">BG</country><country mxw-id="DS548806123" load-source="docdb">CH</country><country mxw-id="DS548869487" load-source="docdb">CY</country><country mxw-id="DS548872359" load-source="docdb">CZ</country><country mxw-id="DS548805369" load-source="docdb">DE</country><country mxw-id="DS548869488" load-source="docdb">DK</country><country mxw-id="DS548869489" load-source="docdb">EE</country><country mxw-id="DS548886273" load-source="docdb">ES</country><country mxw-id="DS548865743" load-source="docdb">FI</country><country mxw-id="DS548865744" load-source="docdb">FR</country><country mxw-id="DS548805370" load-source="docdb">GB</country><country mxw-id="DS548869490" load-source="docdb">GR</country><country mxw-id="DS548805371" load-source="docdb">HR</country><country mxw-id="DS548872360" load-source="docdb">HU</country><country mxw-id="DS548806124" load-source="docdb">IE</country><country mxw-id="DS548805372" load-source="docdb">IS</country><country mxw-id="DS548865745" load-source="docdb">IT</country><country mxw-id="DS548869491" load-source="docdb">LI</country><country mxw-id="DS548843041" load-source="docdb">LT</country><country mxw-id="DS548872361" load-source="docdb">LU</country><country mxw-id="DS548843070" load-source="docdb">LV</country><country mxw-id="DS548843071" load-source="docdb">MC</country><country mxw-id="DS548896958" load-source="docdb">MK</country><country mxw-id="DS548896959" load-source="docdb">MT</country><country mxw-id="DS548886274" load-source="docdb">NL</country><country mxw-id="DS548872362" load-source="docdb">NO</country><country mxw-id="DS548886275" load-source="docdb">PL</country><country mxw-id="DS548869492" load-source="docdb">PT</country><country mxw-id="DS548886284" load-source="docdb">RO</country><country mxw-id="DS548869493" load-source="docdb">RS</country><country mxw-id="DS548886285" load-source="docdb">SE</country><country mxw-id="DS548869494" load-source="docdb">SI</country><country mxw-id="DS548896960" load-source="docdb">SK</country><country mxw-id="DS548896961" load-source="docdb">SM</country><country mxw-id="DS548806125" load-source="docdb">TR</country></ep-contracting-states><ep-extended-states><ep-extended-state-data><country>BA</country></ep-extended-state-data><ep-extended-state-data><country>ME</country></ep-extended-state-data></ep-extended-states></designated-states></international-convention-data></bibliographic-data><abstract mxw-id="PA128670173" lang="EN" load-source="patent-office"><p id="pa01" num="0001">A storage virtualization apparatus includes: a first storing unit to store, with respect to each storage port, a process incomplete command count defined as number of commands not yet processed by the storage device having each storage port; a control unit to obtain process incomplete command counts accumulated by other storage virtualization apparatuses, and stores into a second storing unit a process incomplete command total count that is a total of the process incomplete command counts obtained from the other storage virtualization apparatuses and the first storing unit; and an access request responding unit to, when receiving an access request, obtain the process incomplete command total count about a storage port corresponding to the received access request, and to, when the obtained process incomplete command total count is larger than a prescribed number, cause completion timing of an access responding process to the access request to be delayed.
<img id="iaf01" file="imgaf001.tif" wi="102" he="93" img-content="drawing" img-format="tif"/></p></abstract><abstract mxw-id="PA128499546" lang="EN" source="EPO" load-source="docdb"><p>A storage virtualization apparatus includes: a first storing unit to store, with respect to each storage port, a process incomplete command count defined as number of commands not yet processed by the storage device having each storage port; a control unit to obtain process incomplete command counts accumulated by other storage virtualization apparatuses, and stores into a second storing unit a process incomplete command total count that is a total of the process incomplete command counts obtained from the other storage virtualization apparatuses and the first storing unit; and an access request responding unit to, when receiving an access request, obtain the process incomplete command total count about a storage port corresponding to the received access request, and to, when the obtained process incomplete command total count is larger than a prescribed number, cause completion timing of an access responding process to the access request to be delayed.</p></abstract><description mxw-id="PDES63955603" lang="EN" load-source="patent-office"><!-- EPO <DP n="1"> --><heading id="h0001">Technical Field</heading><p id="p0001" num="0001">The present invention relates to a storage virtualization apparatus, a storage virtualization method and a storage virtualization program for virtualizing storage devices.</p><heading id="h0002">Background Art</heading><p id="p0002" num="0002">Over the recent years, almost all pieces of work (business) have been performed making use of computers, and consequently the number of the storage devices used to retain data has increased. Moreover, it is hard to manage many storage devices, and therefore storage virtualization is done in order to mitigate the system administrator's burden, etc.</p><p id="p0003" num="0003">Storage virtualization is done, as schematically illustrated in <figref idrefs="f0001">FIG. 1</figref>, by connecting a plurality of storage devices and a plurality of servers through a storage virtualization apparatus cluster consisting of a plurality of storage virtualization apparatuses (not illustrated).</p><p id="p0004" num="0004">The storage virtualization apparatus is an apparatus capable of integrally managing all logical units of the plurality of storage devices as one virtual storage pool and extracting from the storage pool a virtual volume of arbitrary size, which is seen as one storage device by the servers.</p><p id="p0005" num="0005">When receiving an access request from a server to a virtual volume, the storage virtualization apparatus refers to the mapping information set in its inside, thereby specifying a storage port to which a command corresponding to the received access request is to be issued. Then, the storage virtualization apparatus issues the command to the specified storage port.<!-- EPO <DP n="2"> --></p><p id="p0006" num="0006">Documents of Related Arts
<ul><li>Patent document 1: Japanese Laid-Open Patent Publication No. <patcit id="pcit0001" dnum="JP2004295860A"><text>2004-295860</text></patcit></li><li>Patent document 2: Japanese Laid-Open Patent Publication No. <patcit id="pcit0002" dnum="JP2005326935A"><text>2005-326935</text></patcit></li></ul></p><heading id="h0003">Summary of Invention</heading><heading id="h0004">Technical Problem</heading><p id="p0007" num="0007">To the storage port of the storage device, commands can be enqueued to some extent. However, when Queue Full occurs in the storage port (when a command queue in the storage port becomes full) as a result of continuous input of many commands, the storage port will go into the state where it does not accept a command.</p><p id="p0008" num="0008">The storage device (see <figref idrefs="f0001">FIG. 1</figref>), which is connected to the storage virtualization apparatus, generally has two redundant storage ports. Hence, even if Queue Full occurs at one storage port, it is possible to access the logical units in the storage device by using the other storage port. However, when Queue Full has occurred in a storage port, since commands which are received till then by two storage ports are received by only one storage port where Queue Full has not occurred, Queue Full of the storage port tends to be spawned frequently.</p><p id="p0009" num="0009">If Queue Full occurs in all the storage ports of a storage device, it follows that every logical volume related to the storage device (logical units in the storage device) can not be used. For instance, in a case where Queue Full occurs in two storage ports of the storage device #1 in <figref idrefs="f0001">FIG. 1</figref> and there exist two logical volumes related to the storage device #1, as schematically illustrated in <figref idrefs="f0002">FIG. 2</figref>, these two logical volumes can not be used.</p><p id="p0010" num="0010">Accordingly, the system (<figref idrefs="f0001">FIG. 1</figref>) using storage virtualization apparatuses is desired to be one where Queue Full<!-- EPO <DP n="3"> --> does not occur in either of the storage ports across the storage devices. But currently, since it is very difficult to design/operate the storage virtualization apparatus so that Queue Full may occur in neither of the storage ports, the storage virtualization apparatus capable of constructing the storage virtualization system in which Queue Full hardly occurs in every storage port has not been actualized.</p><p id="p0011" num="0011">It is an obj ect of the technique that is disclosed to provide a storage virtualization apparatus and a storage virtualization method capable of suppressing occurrence of Queue Full in the storage ports of the storage devices, and a storage virtualization program causes a computer to operate as an apparatus capable of suppressing occurrence of Queue Full in the storage ports of the storage devices.</p><heading id="h0005">Solution to Problem</heading><p id="p0012" num="0012">According to an aspect of the disclosed technique, a storage virtualization apparatus capable of being connected with a plurality of storage ports across a plurality of storage devices includes:
<ul><li>a first storing unit to store, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port;</li><li>a control unit to obtain, from each of other storage virtualization apparatuses connected to any one of the plurality of storage ports, the process incomplete command count accumulated by the storage virtualization apparatus, and stores into a second storing unit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of the other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and<!-- EPO <DP n="4"> --></li><li>an access request responding unit to, when receiving an access request against any one of the plurality of storage devices, obtain the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and to, when the obtained process incomplete command total count is larger than a prescribed number, cause completion timing of an access responding process to the access request to be delayed.</li></ul></p><p id="p0013" num="0013">According to an aspect of the disclosed technique, a method for making a plurality of storage devices function as one or more virtual volumes, a first storage virtualization apparatus connected with a plurality of storage ports across the plurality of storage devices executes:
<ul><li>storing, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port into a first storing unit;</li><li>obtaining, from each storage virtualization apparatus connected to any one of the plurality of storage ports , the process incomplete command count accumulated by the storage virtualizationapparatus, andstoringintoasecondstoringunit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and</li><li>obtaining, when receiving an access request against any one of the plurality of storage devices, the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and causing, when the obtainedprocess incomplete command total count is larger than a prescribed number, completion timing of an access responding process to the access request to be delayed.</li></ul><!-- EPO <DP n="5"> --></p><p id="p0014" num="0014">According to an aspect of the disclosed technique, a storage virtualization program for causing a computer connected with a plurality of storage ports of a plurality of storage devices to execute a process, the process includes:
<ul><li>storing, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port into a first storing unit;</li><li>obtaining, from each storage virtualization apparatus connected to any one of the plurality of storage ports , the process incomplete command count accumulated by the storage virtualizationapparatus, andstoringintoasecondstoringunit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and</li><li>obtaining, when receiving an access request against any one of the plurality of storage devices, the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and causing, when the obtainedprocess incomplete command total count is larger than a prescribed number, completion timing of an access responding process to the access request to be delayed.</li></ul></p><heading id="h0006">Advantageous Effects of Invention</heading><p id="p0015" num="0015">By virtualizing storages using the disclosed technique, it is possible to suppress occurrence of Queue Full in the storage ports across the storage devices.</p><heading id="h0007">Brief Description of Drawings</heading><p id="p0016" num="0016"><ul><li><figref idrefs="f0001">FIG. 1</figref> is an explanatory diagram of a storage virtualization system;<!-- EPO <DP n="6"> --></li><li><figref idrefs="f0002">FIG. 2</figref> is an explanatory diagram of problem that arises in the storage virtualization system;</li><li><figref idrefs="f0003">FIG. 3</figref> is an explanatory diagram illustrating a configuration and a use pattern of a storage virtualization apparatus according to a first embodiment;</li><li><figref idrefs="f0004">FIG. 4</figref> is a block diagram of the storage virtualization apparatus according to the first embodiment;</li><li><figref idrefs="f0005">FIG. 5</figref> is a flowchart of an information interchange process performed by the cluster control unit of the storage virtualization apparatus according to the first embodiment;</li><li><figref idrefs="f0006">FIG. 6</figref> is a flowchart of a virtual volume control process performed by the virtual volume control unit of the storage virtualization apparatus according to the first embodiment performs;</li><li><figref idrefs="f0007">FIG. 7</figref> is a functional block diagram of a storage virtualization apparatus according to a second embodiment;</li><li><figref idrefs="f0008">FIG. 8</figref> is a flowchart of a write request responding process performed by a virtual volume control unit of the storage virtualization apparatus according to the second embodiment;</li><li><figref idrefs="f0009">FIG. 9</figref> is a functional block diagram of a storage virtualization apparatus according to the third embodiment;</li><li><figref idrefs="f0010">FIG. 10</figref> is a flowchart of a write request responding process performed by a virtual volume control unit of the storage virtualization apparatus according to the third embodiment; and</li><li><figref idrefs="f0011">FIG. 11</figref> is an explanatory diagram of function of the storage virtualization apparatus according to the third embodiment.</li></ul></p><heading id="h0008">Description of Embodiments</heading><p id="p0017" num="0017">Some embodiments of the present invention will hereinafter be described with reference to the drawings.</p><heading id="h0009">«First Embodiment»</heading><p id="p0018" num="0018">To start with, use and configuration of a storage virtualization apparatus 10 according to the first embodiment<!-- EPO <DP n="7"> --> will be explained referring to <figref idrefs="f0003">FIGS. 3</figref> and <figref idrefs="f0004">4</figref>.</p><p id="p0019" num="0019">As illustrated in <figref idrefs="f0003">FIG. 3</figref>, the storage virtualization apparatus 10 according to the present embodiment is an apparatus used as a component of a storage virtualization apparatus cluster 1 that connects between a plurality of servers 80 and a plurality of storage devices 50.</p><p id="p0020" num="0020">The storage virtualization apparatus 10 is an apparatus that causes the plurality of storage devices 50 connected with itself to function as one ormore virtual volumes. As illustrated in <figref idrefs="f0003">FIG. 3</figref>, the storage virtualization apparatus 10 includes a cluster control unit 11, a storage unit 12 and a virtual volume control unit 13. Further, the storage virtualization apparatus 10 includes a port 15 (for example, a LAN port) to communicate with other storage virtualization apparatuses 10 and a port 16 (for example, a fibre channel port) to communicate with the servers 80. Moreover, the storage virtualization apparatus 10 includes two ports 17 (for example, SAS (Serial Attached SCSI) ports) that will be connected with a plurality of storage ports 51 across the plurality of storage devices 50.</p><p id="p0021" num="0021">Although, in <figref idrefs="f0003">FIG. 3</figref>, illustrated is the storage device 50 provided with a plurality of disk drives and two controller modules (CMs) each having the storage port 51, the storage virtualization apparatus 10 may also be connected to the storage device 50 (not illustrated) that has only one number of the storage ports 51.</p><p id="p0022" num="0022">Further, the storage virtualization apparatus 10 according to the present embodiment is in reality, as shown in <figref idrefs="f0004">FIG. 4</figref>, a computer 20 having a generic configuration where a storage virtualization program 30 is installed on its HDD (Hard Disk Drive) 23 from a portable recording medium (not illustrated) such as a CD-ROM etc. Each of the cluster control unit 11 and the virtual volume control unit 13 (<figref idrefs="f0003">FIG. 3</figref>) of the storage virtualization apparatus 10 is equivalent to a CPU (Central<!-- EPO <DP n="8"> --> Processing Unit) 21 performing specific processing according to the storage virtualization program 30. Further, the storage unit 12 is equivalent to the HDD 23 and a RAM (Random Access Memory) 22 of the computer 20, and the ports 15-17 is equivalent to the various interface circuits ("IF" in <figref idrefs="f0004">FIG. 4</figref>) of the computer 20.</p><p id="p0023" num="0023">The configuration and the operation of the storage virtualization apparatus 10 according to the present embodiment will be hereinafter described more specifically.</p><p id="p0024" num="0024">The storage virtualization apparatus 10 (<figref idrefs="f0003">FIG. 3</figref>) is given a function of issuing many commands to a storage port 51 while accumulating a difference between command counts , and outputting the difference between command counts (denoted hereafter as the queueable command number) at the point at which the storage port 51 becomes impossible to accept a command (at the point when Queue Full occurs). Note that, the difference between command counts is defined as the difference between the number of issued commands and the number of commands, responses to which have been obtained ("the number of issued commands"- "the number of the commands, responses to which have been obtained").</p><p id="p0025" num="0025">At the time of introduction (a setup) of the storage virtualization apparatus cluster 1, the queueable command number regarding each storage port 51 connected with each storage virtualization apparatus 10 is measured using the above-mentioned function. Thereafter, a upper threshold and a lower threshold that satisfies "the queueable command number &gt; the upper threshold &gt; the lower threshold" is determined with respect to each of the storage ports 51, and the determined upper thresholds and lower thresholds about the storage ports 51 are registered into the storage unit 12 of each storage virtualization apparatus 10.</p><p id="p0026" num="0026">Incidentally, at the time of the determination of the upper threshold and the lower threshold, not only the queueable command<!-- EPO <DP n="9"> --> number but also the execution period of the process of step S102 (<figref idrefs="f0005">FIG. 5</figref>), which will be detailed later, and the frequency of the access requests from the servers 80 are taken into consideration. Further, as to each storage port 51 that has been turned out to have the same specification with the storage port 51 whose queueable command number is already measured, measurement of the queueable command number is omitted. As the upper threshold and the lower threshold of each of such storage ports 51, registered are the upper threshold and the lower threshold that are determined from the measurement result of the queueable command number about another storage port 51 having the same specification.</p><p id="p0027" num="0027">When starting the operation of the storage virtualization apparatus cluster 1, also performed are an operation to set (specify) the storage virtualization apparatus 10 that is made to function as a master virtualization apparatus (details of which are given later on) and an operation to register virtual volumes (an operation to register mapping information indicating the correspondence relationship between each virtual volume and actual disk drives into the storage unit 12 of each storage virtualization apparatus 10).</p><p id="p0028" num="0028">When the above various operations (denoted hereinafter as the setup operation) are completed, each part of the storage virtualization apparatus 10 will go in the status of actually working.</p><p id="p0029" num="0029">First, an operation of the cluster control unit 11 will be described. Note that, in the following explanation, the master virtualization apparatus is the storage virtualization apparatus 10 which is operating as the master virtualization apparatus (which is set to operate as the master virtualization apparatus). Further, the slave virtualization apparatus is the storage virtualization apparatus 10 that is not the master virtualization apparatus.<!-- EPO <DP n="10"> --></p><p id="p0030" num="0030">When the setup operation is completed, the cluster control unit 11 in the master virtualization apparatus starts an information interchange process in a procedure illustrated in <figref idrefs="f0005">FIG. 5</figref>.</p><p id="p0031" num="0031">Namely, the cluster control unit 11 in the master virtualization apparatus which started this information interchange process, at first, obtains the difference between command counts related to each storage port 51 from each slave virtualization apparatus (each of other storage virtualization apparatuses 10) by sending a predetermined request for the difference of the command counts (step S101).</p><p id="p0032" num="0032">Although update procedure of the difference between command counts (the difference between the number of issued commands and the number of the commands the responses to which have been obtained) will be mentioned later on, each difference of command counts is stored in the storage unit 12 of each storage virtualization apparatus 10. Moreover, the request for the difference of the command counts is a request that is received by the cluster control unit 11 in the slave virtualization apparatus, and the cluster control unit 11 in the slave virtualization apparatus, when receiving the request for the difference of the command counts, reads the difference of the command counts related to each storage port 51 from the storage unit 12 and sends back them to the master virtualization apparatus.</p><p id="p0033" num="0033">The cluster control unit 11 having finished the process of step S101 calculates, with respect to each of the storage ports 51, a process incomplete command total count that is a total of the differences between the command counts obtained from the slave virtualization apparatuses and the differences between the command counts that the cluster control unit 11 manages as information in the storage unit 12. That is to say, the cluster control unit 11 in the master virtualization<!-- EPO <DP n="11"> --> apparatus calculates, with respect to each of the storage ports 51, the process incomplete command total count that is equivalent with "the number of commands which are inputted into a storage port 51 from one of the storage virtualization apparatus 10 and the process for which within the storage device 50 has not completed."</p><p id="p0034" num="0034">At step S102, the cluster control unit 11 also performs a process of rewriting the process incomplete command total count in the storage unit 12 related to each storage port 51 with the calculated process incomplete command total count related to each storage port 51.</p><p id="p0035" num="0035">Moreover, the cluster control unit 11 also performs at step S102 a process of distributing every calculated process incomplete command total count to each of the other storage virtualization apparatuses 10 (the slave virtualization apparatuses). Then, in each slave virtualization apparatus to which the various process incomplete command total counts are distributed from the master virtualization apparatus, the cluster control unit 11 performs a process of writing the distributed process incomplete command total count related to each storage port 51 instead of the corresponding process incomplete command total count in the storage unit 12.</p><p id="p0036" num="0036">After finishing the process of step 102 , the cluster control unit 11 waits for a lapse of a prescribed period of time (step S103), and thereafter performs again processing subsequent to step S101.</p><p id="p0037" num="0037">Given next is an explanation of an operation of the virtual volume control unit 13.</p><p id="p0038" num="0038">When the setup operation is completed, the virtual volume control unit 13 in each storage virtualization apparatus 10 (the master/slave virtualization apparatus) comes to a status of starting, when receiving an access request for a virtual volume from a server 80, a virtual volume control process in a procedure<!-- EPO <DP n="12"> --> illustrated in <figref idrefs="f0006">FIG. 6</figref>.</p><p id="p0039" num="0039">Namely, the virtual volume control unit 13 having received an access request from a server 80, to begin with, refers to the mapping information, thereby specifying the storage port 51 to which a command for responding the access request is to be issued (which will be hereinafter denoted as the access target port) (step S201). Then, the virtual volume control unit 13 compares the process incomplete command total count ("total count" in <figref idrefs="f0006">FIG. 6</figref>) and the upper threshold which are stored in the storage unit 12 as information related to the access target port (step S201).</p><p id="p0040" num="0040">When the process incomplete command total count related to the access target port is less than or equal to the upper threshold related to the access target port (step S201; NO), the virtual volume control unit 13 reserves the access target port and sends reservation notification to each of other storage virtualization apparatuses 10 (step S203).</p><p id="p0041" num="0041">Subsequently, the virtual volume control unit 13 issues to the access target port a read/write command for making the storage device 50 (the CM in the storage device 50) perform a read/write process the contents of which is specified by the received access request (step S204).</p><p id="p0042" num="0042">Moreover, the virtual volume control unit 13 performs a process of updating the difference of the command counts related to the access target port stored in the storage unit 12 (step S205). As already explained, the difference of the command counts is the difference between the number of the issued commands and the number of commands the responses to which are obtained ("the number of the issued commands" - "the number of the commands the response to which are obtained"). Therefore, at this step S205, performed is a process of adding "1" to the difference of the command counts related to the access target port. The virtual volume control unit 13 having finished the<!-- EPO <DP n="13"> --> process of step S205 waits for receiving a completion response (information indicating that the write process is completed, data read by the read process) of the write/read process from the access target port (step S206).</p><p id="p0043" num="0043">The virtual volume control unit 13 having received the completion response releases the reservation of the access target port and sends the reservation release notification to each of other storage virtualization apparatus 10 (step S207). At subsequent step S208, the virtual volume control unit 13 performs a process of updating the difference between the command counts related to the access target port (a process of subtracting "1" from the difference between the command counts related to the access target port in the storage unit 12).</p><p id="p0044" num="0044">Then, the virtual volume control unit 13 sends back a normal response (information indicating that the write process is completed, the data read by the read process) to the server 80 that has transmitted the access request (step S209), and thereafter finishes the virtual volume control process.</p><p id="p0045" num="0045">On the other hand, when the process incomplete command total count is greater than the upper threshold (step S201; YES), the virtual volume control unit 13 waits until the process incomplete command total count related to the access target port becomes a value less than or equal to the lower threshold related to the access target port (step S202).</p><p id="p0046" num="0046">Namely, the virtual volume control unit 13 waits until the process incomplete command total count related to the access target port is rewritten with a value less than or equal to the lower threshold related to the access target port by the information exchange process (<figref idrefs="f0005">FIG. 5</figref>) in consequence of progress of processing to commands queued within the access target port.</p><p id="p0047" num="0047">Then, when the process incomplete command total count related to the access target port becomes a value less than or equal to the lower threshold related to the access target port<!-- EPO <DP n="14"> --> (step S202; YES), the virtual volume control unit 13 performs the already-explained processes of steps S203-S209, and thereafter finishes the virtual volume control process.</p><p id="p0048" num="0048">As described above, the storage virtualization apparatus 10 according to the present embodiment constantly accumulates the difference between the command counts (the value obtained by subtracting the number of the commands the responses to which are obtained from the number of the commands that the storage virtualization apparatus has issued) related to each storage port 51. The master virtualization apparatus also periodically obtains the difference between the command counts related each storage port 51 from each slave virtualization apparatus, and calculates, with respect to each storage port 51, the process incomplete command total count that is a total of the differences between the command counts that the master virtualization apparatus itself accumulates and the differences between the command counts that the slave virtualization apparatus accumulates. Further, the master virtualization apparatus stores the calculated results internally (in the storage unit 12) and distributes them to each slave virtualization apparatus, and each slave virtualization apparatus, to which process incomplete command total counts related to storage ports 51 are distributed, stores the calculated results internally (in the storage unit 12).</p><p id="p0049" num="0049">Moreover, when receiving an access request from a server 80, the storage virtualization apparatus 10 (the master/slave virtualization apparatus) compares the process incomplete command total count related to the access target port with the upper threshold related to the access target port that is determined based on the queueable command number (<figref idrefs="f0006">FIG. 6</figref> ; step S201). When the process incomplete command total count is larger the upper threshold (step S201; YES), the storage virtualization apparatus 10 waits for the process incomplete command total count<!-- EPO <DP n="15"> --> to become a value less than the lower threshold (which is less than the upper threshold) (step S202; NO), and then starts the actual processes (steps S203-S209) to the received access request.</p><p id="p0050" num="0050">In short, each storage virtualization apparatus 10 in the storage virtualization apparatus cluster 1 operates in such a status that it holds, with respect to each of the plurality of storage port 51, the process incomplete command total count that is roughly equivalent to the number of commands remaining in the queue within the storage port 51. Then, each storage virtualization apparatus 10, in a case where Queue Full is likely to occur, wait until commands in the queue of the access target port are processed to some extent, and issues a command to the access target port.</p><p id="p0051" num="0051">The storage virtualization apparatus 10 according to the present embodiment is one that operates as mentioned above. Accordingly, with this storage virtualization apparatus used, it is feasible to construct easily (in a way that does not require a system design in consideration performance, etc. of each storage device 50) the storage virtualization system in which Queue Full hardly occurs at each storage port 51 across the storage devices 50.</p><heading id="h0010">«Second Embodiment»</heading><p id="p0052" num="0052">A configuration and an operation of a storage virtualization apparatus 10 according to a second embodiment will be explained in a way that puts a focus on differences from the above-mentioned storage virtualization apparatus 10 according to the first embodiment.</p><p id="p0053" num="0053"><figref idrefs="f0007">FIG. 7</figref> is a functional block diagram of the storage virtualization apparatus 10B according to the second embodiment. Note that, the storage virtualization apparatus 10B is an apparatus that is used in the same way (<figref idrefs="f0003">FIG. 3</figref>) as the storage virtualization apparatus 10. Further, the storage<!-- EPO <DP n="16"> --> virtualization apparatus 10B is, as with the storage virtualization apparatus 10, the computer 20 on which the storagevirtualizationprogram30 (contents of which is different from that of the first embodiment) is installed</p><p id="p0054" num="0054">As illustrated in <figref idrefs="f0007">FIG. 7</figref>, the storage virtualization apparatus 10B includes a cluster control unit 11, a storage unit 12 and a virtual volume control unit 13B. Further, the storage virtualization apparatus 10B includes a port 15 to communicate with other storage virtualization apparatuses 10B, a port 16 to communicate with the servers 80 (see <figref idrefs="f0003">FIG. 3</figref>), and two ports 17 that will be connected with a plurality of storage ports 51 (see <figref idrefs="f0003">FIG. 3</figref>) across the plurality of storage devices 50.</p><p id="p0055" num="0055">The cluster control unit 11, the storage unit 12 and the ports 15-17 of this storage virtualization apparatus 10B are the same as the cluster control unit 11, the storage unit 12 and the ports 15-17 of the storage virtualization apparatus 10, respectively. However, part of the storage area (part of the storage areas of RAM 22 in <figref idrefs="f0004">FIG. 4</figref>) of the storage unit 12 in the storage virtualization apparatus 10B is used as a cache memory 12B.</p><p id="p0056" num="0056">The virtual volume control unit 13B is a unit (a functional block) corresponding to the virtual volume control unit 13 to which the function to use the cache memory 12B is added.</p><p id="p0057" num="0057">An operation of the virtual volume control unit 13B to a read request and an operation of the virtual volume control unit 13B to a write request will be separately described below.</p><heading id="h0011">Operation to a read request</heading><p id="p0058" num="0058">When receiving a read request, the virtual volume control unit 13B, at first, judges whether there exists data, which is requested by the read request to be read, in the cache memory 12B.</p><p id="p0059" num="0059">When there exists the data requested by the read request<!-- EPO <DP n="17"> --> to be read in the cache memory 12B, the virtual volume control unit 13B reads the data from the cache memory 12B. Then, the virtual volume control unit 13B sends back the read data to the server 80 that has transmitted the read request, and thereafter terminates the processing to the received read request.</p><p id="p0060" num="0060">On the other hand, when there does not exist the data requested by the read request to be read in the cache memory 12B, the virtual volume control unit 13B performs a process corresponding to the above-mentioned virtual volume control process (<figref idrefs="f0006">FIG. 6</figref>) involving a step of caching the data read from the storage device 50. Then, the virtual volume control unit 13B having finished the process terminates the processing to the received read request.</p><heading id="h0012">Operation to Write Request</heading><p id="p0061" num="0061">When receiving a write request, the virtual volume control unit 13B performs a write request responding process in a procedure illustrated in <figref idrefs="f0008">FIG. 8</figref>.</p><p id="p0062" num="0062">That is, the virtual volume control unit 13B receiving the write request, at first, caches the received write request into the cache memory 12B (step S301).</p><p id="p0063" num="0063">At subsequent step S302, the virtual volume control unit 13B performs a process (decision) identical with the already explainedprocess (<figref idrefs="f0006">FIG. 6</figref>) of step S201. Then, the virtual volume control unit 13B, when the process incomplete command total count related to the access target port is less than or equal to the upper threshold related to the access target port (step S302; NO), sends back a normal response (write-in completion notification) to the server 80 that has transmitted the access request (step S304).</p><p id="p0064" num="0064">The virtual volume control unit 13B performs processes at step S305-S310 which are identical with the already explained processes at step S203-S208, respectively. Then, the virtual volume control unit 13B having finished the process of step S310<!-- EPO <DP n="18"> --> terminates the write request responding process.</p><p id="p0065" num="0065">On the other hand, when the process incomplete command total count is larger than the upper threshold (step S302; YES), the virtual volume control unit 13B waits until the process incomplete command total count related to the access target port becomes a value less than or equal to the lower threshold related to the access target port (step S303).</p><p id="p0066" num="0066">Then, when the process incomplete command total count related to the access target port becomes a value less than or equal to the lower threshold related to the access target port (step S303; YES), the virtual volume control unit 13B performs processing subsequent to step S304.</p><p id="p0067" num="0067">As is clear from the description given above, this storage virtualization apparatus 10B is, as with the storage virtualization apparatus 10, an apparatus that, when the process incomplete command total count is larger than the upper threshold, waits until theprocess incomplete command total count becomes a value less than or equal to the lower threshold, and thereafter issues the competition response to the access target port. Accordingly, with the storage virtualization apparatus 10B used, it is feasible to construct easily (in a way that does not require a system design in consideration performance, etc. of each storage device 50) the storage virtualization system in which Queue Full hardly occurs at each storage port 51 across the storage devices 50.</p><p id="p0068" num="0068">Moreover, the storage virtualization apparatus 10B responds an access request using the cache memory 12B. The storage virtualization apparatus 10B can be therefore said to be the apparatus that can respond to an access request earlier than the storage virtualization apparatus 10.</p><heading id="h0013">«Third Embodiment»</heading><p id="p0069" num="0069">A configuration and an operation of astorage virtualization apparatus 10 according to a second embodiment will be explained<!-- EPO <DP n="19"> --> in a way that puts a focus on differences from the above-mentioned storage virtualization apparatus 10 according to the first embodiment.</p><p id="p0070" num="0070">The configuration of the storage virtualization apparatus 10C according to the third embodiment is shown in <figref idrefs="f0009">FIG. 9. FIG. 9</figref> is a functional block diagram of the storage virtualization apparatus 10C according to the third embodiment. Note that, the storage virtualization apparatus 10B is an apparatus that is used in the same way (<figref idrefs="f0003">FIG. 3</figref>) as the storage virtualization apparatuses 10 and 10B. Further, the storage virtualization apparatus 10B is, as with the storage virtualization apparatuses 10 and 10B, the computer 20 on which the storage virtualization program 30 (contents of which is different from that of the first or second embodiment) is installed</p><p id="p0071" num="0071">As illustrated in <figref idrefs="f0009">FIG. 9</figref>, the storage virtualization apparatus 10B includes a cluster control unit 11, a storage unit 12 and a virtual volume control unit 13C. Further, the storage virtualization apparatus 10C includes a port 15 to communicate with other storage virtualization apparatuses 10C, a port 16 to communicate with the servers 80 (see <figref idrefs="f0003">FIG. 3</figref>), and two ports 17 that will be connected with a plurality of storage ports 51 (see <figref idrefs="f0003">FIG. 3</figref>) across the plurality of storage devices 50.</p><p id="p0072" num="0072">The cluster control unit 11, the storage unit 12 and the ports 15-17 of this storage virtualization apparatus 10B are the same as the cluster control unit 11, the storage unit 12 and the ports 15-17 of the storage virtualization apparatus 10, respectively.</p><p id="p0073" num="0073">The virtual volume control unit 13C is a unit (functional block) that performs, when receiving an access request from a server 80, a virtual volume control process in a procedure illustrated in <figref idrefs="f0010">FIG. 10</figref></p><p id="p0074" num="0074">Namely, the virtual volume control unit 13C having received an access request from a server 80 refers to the mapping<!-- EPO <DP n="20"> --> information, thereby specifying the storage port 51 to which a command for responding the access request is to be issued (which will be hereinafter denoted as the access target port) (step S401). Then, the virtual volume control unit 13C reserves the access target port and sends reservation notification to each of other storage virtualization apparatuses 10C (virtualization apparatuses in <figref idrefs="f0010">FIG. 10</figref>) (step S401).</p><p id="p0075" num="0075">Subsequently, the virtual volume control unit 13 issues to the access target port a read/write command for making the storage device 50 (the CM in the storage device 50) perform a read/write process the contents of which is specified by the received access request (step S402).</p><p id="p0076" num="0076">Further, the virtual volume control unit 13C performs a process of updating the difference of the command counts related to the access target port stored in the storage unit 12 (step S403). Specifically, the virtual volume control unit 13C adds "1" to the difference of the command counts related to the access target port.</p><p id="p0077" num="0077">The virtual volume control unit 13C having finished the process of step S403 waits for receiving a completion response (information indicating that the write process is completed, data read by the read process) of the write/read process from the access target port (step S404).</p><p id="p0078" num="0078">The virtual volume control unit 13 having received the completion response releases the reservation of the access target port and sends the reservation release notification to each of other storage virtualization apparatus 10 (step S405). Further, the virtual volume control unit 13C performs a process of updating the difference between the command counts related to the access target port (a process of subtracting "1" from the difference between the command counts related to the access target port in the storage unit 12) (step S406). Thereafter, the virtual volume control unit 13C compares<!-- EPO <DP n="21"> --> the process incomplete command total count ("total count" in <figref idrefs="f0010">FIG. 10</figref>) and the upper threshold which are stored in the storage unit 12 as information related to the access target port (step S407).</p><p id="p0079" num="0079">When the process incomplete command total count related to the access target port is less than or equal to the upper threshold related to the access target port (step S407; NO), the virtual volume control unit 13C sends back the normal response (information indicating that the write process is completed, the data read by the read process) to the server 80 that has transmitted the access request (step S409). Then, the virtual volume control unit 13C terminates this virtual volume control process.</p><p id="p0080" num="0080">On the other hand, when the process incomplete command total count is greater than the upper threshold (step S407; YES), the virtual volume control unit 13C waits until the process incomplete command total count related to the access target port becomes a value less than or equal to the lower threshold related to the access target port (step S408).</p><p id="p0081" num="0081">Then, the virtual volume control unit 13C, when the process incomplete command total count related to the access target port becomes less than or equal to the lower threshold related to the access target port, sends back the normal response to the server 80 that has transmitted the access request (step S409), and thereafter terminates the virtual volume control process.</p><p id="p0082" num="0082">As described above, the storage virtualization apparatus 10C constantly accumulates the difference between the command counts related to each storage port 51 as with the storage virtualization apparatuses 10 and 10B. The master virtualization apparatus, as schematically illustrated in <figref idrefs="f0011">FIG. 11</figref>, periodically obtains the difference between the command counts ("difference" in <figref idrefs="f0011">FIG. 11</figref>) related each storage port 51 from each slave virtualization apparatus, and calculates, with<!-- EPO <DP n="22"> --> respect to each storage port 51, the process incomplete command total count ("total count" in <figref idrefs="f0011">FIG. 11</figref>) that is a total of the differences between the command counts that the master virtualization apparatus itself accumulates and the differences between the command counts that the slave virtualization apparatus accumulates. Further, the master virtualization apparatus stores the calculated results internally (in the storage unit 12) and distributes them to each slave virtualization apparatus, and each slave virtualization apparatus, to which process incomplete command total counts related to storage ports 51 are distributed, stores the calculated results internally (in the storage unit 12).</p><p id="p0083" num="0083">Moreover, when receiving an access request from a server 80, the storage virtualization apparatus 10C (the master/slave virtualization apparatus) issues a command to the access target port. When receiving the complete response to the issued command, the storage virtualization apparatus 10C compares the process incomplete command total count with the upper threshold. In other words, the storage virtualization apparatus 10C judges whether the number of commands in the queue of the access target port which are waiting for being processed (≒the process incomplete command total count) is larger than the upper threshold.</p><p id="p0084" num="0084">Then, the storage virtualization apparatus 10C, when the process incomplete command total count is larger than the upper threshold, waits until the process incomplete command total count becomes a value less than or equal to the lower threshold, and thereafter issues the competition response to the access target port.</p><p id="p0085" num="0085">The storage virtualization apparatus 10C according to the present embodiment is one that operates as mentioned above. And, a delay of the completion response to the access request can allow the transmitting timing of the next access request of the<!-- EPO <DP n="23"> --> server 80 to be delayed. Accordingly, with storage virtualization apparatus 10C used, it is feasible to construct easily (in a way that does not require a system design in consideration performance, etc. of each storage device 50) the storage virtualization system in which Queue Full hardly occurs at each storage port 51 across the storage devices 50.</p><heading id="h0014">«Modifications»</heading><p id="p0086" num="0086">Various modifications are possible for the storage virtualization apparatus (10, 10B, or 10C) according to each above-mentioned embodiment. For example, the storage virtualization apparatus (10, 10B, or 10C) according to each above-mentioned embodiment can be modified into an apparatus wherein the lower threshold matches the upper threshold agrees with the lower threshold (an apparatus wherein the same values are set as both thresholds, an apparatus wherein one value is used each of the lower and upper values).</p><p id="p0087" num="0087">The storage virtualization apparatus 10C can also be modified into an apparatus including a cache memory. The storage virtualization apparatus according to each above-mentioned embodiment can be modified into an apparatus that is non-distinguishable between master and slave, i.e., "an apparatus that does not obtain the process incomplete command total count from the other storage virtualization apparatuses, and periodically obtains the difference between the command counts from each of the other storage virtualization apparatuses to calculate the process incomplete command total count."</p><p id="p0088" num="0088">Moreover, it is taken for granted that the configuration of the computer 20 that is made operate as the storage virtual apparatus may be differentiated from that illustrated in <figref idrefs="f0004">FIG. 4</figref>, and that the storage virtual apparatus may be actualized not as the computer 20 on which program is installedbut as andedicated apparatus.</p><p id="p0089" num="0089">Furthermore, with regard to the above technology, the<!-- EPO <DP n="24"> --> following note is disclosed.</p><p id="p0090" num="0090">(Note 1) A storage virtualization apparatus cluster for making a plurality of storage devices function as one or more virtual volumes, the cluster comprising:
<ul><li>a first storage virtualization apparatus and one or more second storage virtualization apparatus each of which is connected with a plurality of storage ports across the plurality of storage devices;</li><li>the first storage virtualization apparatus including:
<ul><li>an accumulate unit to accumulate, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are sent by the first storage virtualization apparatus, but are not yet processed by the storage device having each storage port;</li><li>a management unit to periodically obtain, from each of other storage virtualization apparatuses connected to any one of the plurality of storage ports, the process incomplete command count accumulated by the storage virtualization apparatus, calculates, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of the other storage virtualization apparatuses and the process incomplete command count accumulated by the accumulate unit, sends the calculated process incomplete command total counts to each of the second storage virtualization apparatus and manages the calculated process incomplete command total counts; and</li><li>an access request responding unit to perform, when receiving an access request against any one of the plurality of storage devices from a server, an access responding process including a process of issuing a command to a storage port corresponding to the access request,<br/>
wherein the access request responding unit, when the process<!-- EPO <DP n="25"> --> incomplete command total count about the storage port corresponding to the access request managed by the management unit is larger than a prescribed number, delays completion timing of an access responding process to the access request,</li></ul></li><li>each of the one or more second storage virtualization apparatus including:
<ul><li>a second accumulate unit to accumulate, with respect to each of the plurality of storage ports, the process incomplete command count defined as number of commands that are sent by the second storage virtualization apparatus, but are not yet processed by the storage device having each storage port;</li><li>a sending unit to send the process incomplete command count about each storage port to the first storage virtualization apparatus;</li><li>a second management unit to manage the process incomplete command total count about each storage port that is sent from the first storage virtualization apparatus;</li><li>a second access request responding unit to, when receiving an access request against any one of the plurality of storage devices, obtain the process incomplete command total count corresponding to the received access request from the second storing unit, and to, when the obtained process incomplete command total count is larger than a prescribed number, cause completion timing of an access responding process to the access response to be delayed; and</li><li>a second access request responding unit to perform, when receiving an access request from a server, an access responding process including a process of issuing a command to a storage port corresponding to the access request,</li></ul>
wherein the second access request responding unit, when the process incomplete command total count about the storage port corresponding to the access request managed by the second management unit is larger than the prescribed number, delays<!-- EPO <DP n="26"> --> completion timing of the access responding process to the access request.</li></ul></p><heading id="h0015">Reference Signs List</heading><p id="p0091" num="0091"><dl id="dl0001" compact="compact"><dt>1</dt><dd>storage virtualization device cluster</dd><dt>10, 10B, 10C</dt><dd>storage virtualization apparatus</dd><dt>11</dt><dd>cluster control unit</dd><dt>12</dt><dd>storage device</dd><dt>12B</dt><dd>cache memory</dd><dt>13, 13B, 13C</dt><dd>virtual volume control unit</dd><dt>15, 16, 17</dt><dd>port</dd><dt>20</dt><dd>computer</dd><dt>21</dt><dd>CPU</dd><dt>22</dt><dd>RAM</dd><dt>23</dt><dd>HDD</dd><dt>30</dt><dd>storage virtualization program</dd><dt>50</dt><dd>storage device</dd><dt>51</dt><dd>storage port</dd><dt>80</dt><dd>server</dd></dl></p></description><claims mxw-id="PCLM56976521" lang="EN" load-source="patent-office"><!-- EPO <DP n="27"> --><claim id="c-en-0001" num="0001"><claim-text>A storage virtualization apparatus capable of being connected with a plurality of storage ports across a plurality of storage devices, the apparatus comprising:
<claim-text>a first storing unit to store, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port;</claim-text>
<claim-text>a control unit to obtain, from each of other storage virtualization apparatuses connected to any one of the plurality of storage ports, the process incomplete command count accumulated by the storage virtualization apparatus, and stores into a second storing unit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of the other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and</claim-text>
<claim-text>an access request responding unit to, when receiving an access request against any one of the plurality of storage devices, obtain the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and to, when the obtained process incomplete command total count is larger than a prescribed number, cause completion timing of an access responding process to the access request to be delayed.</claim-text></claim-text></claim><claim id="c-en-0002" num="0002"><claim-text>The storage virtualization apparatus according to claim 1, wherein the access request responding unit, when the obtained process incomplete command total count is larger than the prescribed number, performs a process of issuing a command to the storage port corresponding to the received access request,<!-- EPO <DP n="28"> --> and thereafter makes sending back of a response to the command be delayed until the process incomplete command total count becomes less than or equal to a second prescribed number.</claim-text></claim><claim id="c-en-0003" num="0003"><claim-text>The storage virtualization apparatus according to claim 1, wherein the access request responding unit, when the obtained process incomplete command total count is larger than the prescribed number, makes a start of the access responding process to the received access request be delayed until the process incomplete command total count becomes less than or equal to a second prescribed number.</claim-text></claim><claim id="c-en-0004" num="0004"><claim-text>The storage virtualization apparatus according to any one of claims 1 through 3, wherein the access responding process to a write request performed by the access request responding unit is a process of storing the write request into a memory, notifying a sender of competition of response to the write request, and thereafter sends a command to a storage port corresponding to the write request.</claim-text></claim><claim id="c-en-0005" num="0005"><claim-text>The storage virtualization apparatus according to any one of claim 1 through 4, wherein the prescribed number is a value determined on per storage port basis.</claim-text></claim><claim id="c-en-0006" num="0006"><claim-text>The storage virtualization apparatus according to claim 2 or 3, wherein the second prescribed number agrees with the first prescribed number.</claim-text></claim><claim id="c-en-0007" num="0007"><claim-text>A method for making a plurality of storage devices function as one or more virtual volumes, a first storage virtualization apparatus connected with a plurality of storage ports across the plurality of storage devices executing:
<claim-text>storing, with respect to each of the plurality of storage<!-- EPO <DP n="29"> --> ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port into a first storing unit;</claim-text>
<claim-text>obtaining, from each storage virtualization apparatus connected to any one of the plurality of storage ports , the process incomplete command count accumulated by the storage virtualizationapparatus, and storing into a second storing unit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and</claim-text>
<claim-text>obtaining, when receiving an access request against any one of the plurality of storage devices, the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and causing, when the obtainedprocess incomplete command total count is larger than a prescribed number, completion timing of an access responding process to the access request to be delayed.</claim-text></claim-text></claim><claim id="c-en-0008" num="0008"><claim-text>The storage virtualization method according to claim 7, wherein the first virtualization apparatus, when the obtained process incomplete command total count is larger than the prescribed number, makes a start of the access responding process to the received access request be delayed until the process incomplete command total count becomes less than or equal to a second prescribed number.</claim-text></claim><claim id="c-en-0009" num="0009"><claim-text>The storage virtualization method according to claim 7, wherein the first virtualization apparatus, when the obtained process incomplete command total count is larger than the prescribed number, performs a process of issuing a command to the storage port corresponding to the received access request,<!-- EPO <DP n="30"> --> and thereafter makes sending back of a response to the command be delayed until the process incomplete command total count becomes less than or equal to a second prescribed number.</claim-text></claim><claim id="c-en-0010" num="0010"><claim-text>A storage virtualization program for causing a computer connected with a plurality of storage ports of a plurality of storage devices to execute a process, the process comprising:
<claim-text>storing, with respect to each of the plurality of storage ports, a process incomplete command count defined as number of commands that are not yet processed by the storage device having each storage port into a first storing unit;</claim-text>
<claim-text>obtaining, from each storage virtualization apparatus connected to anyone of the plurality of storage ports , the process incomplete command count accumulated by the storage virtualization apparatus, andstoringintoasecondstoringunit, with respect to each of the plurality of storage ports, a process incomplete command total count that is a total of the process incomplete command count obtained from each of other storage virtualization apparatuses and the process incomplete command count obtained from the first storing unit; and</claim-text>
<claim-text>obtaining, when receiving an access request against any one of the plurality of storage devices, the process incomplete command total count about a storage port corresponding to the received access request from the second storing unit, and causing, when the obtained process incomplete command total count is larger than a prescribed number, completion timing of an access responding process to the access request to be delayed.</claim-text></claim-text></claim></claims><drawings mxw-id="PDW16667301" load-source="patent-office"><!-- EPO <DP n="31"> --><figure id="f0001" num="1"><img id="if0001" file="imgf0001.tif" wi="165" he="220" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="32"> --><figure id="f0002" num="2"><img id="if0002" file="imgf0002.tif" wi="165" he="211" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="33"> --><figure id="f0003" num="3"><img id="if0003" file="imgf0003.tif" wi="165" he="204" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="34"> --><figure id="f0004" num="4"><img id="if0004" file="imgf0004.tif" wi="153" he="157" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="35"> --><figure id="f0005" num="5"><img id="if0005" file="imgf0005.tif" wi="160" he="155" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="36"> --><figure id="f0006" num="6"><img id="if0006" file="imgf0006.tif" wi="160" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="37"> --><figure id="f0007" num="7"><img id="if0007" file="imgf0007.tif" wi="110" he="140" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="38"> --><figure id="f0008" num="8"><img id="if0008" file="imgf0008.tif" wi="151" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="39"> --><figure id="f0009" num="9"><img id="if0009" file="imgf0009.tif" wi="95" he="125" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="40"> --><figure id="f0010" num="10"><img id="if0010" file="imgf0010.tif" wi="143" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="41"> --><figure id="f0011" num="11"><img id="if0011" file="imgf0011.tif" wi="152" he="233" img-content="drawing" img-format="tif"/></figure></drawings><copyright>User acknowledges that Fairview Research LLC and its third party providers retain all right, title and interest in and to this xml under applicable copyright laws.  User acquires no ownership rights to this xml including but not limited to its format.  User hereby accepts the terms and conditions of the Licence Agreement</copyright></patent-document>
